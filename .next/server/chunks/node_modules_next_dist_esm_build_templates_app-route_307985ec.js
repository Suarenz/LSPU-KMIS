module.exports=[80802,e=>{"use strict";var t=e.i(47909),i=e.i(74017),a=e.i(96250),n=e.i(59756),r=e.i(61916),o=e.i(14444),s=e.i(37092),l=e.i(69741),c=e.i(16795),u=e.i(87718),d=e.i(95169),p=e.i(47587),g=e.i(66012),m=e.i(70101),h=e.i(26937),v=e.i(10372),f=e.i(93695);e.i(52474);var y=e.i(220),I=e.i(89171),R=e.i(81563),$=e.i(15270);e.i(52914);var A=e.i(40849);e.i(37253);var T=e.i(60427),E=e.i(11614),P=e.i(83522),S=e.i(73716),w=e.i(94681);async function C(e,t,i,a,n,r,o){try{let o;if(!r||!r.initiatives||0===r.initiatives.length)return console.log(`[matchActivityToKPI] No initiatives found for KRA ${a}`),null;let s=r.initiatives.map((e,t)=>{let i=e.description||e.kpi_title||"",a=e.targets?.type||"numeric",n=(e.targets?.timeline_data||[]).slice(-2).map(e=>`Year ${e.year}: ${e.target_value}`).join(", ");return`${t+1}. **${e.id}**: ${i}
   Type: ${a}
   Recent targets: ${n}`}).join("\n\n"),l=`
You are a strategic planning expert at a university. Your task is to match a reported activity to the MOST APPROPRIATE Key Performance Indicator (KPI) within a Key Result Area (KRA).

**Activity Being Matched:**
Name: ${t}
Description: ${i}

**Target KRA:**
${a}: ${n}

**Available KPIs within this KRA:**
${s}

**Task:** 
Analyze the activity name and description. Determine which KPI BEST matches this activity based on:
1. Semantic similarity (does the activity description match the KPI description?)
2. Metric alignment (is the reported value consistent with what this KPI measures?)
3. Strategic fit (does this activity contribute to this KPI's objective?)

**Response Format (JSON):**
{
  "selectedKPINumber": <number 1-${r.initiatives.length}>,
  "selectedKPIId": "<KPI ID>",
  "confidenceScore": <0.0-1.0>,
  "reason": "<brief explanation of why this KPI was selected>"
}

Select the BEST matching KPI. If none are good matches, still select the closest one.`,c=[new E.SystemMessage("You are a university performance analyst. Respond only with valid JSON."),new T.HumanMessage(l)],u=await e.invoke(c),d=u.content?.toString()||"";try{let e=d.match(/\{[\s\S]*\}/);if(e)o=JSON.parse(e[0]);else throw Error("No JSON found in response")}catch(e){return console.log(`[matchActivityToKPI] Failed to parse LLM response: ${d}`),{initiativeId:r.initiatives[0].id,matchedKPI:r.initiatives[0]}}let p=(o.selectedKPINumber||1)-1;if(p<0||p>=r.initiatives.length)return console.log(`[matchActivityToKPI] Invalid index ${p}, using first KPI`),{initiativeId:r.initiatives[0].id,matchedKPI:r.initiatives[0]};let g=r.initiatives[p];return console.log(`[matchActivityToKPI] Matched activity "${t}" to KPI: ${g.id} (confidence: ${o.confidenceScore})`),console.log(`[matchActivityToKPI] Reason: ${o.reason}`),{initiativeId:g.id,matchedKPI:g}}catch(e){return console.error("[matchActivityToKPI] Error during KPI matching:",e),null}}async function K(t){try{let i,a=await (0,R.requireAuth)(t);if("status"in a)return a;let{user:n}=a,{analysisId:r,activities:o}=await t.json();if(!r||!o||!Array.isArray(o))return I.NextResponse.json({error:"Missing analysisId or activities"},{status:400});if(!["ADMIN","FACULTY"].includes(n.role))return I.NextResponse.json({error:"Insufficient permissions to regenerate insights"},{status:403});let s=await $.default.qPROAnalysis.findUnique({where:{id:r}});if(!s)return I.NextResponse.json({error:"Analysis not found"},{status:404});let l=e.r(23257),c=l.kras||[],u=s.year||2025,d=new A.ChatOpenAI({model:"gpt-4o-mini",apiKey:process.env.OPENAI_API_KEY,temperature:.7,maxTokens:500}),p=[];for(let e of o)try{let t=(0,P.normalizeKraId)(e.kraId),i=c.find(e=>(0,P.normalizeKraId)(e.kra_id)===t),a=i?.kra_title||e.kraId;if(!i){console.log(`[Regenerate] KRA not found: ${e.kraId}`),p.push({...e,aiInsight:null,prescriptiveAnalysis:null});continue}console.log(`[Regenerate] Processing activity: ${e.name}`),console.log(`[Regenerate] Original KRA: ${e.initiativeId}, New KRA: ${e.kraId}`);let n=!0===e.userSelectedKPI,r=e.initiativeId;if(n)console.log(`[Regenerate] Using user-selected KPI: ${r}`);else{let t=await C(d,e.name,e.description||e.name,e.kraId,a,i,l);t?(r=t.initiativeId,console.log(`[Regenerate] Matched to KPI: ${r}`)):(console.log("[Regenerate] Could not match to KPI, using first available for KRA"),i.initiatives&&i.initiatives.length>0&&(r=i.initiatives[0].id))}let{target:o,targetType:s}=function(e,t,i,a){let n=e.kras||[],r=(0,P.normalizeKraId)(t),o=n.find(e=>(0,P.normalizeKraId)(e.kra_id)===r);if(!o)return console.log(`[findTargetFromStrategicPlan] KRA not found: ${t}`),{target:null,targetType:"unknown"};console.log(`[findTargetFromStrategicPlan] Found KRA: ${t}, looking for initiative: ${i}`),console.log("[findTargetFromStrategicPlan] Available initiatives:",o.initiatives?.map(e=>e.id));let s=o.initiatives?.find(e=>e.id===i);if(!s&&i){let e=i.replace(/\s+/g,"");if(!(s=o.initiatives?.find(t=>t.id.replace(/\s+/g,"")===e))){let e=i.match(/KPI(\d+)/i);if(e){let t=e[1];s=o.initiatives?.find(e=>e.id.includes(`KPI${t}`))}}}if(!s||!s.targets)return console.log(`[findTargetFromStrategicPlan] Initiative not found: ${i}`),{target:null,targetType:"unknown"};console.log(`[findTargetFromStrategicPlan] Found initiative: ${s.id}`);let l=s.targets.type||"percentage",c=s.targets.timeline_data||[],u=c.find(e=>e.year===a);if(u&&"number"==typeof u.target_value)return console.log(`[findTargetFromStrategicPlan] Found target for year ${a}: ${u.target_value}`),{target:u.target_value,targetType:l};let d=c.filter(e=>"number"==typeof e.target_value);if(d.length>0){let e=d.filter(e=>e.year<=a);if(e.length>0){let t=e[e.length-1].target_value;return console.log(`[findTargetFromStrategicPlan] Using closest target: ${t}`),{target:t,targetType:l}}let t=d[0].target_value;return console.log(`[findTargetFromStrategicPlan] Using first available target: ${t}`),{target:t,targetType:l}}return console.log(`[findTargetFromStrategicPlan] No numeric target found for ${i}`),{target:null,targetType:l}}(l,e.kraId,r,u);console.log(`[Regenerate] Found target for ${e.name}: ${o} (type: ${s})`);let g=null!==o?o:e.target,{achievement:m,status:h}=function(e,t){let i;if(0===t)return{achievement:0,status:"MISSED"};let a=e/t*100;return i=a>=100?a>100?"EXCEEDED":"MET":"MISSED",{achievement:a,status:i}}(e.reported,g);console.log(`[Regenerate] Final target: ${g}, Achievement: ${m.toFixed(2)}%, Status: ${h}`);let v={...e,kraId:e.kraId,initiativeId:r,target:g,achievement:m,status:h,targetType:s,aiInsight:null,prescriptiveAnalysis:null};console.log("[Regenerate] Pushing activity with target:",v.target),p.push(v)}catch(t){console.error(`Error regenerating insights for activity: ${e.name}`,t),p.push({...e,aiInsight:null,prescriptiveAnalysis:null})}let g=(s.activities||[]).map(e=>{let t=p.find(t=>t.name===e.name||t.index===e.index);return t?{...e,kraId:t.kraId,initiativeId:t.initiativeId,target:t.target,achievement:t.achievement,status:t.status,targetType:t.targetType,aiInsight:null,prescriptiveAnalysis:null}:e}),m=Number(s.year??u??2025),h=new Map;for(let e of g){let t=String(e.kraId||"").trim(),i=String(e.initiativeId||"").trim();if(!t||!i)continue;let a=`${t}::${i}`;h.has(a)||h.set(a,{kraId:t,initiativeId:i,activities:[]}),h.get(a).activities.push(e)}let v=[];for(let e of h.values()){let t=(0,P.getInitiativeTargetMeta)({kras:c},e.kraId,e.initiativeId,m),i="number"==typeof e.activities?.[0]?.initiativeTarget?e.activities[0].initiativeTarget:"number"==typeof e.activities?.[0]?.target?e.activities[0].target:Number(e.activities?.[0]?.target||0),a=t.targetValue??(Number.isFinite(i)&&i>0?i:0),n=(0,P.computeAggregatedAchievement)({targetType:t.targetType||e.activities?.[0]?.targetType,targetValue:a,targetScope:t.targetScope,activities:e.activities}),r="percentage"===String(t.targetType||e.activities?.[0]?.targetType||"").toLowerCase();v.push({totalTarget:n.totalTarget,totalReported:n.totalReported,achievementPercent:n.achievementPercent,isRateMetric:r})}let f=v.length>0?v.reduce((e,t)=>e+(t.achievementPercent||0),0)/v.length:0,y={};for(let e of g)if("MISSED"===e.status||e.achievement&&e.achievement<100){e.target,e.reported;let t=e.target>0?(e.target-e.reported)/e.target*100:0;y[e.name]={target:e.target,actual:e.reported,gap:t}}if(v.length>0){let e=v.every(e=>e.isRateMetric),t=e?v.reduce((e,t)=>e+(t.totalTarget||0),0)/v.length:v.reduce((e,t)=>e+(t.totalTarget||0),0),i=e?v.reduce((e,t)=>e+(t.totalReported||0),0)/v.length:v.reduce((e,t)=>e+(t.totalReported||0),0);y["Overall Achievement"]={target:t,actual:i,gap:t>0?(t-i)/t*100:0}}let K=g.filter(e=>"MET"===e.status||"EXCEEDED"===e.status||e.achievement&&e.achievement>=100),N=g.filter(e=>"MISSED"===e.status||e.achievement&&e.achievement<100),x=[...new Set(g.map(e=>e.kraId))],b=x.map(e=>{let t=(0,P.normalizeKraId)(e),i=c.find(e=>(0,P.normalizeKraId)(e.kra_id)===t);return i?.kra_title||e}).join(", "),k=y["Overall Achievement"]?y["Overall Achievement"]:null,F=!!k&&k.target<=100&&k.actual<=100,O=`### Summary
- Activities analyzed: ${g.length}
- KRAs covered: ${x.length}${b?` (${b})`:""}
- Activities met/exceeded: ${K.length}
- Activities missed: ${N.length}
- Overall achievement score: ${f.toFixed(2)}%
`+(k?`- ${F?"Average reported rate":"Total reported"}: ${k.actual.toFixed(2)}${F?"%":""}
- ${F?"Target rate":"Total target"}: ${k.target.toFixed(2)}${F?"%":""}
`:""),M=g.filter(e=>Number(e?.achievement||0)>80).slice().sort((e,t)=>Number(t.achievement||0)-Number(e.achievement||0))[0],_=N.slice().sort((e,t)=>Number(e.achievement||0)-Number(t.achievement||0))[0];(i=[]).push(`The report indicates an overall achievement score of ${f.toFixed(2)}% across ${g.length} tracked activities.`),b&&i.push(`Coverage spans ${x.length} KRA(s): ${b}.`),M?.name&&i.push(`Key strengths appear in "${M.name}" (${Number(M.achievement||0).toFixed(1)}% of target).`),_?.name&&i.push(`Performance is primarily constrained by "${_.name}", which is at ${Number(_.achievement||0).toFixed(1)}% of target, suggesting a volume or reporting pipeline bottleneck rather than a technical output issue.`),i.join(" ");let D="";if(K.length>0){let e=K.map(e=>`- ${e.name} (${(e.achievement||0).toFixed(1)}% achievement)`).join("\n");D=`### High-performing activities
${e}
`}if(N.length>0){let e=N.map(e=>{let t=e.target>0?(e.target-e.reported)/e.target*100:0,i=e.target<=100&&e.reported<=100?"%":"";return`- ${e.name}: Target ${Number(e.target||0).toFixed(2)}${i}, Reported ${Number(e.reported||0).toFixed(2)}${i} (Gap ${t.toFixed(1)}%)`}).join("\n");D+=(D?"\n\n":"")+`### Improvement opportunities
`+`${e}
`}console.log("[Regenerate] Generating fresh prescriptive analysis via LLM...");let U=g.map(e=>{let t=(0,P.normalizeKraId)(e.kraId),i=c.find(e=>(0,P.normalizeKraId)(e.kra_id)===t),a=i?.initiatives?.find(t=>t.id===e.initiativeId),n=a?.targets?.type||e.targetType||"count",r=(0,w.getKpiTypeCategory)(n),o=(0,w.getGapInterpretation)(r);return{name:e.name,kraTitle:i?.kra_title||e.kraId,kpiId:e.initiativeId,kpiType:n,kpiCategory:r,reported:e.reported,target:e.target,achievement:e.achievement,status:e.status,gapType:o.gapType,actionArchetype:o.actionArchetype,antiPattern:o.antiPattern}}),q=U.map(e=>(0,w.generateTypeSpecificLogicInstruction)(e.kpiType)).filter((e,t,i)=>i.indexOf(e)===t).join("\n"),L=U.filter(e=>"EFFICIENCY"===e.kpiCategory).map(e=>`- "${e.name}": Type is ${e.kpiType.toUpperCase()} (RATE/PERCENTAGE) - diagnose as QUALITY issue, NOT volume/pipeline issue`).join("\n"),j=null;try{let e=`[SYSTEM INSTRUCTION: FRESH START]
You are analyzing this QPRO data from scratch. Disregard all previous analyses.

CRITICAL METADATA UPDATE - KPI TYPES HAVE BEEN CORRECTED:
${L||"All KPIs are count/volume based."}

STRICT CONSTRAINTS:
1. For KPIs marked as RATE, PERCENTAGE, or EFFICIENCY type:
   - You are FORBIDDEN from diagnosing as "data collection", "pipeline", "reporting workflow", or "scale" issues
   - You MUST diagnose as "quality", "performance", "curriculum alignment", "training effectiveness", or "conversion" issues
   - Recommendations must focus on IMPROVING QUALITY, not increasing volume

2. For KPIs marked as COUNT or VOLUME type:
   - You may diagnose as scaling, capacity, or collection issues
   - Recommendations can focus on increasing volume or streamlining processes

Respond with valid JSON only.`,t=`[FRESH ANALYSIS REQUIRED - NEW KPI CLASSIFICATIONS]

**KPI Type Rules (MUST FOLLOW):**
${q}

**Summary:** ${f.toFixed(2)}% achievement across ${g.length} activities. KRAs: ${b}

**Activities with CORRECTED KPI Types:**
${U.map((e,t)=>`${t+1}. ${e.name}
   - KPI Type: ${e.kpiType.toUpperCase()} (Category: ${e.kpiCategory})
   - Values: ${e.reported}/${e.target} = ${e.achievement.toFixed(1)}%
   - Status: ${e.status}
   - Required Action Type: ${e.actionArchetype}
   ${e.antiPattern?`- FORBIDDEN: ${e.antiPattern}`:""}`).join("\n\n")}

Return JSON: {"documentInsight": "<2-3 sentence summary matching KPI types>", "prescriptiveItems": [{"title": "<action title>", "issue": "<describe issue matching KPI type>", "action": "<recommendation matching KPI type>", "nextStep": "<optional next step>"}]}

REMEMBER: For RATE/PERCENTAGE KPIs, the issue is NEVER about "collecting more data" or "scaling pipelines". It's about IMPROVING QUALITY.`,i=await d.invoke([new E.SystemMessage(e),new T.HumanMessage(t)]),a=(i.content?.toString()||"").match(/\{[\s\S]*\}/);a&&(j=JSON.parse(a[0]),console.log("[Regenerate] LLM prescriptive analysis generated with fresh KPI types"))}catch(e){console.error("[Regenerate] LLM failed, using fallback:",e)}let H=j?.prescriptiveItems||(()=>{let e=[];if(_?.name){let t=U.find(e=>e.name===_.name),i=t?.kpiType||"count",a=t?.kpiCategory||"VOLUME",n="",r="";"EFFICIENCY"===a?(n=`"${_.name}" is at ${Number(_.achievement||0).toFixed(1)}% of target. This is a ${i.toUpperCase()} KPI measuring quality/efficiency, NOT volume.`,r="Focus on improving quality of outcomes, process efficiency, curriculum alignment, or training effectiveness. Review compliance criteria and conversion rates rather than increasing volume."):"VOLUME"===a?(n=`"${_.name}" is at ${Number(_.achievement||0).toFixed(1)}% of target. This is a count-based KPI measuring volume.`,r="Scale up production capacity, increase activity frequency, or streamline collection processes to meet volume targets."):(n=`"${_.name}" is at ${Number(_.achievement||0).toFixed(1)}% of target.`,r="Conduct root cause analysis and implement targeted interventions."),e.push({title:"Address the primary performance gap",issue:n,action:r})}else e.push({title:"Address the primary performance gap",issue:"At least one KPI area remains below target, limiting overall performance.",action:"Prioritize the lowest-performing KPI and implement targeted interventions with clear owners and deadlines by the next reporting cycle."});return M?.name&&e.push({title:"Sustain and operationalize high performers",issue:`High-performing areas (e.g., "${M.name}") should be protected from regression as attention shifts to gaps.`,action:"Standardize the execution approach, document evidence artifacts, and transition outputs into ongoing utilization/operations within the next quarter.",nextStep:"Assign an owner to compile evidence and standard operating steps within 2 weeks."}),e.push({title:"KPI classification verification",issue:"Ensure KPI types are correctly classified (rate/percentage vs count) to generate appropriate recommendations.",action:"Validate that rate KPIs focus on quality/efficiency outcomes while count KPIs track volumes correctly."}),e.slice(0,3)})(),Y=H.map((e,t)=>{let i=[`${t+1}. ${e.title}`,`- Issue: ${e.issue}`,`- Action: ${e.action}`];return e.nextStep&&i.push(`- Next Step: ${e.nextStep}`),i.join("\n")}).join("\n\n"),z={documentInsight:j?.documentInsight||(()=>{let e=[];if(e.push(`The report indicates an overall achievement score of ${f.toFixed(2)}% across ${g.length} tracked activities.`),b&&e.push(`Coverage spans ${x.length} KRA(s): ${b}.`),M?.name&&e.push(`Key strengths appear in "${M.name}" (${Number(M.achievement||0).toFixed(1)}% of target).`),_?.name){let t=U.find(e=>e.name===_.name),i=t?.kpiCategory||"VOLUME";"EFFICIENCY"===i?e.push(`Performance is constrained by "${_.name}" (${Number(_.achievement||0).toFixed(1)}% of target), a rate/percentage KPI indicating a quality or conversion issue that requires process optimization, not volume scaling.`):e.push(`Performance is constrained by "${_.name}" (${Number(_.achievement||0).toFixed(1)}% of target).`)}return e.join(" ")})(),prescriptiveAnalysis:Y,prescriptiveItems:H,summary:{totalActivities:g.length,metCount:K.length,missedCount:N.length,overallAchievement:f},generatedAt:new Date().toISOString()};await $.default.qPROAnalysis.update({where:{id:r},data:{activities:g,achievementScore:f,gaps:JSON.stringify(y),alignment:O,opportunities:D,recommendations:Y,prescriptiveAnalysis:z,updatedAt:new Date}}),console.log(`[Regenerate] Invalidating cache for analysis: ${r}`);try{await S.qproCacheService.invalidateAnalysisCache(r),s.documentId&&await S.qproCacheService.invalidateAnalysisCache(s.documentId),await S.qproCacheService.invalidateProcessingStatus(r),s.uploadedById&&await S.qproCacheService.invalidateUserAnalysesCache(s.uploadedById),console.log("[Regenerate] Cache invalidation complete")}catch(e){console.error("[Regenerate] Cache invalidation error (non-fatal):",e)}return console.log(`[Regenerate] Sending response with ${p.length} activities:`),p.forEach((e,t)=>{console.log(`  [${t}] ${e.name} - Target: ${e.target}, Achievement: ${e.achievement?.toFixed(2)||"N/A"}%`)}),I.NextResponse.json({activities:p,overallAchievementScore:f,gaps:y,alignment:O,opportunities:D,recommendations:Y,prescriptiveAnalysis:z,regeneratedAt:new Date().toISOString()},{status:200,headers:{"Cache-Control":"no-store, no-cache, must-revalidate, proxy-revalidate",Pragma:"no-cache",Expires:"0"}})}catch(e){return console.error("Error regenerating insights:",e),I.NextResponse.json({error:e instanceof Error?e.message:"Failed to regenerate insights"},{status:500})}}e.s(["POST",()=>K],28036);var N=e.i(28036);let x=new t.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/qpro/regenerate-insights/route",pathname:"/api/qpro/regenerate-insights",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/qpro/regenerate-insights/route.ts",nextConfigOutput:"standalone",userland:N}),{workAsyncStorage:b,workUnitAsyncStorage:k,serverHooks:F}=x;function O(){return(0,a.patchFetch)({workAsyncStorage:b,workUnitAsyncStorage:k})}async function M(e,t,a){x.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let I="/api/qpro/regenerate-insights/route";I=I.replace(/\/index$/,"")||"/";let R=await x.prepare(e,t,{srcPage:I,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:$,params:A,nextConfig:T,parsedUrl:E,isDraftMode:P,prerenderManifest:S,routerServerContext:w,isOnDemandRevalidate:C,revalidateOnlyGenerated:K,resolvedPathname:N,clientReferenceManifest:b,serverActionsManifest:k}=R,F=(0,l.normalizeAppPath)(I),O=!!(S.dynamicRoutes[F]||S.routes[N]),M=async()=>((null==w?void 0:w.render404)?await w.render404(e,t,E,!1):t.end("This page could not be found"),null);if(O&&!P){let e=!!S.routes[N],t=S.dynamicRoutes[F];if(t&&!1===t.fallback&&!e){if(T.experimental.adapterPath)return await M();throw new f.NoFallbackError}}let _=null;!O||x.isDev||P||(_="/index"===(_=N)?"/":_);let D=!0===x.isDev||!O,U=O&&!D;k&&b&&(0,o.setReferenceManifestsSingleton)({page:I,clientReferenceManifest:b,serverActionsManifest:k,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:k})});let q=e.method||"GET",L=(0,r.getTracer)(),j=L.getActiveScopeSpan(),H={params:A,prerenderManifest:S,renderOpts:{experimental:{authInterrupts:!!T.experimental.authInterrupts},cacheComponents:!!T.cacheComponents,supportsDynamicResponse:D,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:T.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,i,a)=>x.onRequestError(e,t,a,w)},sharedContext:{buildId:$}},Y=new c.NodeNextRequest(e),z=new c.NodeNextResponse(t),B=u.NextRequestAdapter.fromNodeNextRequest(Y,(0,u.signalFromNodeResponse)(t));try{let o=async e=>x.handle(B,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let i=L.getRootSpanAttributes();if(!i)return;if(i.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${i.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=i.get("next.route");if(a){let t=`${q} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${q} ${I}`)}),s=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var r,l;let c=async({previousCacheEntry:i})=>{try{if(!s&&C&&K&&!i)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await o(n);e.fetchMetrics=H.renderOpts.fetchMetrics;let l=H.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let c=H.renderOpts.collectedTags;if(!O)return await (0,g.sendResponse)(Y,z,r,H.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(r.headers);c&&(t[v.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let i=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=v.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,a=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=v.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:i,expire:a}}}}catch(t){throw(null==i?void 0:i.isStale)&&await x.onRequestError(e,t,{routerKind:"App Router",routePath:I,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:C})},w),t}},u=await x.handleResponse({req:e,nextConfig:T,cacheKey:_,routeKind:i.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:S,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:K,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:s});if(!O)return null;if((null==u||null==(r=u.value)?void 0:r.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",C?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),P&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let d=(0,m.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&O||d.delete(v.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||d.get("Cache-Control")||d.set("Cache-Control",(0,h.getCacheControlHeader)(u.cacheControl)),await (0,g.sendResponse)(Y,z,new Response(u.value.body,{headers:d,status:u.value.status||200})),null};j?await l(j):await L.withPropagatedContext(e.headers,()=>L.trace(d.BaseServerSpan.handleRequest,{spanName:`${q} ${I}`,kind:r.SpanKind.SERVER,attributes:{"http.method":q,"http.target":e.url}},l))}catch(t){if(t instanceof f.NoFallbackError||await x.onRequestError(e,t,{routerKind:"App Router",routePath:F,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:U,isOnDemandRevalidate:C})}),O)throw t;return await (0,g.sendResponse)(Y,z,new Response(null,{status:500})),null}}e.s(["handler",()=>M,"patchFetch",()=>O,"routeModule",()=>x,"serverHooks",()=>F,"workAsyncStorage",()=>b,"workUnitAsyncStorage",()=>k],80802)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_307985ec.js.map