{"version":3,"sources":["../../../node_modules/next/dist/esm/build/templates/app-route.js","../../../app/api/qpro/regenerate-insights/route.ts"],"sourcesContent":["import { AppRouteRouteModule } from \"next/dist/esm/server/route-modules/app-route/module.compiled\";\nimport { RouteKind } from \"next/dist/esm/server/route-kind\";\nimport { patchFetch as _patchFetch } from \"next/dist/esm/server/lib/patch-fetch\";\nimport { addRequestMeta, getRequestMeta } from \"next/dist/esm/server/request-meta\";\nimport { getTracer, SpanKind } from \"next/dist/esm/server/lib/trace/tracer\";\nimport { setReferenceManifestsSingleton } from \"next/dist/esm/server/app-render/encryption-utils\";\nimport { createServerModuleMap } from \"next/dist/esm/server/app-render/action-utils\";\nimport { normalizeAppPath } from \"next/dist/esm/shared/lib/router/utils/app-paths\";\nimport { NodeNextRequest, NodeNextResponse } from \"next/dist/esm/server/base-http/node\";\nimport { NextRequestAdapter, signalFromNodeResponse } from \"next/dist/esm/server/web/spec-extension/adapters/next-request\";\nimport { BaseServerSpan } from \"next/dist/esm/server/lib/trace/constants\";\nimport { getRevalidateReason } from \"next/dist/esm/server/instrumentation/utils\";\nimport { sendResponse } from \"next/dist/esm/server/send-response\";\nimport { fromNodeOutgoingHttpHeaders, toNodeOutgoingHttpHeaders } from \"next/dist/esm/server/web/utils\";\nimport { getCacheControlHeader } from \"next/dist/esm/server/lib/cache-control\";\nimport { INFINITE_CACHE, NEXT_CACHE_TAGS_HEADER } from \"next/dist/esm/lib/constants\";\nimport { NoFallbackError } from \"next/dist/esm/shared/lib/no-fallback-error.external\";\nimport { CachedRouteKind } from \"next/dist/esm/server/response-cache\";\nimport * as userland from \"INNER_APP_ROUTE\";\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"standalone\"\nconst routeModule = new AppRouteRouteModule({\n    definition: {\n        kind: RouteKind.APP_ROUTE,\n        page: \"/api/qpro/regenerate-insights/route\",\n        pathname: \"/api/qpro/regenerate-insights\",\n        filename: \"route\",\n        bundlePath: \"\"\n    },\n    distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n    relativeProjectDir: process.env.__NEXT_RELATIVE_PROJECT_DIR || '',\n    resolvedPagePath: \"[project]/app/api/qpro/regenerate-insights/route.ts\",\n    nextConfigOutput,\n    userland\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { workAsyncStorage, workUnitAsyncStorage, serverHooks } = routeModule;\nfunction patchFetch() {\n    return _patchFetch({\n        workAsyncStorage,\n        workUnitAsyncStorage\n    });\n}\nexport { routeModule, workAsyncStorage, workUnitAsyncStorage, serverHooks, patchFetch,  };\nexport async function handler(req, res, ctx) {\n    if (routeModule.isDev) {\n        addRequestMeta(req, 'devRequestTimingInternalsEnd', process.hrtime.bigint());\n    }\n    let srcPage = \"/api/qpro/regenerate-insights/route\";\n    // turbopack doesn't normalize `/index` in the page name\n    // so we need to to process dynamic routes properly\n    // TODO: fix turbopack providing differing value from webpack\n    if (process.env.TURBOPACK) {\n        srcPage = srcPage.replace(/\\/index$/, '') || '/';\n    } else if (srcPage === '/index') {\n        // we always normalize /index specifically\n        srcPage = '/';\n    }\n    const multiZoneDraftMode = process.env.__NEXT_MULTI_ZONE_DRAFT_MODE;\n    const prepareResult = await routeModule.prepare(req, res, {\n        srcPage,\n        multiZoneDraftMode\n    });\n    if (!prepareResult) {\n        res.statusCode = 400;\n        res.end('Bad Request');\n        ctx.waitUntil == null ? void 0 : ctx.waitUntil.call(ctx, Promise.resolve());\n        return null;\n    }\n    const { buildId, params, nextConfig, parsedUrl, isDraftMode, prerenderManifest, routerServerContext, isOnDemandRevalidate, revalidateOnlyGenerated, resolvedPathname, clientReferenceManifest, serverActionsManifest } = prepareResult;\n    const normalizedSrcPage = normalizeAppPath(srcPage);\n    let isIsr = Boolean(prerenderManifest.dynamicRoutes[normalizedSrcPage] || prerenderManifest.routes[resolvedPathname]);\n    const render404 = async ()=>{\n        // TODO: should route-module itself handle rendering the 404\n        if (routerServerContext == null ? void 0 : routerServerContext.render404) {\n            await routerServerContext.render404(req, res, parsedUrl, false);\n        } else {\n            res.end('This page could not be found');\n        }\n        return null;\n    };\n    if (isIsr && !isDraftMode) {\n        const isPrerendered = Boolean(prerenderManifest.routes[resolvedPathname]);\n        const prerenderInfo = prerenderManifest.dynamicRoutes[normalizedSrcPage];\n        if (prerenderInfo) {\n            if (prerenderInfo.fallback === false && !isPrerendered) {\n                if (nextConfig.experimental.adapterPath) {\n                    return await render404();\n                }\n                throw new NoFallbackError();\n            }\n        }\n    }\n    let cacheKey = null;\n    if (isIsr && !routeModule.isDev && !isDraftMode) {\n        cacheKey = resolvedPathname;\n        // ensure /index and / is normalized to one key\n        cacheKey = cacheKey === '/index' ? '/' : cacheKey;\n    }\n    const supportsDynamicResponse = // If we're in development, we always support dynamic HTML\n    routeModule.isDev === true || // If this is not SSG or does not have static paths, then it supports\n    // dynamic HTML.\n    !isIsr;\n    // This is a revalidation request if the request is for a static\n    // page and it is not being resumed from a postponed render and\n    // it is not a dynamic RSC request then it is a revalidation\n    // request.\n    const isStaticGeneration = isIsr && !supportsDynamicResponse;\n    // Before rendering (which initializes component tree modules), we have to\n    // set the reference manifests to our global store so Server Action's\n    // encryption util can access to them at the top level of the page module.\n    if (serverActionsManifest && clientReferenceManifest) {\n        setReferenceManifestsSingleton({\n            page: srcPage,\n            clientReferenceManifest,\n            serverActionsManifest,\n            serverModuleMap: createServerModuleMap({\n                serverActionsManifest\n            })\n        });\n    }\n    const method = req.method || 'GET';\n    const tracer = getTracer();\n    const activeSpan = tracer.getActiveScopeSpan();\n    const context = {\n        params,\n        prerenderManifest,\n        renderOpts: {\n            experimental: {\n                authInterrupts: Boolean(nextConfig.experimental.authInterrupts)\n            },\n            cacheComponents: Boolean(nextConfig.cacheComponents),\n            supportsDynamicResponse,\n            incrementalCache: getRequestMeta(req, 'incrementalCache'),\n            cacheLifeProfiles: nextConfig.cacheLife,\n            waitUntil: ctx.waitUntil,\n            onClose: (cb)=>{\n                res.on('close', cb);\n            },\n            onAfterTaskError: undefined,\n            onInstrumentationRequestError: (error, _request, errorContext)=>routeModule.onRequestError(req, error, errorContext, routerServerContext)\n        },\n        sharedContext: {\n            buildId\n        }\n    };\n    const nodeNextReq = new NodeNextRequest(req);\n    const nodeNextRes = new NodeNextResponse(res);\n    const nextReq = NextRequestAdapter.fromNodeNextRequest(nodeNextReq, signalFromNodeResponse(res));\n    try {\n        const invokeRouteModule = async (span)=>{\n            return routeModule.handle(nextReq, context).finally(()=>{\n                if (!span) return;\n                span.setAttributes({\n                    'http.status_code': res.statusCode,\n                    'next.rsc': false\n                });\n                const rootSpanAttributes = tracer.getRootSpanAttributes();\n                // We were unable to get attributes, probably OTEL is not enabled\n                if (!rootSpanAttributes) {\n                    return;\n                }\n                if (rootSpanAttributes.get('next.span_type') !== BaseServerSpan.handleRequest) {\n                    console.warn(`Unexpected root span type '${rootSpanAttributes.get('next.span_type')}'. Please report this Next.js issue https://github.com/vercel/next.js`);\n                    return;\n                }\n                const route = rootSpanAttributes.get('next.route');\n                if (route) {\n                    const name = `${method} ${route}`;\n                    span.setAttributes({\n                        'next.route': route,\n                        'http.route': route,\n                        'next.span_name': name\n                    });\n                    span.updateName(name);\n                } else {\n                    span.updateName(`${method} ${srcPage}`);\n                }\n            });\n        };\n        const isMinimalMode = Boolean(process.env.MINIMAL_MODE || getRequestMeta(req, 'minimalMode'));\n        const handleResponse = async (currentSpan)=>{\n            var _cacheEntry_value;\n            const responseGenerator = async ({ previousCacheEntry })=>{\n                try {\n                    if (!isMinimalMode && isOnDemandRevalidate && revalidateOnlyGenerated && !previousCacheEntry) {\n                        res.statusCode = 404;\n                        // on-demand revalidate always sets this header\n                        res.setHeader('x-nextjs-cache', 'REVALIDATED');\n                        res.end('This page could not be found');\n                        return null;\n                    }\n                    const response = await invokeRouteModule(currentSpan);\n                    req.fetchMetrics = context.renderOpts.fetchMetrics;\n                    let pendingWaitUntil = context.renderOpts.pendingWaitUntil;\n                    // Attempt using provided waitUntil if available\n                    // if it's not we fallback to sendResponse's handling\n                    if (pendingWaitUntil) {\n                        if (ctx.waitUntil) {\n                            ctx.waitUntil(pendingWaitUntil);\n                            pendingWaitUntil = undefined;\n                        }\n                    }\n                    const cacheTags = context.renderOpts.collectedTags;\n                    // If the request is for a static response, we can cache it so long\n                    // as it's not edge.\n                    if (isIsr) {\n                        const blob = await response.blob();\n                        // Copy the headers from the response.\n                        const headers = toNodeOutgoingHttpHeaders(response.headers);\n                        if (cacheTags) {\n                            headers[NEXT_CACHE_TAGS_HEADER] = cacheTags;\n                        }\n                        if (!headers['content-type'] && blob.type) {\n                            headers['content-type'] = blob.type;\n                        }\n                        const revalidate = typeof context.renderOpts.collectedRevalidate === 'undefined' || context.renderOpts.collectedRevalidate >= INFINITE_CACHE ? false : context.renderOpts.collectedRevalidate;\n                        const expire = typeof context.renderOpts.collectedExpire === 'undefined' || context.renderOpts.collectedExpire >= INFINITE_CACHE ? undefined : context.renderOpts.collectedExpire;\n                        // Create the cache entry for the response.\n                        const cacheEntry = {\n                            value: {\n                                kind: CachedRouteKind.APP_ROUTE,\n                                status: response.status,\n                                body: Buffer.from(await blob.arrayBuffer()),\n                                headers\n                            },\n                            cacheControl: {\n                                revalidate,\n                                expire\n                            }\n                        };\n                        return cacheEntry;\n                    } else {\n                        // send response without caching if not ISR\n                        await sendResponse(nodeNextReq, nodeNextRes, response, context.renderOpts.pendingWaitUntil);\n                        return null;\n                    }\n                } catch (err) {\n                    // if this is a background revalidate we need to report\n                    // the request error here as it won't be bubbled\n                    if (previousCacheEntry == null ? void 0 : previousCacheEntry.isStale) {\n                        await routeModule.onRequestError(req, err, {\n                            routerKind: 'App Router',\n                            routePath: srcPage,\n                            routeType: 'route',\n                            revalidateReason: getRevalidateReason({\n                                isStaticGeneration,\n                                isOnDemandRevalidate\n                            })\n                        }, routerServerContext);\n                    }\n                    throw err;\n                }\n            };\n            const cacheEntry = await routeModule.handleResponse({\n                req,\n                nextConfig,\n                cacheKey,\n                routeKind: RouteKind.APP_ROUTE,\n                isFallback: false,\n                prerenderManifest,\n                isRoutePPREnabled: false,\n                isOnDemandRevalidate,\n                revalidateOnlyGenerated,\n                responseGenerator,\n                waitUntil: ctx.waitUntil,\n                isMinimalMode\n            });\n            // we don't create a cacheEntry for ISR\n            if (!isIsr) {\n                return null;\n            }\n            if ((cacheEntry == null ? void 0 : (_cacheEntry_value = cacheEntry.value) == null ? void 0 : _cacheEntry_value.kind) !== CachedRouteKind.APP_ROUTE) {\n                var _cacheEntry_value1;\n                throw Object.defineProperty(new Error(`Invariant: app-route received invalid cache entry ${cacheEntry == null ? void 0 : (_cacheEntry_value1 = cacheEntry.value) == null ? void 0 : _cacheEntry_value1.kind}`), \"__NEXT_ERROR_CODE\", {\n                    value: \"E701\",\n                    enumerable: false,\n                    configurable: true\n                });\n            }\n            if (!isMinimalMode) {\n                res.setHeader('x-nextjs-cache', isOnDemandRevalidate ? 'REVALIDATED' : cacheEntry.isMiss ? 'MISS' : cacheEntry.isStale ? 'STALE' : 'HIT');\n            }\n            // Draft mode should never be cached\n            if (isDraftMode) {\n                res.setHeader('Cache-Control', 'private, no-cache, no-store, max-age=0, must-revalidate');\n            }\n            const headers = fromNodeOutgoingHttpHeaders(cacheEntry.value.headers);\n            if (!(isMinimalMode && isIsr)) {\n                headers.delete(NEXT_CACHE_TAGS_HEADER);\n            }\n            // If cache control is already set on the response we don't\n            // override it to allow users to customize it via next.config\n            if (cacheEntry.cacheControl && !res.getHeader('Cache-Control') && !headers.get('Cache-Control')) {\n                headers.set('Cache-Control', getCacheControlHeader(cacheEntry.cacheControl));\n            }\n            await sendResponse(nodeNextReq, nodeNextRes, // @ts-expect-error - Argument of type 'Buffer<ArrayBufferLike>' is not assignable to parameter of type 'BodyInit | null | undefined'.\n            new Response(cacheEntry.value.body, {\n                headers,\n                status: cacheEntry.value.status || 200\n            }));\n            return null;\n        };\n        // TODO: activeSpan code path is for when wrapped by\n        // next-server can be removed when this is no longer used\n        if (activeSpan) {\n            await handleResponse(activeSpan);\n        } else {\n            await tracer.withPropagatedContext(req.headers, ()=>tracer.trace(BaseServerSpan.handleRequest, {\n                    spanName: `${method} ${srcPage}`,\n                    kind: SpanKind.SERVER,\n                    attributes: {\n                        'http.method': method,\n                        'http.target': req.url\n                    }\n                }, handleResponse));\n        }\n    } catch (err) {\n        if (!(err instanceof NoFallbackError)) {\n            await routeModule.onRequestError(req, err, {\n                routerKind: 'App Router',\n                routePath: normalizedSrcPage,\n                routeType: 'route',\n                revalidateReason: getRevalidateReason({\n                    isStaticGeneration,\n                    isOnDemandRevalidate\n                })\n            });\n        }\n        // rethrow so that we can handle serving error page\n        // If this is during static generation, throw the error again.\n        if (isIsr) throw err;\n        // Otherwise, send a 500 response.\n        await sendResponse(nodeNextReq, nodeNextRes, new Response(null, {\n            status: 500\n        }));\n        return null;\n    }\n}\n\n//# sourceMappingURL=app-route.js.map\n","import { NextRequest, NextResponse } from 'next/server';\r\nimport { requireAuth } from '@/lib/middleware/auth-middleware';\r\nimport prisma from '@/lib/prisma';\r\nimport { ChatOpenAI } from '@langchain/openai';\r\nimport { HumanMessage, SystemMessage } from '@langchain/core/messages';\r\nimport { computeAggregatedAchievement, getInitiativeTargetMeta, normalizeKraId } from '@/lib/utils/qpro-aggregation';\r\nimport { qproCacheService } from '@/lib/services/qpro-cache-service';\r\nimport { getKpiTypeCategory, getGapInterpretation, generateTypeSpecificLogicInstruction } from '@/lib/utils/kpi-type-logic';\r\n\r\ninterface ActivityToRegenerate {\r\n  name: string;\r\n  kraId: string;\r\n  initiativeId: string;\r\n  reported: number;\r\n  target: number;\r\n  achievement: number;\r\n  status: 'MET' | 'MISSED' | 'EXCEEDED';\r\n  index: number;\r\n  targetType?: string;\r\n  aiInsight?: string;\r\n  prescriptiveAnalysis?: string;\r\n  dataType?: string;\r\n  evidenceSnippet?: string;\r\n  confidenceScore?: number;\r\n}\r\n\r\n/**\r\n * Helper function to find the target value from strategic plan based on KRA, KPI, and year\r\n */\r\nfunction findTargetFromStrategicPlan(\r\n  strategicPlan: any,\r\n  kraId: string,\r\n  initiativeId: string,\r\n  year: number\r\n): { target: number | null; targetType: string } {\r\n  const kras = strategicPlan.kras || [];\r\n  \r\n  // Find the KRA using normalized ID for consistent lookup\r\n  const normalizedKraIdVal = normalizeKraId(kraId);\r\n  const kra = kras.find((k: any) => normalizeKraId(k.kra_id) === normalizedKraIdVal);\r\n  if (!kra) {\r\n    console.log(`[findTargetFromStrategicPlan] KRA not found: ${kraId}`);\r\n    return { target: null, targetType: 'unknown' };\r\n  }\r\n  \r\n  console.log(`[findTargetFromStrategicPlan] Found KRA: ${kraId}, looking for initiative: ${initiativeId}`);\r\n  console.log(`[findTargetFromStrategicPlan] Available initiatives:`, kra.initiatives?.map((i: any) => i.id));\r\n  \r\n  // Find the initiative/KPI within the KRA - try multiple formats\r\n  let initiative = kra.initiatives?.find((i: any) => i.id === initiativeId);\r\n  \r\n  // If not found, try alternative formats (e.g., \"KRA3-KPI5\" vs \"KRA 3-KPI5\")\r\n  if (!initiative && initiativeId) {\r\n    // Normalize the initiative ID by removing spaces\r\n    const normalizedId = initiativeId.replace(/\\s+/g, '');\r\n    initiative = kra.initiatives?.find((i: any) => \r\n      i.id.replace(/\\s+/g, '') === normalizedId\r\n    );\r\n    \r\n    // Also try matching just by KPI number if still not found\r\n    if (!initiative) {\r\n      const kpiMatch = initiativeId.match(/KPI(\\d+)/i);\r\n      if (kpiMatch) {\r\n        const kpiNumber = kpiMatch[1];\r\n        initiative = kra.initiatives?.find((i: any) => i.id.includes(`KPI${kpiNumber}`));\r\n      }\r\n    }\r\n  }\r\n  \r\n  if (!initiative || !initiative.targets) {\r\n    console.log(`[findTargetFromStrategicPlan] Initiative not found: ${initiativeId}`);\r\n    return { target: null, targetType: 'unknown' };\r\n  }\r\n  \r\n  console.log(`[findTargetFromStrategicPlan] Found initiative: ${initiative.id}`);\r\n  \r\n  const targetType = initiative.targets.type || 'percentage';\r\n  const timelineData = initiative.targets.timeline_data || [];\r\n  \r\n  // Find the target for the specific year\r\n  const yearTarget = timelineData.find((t: any) => t.year === year);\r\n  if (yearTarget && typeof yearTarget.target_value === 'number') {\r\n    console.log(`[findTargetFromStrategicPlan] Found target for year ${year}: ${yearTarget.target_value}`);\r\n    return { target: yearTarget.target_value, targetType };\r\n  }\r\n  \r\n  // If no exact year match, try to find the closest year or default\r\n  const numericTargets = timelineData.filter((t: any) => typeof t.target_value === 'number');\r\n  if (numericTargets.length > 0) {\r\n    // Get the most recent target before or on the year\r\n    const validTargets = numericTargets.filter((t: any) => t.year <= year);\r\n    if (validTargets.length > 0) {\r\n      const target = validTargets[validTargets.length - 1].target_value;\r\n      console.log(`[findTargetFromStrategicPlan] Using closest target: ${target}`);\r\n      return { target, targetType };\r\n    }\r\n    // Otherwise use the first available target\r\n    const target = numericTargets[0].target_value;\r\n    console.log(`[findTargetFromStrategicPlan] Using first available target: ${target}`);\r\n    return { target, targetType };\r\n  }\r\n  \r\n  console.log(`[findTargetFromStrategicPlan] No numeric target found for ${initiativeId}`);\r\n  return { target: null, targetType };\r\n}\r\n\r\n/**\r\n * Calculate achievement and status based on reported and target values\r\n */\r\nfunction calculateAchievementAndStatus(\r\n  reported: number,\r\n  target: number\r\n): { achievement: number; status: 'MET' | 'MISSED' | 'EXCEEDED' } {\r\n  if (target === 0) {\r\n    return { achievement: 0, status: 'MISSED' };\r\n  }\r\n  \r\n  const achievement = (reported / target) * 100;\r\n  \r\n  let status: 'MET' | 'MISSED' | 'EXCEEDED';\r\n  if (achievement >= 100) {\r\n    status = achievement > 100 ? 'EXCEEDED' : 'MET';\r\n  } else {\r\n    status = 'MISSED';\r\n  }\r\n  \r\n  return { achievement, status };\r\n}\r\n\r\n/**\r\n * Helper function to intelligently match an activity to the best KPI within a KRA\r\n * Uses LLM to analyze activity description and find the most appropriate KPI\r\n */\r\nasync function matchActivityToKPI(\r\n  llm: ChatOpenAI,\r\n  activityName: string,\r\n  activityDescription: string,\r\n  kraId: string,\r\n  kraTitle: string,\r\n  kra: any,\r\n  strategicPlan: any\r\n): Promise<{ initiativeId: string; matchedKPI: any } | null> {\r\n  try {\r\n    if (!kra || !kra.initiatives || kra.initiatives.length === 0) {\r\n      console.log(`[matchActivityToKPI] No initiatives found for KRA ${kraId}`);\r\n      return null;\r\n    }\r\n\r\n    // Build a menu of available KPIs for this KRA\r\n    const kpiMenu = kra.initiatives\r\n      .map((initiative: any, idx: number) => {\r\n        const description = initiative.description || initiative.kpi_title || '';\r\n        const targetType = initiative.targets?.type || 'numeric';\r\n        const targets = (initiative.targets?.timeline_data || [])\r\n          .slice(-2)\r\n          .map((t: any) => `Year ${t.year}: ${t.target_value}`)\r\n          .join(', ');\r\n        \r\n        return `${idx + 1}. **${initiative.id}**: ${description}\\n   Type: ${targetType}\\n   Recent targets: ${targets}`;\r\n      })\r\n      .join('\\n\\n');\r\n\r\n    const matchingPrompt = `\r\nYou are a strategic planning expert at a university. Your task is to match a reported activity to the MOST APPROPRIATE Key Performance Indicator (KPI) within a Key Result Area (KRA).\r\n\r\n**Activity Being Matched:**\r\nName: ${activityName}\r\nDescription: ${activityDescription}\r\n\r\n**Target KRA:**\r\n${kraId}: ${kraTitle}\r\n\r\n**Available KPIs within this KRA:**\r\n${kpiMenu}\r\n\r\n**Task:** \r\nAnalyze the activity name and description. Determine which KPI BEST matches this activity based on:\r\n1. Semantic similarity (does the activity description match the KPI description?)\r\n2. Metric alignment (is the reported value consistent with what this KPI measures?)\r\n3. Strategic fit (does this activity contribute to this KPI's objective?)\r\n\r\n**Response Format (JSON):**\r\n{\r\n  \"selectedKPINumber\": <number 1-${kra.initiatives.length}>,\r\n  \"selectedKPIId\": \"<KPI ID>\",\r\n  \"confidenceScore\": <0.0-1.0>,\r\n  \"reason\": \"<brief explanation of why this KPI was selected>\"\r\n}\r\n\r\nSelect the BEST matching KPI. If none are good matches, still select the closest one.`;\r\n\r\n    const messages = [\r\n      new SystemMessage('You are a university performance analyst. Respond only with valid JSON.'),\r\n      new HumanMessage(matchingPrompt),\r\n    ];\r\n\r\n    const response = await llm.invoke(messages);\r\n    const responseText = response.content?.toString() || '';\r\n\r\n    // Parse the JSON response\r\n    let matchResult;\r\n    try {\r\n      const jsonMatch = responseText.match(/\\{[\\s\\S]*\\}/);\r\n      if (jsonMatch) {\r\n        matchResult = JSON.parse(jsonMatch[0]);\r\n      } else {\r\n        throw new Error('No JSON found in response');\r\n      }\r\n    } catch (parseError) {\r\n      console.log(`[matchActivityToKPI] Failed to parse LLM response: ${responseText}`);\r\n      // Fallback: return the first KPI\r\n      return {\r\n        initiativeId: kra.initiatives[0].id,\r\n        matchedKPI: kra.initiatives[0],\r\n      };\r\n    }\r\n\r\n    const selectedIndex = (matchResult.selectedKPINumber || 1) - 1;\r\n    if (selectedIndex < 0 || selectedIndex >= kra.initiatives.length) {\r\n      console.log(`[matchActivityToKPI] Invalid index ${selectedIndex}, using first KPI`);\r\n      return {\r\n        initiativeId: kra.initiatives[0].id,\r\n        matchedKPI: kra.initiatives[0],\r\n      };\r\n    }\r\n\r\n    const matchedKPI = kra.initiatives[selectedIndex];\r\n    console.log(\r\n      `[matchActivityToKPI] Matched activity \"${activityName}\" to KPI: ${matchedKPI.id} (confidence: ${matchResult.confidenceScore})`\r\n    );\r\n    console.log(`[matchActivityToKPI] Reason: ${matchResult.reason}`);\r\n\r\n    return {\r\n      initiativeId: matchedKPI.id,\r\n      matchedKPI,\r\n    };\r\n  } catch (error) {\r\n    console.error('[matchActivityToKPI] Error during KPI matching:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n/**\r\n * POST /api/qpro/regenerate-insights\r\n *\r\n * Regenerates KPI/target/achievement for activities with corrected KRAs\r\n * This endpoint:\r\n * 1. Takes activities with updated KRAs\r\n * 2. Uses LLM to intelligently match activities to best KPI within the new KRA\r\n * 3. Looks up the correct target from strategic plan for the matched KPI\r\n * 4. Recalculates achievement and status based on new target\r\n * 5. Generates ONE document-level insight + ONE prescriptive analysis (no per-activity AI blocks)\r\n * 6. Updates all related fields and saves to database\r\n * 7. Returns regenerated activities and updated document-level fields\r\n */\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    // Authenticate user\r\n    const authResult = await requireAuth(request);\r\n    if ('status' in authResult) return authResult;\r\n\r\n    const { user } = authResult;\r\n    const { analysisId, activities } = await request.json();\r\n\r\n    if (!analysisId || !activities || !Array.isArray(activities)) {\r\n      return NextResponse.json(\r\n        { error: 'Missing analysisId or activities' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Check permissions\r\n    if (!['ADMIN', 'FACULTY'].includes(user.role)) {\r\n      return NextResponse.json(\r\n        { error: 'Insufficient permissions to regenerate insights' },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Fetch the analysis\r\n    const analysis = await prisma.qPROAnalysis.findUnique({\r\n      where: { id: analysisId },\r\n    });\r\n\r\n    if (!analysis) {\r\n      return NextResponse.json(\r\n        { error: 'Analysis not found' },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Get strategic plan for KRA context\r\n    const strategicPlanJson = require('@/lib/data/strategic_plan.json');\r\n    const allKRAs = strategicPlanJson.kras || [];\r\n    const reportYear = analysis.year || 2025;\r\n\r\n    // Initialize OpenAI LLM\r\n    const llm = new ChatOpenAI({\r\n      model: 'gpt-4o-mini',\r\n      apiKey: process.env.OPENAI_API_KEY,\r\n      temperature: 0.7,\r\n      maxTokens: 500,\r\n    });\r\n\r\n    // Regenerate KPI/target/achievement for each activity (document-level insights only)\r\n    const regeneratedActivities: ActivityToRegenerate[] = [];\r\n\r\n    for (const activity of activities) {\r\n      try {\r\n        // Find the KRA in strategic plan using normalized ID\r\n        const normalizedActivityKraId = normalizeKraId(activity.kraId);\r\n        const kra = allKRAs.find((k: any) => normalizeKraId(k.kra_id) === normalizedActivityKraId);\r\n        const kraTitle = kra?.kra_title || activity.kraId;\r\n\r\n        if (!kra) {\r\n          console.log(`[Regenerate] KRA not found: ${activity.kraId}`);\r\n          regeneratedActivities.push({\r\n            ...activity,\r\n            aiInsight: null as any,\r\n            prescriptiveAnalysis: null as any,\r\n          });\r\n          continue;\r\n        }\r\n\r\n        console.log(`[Regenerate] Processing activity: ${activity.name}`);\r\n        console.log(`[Regenerate] Original KRA: ${activity.initiativeId}, New KRA: ${activity.kraId}`);\r\n\r\n        // Check if a specific KPI/Initiative was explicitly selected by the user\r\n        const userSelectedKPI = (activity as any).userSelectedKPI === true;\r\n        let newInitiativeId = activity.initiativeId;\r\n\r\n        // If user explicitly selected a KPI, use it\r\n        if (userSelectedKPI) {\r\n          console.log(`[Regenerate] Using user-selected KPI: ${newInitiativeId}`);\r\n        } else {\r\n          // Otherwise, use LLM to match the activity to the best KPI within the selected KRA\r\n          const kpiMatch = await matchActivityToKPI(\r\n            llm,\r\n            activity.name,\r\n            activity.description || activity.name,\r\n            activity.kraId,\r\n            kraTitle,\r\n            kra,\r\n            strategicPlanJson\r\n          );\r\n\r\n          if (kpiMatch) {\r\n            newInitiativeId = kpiMatch.initiativeId;\r\n            console.log(`[Regenerate] Matched to KPI: ${newInitiativeId}`);\r\n          } else {\r\n            console.log(`[Regenerate] Could not match to KPI, using first available for KRA`);\r\n            // Fallback: use first KPI in the KRA\r\n            if (kra.initiatives && kra.initiatives.length > 0) {\r\n              newInitiativeId = kra.initiatives[0].id;\r\n            }\r\n          }\r\n        }\r\n\r\n        // Look up the correct target from the strategic plan using the matched KPI\r\n        const { target: newTarget, targetType } = findTargetFromStrategicPlan(\r\n          strategicPlanJson,\r\n          activity.kraId,\r\n          newInitiativeId,\r\n          reportYear\r\n        );\r\n\r\n        console.log(`[Regenerate] Found target for ${activity.name}: ${newTarget} (type: ${targetType})`);\r\n\r\n        // Use the new target if found, otherwise keep the original\r\n        const finalTarget = newTarget !== null ? newTarget : activity.target;\r\n        \r\n        // Recalculate achievement and status based on the new target\r\n        const { achievement: newAchievement, status: newStatus } = calculateAchievementAndStatus(\r\n          activity.reported,\r\n          finalTarget\r\n        );\r\n\r\n        console.log(`[Regenerate] Final target: ${finalTarget}, Achievement: ${newAchievement.toFixed(2)}%, Status: ${newStatus}`);\r\n\r\n        const regeneratedActivity = {\r\n          ...activity,\r\n          kraId: activity.kraId,\r\n          initiativeId: newInitiativeId,\r\n          target: finalTarget,\r\n          achievement: newAchievement,\r\n          status: newStatus,\r\n          targetType,\r\n          // Requirement: document-level only (no per-activity AI insight/prescriptive analysis)\r\n          aiInsight: null as any,\r\n          prescriptiveAnalysis: null as any,\r\n        };\r\n        console.log(`[Regenerate] Pushing activity with target:`, regeneratedActivity.target);\r\n        regeneratedActivities.push(regeneratedActivity);\r\n      } catch (activityError) {\r\n        console.error(`Error regenerating insights for activity: ${activity.name}`, activityError);\r\n        // Still include the activity but with empty insights\r\n        regeneratedActivities.push({\r\n          ...activity,\r\n          aiInsight: null as any,\r\n          prescriptiveAnalysis: null as any,\r\n        });\r\n      }\r\n    }\r\n\r\n    // Save the updated activities with new KRAs, targets, achievements, and insights to the database\r\n    const existingActivities = (analysis.activities as any[]) || [];\r\n\r\n    // Merge regenerated insights into existing activities\r\n    const updatedActivities = existingActivities.map((existingAct: any) => {\r\n      const regeneratedAct = regeneratedActivities.find(\r\n        (regen: any) => regen.name === existingAct.name || regen.index === existingAct.index\r\n      );\r\n      if (regeneratedAct) {\r\n        return {\r\n          ...existingAct,\r\n          kraId: regeneratedAct.kraId,\r\n          initiativeId: regeneratedAct.initiativeId,\r\n          target: regeneratedAct.target,\r\n          achievement: regeneratedAct.achievement,\r\n          status: regeneratedAct.status,\r\n          targetType: regeneratedAct.targetType,\r\n          // Clear any legacy per-activity insight fields\r\n          aiInsight: null,\r\n          prescriptiveAnalysis: null,\r\n        };\r\n      }\r\n      return existingAct;\r\n    });\r\n\r\n    // Recalculate overall achievement score at KPI-level (prevents averaging tiny per-item % for count KPIs)\r\n    const year = Number((analysis as any).year ?? reportYear ?? 2025);\r\n    const groups = new Map<string, { kraId: string; initiativeId: string; activities: any[] }>();\r\n    for (const act of updatedActivities) {\r\n      const kraId = String(act.kraId || '').trim();\r\n      const initiativeId = String(act.initiativeId || '').trim();\r\n      if (!kraId || !initiativeId) continue;\r\n\r\n      const key = `${kraId}::${initiativeId}`;\r\n      if (!groups.has(key)) {\r\n        groups.set(key, { kraId, initiativeId, activities: [] });\r\n      }\r\n      groups.get(key)!.activities.push(act);\r\n    }\r\n\r\n    const kpiSummaries: Array<{ totalTarget: number; totalReported: number; achievementPercent: number; isRateMetric: boolean }> = [];\r\n    for (const g of groups.values()) {\r\n      const meta = getInitiativeTargetMeta({ kras: allKRAs } as any, g.kraId, g.initiativeId, year);\r\n\r\n      const fallbackTarget = typeof g.activities?.[0]?.initiativeTarget === 'number'\r\n        ? g.activities[0].initiativeTarget\r\n        : (typeof g.activities?.[0]?.target === 'number' ? g.activities[0].target : Number(g.activities?.[0]?.target || 0));\r\n      const targetValue = meta.targetValue ?? (Number.isFinite(fallbackTarget) && fallbackTarget > 0 ? fallbackTarget : 0);\r\n\r\n      const aggregated = computeAggregatedAchievement({\r\n        targetType: meta.targetType || g.activities?.[0]?.targetType,\r\n        targetValue,\r\n        targetScope: meta.targetScope,\r\n        activities: g.activities,\r\n      });\r\n\r\n      const isRateMetric = String(meta.targetType || g.activities?.[0]?.targetType || '').toLowerCase() === 'percentage';\r\n      kpiSummaries.push({\r\n        totalTarget: aggregated.totalTarget,\r\n        totalReported: aggregated.totalReported,\r\n        achievementPercent: aggregated.achievementPercent,\r\n        isRateMetric,\r\n      });\r\n    }\r\n\r\n    const overallAchievementScore =\r\n      kpiSummaries.length > 0\r\n        ? (kpiSummaries.reduce((sum, k) => sum + (k.achievementPercent || 0), 0) / kpiSummaries.length)\r\n        : 0;\r\n\r\n    // Recalculate gaps for activities that missed their targets\r\n    const gapsData: Record<string, { target: number; actual: number; gap: number }> = {};\r\n    \r\n    for (const act of updatedActivities) {\r\n      if (act.status === 'MISSED' || (act.achievement && act.achievement < 100)) {\r\n        const gapValue = act.target - act.reported;\r\n        const gapPercentage = act.target > 0 ? ((act.target - act.reported) / act.target) * 100 : 0;\r\n        gapsData[act.name] = {\r\n          target: act.target,\r\n          actual: act.reported,\r\n          gap: gapPercentage,\r\n        };\r\n      }\r\n    }\r\n\r\n    // Add overall summary to gaps\r\n    if (kpiSummaries.length > 0) {\r\n      const allRate = kpiSummaries.every((k) => k.isRateMetric);\r\n      const overallTarget = allRate\r\n        ? (kpiSummaries.reduce((sum, k) => sum + (k.totalTarget || 0), 0) / kpiSummaries.length)\r\n        : kpiSummaries.reduce((sum, k) => sum + (k.totalTarget || 0), 0);\r\n      const overallActual = allRate\r\n        ? (kpiSummaries.reduce((sum, k) => sum + (k.totalReported || 0), 0) / kpiSummaries.length)\r\n        : kpiSummaries.reduce((sum, k) => sum + (k.totalReported || 0), 0);\r\n\r\n      const overallGap = overallTarget > 0 ? ((overallTarget - overallActual) / overallTarget) * 100 : 0;\r\n      gapsData['Overall Achievement'] = {\r\n        target: overallTarget,\r\n        actual: overallActual,\r\n        gap: overallGap,\r\n      };\r\n    }\r\n\r\n    // Generate overall alignment and opportunities text\r\n    const metActivities = updatedActivities.filter((a: any) => a.status === 'MET' || a.status === 'EXCEEDED' || (a.achievement && a.achievement >= 100));\r\n    const missedActivities = updatedActivities.filter((a: any) => a.status === 'MISSED' || (a.achievement && a.achievement < 100));\r\n    \r\n    // Collect unique KRAs\r\n    const kraIds = [...new Set(updatedActivities.map((a: any) => a.kraId))];\r\n    const kraList = kraIds.map((kraId: any) => {\r\n      const normalizedKraIdForList = normalizeKraId(kraId);\r\n      const kra = allKRAs.find((k: any) => normalizeKraId(k.kra_id) === normalizedKraIdForList);\r\n      return kra?.kra_title || kraId;\r\n    }).join(', ');\r\n\r\n    // Create document insight text (markdown-friendly) for legacy fields\r\n    const overallSummary = gapsData['Overall Achievement']\r\n      ? gapsData['Overall Achievement']\r\n      : null;\r\n    const isRateSummary = overallSummary\r\n      ? overallSummary.target <= 100 && overallSummary.actual <= 100\r\n      : false;\r\n\r\n    const alignmentText =\r\n      `### Summary\\n` +\r\n      `- Activities analyzed: ${updatedActivities.length}\\n` +\r\n      `- KRAs covered: ${kraIds.length}${kraList ? ` (${kraList})` : ''}\\n` +\r\n      `- Activities met/exceeded: ${metActivities.length}\\n` +\r\n      `- Activities missed: ${missedActivities.length}\\n` +\r\n      `- Overall achievement score: ${overallAchievementScore.toFixed(2)}%\\n` +\r\n      (overallSummary\r\n        ? (`- ${isRateSummary ? 'Average reported rate' : 'Total reported'}: ${overallSummary.actual.toFixed(2)}${isRateSummary ? '%' : ''}\\n` +\r\n           `- ${isRateSummary ? 'Target rate' : 'Total target'}: ${overallSummary.target.toFixed(2)}${isRateSummary ? '%' : ''}\\n`)\r\n        : '');\r\n\r\n    // Screenshot-style document insight paragraph (plain text, no markdown)\r\n    // Treat \"high performers\" as activities with >80% achievement.\r\n    // If none meet that threshold, do not mention strengths and do NOT generate a Sustain section.\r\n    const strongestHighPerformer = updatedActivities\r\n      .filter((a: any) => Number(a?.achievement || 0) > 80)\r\n      .slice()\r\n      .sort((a: any, b: any) => (Number(b.achievement || 0) - Number(a.achievement || 0)))[0];\r\n    const bottleneck = missedActivities\r\n      .slice()\r\n      .sort((a: any, b: any) => (Number(a.achievement || 0) - Number(b.achievement || 0)))[0];\r\n\r\n    const documentInsightPlain = (() => {\r\n      const parts: string[] = [];\r\n      parts.push(`The report indicates an overall achievement score of ${overallAchievementScore.toFixed(2)}% across ${updatedActivities.length} tracked activities.`);\r\n      if (kraList) {\r\n        parts.push(`Coverage spans ${kraIds.length} KRA(s): ${kraList}.`);\r\n      }\r\n      if (strongestHighPerformer?.name) {\r\n        parts.push(`Key strengths appear in \"${strongestHighPerformer.name}\" (${Number(strongestHighPerformer.achievement || 0).toFixed(1)}% of target).`);\r\n      }\r\n      if (bottleneck?.name) {\r\n        parts.push(`Performance is primarily constrained by \"${bottleneck.name}\", which is at ${Number(bottleneck.achievement || 0).toFixed(1)}% of target, suggesting a volume or reporting pipeline bottleneck rather than a technical output issue.`);\r\n      }\r\n      return parts.join(' ');\r\n    })();\r\n\r\n    // Create detailed opportunities text based on actual results\r\n    let opportunitiesText = '';\r\n    if (metActivities.length > 0) {\r\n      const successSummary = metActivities\r\n        .map((a: any) => `- ${a.name} (${(a.achievement || 0).toFixed(1)}% achievement)`)\r\n        .join('\\n');\r\n      opportunitiesText =\r\n        `### High-performing activities\\n` +\r\n        `${successSummary}\\n`;\r\n    }\r\n    \r\n    if (missedActivities.length > 0) {\r\n      const improvementArea = missedActivities\r\n        .map((a: any) => {\r\n          const gapPct = a.target > 0 ? ((a.target - a.reported) / a.target * 100) : 0;\r\n          const suffix = (a.target <= 100 && a.reported <= 100) ? '%' : '';\r\n          return `- ${a.name}: Target ${Number(a.target || 0).toFixed(2)}${suffix}, Reported ${Number(a.reported || 0).toFixed(2)}${suffix} (Gap ${gapPct.toFixed(1)}%)`;\r\n        })\r\n        .join('\\n');\r\n      opportunitiesText += (opportunitiesText ? '\\n\\n' : '') +\r\n        `### Improvement opportunities\\n` +\r\n        `${improvementArea}\\n`;\r\n    }\r\n\r\n    // =========================================================================\r\n    // LLM-BASED PRESCRIPTIVE ANALYSIS GENERATION\r\n    // =========================================================================\r\n    \r\n    console.log('[Regenerate] Generating fresh prescriptive analysis via LLM...');\r\n    \r\n    // Build context for LLM with KPI type information\r\n    const activitiesContext = updatedActivities.map((act: any) => {\r\n      const normalizedKraIdForType = normalizeKraId(act.kraId);\r\n      const kra = allKRAs.find((k: any) => normalizeKraId(k.kra_id) === normalizedKraIdForType);\r\n      const initiative = kra?.initiatives?.find((i: any) => i.id === act.initiativeId);\r\n      const kpiType = initiative?.targets?.type || act.targetType || 'count';\r\n      const kpiCategory = getKpiTypeCategory(kpiType);\r\n      const gapInterpretation = getGapInterpretation(kpiCategory);\r\n      \r\n      return {\r\n        name: act.name,\r\n        kraTitle: kra?.kra_title || act.kraId,\r\n        kpiId: act.initiativeId,\r\n        kpiType,\r\n        kpiCategory,\r\n        reported: act.reported,\r\n        target: act.target,\r\n        achievement: act.achievement,\r\n        status: act.status,\r\n        gapType: gapInterpretation.gapType,\r\n        actionArchetype: gapInterpretation.actionArchetype,\r\n        antiPattern: gapInterpretation.antiPattern,\r\n      };\r\n    });\r\n\r\n    // Build type-specific instructions\r\n    const typeInstructions = activitiesContext.map((act: any) => \r\n      generateTypeSpecificLogicInstruction(act.kpiType)\r\n    ).filter((v: string, i: number, a: string[]) => a.indexOf(v) === i).join('\\n');\r\n\r\n    // Build KPI type change notices for the LLM (critical for breaking old patterns)\r\n    const kpiTypeNotices = activitiesContext\r\n      .filter((act: any) => act.kpiCategory === 'EFFICIENCY')\r\n      .map((act: any) => `- \"${act.name}\": Type is ${act.kpiType.toUpperCase()} (RATE/PERCENTAGE) - diagnose as QUALITY issue, NOT volume/pipeline issue`)\r\n      .join('\\n');\r\n\r\n    // Call LLM for fresh prescriptive analysis\r\n    let llmPrescriptiveResult: { documentInsight: string; prescriptiveItems: any[] } | null = null;\r\n    \r\n    try {\r\n      // Build fresh start system message with explicit type constraints\r\n      const systemPrompt = `[SYSTEM INSTRUCTION: FRESH START]\r\nYou are analyzing this QPRO data from scratch. Disregard all previous analyses.\r\n\r\nCRITICAL METADATA UPDATE - KPI TYPES HAVE BEEN CORRECTED:\r\n${kpiTypeNotices || 'All KPIs are count/volume based.'}\r\n\r\nSTRICT CONSTRAINTS:\r\n1. For KPIs marked as RATE, PERCENTAGE, or EFFICIENCY type:\r\n   - You are FORBIDDEN from diagnosing as \"data collection\", \"pipeline\", \"reporting workflow\", or \"scale\" issues\r\n   - You MUST diagnose as \"quality\", \"performance\", \"curriculum alignment\", \"training effectiveness\", or \"conversion\" issues\r\n   - Recommendations must focus on IMPROVING QUALITY, not increasing volume\r\n\r\n2. For KPIs marked as COUNT or VOLUME type:\r\n   - You may diagnose as scaling, capacity, or collection issues\r\n   - Recommendations can focus on increasing volume or streamlining processes\r\n\r\nRespond with valid JSON only.`;\r\n\r\n      const prescriptivePrompt = `[FRESH ANALYSIS REQUIRED - NEW KPI CLASSIFICATIONS]\r\n\r\n**KPI Type Rules (MUST FOLLOW):**\r\n${typeInstructions}\r\n\r\n**Summary:** ${overallAchievementScore.toFixed(2)}% achievement across ${updatedActivities.length} activities. KRAs: ${kraList}\r\n\r\n**Activities with CORRECTED KPI Types:**\r\n${activitiesContext.map((act: any, i: number) => \r\n  `${i+1}. ${act.name}\r\n   - KPI Type: ${act.kpiType.toUpperCase()} (Category: ${act.kpiCategory})\r\n   - Values: ${act.reported}/${act.target} = ${act.achievement.toFixed(1)}%\r\n   - Status: ${act.status}\r\n   - Required Action Type: ${act.actionArchetype}\r\n   ${act.antiPattern ? `- FORBIDDEN: ${act.antiPattern}` : ''}`\r\n).join('\\n\\n')}\r\n\r\nReturn JSON: {\"documentInsight\": \"<2-3 sentence summary matching KPI types>\", \"prescriptiveItems\": [{\"title\": \"<action title>\", \"issue\": \"<describe issue matching KPI type>\", \"action\": \"<recommendation matching KPI type>\", \"nextStep\": \"<optional next step>\"}]}\r\n\r\nREMEMBER: For RATE/PERCENTAGE KPIs, the issue is NEVER about \"collecting more data\" or \"scaling pipelines\". It's about IMPROVING QUALITY.`;\r\n\r\n      const llmResponse = await llm.invoke([\r\n        new SystemMessage(systemPrompt),\r\n        new HumanMessage(prescriptivePrompt),\r\n      ]);\r\n      \r\n      const jsonMatch = (llmResponse.content?.toString() || '').match(/\\{[\\s\\S]*\\}/);\r\n      if (jsonMatch) {\r\n        llmPrescriptiveResult = JSON.parse(jsonMatch[0]);\r\n        console.log('[Regenerate] LLM prescriptive analysis generated with fresh KPI types');\r\n      }\r\n    } catch (llmError) {\r\n      console.error('[Regenerate] LLM failed, using fallback:', llmError);\r\n    }\r\n\r\n    // Fallback or use LLM result - now type-aware based on KPI classification\r\n    const prescriptiveItems = llmPrescriptiveResult?.prescriptiveItems || (() => {\r\n      const items: Array<{ title: string; issue: string; action: string; nextStep?: string }> = [];\r\n      if (bottleneck?.name) {\r\n        // Get the KPI type for the bottleneck to generate type-appropriate recommendations\r\n        const bottleneckContext = activitiesContext.find((a: any) => a.name === bottleneck.name);\r\n        const bottleneckKpiType = bottleneckContext?.kpiType || 'count';\r\n        const bottleneckCategory = bottleneckContext?.kpiCategory || 'VOLUME';\r\n        \r\n        let issueDescription = '';\r\n        let actionRecommendation = '';\r\n        \r\n        if (bottleneckCategory === 'EFFICIENCY') {\r\n          // Rate/percentage KPIs: QUALITY focus, NOT volume/pipeline\r\n          issueDescription = `\"${bottleneck.name}\" is at ${Number(bottleneck.achievement || 0).toFixed(1)}% of target. This is a ${bottleneckKpiType.toUpperCase()} KPI measuring quality/efficiency, NOT volume.`;\r\n          actionRecommendation = 'Focus on improving quality of outcomes, process efficiency, curriculum alignment, or training effectiveness. Review compliance criteria and conversion rates rather than increasing volume.';\r\n        } else if (bottleneckCategory === 'VOLUME') {\r\n          issueDescription = `\"${bottleneck.name}\" is at ${Number(bottleneck.achievement || 0).toFixed(1)}% of target. This is a count-based KPI measuring volume.`;\r\n          actionRecommendation = 'Scale up production capacity, increase activity frequency, or streamline collection processes to meet volume targets.';\r\n        } else {\r\n          issueDescription = `\"${bottleneck.name}\" is at ${Number(bottleneck.achievement || 0).toFixed(1)}% of target.`;\r\n          actionRecommendation = 'Conduct root cause analysis and implement targeted interventions.';\r\n        }\r\n        \r\n        items.push({\r\n          title: 'Address the primary performance gap',\r\n          issue: issueDescription,\r\n          action: actionRecommendation,\r\n        });\r\n      } else {\r\n        items.push({\r\n          title: 'Address the primary performance gap',\r\n          issue: 'At least one KPI area remains below target, limiting overall performance.',\r\n          action: 'Prioritize the lowest-performing KPI and implement targeted interventions with clear owners and deadlines by the next reporting cycle.',\r\n        });\r\n      }\r\n\r\n      // Only add Sustain when there is actually a high-performing activity.\r\n      if (strongestHighPerformer?.name) {\r\n        items.push({\r\n          title: 'Sustain and operationalize high performers',\r\n          issue: `High-performing areas (e.g., \"${strongestHighPerformer.name}\") should be protected from regression as attention shifts to gaps.`,\r\n          action: 'Standardize the execution approach, document evidence artifacts, and transition outputs into ongoing utilization/operations within the next quarter.',\r\n          nextStep: 'Assign an owner to compile evidence and standard operating steps within 2 weeks.',\r\n        });\r\n      }\r\n\r\n      items.push({\r\n        title: 'KPI classification verification',\r\n        issue: 'Ensure KPI types are correctly classified (rate/percentage vs count) to generate appropriate recommendations.',\r\n        action: 'Validate that rate KPIs focus on quality/efficiency outcomes while count KPIs track volumes correctly.',\r\n      });\r\n\r\n      // If no high performers exist, we intentionally return only 2 items.\r\n      return items.slice(0, 3);\r\n    })();\r\n\r\n    const prescriptiveTextFormatted = prescriptiveItems\r\n      .map((x, idx) => {\r\n        const lines = [\r\n          `${idx + 1}. ${x.title}`,\r\n          `- Issue: ${x.issue}`,\r\n          `- Action: ${x.action}`,\r\n        ];\r\n        if (x.nextStep) lines.push(`- Next Step: ${x.nextStep}`);\r\n        return lines.join('\\n');\r\n      })\r\n      .join('\\n\\n');\r\n\r\n    // Build document-level prescriptive analysis JSON for database\r\n    // Use LLM-generated insight or create type-aware fallback\r\n    const typeAwareDocumentInsight = llmPrescriptiveResult?.documentInsight || (() => {\r\n      const parts: string[] = [];\r\n      parts.push(`The report indicates an overall achievement score of ${overallAchievementScore.toFixed(2)}% across ${updatedActivities.length} tracked activities.`);\r\n      if (kraList) {\r\n        parts.push(`Coverage spans ${kraIds.length} KRA(s): ${kraList}.`);\r\n      }\r\n      if (strongestHighPerformer?.name) {\r\n        parts.push(`Key strengths appear in \"${strongestHighPerformer.name}\" (${Number(strongestHighPerformer.achievement || 0).toFixed(1)}% of target).`);\r\n      }\r\n      if (bottleneck?.name) {\r\n        const bottleneckContext = activitiesContext.find((a: any) => a.name === bottleneck.name);\r\n        const bottleneckCategory = bottleneckContext?.kpiCategory || 'VOLUME';\r\n        \r\n        if (bottleneckCategory === 'EFFICIENCY') {\r\n          parts.push(`Performance is constrained by \"${bottleneck.name}\" (${Number(bottleneck.achievement || 0).toFixed(1)}% of target), a rate/percentage KPI indicating a quality or conversion issue that requires process optimization, not volume scaling.`);\r\n        } else {\r\n          parts.push(`Performance is constrained by \"${bottleneck.name}\" (${Number(bottleneck.achievement || 0).toFixed(1)}% of target).`);\r\n        }\r\n      }\r\n      return parts.join(' ');\r\n    })();\r\n\r\n    const prescriptiveAnalysisData = {\r\n      documentInsight: typeAwareDocumentInsight,\r\n      prescriptiveAnalysis: prescriptiveTextFormatted,\r\n      prescriptiveItems,\r\n      summary: {\r\n        totalActivities: updatedActivities.length,\r\n        metCount: metActivities.length,\r\n        missedCount: missedActivities.length,\r\n        overallAchievement: overallAchievementScore,\r\n      },\r\n      generatedAt: new Date().toISOString(),\r\n    };\r\n\r\n    // Update the analysis in the database\r\n    await prisma.qPROAnalysis.update({\r\n      where: { id: analysisId },\r\n      data: {\r\n        activities: updatedActivities,\r\n        achievementScore: overallAchievementScore,\r\n        gaps: JSON.stringify(gapsData),\r\n        alignment: alignmentText,\r\n        opportunities: opportunitiesText,\r\n        recommendations: prescriptiveTextFormatted,\r\n        prescriptiveAnalysis: prescriptiveAnalysisData,\r\n        updatedAt: new Date(),\r\n      },\r\n    });\r\n\r\n    // CRITICAL: Invalidate all cached data for this analysis to ensure fresh data on next fetch\r\n    // This fixes the stale data issue when user corrects KPI/KRA classifications\r\n    console.log(`[Regenerate] Invalidating cache for analysis: ${analysisId}`);\r\n    try {\r\n      // Invalidate analysis cache by analysisId\r\n      await qproCacheService.invalidateAnalysisCache(analysisId);\r\n      // Also invalidate by documentId if we have it\r\n      if (analysis.documentId) {\r\n        await qproCacheService.invalidateAnalysisCache(analysis.documentId);\r\n      }\r\n      // Invalidate processing status\r\n      await qproCacheService.invalidateProcessingStatus(analysisId);\r\n      // Invalidate the uploader's user cache so their analyses list refreshes\r\n      if (analysis.uploadedById) {\r\n        await qproCacheService.invalidateUserAnalysesCache(analysis.uploadedById);\r\n      }\r\n      console.log(`[Regenerate] Cache invalidation complete`);\r\n    } catch (cacheError) {\r\n      // Log but don't fail the request if cache invalidation fails\r\n      console.error('[Regenerate] Cache invalidation error (non-fatal):', cacheError);\r\n    }\r\n\r\n    // Log final response before sending\r\n    console.log(`[Regenerate] Sending response with ${regeneratedActivities.length} activities:`);\r\n    regeneratedActivities.forEach((act: any, idx: number) => {\r\n      console.log(`  [${idx}] ${act.name} - Target: ${act.target}, Achievement: ${act.achievement?.toFixed(2) || 'N/A'}%`);\r\n    });\r\n\r\n    return NextResponse.json({ \r\n      activities: regeneratedActivities,\r\n      overallAchievementScore,\r\n      gaps: gapsData,\r\n      alignment: alignmentText,\r\n      opportunities: opportunitiesText,\r\n      recommendations: prescriptiveTextFormatted,\r\n      prescriptiveAnalysis: prescriptiveAnalysisData,\r\n      // Include timestamp to help frontend detect fresh data\r\n      regeneratedAt: new Date().toISOString(),\r\n    }, { \r\n      status: 200,\r\n      headers: {\r\n        'Cache-Control': 'no-store, no-cache, must-revalidate, proxy-revalidate',\r\n        'Pragma': 'no-cache',\r\n        'Expires': '0',\r\n      },\r\n    });\r\n  } catch (error) {\r\n    console.error('Error regenerating insights:', error);\r\n    return NextResponse.json(\r\n      {\r\n        error: error instanceof Error ? error.message : 'Failed to regenerate insights',\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"uCAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,CAAA,CAAA,OAAA,IAAA,EAAA,EAAA,CAAA,CAAA,KCjBA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,CAAA,CAAA,OAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,CAAA,CAAA,OAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OAAA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OACA,EAAA,EAAA,CAAA,CAAA,OA8HA,eAAe,EACb,CAAe,CACf,CAAoB,CACpB,CAA2B,CAC3B,CAAa,CACb,CAAgB,CAChB,CAAQ,CACR,CAAkB,EAElB,GAAI,KA0DE,EAzDJ,GAAI,CAAC,GAAO,CAAC,EAAI,WAAW,EAA+B,GAAG,CAA9B,EAAI,WAAW,CAAC,MAAM,CAEpD,OADA,QAAQ,GAAG,CAAC,CAAC,kDAAkD,EAAE,EAAA,CAAO,EACjE,KAIT,IAAM,EAAU,EAAI,WAAW,CAC5B,GAAG,CAAC,CAAC,EAAiB,KACrB,IAAM,EAAc,EAAW,WAAW,EAAI,EAAW,SAAS,EAAI,GAChE,EAAa,EAAW,OAAO,EAAE,MAAQ,UACzC,EAAU,CAAC,EAAW,OAAO,EAAE,eAAiB,EAAA,AAAE,EACrD,KAAK,CAAC,CAAC,GACP,GAAG,CAAC,AAAC,GAAW,CAAC,KAAK,EAAE,EAAE,IAAI,CAAC,EAAE,EAAE,EAAE,YAAY,CAAA,CAAE,EACnD,IAAI,CAAC,MAER,MAAO,CAAA,EAAG,EAAM,EAAE,IAAI,EAAE,EAAW,EAAE,CAAC,IAAI,EAAE,YAAY;AAAA,SAAW,EAAE,WAAW;AAAA,mBAAqB,EAAE,EAAA,CAAS,AAClH,GACC,IAAI,CAAC,QAEF,EAAiB,CAAC;;;;MAItB,EAAE,aAAa;aACR,EAAE,oBAAoB;;;AAGnC,EAAE,EAAM,EAAE,EAAE,SAAS;;;AAGrB,EAAE,QAAQ;;;;;;;;;;iCAUuB,EAAE,EAAI,WAAW,CAAC,MAAM,CAAC;;;;;;qFAM2B,CAAC,CAE5E,EAAW,CACf,IAAI,EAAA,aAAa,CAAC,2EAClB,IAAI,EAAA,YAAY,CAAC,GAClB,CAEK,EAAW,MAAM,EAAI,MAAM,CAAC,GAC5B,EAAe,EAAS,OAAO,EAAE,YAAc,GAIrD,GAAI,CACF,IAAM,EAAY,EAAa,KAAK,CAAC,eACrC,GAAI,EACF,EAAc,KAAK,EADN,GACW,CAAC,CAAS,CAAC,EAAE,OAErC,MAAM,AAAI,MAAM,4BAEpB,CAAE,MAAO,EAAY,CAGnB,OAFA,QAAQ,GAAG,CAAC,CAAC,mDAAmD,EAAE,EAAA,CAAc,EAEzE,CACL,aAAc,EAAI,WAAW,CAAC,EAAE,CAAC,EAAE,CACnC,WAAY,EAAI,WAAW,CAAC,EAAE,AAChC,CACF,CAEA,IAAM,EAAgB,CAAC,EAAY,iBAAiB,GAAI,CAAC,CAAI,EAC7D,GAAI,EAAgB,GAAK,GAAiB,EAAI,WAAW,CAAC,MAAM,CAE9D,CAFgE,MAChE,QAAQ,GAAG,CAAC,CAAC,mCAAmC,EAAE,EAAc,iBAAiB,CAAC,EAC3E,CACL,aAAc,EAAI,WAAW,CAAC,EAAE,CAAC,EAAE,CACnC,WAAY,EAAI,WAAW,CAAC,EAAE,AAChC,EAGF,IAAM,EAAa,EAAI,WAAW,CAAC,EAAc,CAMjD,OALA,QAAQ,GAAG,CACT,CAAC,uCAAuC,EAAE,EAAa,UAAU,EAAE,EAAW,EAAE,CAAC,cAAc,EAAE,EAAY,eAAe,CAAC,CAAC,CAAC,EAEjI,QAAQ,GAAG,CAAC,CAAC,6BAA6B,EAAE,EAAY,MAAM,CAAA,CAAE,EAEzD,CACL,aAAc,EAAW,EAAE,YAC3B,CACF,CACF,CAAE,MAAO,EAAO,CAEd,OADA,QAAQ,KAAK,CAAC,kDAAmD,GAC1D,IACT,CACF,CAeO,eAAe,EAAK,CAAoB,EAC7C,GAAI,CAEF,IAqSQ,EArSF,EAAa,MAAM,CAAA,EAAA,EAAA,WAAA,AAAW,EAAC,GACrC,GAAI,WAAY,EAAY,OAAO,EAEnC,GAAM,MAAE,CAAI,CAAE,CAAG,EACX,YAAE,CAAU,YAAE,CAAU,CAAE,CAAG,MAAM,EAAQ,IAAI,GAErD,GAAI,CAAC,GAAc,CAAC,GAAc,CAAC,MAAM,OAAO,CAAC,GAC/C,OAAO,EAAA,CADqD,WACzC,CAAC,IAAI,CACtB,CAAE,MAAO,kCAAmC,EAC5C,CAAE,OAAQ,GAAI,GAKlB,GAAI,CAAC,CAAC,QAAS,UAAU,CAAC,QAAQ,CAAC,EAAK,IAAI,EAC1C,CAD6C,MACtC,EAAA,YAAY,CAAC,IAAI,CACtB,CAAE,MAAO,iDAAkD,EAC3D,CAAE,OAAQ,GAAI,GAKlB,IAAM,EAAW,MAAM,EAAA,OAAM,CAAC,YAAY,CAAC,UAAU,CAAC,CACpD,MAAO,CAAE,GAAI,CAAW,CAC1B,GAEA,GAAI,CAAC,EACH,OAAO,CADM,CACN,YAAY,CAAC,IAAI,CACtB,CAAE,MAAO,oBAAqB,EAC9B,CAAE,OAAQ,GAAI,GAKlB,IAAM,EAAA,EAAA,CAAA,CAAA,OACA,EAAU,EAAkB,IAAI,EAAI,EAAE,CACtC,EAAa,EAAS,IAAI,EAAI,KAG9B,EAAM,IAAI,EAAA,UAAU,CAAC,CACzB,MAAO,cACP,OAAQ,QAAQ,GAAG,CAAC,cAAc,CAClC,YAAa,GACb,UAAW,GACb,GAGM,EAAgD,EAAE,CAExD,IAAK,IAAM,KAAY,EACrB,GAAI,CAEF,IAAM,CAHyB,CAGC,CAAA,EAAA,EAAA,cAAc,AAAd,EAAe,EAAS,KAAK,EACvD,EAAM,EAAQ,IAAI,CAAC,AAAC,GAAW,CAAA,EAAA,EAAA,cAAA,EAAe,EAAE,MAAM,IAAM,GAC5D,EAAW,GAAK,WAAa,EAAS,KAAK,CAEjD,GAAI,CAAC,EAAK,CACR,QAAQ,GAAG,CAAC,CAAC,4BAA4B,EAAE,EAAS,KAAK,CAAA,CAAE,EAC3D,EAAsB,IAAI,CAAC,CACzB,GAAG,CAAQ,CACX,UAAW,KACX,qBAAsB,IACxB,GACA,QACF,CAEA,QAAQ,GAAG,CAAC,CAAC,kCAAkC,EAAE,EAAS,IAAI,CAAA,CAAE,EAChE,QAAQ,GAAG,CAAC,CAAC,2BAA2B,EAAE,EAAS,YAAY,CAAC,WAAW,EAAE,EAAS,KAAK,CAAA,CAAE,EAG7F,IAAM,GAAwD,IAArC,EAAiB,eAAe,CACrD,EAAkB,EAAS,YAAY,CAG3C,GAAI,EACF,QAAQ,GAAG,CAAC,CAAC,EADM,oCACgC,EAAE,EAAA,CAAiB,MACjE,CAEL,IAAM,EAAW,MAAM,EACrB,EACA,EAAS,IAAI,CACb,EAAS,WAAW,EAAI,EAAS,IAAI,CACrC,EAAS,KAAK,CACd,EACA,EACA,GAGE,GACF,EAAkB,EAAS,GADf,SAC2B,CACvC,QAAQ,GAAG,CAAC,CAAC,6BAA6B,EAAE,EAAA,CAAiB,IAE7D,QAAQ,GAAG,CAAC,CAAC,kEAAkE,CAAC,EAE5E,EAAI,WAAW,EAAI,EAAI,WAAW,CAAC,MAAM,CAAG,GAAG,CACjD,EAAkB,EAAI,WAAW,CAAC,EAAE,CAAC,EAAA,AAAE,EAG7C,CAGA,GAAM,CAAE,OAAQ,CAAS,YAAE,CAAU,CAAE,CA1U/C,AA0UkD,SA1UzC,AACP,CAAkB,CAClB,CAAa,CACb,CAAoB,CACpB,CAAY,EAEZ,IAAM,EAAO,EAAc,IAAI,EAAI,EAAE,CAG/B,EAAqB,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,GACpC,EAAM,EAAK,IAAI,CAAE,AAAD,GAAY,CAAA,EAAA,EAAA,cAAA,EAAe,EAAE,MAAM,IAAM,GAC/D,GAAI,CAAC,EAEH,GAFQ,IACR,QAAQ,GAAG,CAAC,CAAC,6CAA6C,EAAE,EAAA,CAAO,EAC5D,CAAE,OAAQ,KAAM,WAAY,SAAU,EAG/C,QAAQ,GAAG,CAAC,CAAC,yCAAyC,EAAE,EAAM,0BAA0B,EAAE,EAAA,CAAc,EACxG,QAAQ,GAAG,CAAC,CAAC,oDAAoD,CAAC,CAAE,EAAI,WAAW,EAAE,IAAI,AAAC,GAAW,EAAE,EAAE,GAGzG,IAAI,EAAa,EAAI,WAAW,EAAE,KAAK,AAAC,GAAW,EAAE,EAAE,GAAK,GAG5D,GAAI,CAAC,GAAc,EAAc,CAE/B,IAAM,EAAe,EAAa,OAAO,CAAC,OAAQ,IAMlD,GAAI,CAAC,CALL,EAAa,EAAI,WAAW,EAAE,KAAK,AAAC,GAClC,EAAE,EAAE,CAAC,OAAO,CAAC,OAAQ,MAAQ,EAAA,EAId,CACf,IAAM,EAAW,EAAa,KAAK,CAAC,aACpC,GAAI,EAAU,CACZ,IAAM,EAAY,CAAQ,CAAC,EAAE,CAC7B,EAAa,EAAI,WAAW,EAAE,KAAK,AAAC,GAAW,EAAE,EAAE,CAAC,QAAQ,CAAC,CAAC,GAAG,EAAE,EAAA,CAAW,EAChF,CACF,CACF,CAEA,GAAI,CAAC,GAAc,CAAC,EAAW,OAAO,CAEpC,CAFsC,MACtC,QAAQ,GAAG,CAAC,CAAC,oDAAoD,EAAE,EAAA,CAAc,EAC1E,CAAE,OAAQ,KAAM,WAAY,SAAU,EAG/C,QAAQ,GAAG,CAAC,CAAC,gDAAgD,EAAE,EAAW,EAAE,CAAA,CAAE,EAE9E,IAAM,EAAa,EAAW,OAAO,CAAC,IAAI,EAAI,aACxC,EAAe,EAAW,OAAO,CAAC,aAAa,EAAI,EAAE,CAGrD,EAAa,EAAa,IAAI,CAAC,AAAC,GAAW,EAAE,IAAI,GAAK,GAC5D,GAAI,GAAiD,UAAnC,AAA6C,OAAtC,EAAW,YAAY,CAE9C,OADA,QAAQ,GAAG,CAAC,CAAC,oDAAoD,EAAE,EAAK,EAAE,EAAE,EAAW,YAAY,CAAA,CAAE,EAC9F,CAAE,OAAQ,EAAW,YAAY,YAAE,CAAW,EAIvD,IAAM,EAAiB,EAAa,MAAM,CAAC,AAAC,GAAW,AAA0B,iBAAnB,EAAE,YAAY,EAC5E,GAAI,EAAe,MAAM,CAAG,EAAG,CAE7B,IAAM,EAAe,EAAe,MAAM,CAAC,AAAC,GAAW,EAAE,IAAI,EAAI,GACjE,GAAI,EAAa,MAAM,CAAG,EAAG,CAC3B,IAAM,EAAS,CAAY,CAAC,EAAa,MAAM,CAAG,EAAE,CAAC,YAAY,CAEjE,OADA,QAAQ,GAAG,CAAC,CAAC,oDAAoD,EAAE,EAAA,CAAQ,EACpE,CAAE,oBAAQ,CAAW,CAC9B,CAEA,IAAM,EAAS,CAAc,CAAC,EAAE,CAAC,YAAY,CAE7C,OADA,QAAQ,GAAG,CAAC,CAAC,4DAA4D,EAAE,EAAA,CAAQ,EAC5E,QAAE,aAAQ,CAAW,CAC9B,CAGA,OADA,QAAQ,GAAG,CAAC,CAAC,0DAA0D,EAAE,EAAA,CAAc,EAChF,CAAE,OAAQ,gBAAM,CAAW,CACpC,EAgQU,EACA,EAAS,KAAK,CACd,EACA,GAGF,QAAQ,GAAG,CAAC,CAAC,8BAA8B,EAAE,EAAS,IAAI,CAAC,EAAE,EAAE,EAAU,QAAQ,EAAE,EAAW,CAAC,CAAC,EAGhG,IAAM,EAA4B,OAAd,EAAqB,EAAY,EAAS,MAAM,CAG9D,CAAE,YAAa,CAAc,CAAE,OAAQ,CAAS,CAAE,CAvQhE,AAuQmE,SAvQ1D,AACP,CAAgB,CAChB,CAAc,MAQV,EANJ,GAAe,GAAG,CAAd,EACF,MAAO,CAAE,YAAa,EAAG,OAAQ,QAAS,EAG5C,IAAM,EAAe,EAAW,EAAU,IAS1C,OALE,EADE,GAAe,IACR,CADa,CACC,IAAM,WAAa,MAEjC,SAGJ,aAAE,SAAa,CAAO,CAC/B,EAsPU,EAAS,QAAQ,CACjB,GAGF,QAAQ,GAAG,CAAC,CAAC,2BAA2B,EAAE,EAAY,eAAe,EAAE,EAAe,OAAO,CAAC,GAAG,WAAW,EAAE,EAAA,CAAW,EAEzH,IAAM,EAAsB,CAC1B,GAAG,CAAQ,CACX,MAAO,EAAS,KAAK,CACrB,aAAc,EACd,OAAQ,EACR,YAAa,EACb,OAAQ,EACR,aAEA,UAAW,KACX,qBAAsB,IACxB,EACA,QAAQ,GAAG,CAAC,CAAC,0CAA0C,CAAC,CAAE,EAAoB,MAAM,EACpF,EAAsB,IAAI,CAAC,EAC7B,CAAE,MAAO,EAAe,CACtB,QAAQ,KAAK,CAAC,CAAC,0CAA0C,EAAE,EAAS,IAAI,CAAA,CAAE,CAAE,GAE5E,EAAsB,IAAI,CAAC,CACzB,GAAG,CAAQ,CACX,UAAW,KACX,qBAAsB,IACxB,EACF,CAOF,IAAM,EAHqB,AAGD,GAHW,UAAU,EAAc,EAAE,AAAF,EAGhB,GAAG,CAAC,AAAC,IAChD,IAAM,EAAiB,EAAsB,IAAI,CAC/C,AAAC,GAAe,EAAM,IAAI,GAAK,EAAY,IAAI,EAAI,EAAM,KAAK,GAAK,EAAY,KAAK,SAEtF,AAAI,EACK,CACL,GAAG,CAAW,CACd,MAAO,EAAe,AAHN,KAGW,CAC3B,aAAc,EAAe,YAAY,CACzC,OAAQ,EAAe,MAAM,CAC7B,YAAa,EAAe,WAAW,CACvC,OAAQ,EAAe,MAAM,CAC7B,WAAY,EAAe,UAAU,CAErC,UAAW,KACX,qBAAsB,IACxB,EAEK,CACT,GAGM,EAAO,OAAQ,EAAiB,IAAI,EAAI,GAAc,MACtD,EAAS,IAAI,IACnB,IAAK,IAAM,KAAO,EAAmB,CACnC,IAAM,EAAQ,OAAO,EAAI,KAAK,EAAI,IAAI,IAAI,GACpC,EAAe,OAAO,EAAI,YAAY,EAAI,IAAI,IAAI,GACxD,GAAI,CAAC,GAAS,CAAC,EAAc,SAE7B,IAAM,EAAM,CAAA,EAAG,EAAM,EAAE,EAAE,EAAA,CACrB,AADmC,CAClC,EAAO,GAAG,CAAC,IACd,EADoB,AACb,GAAG,CAAC,EAAK,OAAE,eAAO,EAAc,WAAY,EAAE,AAAC,GAExD,EAAO,GAAG,CAAC,GAAM,UAAU,CAAC,IAAI,CAAC,EACnC,CAEA,IAAM,EAAyH,EAAE,CACjI,IAAK,IAAM,KAAK,EAAO,MAAM,GAAI,CAC/B,IAAM,EAAO,CAAA,EAAA,EAAA,uBAAuB,AAAvB,EAAwB,CAAE,KAAM,CAAQ,EAAU,EAAE,KAAK,CAAE,EAAE,YAAY,CAAE,GAElF,EAAgE,UAA/C,OAAO,EAAE,UAAU,EAAE,CAAC,EAAE,EAAE,iBAC7C,EAAE,UAAU,CAAC,EAAE,CAAC,gBAAgB,CACM,UAArC,OAAO,EAAE,UAAU,EAAE,CAAC,EAAE,EAAE,OAAsB,EAAE,UAAU,CAAC,EAAE,CAAC,MAAM,CAAG,OAAO,EAAE,UAAU,EAAE,CAAC,EAAE,EAAE,QAAU,GAC5G,EAAc,EAAK,WAAW,GAAK,CAAD,MAAQ,QAAQ,CAAC,IAAmB,EAAiB,EAAI,GAAiB,CAAC,CAE7G,EAAa,CAAA,EAAA,EAAA,4BAAA,AAA4B,EAAC,CAC9C,WAAY,EAAK,UAAU,EAAI,EAAE,UAAU,EAAE,CAAC,EAAE,EAAE,uBAClD,EACA,YAAa,EAAK,WAAW,CAC7B,WAAY,EAAE,UAAU,AAC1B,GAEM,EAAe,AAAiF,sBAA1E,EAAK,UAAU,EAAI,EAAE,UAAU,EAAE,CAAC,EAAE,EAAE,YAAc,IAAI,WAAW,GAC/F,EAAa,IAAI,CAAC,CAChB,YAAa,EAAW,WAAW,CACnC,cAAe,EAAW,aAAa,CACvC,mBAAoB,EAAW,kBAAkB,cACjD,CACF,EACF,CAEA,IAAM,EACJ,EAAa,MAAM,CAAG,EACjB,EAAa,MAAM,CAAC,CAAC,EAAK,IAAM,GAAO,EAAE,CAAH,iBAAqB,GAAI,CAAC,CAAG,GAAK,EAAa,MAAM,CAC5F,EAGA,EAA4E,CAAC,EAEnF,IAAK,IAAM,KAAO,EAChB,GAAmB,WAAf,EAD+B,AAC3B,MAAM,EAAkB,EAAI,WAAW,EAAI,EAAI,WAAW,CAAG,IAAM,CACxD,EAAI,MAAM,CAAG,EAAI,QAAQ,CAC1C,IAAM,EAAgB,EAAI,MAAM,CAAG,EAAK,CAAC,EAAI,MAAM,CAAG,EAAI,QAAA,AAAQ,EAAI,EAAI,MAAM,CAAI,IAAM,EAC1F,CAAQ,CAAC,EAAI,IAAI,CAAC,CAAG,CACnB,OAAQ,EAAI,MAAM,CAClB,OAAQ,EAAI,QAAQ,CACpB,IAAK,CACP,CACF,CAIF,GAAI,EAAa,MAAM,CAAG,EAAG,CAC3B,IAAM,EAAU,EAAa,KAAK,CAAC,AAAC,GAAM,EAAE,YAAY,EAClD,EAAgB,EACjB,EAAa,MAAM,CAAC,CAAC,EAAK,IAAM,GAAO,EAAE,CAAH,UAAc,GAAI,CAAC,CAAG,GAAK,EAAa,MAAM,CACrF,EAAa,MAAM,CAAC,CAAC,EAAK,IAAM,EAAO,GAAE,CAAH,UAAc,GAAI,CAAC,CAAG,GAC1D,EAAgB,EACjB,EAAa,MAAM,CAAC,CAAC,EAAK,IAAM,GAAO,EAAE,CAAH,YAAgB,GAAI,CAAC,CAAG,GAAK,EAAa,MAAM,CACvF,EAAa,MAAM,CAAC,CAAC,EAAK,IAAM,EAAO,GAAE,CAAH,YAAgB,GAAI,CAAC,CAAG,GAGlE,CAAQ,CAAC,sBAAsB,CAAG,CAChC,OAAQ,EACR,OAAQ,EACR,IAJiB,CAIZ,CAJ4B,EAAK,CAAC,EAAgB,CAAA,CAAa,CAAI,EAAiB,IAAM,CAKjG,CACF,CAGA,IAAM,EAAgB,EAAkB,MAAM,CAAC,AAAC,GAAwB,QAAb,EAAE,MAAM,EAA2B,aAAb,EAAE,MAAM,EAAoB,EAAE,WAAW,EAAI,EAAE,WAAW,EAAI,KACzI,EAAmB,EAAkB,MAAM,CAAC,AAAC,GAAwB,WAAb,EAAE,MAAM,EAAkB,EAAE,WAAW,EAAI,EAAE,WAAW,CAAG,KAGnH,EAAS,IAAI,IAAI,IAAI,EAAkB,GAAG,CAAC,AAAC,GAAW,EAAE,KAAK,GAAG,CACjE,EAAU,EAAO,GAAG,CAAC,AAAC,IAC1B,IAAM,EAAyB,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,GACxC,EAAM,EAAQ,IAAI,CAAC,AAAC,GAAW,CAAA,EAAA,EAAA,cAAA,EAAe,EAAE,MAAM,IAAM,GAClE,OAAO,GAAK,WAAa,CAC3B,GAAG,IAAI,CAAC,MAGF,EAAiB,CAAQ,CAAC,sBAAsB,CAClD,CAAQ,CAAC,sBAAsB,CAC/B,KACE,IAAgB,GAClB,EAAe,MAAM,EAAI,KAAO,EAAe,MAAM,EAAI,IAGvD,EAFF,AAGF,CAAC,AACA,aADa;AACb,uBAAuB,EAAE,EAAkB,MAAM,CAAC,EAAE,CAAC,GACtD,CAAC;AAAA,gBAAgB,EAAE,EAAO,MAAM,CAAA,EAAG,EAAU,CAAC,EAAE,EAAE,EAAQ,CAAC,CAAC,CAAG,GAAG,EAAE,CAAC,GACrE,CAAC;AAAA,2BAA2B,EAAE,EAAc,MAAM,CAAC,EAAE,CAAC,GACtD,CAAC;AAAA,qBAAqB,EAAE,EAAiB,MAAM,CAAC,EAAE,CAAC,GACnD,CAAC;AAAA,6BAA6B,EAAE,EAAwB,OAAO,CAAC,GAAG;AAAG,CAAC,AALxD,EAMd,CAAD,AALA,CAMK,CAAC,EAAE,EAAE,EAAgB,wBAA0B,iBAAiB,EAAE,EAAE,EAAe,MAAM,CAAC,OAAO,CAAC,GAAA,EAAK,EAAgB,IAAM,GAAG,EAAE;EAC/H,EAAE,EAAgB,cAAgB,eAAe,EAAE,EAAE,EAAe,MAAM,CAAC,OAAO,CAAC,GAAA,EAAK,EAAgB,IAAM,GAAG;AAAE,CAAC,AADY,CAEpI,EAAA,AADC,CACC,AADA,CAMF,EAAyB,EAC5B,MAAM,CAAC,AAAC,GAAW,OAAO,GAAG,aAAe,GAAK,IACjD,KAAK,GACL,IAAI,CAAC,CAAC,EAAQ,IAAY,OAAO,EAAE,WAAW,EAAI,GAAK,OAAO,EAAE,WAAW,EAAI,GAAI,CAAC,EAAE,CACnF,EAAa,EAChB,KAAK,GACL,IAAI,CAAC,CAAC,EAAQ,IAAY,OAAO,EAAE,WAAW,EAAI,GAAK,OAAO,EAAE,WAAW,EAAI,GAAI,CAAC,EAAE,CAIvF,GADwB,EAAE,EACpB,IAAI,CAAC,CAAC,qDAAqD,EAAE,EAAwB,OAAO,CAAC,GAAG,SAAS,EAAE,EAAkB,MAAM,CAAC,oBAAoB,CAAC,EAC3J,GACF,EAAM,IADK,AACD,CAAC,CAAC,eAAe,EAAE,EAAO,MAAM,CAAC,SAAS,EAAE,EAAQ,CAAC,CAAC,EAE9D,GAAwB,MAAM,AAChC,EAAM,IAAI,CAAC,CAAC,yBAAyB,EAAE,EAAuB,IAAI,CAAC,GAAG,EAAE,OAAO,EAAuB,WAAW,EAAI,GAAG,OAAO,CAAC,GAAG,aAAa,CAAC,EAE/I,GAAY,MAAM,AACpB,EAAM,IAAI,CAAC,CAAC,yCAAyC,EAAE,EAAW,IAAI,CAAC,eAAe,EAAE,OAAO,EAAW,WAAW,EAAI,GAAG,OAAO,CAAC,GAAG,uGAAuG,CAAC,EAE1O,EAAM,IAAI,CAAC,KAIpB,IAAI,EAAoB,GACxB,GAAI,EAAc,MAAM,CAAG,EAAG,CAC5B,IAAM,EAAiB,EACpB,GAAG,CAAC,AAAC,GAAW,CAAC,EAAE,EAAE,EAAE,IAAI,CAAC,EAAE,EAAE,CAAC,EAAE,WAAW,GAAI,CAAC,CAAE,OAAO,CAAC,GAAG,cAAc,CAAC,EAC/E,IAAI,CAAC,MACR,EACE,CAAC,AACD,gCADiC;AACjC,AAGA,EAHG,eAAe;AAAE,CADc,AACb,AACzB,CAEA,EAHI,CAGA,EAAiB,MAAM,CAAG,EAAG,CAC/B,IAAM,EAAkB,EACrB,GAAG,CAAC,AAAC,IACJ,IAAM,EAAS,EAAE,MAAM,CAAG,EAAK,CAAC,EAAE,MAAM,CAAG,EAAE,QAAA,AAAQ,EAAI,EAAE,MAAM,CAAG,IAAO,EACrE,EAAU,EAAE,MAAM,EAAI,KAAO,EAAE,QAAQ,EAAI,IAAO,IAAM,GAC9D,MAAO,CAAC,EAAE,EAAE,EAAE,IAAI,CAAC,SAAS,EAAE,OAAO,EAAE,MAAM,EAAI,GAAG,OAAO,CAAC,GAAA,EAAK,EAAO,WAAW,EAAE,OAAO,EAAE,QAAQ,EAAI,GAAG,OAAO,CAAC,GAAA,EAAK,EAAO,MAAM,EAAE,EAAO,OAAO,CAAC,GAAG,EAAE,CAC/J,AADgK,GAE/J,IAAI,CAAC,MACR,GAAqB,CAAC,EAAoB,OAAS,EAAA,CAAE,CACnD,CAAC;AAA+B,CAAC,CACjC,CAAA,EAAG,gBAAgB;AAAE,CAAC,AAC1B,CAMA,QAAQ,GAAG,CAAC,kEAGZ,IAAM,EAAoB,EAAkB,GAAG,CAAE,AAAD,IAC9C,IAAM,EAAyB,CAAA,EAAA,EAAA,cAAA,EAAe,EAAI,KAAK,EACjD,EAAM,EAAQ,IAAI,CAAC,AAAC,GAAW,CAAA,EAAA,EAAA,cAAA,EAAe,EAAE,MAAM,IAAM,GAC5D,EAAa,GAAK,aAAa,KAAK,AAAC,GAAW,EAAE,EAAE,GAAK,EAAI,YAAY,EACzE,EAAU,GAAY,SAAS,MAAQ,EAAI,UAAU,EAAI,QACzD,EAAc,CAAA,EAAA,EAAA,kBAAA,EAAmB,GACjC,EAAoB,CAAA,EAAA,EAAA,oBAAA,EAAqB,GAE/C,MAAO,CACL,KAAM,EAAI,IAAI,CACd,SAAU,GAAK,WAAa,EAAI,KAAK,CACrC,MAAO,EAAI,YAAY,SACvB,cACA,EACA,SAAU,EAAI,QAAQ,CACtB,OAAQ,EAAI,MAAM,CAClB,YAAa,EAAI,WAAW,CAC5B,OAAQ,EAAI,MAAM,CAClB,QAAS,EAAkB,OAAO,CAClC,gBAAiB,EAAkB,eAAe,CAClD,YAAa,EAAkB,WAAW,AAC5C,CACF,GAGM,EAAmB,EAAkB,GAAG,CAAC,AAAC,GAC9C,CAAA,EAAA,EAAA,oCAAA,AAAoC,EAAC,EAAI,OAAO,GAChD,MAAM,CAAC,CAAC,EAAW,EAAW,IAAgB,EAAE,OAAO,CAAC,KAAO,GAAG,IAAI,CAAC,MAGnE,EAAiB,EACpB,MAAM,CAAC,AAAC,GAAiC,eAApB,EAAI,WAAW,EACpC,GAAG,CAAC,AAAC,GAAa,CAAC,GAAG,EAAE,EAAI,IAAI,CAAC,WAAW,EAAE,EAAI,OAAO,CAAC,WAAW,GAAG,yEAAyE,CAAC,EAClJ,IAAI,CAAC,MAGJ,EAAsF,KAE1F,GAAI,CAEF,IAAM,EAAe,CAAC;;;;AAI5B,EAAE,GAAkB,mCAAmC;;;;;;;;;;;;6BAY1B,CAAC,CAElB,EAAqB,CAAC;;;AAGlC,EAAE,iBAAiB;;aAEN,EAAE,EAAwB,OAAO,CAAC,GAAG,qBAAqB,EAAE,EAAkB,MAAM,CAAC,mBAAmB,EAAE,QAAQ;;;AAG/H,EAAE,EAAkB,GAAG,CAAC,CAAC,EAAU,IACjC,CAAA,EAAG,EAAE,EAAE,EAAE,EAAE,EAAI,IAAI,CAAC;eACP,EAAE,EAAI,OAAO,CAAC,WAAW,GAAG,YAAY,EAAE,EAAI,WAAW,CAAC;aAC5D,EAAE,EAAI,QAAQ,CAAC,CAAC,EAAE,EAAI,MAAM,CAAC,GAAG,EAAE,EAAI,WAAW,CAAC,OAAO,CAAC,GAAG;aAC7D,EAAE,EAAI,MAAM,CAAC;2BACC,EAAE,EAAI,eAAe,CAAC;GAC9C,EAAE,EAAI,WAAW,CAAG,CAAC,aAAa,EAAE,EAAI,WAAW,CAAA,CAAE,CAAG,GAAA,CAAI,EAC7D,IAAI,CAAC,QAAQ;;;;yIAI0H,CAAC,CAE9H,EAAc,MAAM,EAAI,MAAM,CAAC,CACnC,IAAI,EAAA,aAAa,CAAC,GAClB,IAAI,EAAA,YAAY,CAAC,GAClB,EAEK,EAAY,CAAC,EAAY,OAAO,EAAE,YAAc,EAAA,CAAE,CAAE,KAAK,CAAC,eAC5D,IACF,EAAwB,KADX,AACgB,KAAK,CAAC,CAAS,CAAC,EAAE,EAC/C,QAAQ,GAAG,CAAC,yEAEhB,CAAE,MAAO,EAAU,CACjB,QAAQ,KAAK,CAAC,2CAA4C,EAC5D,CAGA,IAAM,EAAoB,GAAuB,mBAAqB,CAAC,KACrE,IAAM,EAAoF,EAAE,CAC5F,GAAI,GAAY,KAAM,CAEpB,IAAM,EAAoB,EAAkB,IAAI,CAAC,AAAC,GAAW,EAAE,IAAI,GAAK,EAAW,IAAI,EACjF,EAAoB,GAAmB,SAAW,QAClD,EAAqB,GAAmB,aAAe,SAEzD,EAAmB,GACnB,EAAuB,GAEA,cAAc,CAArC,GAEF,EAAmB,CAAC,CAAC,EAAE,EAAW,IAAI,CAAC,QAAQ,EAAE,OAAO,EAAW,WAAW,EAAI,GAAG,OAAO,CAAC,GAAG,uBAAuB,EAAE,EAAkB,WAAW,GAAG,8CAA8C,CAAC,CACxM,EAAuB,+LACd,AAAuB,UAAU,IAC1C,EAAmB,CAAC,CAAC,EAAE,EAAW,IAAI,CAAC,QAAQ,EAAE,OAAO,EAAW,WAAW,EAAI,GAAG,OAAO,CAAC,GAAG,wDAAwD,CAAC,CACzJ,EAAuB,0HAEvB,EAAmB,CAAC,CAAC,EAAE,EAAW,IAAI,CAAC,QAAQ,EAAE,OAAO,EAAW,WAAW,EAAI,GAAG,OAAO,CAAC,GAAG,YAAY,CAAC,CAC7G,EAAuB,qEAGzB,EAAM,IAAI,CAAC,CACT,MAAO,sCACP,MAAO,EACP,OAAQ,CACV,EACF,MACE,CADK,CACC,IAAI,CAAC,CACT,MAAO,sCACP,MAAO,4EACP,OAAQ,wIACV,GAoBF,OAhBI,GAAwB,MAAM,AAChC,EAAM,IAAI,CAAC,CACT,MAAO,6CACP,MAAO,CAAC,8BAA8B,EAAE,EAAuB,IAAI,CAAC,mEAAmE,CAAC,CACxI,OAAQ,uJACR,SAAU,kFACZ,GAGF,EAAM,IAAI,CAAC,CACT,MAAO,kCACP,MAAO,gHACP,OAAQ,wGACV,GAGO,EAAM,KAAK,CAAC,EAAG,GACxB,CAAC,GAEK,EAA4B,EAC/B,GAAG,CAAC,CAAC,EAAG,KACP,IAAM,EAAQ,CACZ,CAAA,EAAG,EAAM,EAAE,EAAE,EAAE,EAAE,KAAK,CAAA,CAAE,CACxB,CAAC,SAAS,EAAE,EAAE,KAAK,CAAA,CAAE,CACrB,CAAC,UAAU,EAAE,EAAE,MAAM,CAAA,CAAE,CACxB,CAED,OADI,EAAE,QAAQ,EAAE,EAAM,IAAI,CAAC,CAAC,aAAa,EAAE,EAAE,QAAQ,CAAA,CAAE,EAChD,EAAM,IAAI,CAAC,KACpB,GACC,IAAI,CAAC,QA0BF,EAA2B,CAC/B,gBAvB+B,CAuBd,EAvBqC,iBAAmB,CAAC,KAC1E,IAAM,EAAkB,EAAE,CAQ1B,GAPA,EAAM,IAAI,CAAC,CAAC,qDAAqD,EAAE,EAAwB,OAAO,CAAC,GAAG,SAAS,EAAE,EAAkB,MAAM,CAAC,oBAAoB,CAAC,EAC3J,GACF,EAAM,IAAI,AADC,CACA,CAAC,eAAe,EAAE,EAAO,MAAM,CAAC,SAAS,EAAE,EAAQ,CAAC,CAAC,EAE9D,GAAwB,MAAM,AAChC,EAAM,IAAI,CAAC,CAAC,yBAAyB,EAAE,EAAuB,IAAI,CAAC,GAAG,EAAE,OAAO,EAAuB,WAAW,EAAI,GAAG,OAAO,CAAC,GAAG,aAAa,CAAC,EAE/I,GAAY,KAAM,CACpB,IAAM,EAAoB,EAAkB,IAAI,CAAC,AAAC,GAAW,EAAE,IAAI,GAAK,EAAW,IAAI,EACjF,EAAqB,GAAmB,aAAe,SAElC,cAAc,CAArC,EACF,EAAM,IAAI,CAAC,CAAC,+BAA+B,EAAE,EAAW,IAAI,CAAC,GAAG,EAAE,OAAO,EAAW,WAAW,EAAI,GAAG,OAAO,CAAC,GAAG,oIAAoI,CAAC,EAEtP,EAAM,IAAI,CAAC,CAAC,+BAA+B,EAAE,EAAW,IAAI,CAAC,GAAG,EAAE,OAAO,EAAW,WAAW,EAAI,GAAG,OAAO,CAAC,GAAG,aAAa,CAAC,CAEnI,CACA,OAAO,EAAM,IAAI,CAAC,KACpB,CAAC,GAIC,qBAAsB,oBACtB,EACA,QAAS,CACP,gBAAiB,EAAkB,MAAM,CACzC,SAAU,EAAc,MAAM,CAC9B,YAAa,EAAiB,MAAM,CACpC,mBAAoB,CACtB,EACA,YAAa,IAAI,OAAO,WAAW,EACrC,CAGA,OAAM,EAAA,OAAM,CAAC,YAAY,CAAC,MAAM,CAAC,CAC/B,MAAO,CAAE,GAAI,CAAW,EACxB,KAAM,CACJ,WAAY,EACZ,iBAAkB,EAClB,KAAM,KAAK,SAAS,CAAC,GACrB,UAAW,EACX,cAAe,EACf,gBAAiB,EACjB,qBAAsB,EACtB,UAAW,IAAI,IACjB,CACF,GAIA,QAAQ,GAAG,CAAC,CAAC,8CAA8C,EAAE,EAAA,CAAY,EACzE,GAAI,CAEF,MAAM,EAAA,gBAAgB,CAAC,uBAAuB,CAAC,GAE3C,EAAS,UAAU,EAAE,AACvB,MAAM,EAAA,gBAAgB,CAAC,uBAAuB,CAAC,EAAS,UAAU,EAGpE,MAAM,EAAA,gBAAgB,CAAC,0BAA0B,CAAC,GAE9C,EAAS,YAAY,EAAE,AACzB,MAAM,EAAA,gBAAgB,CAAC,2BAA2B,CAAC,EAAS,YAAY,EAE1E,QAAQ,GAAG,CAAC,CAAC,wCAAwC,CAAC,CACxD,CAAE,MAAO,EAAY,CAEnB,QAAQ,KAAK,CAAC,qDAAsD,EACtE,CAQA,OALA,QAAQ,GAAG,CAAC,CAAC,mCAAmC,EAAE,EAAsB,MAAM,CAAC,YAAY,CAAC,EAC5F,EAAsB,OAAO,CAAC,CAAC,EAAU,KACvC,QAAQ,GAAG,CAAC,CAAC,GAAG,EAAE,EAAI,EAAE,EAAE,EAAI,IAAI,CAAC,WAAW,EAAE,EAAI,MAAM,CAAC,eAAe,EAAE,EAAI,WAAW,EAAE,QAAQ,IAAM,MAAM,CAAC,CAAC,CACrH,GAEO,EAAA,YAAY,CAAC,IAAI,CAAC,CACvB,WAAY,0BACZ,EACA,KAAM,EACN,UAAW,EACX,cAAe,EACf,gBAAiB,EACjB,qBAAsB,EAEtB,cAAe,IAAI,OAAO,WAAW,EACvC,EAAG,CACD,OAAQ,IACR,QAAS,CACP,gBAAiB,wDACjB,OAAU,WACV,QAAW,GACb,CACF,EACF,CAAE,MAAO,EAAO,CAEd,OADA,QAAQ,KAAK,CAAC,+BAAgC,GACvC,EAAA,YAAY,CAAC,IAAI,CACtB,CACE,MAAO,aAAiB,MAAQ,EAAM,OAAO,CAAG,+BAClD,EACA,CAAE,OAAQ,GAAI,EAElB,CACF,2BD/0BA,IAAA,EAAA,EAAA,CAAA,CAAA,OAIA,IAAM,EAAc,IAAI,EAAA,mBAAmB,CAAC,CACxC,WAAY,CACR,KAAM,EAAA,SAAS,CAAC,SAAS,CACzB,KAAM,sCACN,SAAU,gCACV,SAAU,QACV,WAAY,EAChB,EACA,QAAS,CAAA,OACT,IADiD,eACc,CAA3C,EACpB,iBAAkB,sDAClB,iBAZqB,aAarB,SAAA,CACJ,GAIM,CAAE,kBAAgB,CAAE,sBAAoB,aAAE,CAAW,CAAE,CAAG,EAChE,SAAS,IACL,MAAO,CAAA,EAAA,EAAA,UAAA,AAAW,EAAC,kBACf,uBACA,CACJ,EACJ,CAEO,eAAe,EAAQ,CAAG,CAAE,CAAG,CAAE,CAAG,EACnC,EAAY,KAAK,EAAE,AACnB,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,EAAK,+BAAgC,QAAQ,MAAM,CAAC,MAAM,IAE7E,IAAI,EAAU,sCAKV,EAAU,EAAQ,OAAO,CAAC,WAAY,KAAO,IAMjD,IAAM,EAAgB,MAAM,EAAY,OAAO,CAAC,EAAK,EAAK,SACtD,EACA,mBAHE,CAAA,CAIN,GACA,GAAI,CAAC,EAID,OAHA,EAAI,IADY,MACF,CAAG,IACjB,EAAI,GAAG,CAAC,eACR,AAAiB,OAAO,CAApB,IAAyB,KAAhB,EAAoB,EAAI,SAAS,CAAC,IAAI,CAAC,EAAK,QAAQ,OAAO,IACjE,KAEX,GAAM,SAAE,CAAO,QAAE,CAAM,YAAE,CAAU,WAAE,CAAS,aAAE,CAAW,mBAAE,CAAiB,CAAE,qBAAmB,CAAE,sBAAoB,yBAAE,CAAuB,kBAAE,CAAgB,yBAAE,CAAuB,uBAAE,CAAqB,CAAE,CAAG,EACnN,EAAoB,CAAA,EAAA,EAAA,gBAAA,AAAgB,EAAC,GACvC,EAAQ,GAAQ,EAAkB,aAAa,CAAC,EAAkB,EAAI,EAAkB,MAAM,CAAC,EAAA,AAAiB,EAC9G,EAAY,WAEa,MAAvB,EAA8B,KAAK,EAAI,EAAoB,SAAS,AAAT,EAAW,AACtE,MAAM,EAAoB,SAAS,CAAC,EAAK,EAAK,GAAW,GAEzD,EAAI,GAAG,CAAC,gCAEL,MAEX,GAAI,GAAS,CAAC,EAAa,CACvB,IAAM,GAAgB,CAAQ,EAAkB,MAAM,CAAC,EAAiB,CAClE,EAAgB,EAAkB,aAAa,CAAC,EAAkB,CACxE,GAAI,IAC+B,IAA3B,EAAc,KADH,GACW,EAAc,CAAC,EAAe,CACpD,GAAI,EAAW,YAAY,CAAC,WAAW,CACnC,CADqC,MAC9B,MAAM,GAEjB,OAAM,IAAI,EAAA,eAAe,AAC7B,CAER,CACA,IAAI,EAAW,MACX,GAAU,EAAY,IAAb,CAAkB,EAAK,EAAD,EAG/B,EAAW,AAAa,OAHqB,KAC7C,EAAW,CAAA,EAEwB,IAAM,CAAA,EAE7C,IAAM,GACgB,IAAtB,EAAY,EAAkB,GAAb,EAEjB,CAAC,EAKK,EAAqB,GAAS,CAAC,EAIjC,GAAyB,GACzB,CAAA,EAAA,EAAA,iBADkD,aAClD,AAA8B,EAAC,CAC3B,KAAM,IAbqF,sBAc3F,wBACA,EACA,gBAAiB,CAAA,EAAA,EAAA,qBAAqB,AAArB,EAAsB,uBACnC,CACJ,EACJ,GAEJ,IAAM,EAAS,EAAI,MAAM,EAAI,MACvB,EAAS,CAAA,EAAA,EAAA,SAAA,AAAS,IAClB,EAAa,EAAO,kBAAkB,GACtC,EAAU,QACZ,oBACA,EACA,WAAY,CACR,aAAc,CACV,gBAAgB,CAAQ,EAAW,YAAY,CAAC,cAAc,AAClE,EACA,iBAAiB,CAAQ,EAAW,eAAe,yBACnD,EACA,iBAAkB,CAAA,EAAA,EAAA,cAAA,AAAc,EAAC,EAAK,oBACtC,kBAAmB,EAAW,SAAS,CACvC,UAAW,EAAI,SAAS,CACxB,QAAS,AAAC,IACN,EAAI,EAAE,CAAC,QAAS,EACpB,EACA,sBAAkB,EAClB,8BAA+B,CAAC,EAAO,EAAU,IAAe,EAAY,cAAc,CAAC,EAAK,EAAO,EAAc,EACzH,EACA,cAAe,SACX,CACJ,CACJ,EACM,EAAc,IAAI,EAAA,eAAe,CAAC,GAClC,EAAc,IAAI,EAAA,gBAAgB,CAAC,GACnC,EAAU,EAAA,kBAAkB,CAAC,mBAAmB,CAAC,EAAa,CAAA,EAAA,EAAA,sBAAA,AAAsB,EAAC,IAC3F,GAAI,CACA,IAAM,EAAoB,MAAO,GACtB,EAAY,MAAM,CAAC,EAAS,GAAS,OAAO,CAAC,KAChD,GAAI,CAAC,EAAM,OACX,EAAK,aAAa,CAAC,CACf,mBAAoB,EAAI,UAAU,CAClC,YAAY,CAChB,GACA,IAAM,EAAqB,EAAO,qBAAqB,GAEvD,GAAI,CAAC,EACD,OAEJ,GAAI,EAAmB,GAAG,CAAC,EAHF,kBAGwB,EAAA,cAAc,CAAC,aAAa,CAAE,YAC3E,QAAQ,IAAI,CAAC,CAAC,2BAA2B,EAAE,EAAmB,GAAG,CAAC,kBAAkB,qEAAqE,CAAC,EAG9J,IAAM,EAAQ,EAAmB,GAAG,CAAC,cACrC,GAAI,EAAO,CACP,IAAM,EAAO,CAAA,EAAG,EAAO,CAAC,EAAE,EAAA,CAAO,CACjC,EAAK,aAAa,CAAC,CACf,aAAc,EACd,aAAc,EACd,iBAAkB,CACtB,GACA,EAAK,UAAU,CAAC,EACpB,MACI,CADG,CACE,UAAU,CAAC,CAAA,EAAG,EAAO,CAAC,EAAE,EAAA,CAAS,CAE9C,GAEE,GAAgB,CAAoC,CAAA,EAAA,EAAA,EAA5B,YAA4B,AAAc,EAAC,EAAK,eACxE,EAAiB,MAAO,QACtB,EA2FI,EA1FR,IAAM,EAAoB,MAAO,oBAAE,CAAkB,CAAE,IACnD,GAAI,CACA,GAAI,CAAC,GAAiB,GAAwB,GAA2B,CAAC,EAKtE,OAJA,EAAI,SADsF,CAC5E,CAAG,IAEjB,EAAI,SAAS,CAAC,iBAAkB,eAChC,EAAI,GAAG,CAAC,gCACD,KAEX,IAAM,EAAW,MAAM,EAAkB,GACzC,EAAI,YAAY,CAAG,EAAQ,UAAU,CAAC,YAAY,CAClD,IAAI,EAAmB,EAAQ,UAAU,CAAC,gBAAgB,CAGtD,GACI,EAAI,SAAS,EAAE,CACf,CAFc,CAEV,SAAS,CAAC,GACd,OAAmB,GAG3B,IAAM,EAAY,EAAQ,UAAU,CAAC,aAAa,CAGlD,IAAI,EA6BA,OADA,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,EAAC,EAAa,EAAa,EAAU,EAAQ,UAAU,CAAC,gBAAgB,EACnF,IA7BA,EACP,IAAM,EAAO,MAAM,EAAS,IAAI,GAE1B,EAAU,CAAA,EAAA,EAAA,yBAAA,AAAyB,EAAC,EAAS,OAAO,EACtD,IACA,CAAO,CAAC,EAAA,GADG,mBACmB,CAAC,CAAG,CAAA,EAElC,CAAC,CAAO,CAAC,eAAe,EAAI,EAAK,IAAI,EAAE,CACvC,CAAO,CAAC,eAAe,CAAG,EAAK,IAAA,AAAI,EAEvC,IAAM,EAAa,AAAkD,SAA3C,EAAQ,UAAU,CAAC,mBAAmB,IAAoB,EAAQ,UAAU,CAAC,mBAAmB,EAAI,EAAA,cAAA,AAAc,GAAW,AAAR,EAAgB,UAAU,CAAC,mBAAmB,CACvL,EAAS,KAA8C,IAAvC,EAAQ,UAAU,CAAC,eAAe,EAAoB,EAAQ,UAAU,CAAC,eAAe,EAAI,EAAA,cAAc,MAAG,EAAY,EAAQ,UAAU,CAAC,eAAe,CAcjL,MAZmB,CAYZ,AAXH,MAAO,CACH,KAAM,EAAA,eAAe,CAAC,SAAS,CAC/B,OAAQ,EAAS,MAAM,CACvB,KAAM,OAAO,IAAI,CAAC,MAAM,EAAK,WAAW,YACxC,CACJ,EACA,aAAc,YACV,SACA,CACJ,CACJ,CAEJ,CAKJ,CAAE,KALS,CAKF,EAAK,CAcV,MAX0B,MAAtB,EAA6B,KAAK,EAAI,EAAmB,OAAA,AAAO,EAAE,CAClE,MAAM,EAAY,cAAc,CAAC,EAAK,EAAK,CACvC,WAAY,aACZ,UAAW,EACX,UAAW,QACX,iBAAkB,CAAA,EAAA,EAAA,mBAAA,AAAmB,EAAC,oBAClC,uBACA,CACJ,EACJ,EAAG,GAED,CACV,CACJ,EACM,EAAa,MAAM,EAAY,cAAc,CAAC,KAChD,aACA,WACA,EACA,UAAW,EAAA,SAAS,CAAC,SAAS,CAC9B,YAAY,oBACZ,EACA,mBAAmB,uBACnB,0BACA,oBACA,EACA,UAAW,EAAI,SAAS,eACxB,CACJ,GAEA,GAAI,CAAC,EACD,KADQ,EACD,KAEX,GAAI,CAAe,MAAd,CAAqB,EAAmD,AAA1C,GAAJ,IAAK,EAAoB,EAAW,KAAA,AAAK,EAAY,KAAK,EAAI,EAAkB,IAAI,IAAM,EAAA,eAAe,CAAC,SAAS,CAE9I,CAFgJ,KAE1I,OAAO,cAAc,CAAC,AAAI,MAAM,CAAC,kDAAkD,EAAgB,MAAd,CAAqB,EAAS,AAA2C,GAA/C,IAAK,EAAqB,EAAW,KAAA,AAAK,EAAY,KAAK,EAAI,EAAmB,IAAI,CAAA,CAAE,EAAG,oBAAqB,CACjO,MAAO,OACP,YAAY,EACZ,cAAc,CAClB,EAEA,CAAC,GACD,EAAI,SAAS,CADG,AACF,iBAAkB,EAAuB,cAAgB,EAAW,MAAM,CAAG,OAAS,EAAW,OAAO,CAAG,QAAU,OAGnI,GACA,EAAI,QADS,CACA,CAAC,gBAAiB,2DAEnC,IAAM,EAAU,CAAA,EAAA,EAAA,2BAAA,AAA2B,EAAC,EAAW,KAAK,CAAC,OAAO,EAcpE,OAbI,AAAE,CAAD,EAAkB,GACnB,EAAQ,AADgB,GAAG,GACb,CAAC,EAAA,sBAAsB,GAIrC,EAAW,YAAY,EAAK,EAAD,AAAK,SAAS,CAAC,kBAAqB,EAAD,AAAS,GAAG,CAAC,kBAAkB,AAC7F,EAAQ,GAAG,CAAC,gBAAiB,CAAA,EAAA,EAAA,qBAAA,AAAqB,EAAC,EAAW,YAAY,GAE9E,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,EAAC,EAAa,EAChC,IAAI,SAAS,EAAW,KAAK,CAAC,IAAI,CAAE,SAChC,EACA,OAAQ,EAAW,KAAK,CAAC,MAAM,EAAI,GACvC,IACO,IACX,EAGI,EACA,MAAM,EAAe,EADT,CAGZ,MAAM,EAAO,qBAAqB,CAAC,EAAI,OAAO,CAAE,IAAI,EAAO,KAAK,CAAC,EAAA,cAAc,CAAC,aAAa,CAAE,CACvF,SAAU,CAAA,EAAG,EAAO,CAAC,EAAE,EAAA,CAAS,CAChC,KAAM,EAAA,QAAQ,CAAC,MAAM,CACrB,WAAY,CACR,cAAe,EACf,cAAe,EAAI,GAAG,AAC1B,CACJ,EAAG,GAEf,CAAE,MAAO,EAAK,CAcV,GAbI,AAAE,CAAD,YAAgB,EAAA,eAAe,EAChC,CADmC,KAC7B,EAAY,cAAc,CAAC,EAAK,EAAK,CACvC,WAAY,aACZ,UAAW,EACX,UAAW,QACX,iBAAkB,CAAA,EAAA,EAAA,mBAAmB,AAAnB,EAAoB,oBAClC,uBACA,CACJ,EACJ,GAIA,EAAO,MAAM,EAKjB,OAHA,MAAM,CAAA,EAAA,EAAA,YAAA,AAAY,EAAC,EAAa,EAAa,IAAI,SAAS,KAAM,CAC5D,OAAQ,GACZ,IACO,IACX,CACJ,EAEA,qCAAqC","ignoreList":[0]}