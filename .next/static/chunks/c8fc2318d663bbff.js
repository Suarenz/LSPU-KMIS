(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,33525,(e,r,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"warnOnce",{enumerable:!0,get:function(){return o}});let o=e=>{}},60865,e=>{"use strict";var r=e.i(47167);let t=new class{secret;constructor(){this.secret=r.default.env.JWT_SECRET||"6dFk5d0vbyLnZC0Amy83LtI47DsNr/KB4M+FgbUc6njd4cjk7XB2/8nTuhQDWW8OOgQ6fI74huxJE3a/RP2giw=="}stringToUint8Array(e){return new TextEncoder().encode(e)}uint8ArrayToBase64Url(e){let r="";for(let t=0;t<e.byteLength;t++)r+=String.fromCharCode(e[t]);return btoa(r).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}async importSecret(){let e=new TextEncoder().encode(this.secret);return await crypto.subtle.importKey("raw",e,{name:"HMAC",hash:"SHA-256"},!1,["sign","verify"])}async generateToken(e){try{let r=Math.floor(Date.now()/1e3),t={...e,iat:r,exp:r+3600},o=this.uint8ArrayToBase64Url(this.stringToUint8Array(JSON.stringify({alg:"HS256",typ:"JWT"}))),n=this.uint8ArrayToBase64Url(this.stringToUint8Array(JSON.stringify(t))),s=`${o}.${n}`,a=await this.importSecret(),i=new TextEncoder().encode(s),l=await crypto.subtle.sign("HMAC",a,i),c=new Uint8Array(l),u=this.uint8ArrayToBase64Url(c);return`${s}.${u}`}catch(e){throw console.error("JWT token generation failed:",e),Error("Failed to generate JWT token")}}async verifyToken(e){try{if(!e||"string"!=typeof e||""===e.trim())return console.error("Invalid token provided for verification"),null;let r=e.split(".");if(3!==r.length)return console.error("Token format is invalid"),null;let[t,o,n]=r;if(!this.base64UrlDecode(t))return console.error("Failed to decode token header"),null;let s=this.base64UrlDecode(o);if(!s)return console.error("Failed to decode token payload"),null;let a=JSON.parse(s),i=Math.floor(Date.now()/1e3);if(a.exp&&a.exp<i)return console.error("Token has expired"),null;let l=await this.importSecret();if(!await this.verifySignature(`${t}.${o}`,n,l))return console.error("Token signature verification failed"),null;return a}catch(e){return console.error("Token verification failed:",e?.message||e),null}}async verifySignature(e,r,t){try{let o=this.base64UrlDecodeToUint8Array(r);if(!o)return!1;let n=new TextEncoder().encode(e),s=new Uint8Array(o.buffer,o.byteOffset,o.byteLength),a=new Uint8Array(n.buffer,n.byteOffset,n.byteLength);return await crypto.subtle.verify("HMAC",t,s,a)}catch(e){return console.error("Signature verification error:",e),!1}}decodeToken(e){try{if(!e||"string"!=typeof e||""===e.trim())return null;let r=e.split(".");if(3!==r.length)return console.error("Token format is invalid"),null;let t=r[1],o=this.base64UrlDecode(t);if(!o)return null;return JSON.parse(o)}catch(e){return console.error("Token decoding failed:",e?.message||e),null}}isTokenExpired(e){try{let r=this.decodeToken(e);if(!r||!r.exp)return!0;let t=Math.floor(Date.now()/1e3);return r.exp<t}catch(e){return console.error("Error checking token expiration:",e),!0}}base64UrlDecode(e){try{let r="=".repeat((4-e.length%4)%4),t=e.replace(/-/g,"+").replace(/_/g,"/")+r,o=atob(t);return decodeURIComponent(escape(o))}catch(e){return console.error("Base64 URL decode error:",e),null}}base64UrlDecodeToUint8Array(e){try{let r="=".repeat((4-e.length%4)%4),t=e.replace(/-/g,"+").replace(/_/g,"/")+r,o=atob(t),n=new Uint8Array(o.length);for(let e=0;e<o.length;e++)n[e]=o.charCodeAt(e);return n}catch(e){return console.error("Base64 URL decode to Uint8Array error:",e),null}}},o="lspu_kmis_session_cache",n="lspu_kmis_last_auth_check";class s{sessionValidationDebounce=null;constructor(){}getCachedSession(){{let e=localStorage.getItem(o);if(e)try{let{data:r,expiration:t}=JSON.parse(e);if(Date.now()<t)return r;localStorage.removeItem(o)}catch(e){console.error("Error parsing cached session:",e),localStorage.removeItem(o)}}return null}setCachedSession(e,r=3e5){{let t=Date.now()+r;try{localStorage.setItem(o,JSON.stringify({data:e,expiration:t}))}catch(e){console.error("Error caching session:",e)}}}clearCachedSession(){localStorage.removeItem(o),localStorage.removeItem(n)}getLastAuthCheck(){{let e=localStorage.getItem(n);return e?parseInt(e):null}}setLastAuthCheck(e){localStorage.setItem(n,e.toString())}async validateSessionWithoutLoading(){return this.sessionValidationDebounce&&clearTimeout(this.sessionValidationDebounce),new Promise(e=>{this.sessionValidationDebounce=setTimeout(async()=>{try{let r=this.getAccessTokenFromStorage();if(!r)return void e(!1);if(t.isTokenExpired(r)){let r=await this.refreshToken();e(r)}else e(!0)}catch(r){console.error("Session validation error:",r),e(!1)}},500)})}getAccessTokenFromStorage(){return localStorage.getItem("access_token")}setAccessTokenInStorage(e){localStorage.setItem("access_token",e)}removeAccessTokenFromStorage(){localStorage.removeItem("access_token")}async login(e,r){try{let t=await fetch("/api/auth/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:r})});if(!t.ok){let e=await t.json().catch(()=>({}));return{success:!1,error:e.error||"Login failed"}}let o=await t.json();if(!o.success||!o.token||!o.user)return{success:!1,error:o.error||"Login failed"};{this.setAccessTokenInStorage(o.token);let e=this.generateMockRefreshToken();localStorage.setItem("refresh_token",e),this.refreshTokensStore.set(e,{userId:o.user.id,email:o.user.email,role:o.user.role});let r={id:o.user.id,email:o.user.email,name:o.user.name,role:o.user.role,unitId:o.user.unitId||void 0};return{success:!0,user:r}}}catch(e){return console.error("Login error:",e),{success:!1,error:"An unexpected error occurred during login"}}}async signup(e,r,t,o="STUDENT",n){try{let s=await fetch("/api/auth/signup",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e,password:r,name:t,role:o,department:n})});if(!s.ok){let e=await s.json().catch(()=>({}));return{success:!1,error:e.error||"Signup failed"}}let a=await s.json();if(!a.success||!a.token||!a.user)return{success:!1,error:a.error||"Signup failed"};{this.setAccessTokenInStorage(a.token);let e=this.generateMockRefreshToken();localStorage.setItem("refresh_token",e),this.refreshTokensStore.set(e,{userId:a.user.id,email:a.user.email,role:a.user.role});let r={id:a.user.id,email:a.user.email,name:a.user.name,role:a.user.role,unitId:a.user.unitId||void 0};return{success:!0,user:r}}}catch(e){return console.error("Signup error:",e),{success:!1,error:"An unexpected error occurred during signup"}}}async logout(){try{await fetch("/api/auth/logout",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.getAccessTokenFromStorage()}`}});let e=localStorage.getItem("refresh_token");this.removeAccessTokenFromStorage(),localStorage.removeItem("refresh_token"),e&&this.refreshTokensStore.delete(e)}catch(r){console.error("Logout error:",r);let e=localStorage.getItem("refresh_token");this.removeAccessTokenFromStorage(),localStorage.removeItem("refresh_token"),e&&this.refreshTokensStore.delete(e)}}async getCurrentUser(){try{let e=this.getAccessTokenFromStorage();if(!e)return null;if(t.isTokenExpired(e)){if(!await this.refreshToken())return null;{let e=this.getAccessTokenFromStorage();if(!e)return null;{let r=await fetch("/api/auth/me",{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!r.ok)return null;let t=await r.json();if(t.user)return{id:t.user.id,email:t.user.email,name:t.user.name,role:t.user.role,unitId:t.user.unitId||void 0};return null}}}let r=await fetch("/api/auth/me",{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!r.ok){if(401===r.status&&await this.refreshToken()){let e=this.getAccessTokenFromStorage();if(e){let r=await fetch("/api/auth/me",{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!r.ok)return null;let t=await r.json();if(t.user)return{id:t.user.id,email:t.user.email,name:t.user.name,role:t.user.role,unitId:t.user.unitId||void 0}}}return null}let o=await r.json();if(o.user)return{id:o.user.id,email:o.user.email,name:o.user.name,role:o.user.role,unitId:o.user.unitId||void 0};return null}catch(e){return console.error("Error in getCurrentUser:",e),null}}async getSession(){let e=this.getAccessTokenFromStorage();if(!e)return null;{let r=t.decodeToken(e);if(!r){if(await this.refreshToken()){let e=this.getAccessTokenFromStorage();if(e){let r=t.decodeToken(e);return r?{access_token:e,expires_at:r.exp}:null}}return null}return r?{access_token:e,expires_at:r.exp}:null}}async getUser(){return await this.getCurrentUser()}refreshTokensStore=new Map;generateMockRefreshToken(){return`mock_refresh_token_${Date.now()}_${Math.random().toString(36).substring(2,15)}`}async refreshToken(){try{let e=localStorage.getItem("refresh_token");if(!e)return!1;let r=await fetch("/api/auth/refresh",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:e})});if(!r.ok)return this.removeAccessTokenFromStorage(),localStorage.removeItem("refresh_token"),this.refreshTokensStore.delete(e),!1;let t=await r.json();if(t.token)return this.setAccessTokenInStorage(t.token),!0;return!1}catch(e){return console.error("Error refreshing token:",e),!1}}async updatePassword(e){try{let r=await this.getAccessToken();if(!r)return{error:"User not authenticated"};let t=await fetch("/api/auth/update-password",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({newPassword:e})});if(!t.ok){if(401===t.status&&await this.refreshToken()){let r=await this.getAccessToken();if(r){let t=await fetch("/api/auth/update-password",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({newPassword:e})});if(!t.ok)return{error:(await t.json().catch(()=>({}))).error||"Failed to update password"};return{error:null}}}return{error:(await t.json().catch(()=>({}))).error||"Failed to update password"}}return{error:null}}catch(e){return console.error("Error updating password:",e),{error:"Failed to update password"}}}async resetPassword(e){try{let r=await fetch("/api/auth/reset-password",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:e})});if(!r.ok)return{error:(await r.json().catch(()=>({}))).error||"Failed to reset password"};return{error:null}}catch(e){return console.error("Error resetting password:",e),{error:"Failed to reset password"}}}async isAuthenticated(){try{let e=this.getAccessTokenFromStorage();if(!e)return!1;if(t.isTokenExpired(e))return await this.refreshToken();return!0}catch(e){return console.error("Error in isAuthenticated:",e),!1}}async getAccessToken(){try{let e=this.getAccessTokenFromStorage();if(!e)return null;if(t.isTokenExpired(e)){if(await this.refreshToken())return this.getAccessTokenFromStorage();return null}return e}catch(e){return console.error("Error getting access token:",e),null}}async getComprehensiveUserData(){try{let e=this.getCachedSession();if(e)return e;let r=await this.getAccessToken();if(!r)return!await this.isAuthenticated(),{authenticated:!1,user:null};let t=await fetch("/api/auth/me",{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}});if(!t.ok){if(401===t.status||404===t.status){if(await this.refreshToken()){let e=await this.getAccessToken();if(e){let r=await fetch("/api/auth/me",{headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"}});if(!r.ok)return this.clearCachedSession(),{authenticated:!1,user:null};let t=await r.json();return this.setCachedSession(t),t}}return this.clearCachedSession(),{authenticated:!1,user:null}}let e=await t.json().catch(()=>({}));throw Error(e.error||`Failed to fetch user data: ${t.status} ${t.statusText}`)}let o=await t.json();return this.setCachedSession(o),o}catch(e){return console.error("Error fetching comprehensive user data:",e),e instanceof Error&&e.message.includes("No authentication token available"),this.clearCachedSession(),{authenticated:!1,user:null}}}clearCache(){this.clearCachedSession()}}let a=new s;e.s(["default",0,a],60865)},91432,e=>{"use strict";var r=e.i(43476),t=e.i(71645),o=e.i(60865);let n=(0,t.createContext)(void 0);function s({children:e}){let[s,a]=(0,t.useState)(null),[i,l]=(0,t.useState)(!1),[c,u]=(0,t.useState)(!0),[h,d]=(0,t.useState)(null),[m]=(0,t.useState)(o.default);(0,t.useEffect)(()=>{let e=!0,r=async()=>{try{try{let r=await m.getComprehensiveUserData();r&&r.authenticated?e&&(l(!0),a(r.user),u(!1)):e&&(a(null),l(!1),u(!1))}catch(r){console.warn("Comprehensive user data fetch failed, falling back to standard method:",r);try{let r=await m.getCurrentUser();r?(e&&(l(!0),u(!0)),e&&(a(r),u(!1))):e&&(a(null),l(!1),u(!1))}catch(r){console.error("Session check error during initial load:",r),e&&(a(null),l(!1),u(!1))}}}catch(r){console.error("Initial session check error:",r),e&&(a(null),l(!1),u(!1))}},t=async()=>{if("visible"===document.visibilityState){let r=m.getLastAuthCheck(),t=Date.now();(!r||t-r>6e5)&&(!await m.validateSessionWithoutLoading()&&e&&(a(null),l(!1)),m.setLastAuthCheck(t))}};{let o=setTimeout(()=>{e&&r()},0);return document.addEventListener("visibilitychange",t),()=>{clearTimeout(o),e=!1,document.removeEventListener("visibilitychange",t)}}},[]);let f=async(e,r)=>{u(!0),d(null);try{let t=await m.login(e,r);if(t.success&&t.user)return a(t.user),l(!0),u(!1),t;return d(t.error||"Login failed"),u(!1),t}catch(e){return console.error("Login error:",e),d("An error occurred during login"),u(!1),{success:!1,error:"An error occurred during login"}}},g=async()=>{u(!0);try{await m.logout(),a(null),l(!1),u(!1)}catch(e){console.error("Logout error:",e),a(null),l(!1),u(!1)}};return(0,r.jsx)(n.Provider,{value:{user:s,login:f,logout:g,isAuthenticated:i,isLoading:c,error:h},children:e})}function a(){let e=(0,t.useContext)(n);if(void 0===e)throw Error("useAuth must be used within an AuthProvider");return e}e.s(["AuthProvider",()=>s,"useAuth",()=>a])},89554,e=>{"use strict";var r=e.i(43476),t=e.i(71645),o=(e,r,t,o,n,s,a,i)=>{let l=document.documentElement,c=["light","dark"];function u(r){var t;(Array.isArray(e)?e:[e]).forEach(e=>{let t="class"===e,o=t&&s?n.map(e=>s[e]||e):n;t?(l.classList.remove(...o),l.classList.add(s&&s[r]?s[r]:r)):l.setAttribute(e,r)}),t=r,i&&c.includes(t)&&(l.style.colorScheme=t)}if(o)u(o);else try{let e=localStorage.getItem(r)||t,o=a&&"system"===e?window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light":e;u(o)}catch(e){}},n=["light","dark"],s="(prefers-color-scheme: dark)",a="undefined"==typeof window,i=t.createContext(void 0),l=e=>t.useContext(i)?t.createElement(t.Fragment,null,e.children):t.createElement(u,{...e}),c=["light","dark"],u=({forcedTheme:e,disableTransitionOnChange:r=!1,enableSystem:o=!0,enableColorScheme:a=!0,storageKey:l="theme",themes:u=c,defaultTheme:g=o?"system":"light",attribute:p="data-theme",value:y,children:k,nonce:T,scriptProps:S})=>{let[w,v]=t.useState(()=>d(l,g)),[A,b]=t.useState(()=>"system"===w?f():w),C=y?Object.values(y):u,E=t.useCallback(e=>{let t=e;if(!t)return;"system"===e&&o&&(t=f());let s=y?y[t]:t,i=r?m(T):null,l=document.documentElement,c=e=>{"class"===e?(l.classList.remove(...C),s&&l.classList.add(s)):e.startsWith("data-")&&(s?l.setAttribute(e,s):l.removeAttribute(e))};if(Array.isArray(p)?p.forEach(c):c(p),a){let e=n.includes(g)?g:null,r=n.includes(t)?t:e;l.style.colorScheme=r}null==i||i()},[T]),I=t.useCallback(e=>{let r="function"==typeof e?e(w):e;v(r);try{localStorage.setItem(l,r)}catch(e){}},[w]),j=t.useCallback(r=>{b(f(r)),"system"===w&&o&&!e&&E("system")},[w,e]);t.useEffect(()=>{let e=window.matchMedia(s);return e.addListener(j),j(e),()=>e.removeListener(j)},[j]),t.useEffect(()=>{let e=e=>{e.key===l&&(e.newValue?v(e.newValue):I(g))};return window.addEventListener("storage",e),()=>window.removeEventListener("storage",e)},[I]),t.useEffect(()=>{E(null!=e?e:w)},[e,w]);let U=t.useMemo(()=>({theme:w,setTheme:I,forcedTheme:e,resolvedTheme:"system"===w?A:w,themes:o?[...u,"system"]:u,systemTheme:o?A:void 0}),[w,I,e,A,o,u]);return t.createElement(i.Provider,{value:U},t.createElement(h,{forcedTheme:e,storageKey:l,attribute:p,enableSystem:o,enableColorScheme:a,defaultTheme:g,value:y,themes:u,nonce:T,scriptProps:S}),k)},h=t.memo(({forcedTheme:e,storageKey:r,attribute:n,enableSystem:s,enableColorScheme:a,defaultTheme:i,value:l,themes:c,nonce:u,scriptProps:h})=>{let d=JSON.stringify([n,r,i,e,c,l,s,a]).slice(1,-1);return t.createElement("script",{...h,suppressHydrationWarning:!0,nonce:"undefined"==typeof window?u:"",dangerouslySetInnerHTML:{__html:`(${o.toString()})(${d})`}})}),d=(e,r)=>{let t;if(!a){try{t=localStorage.getItem(e)||void 0}catch(e){}return t||r}},m=e=>{let r=document.createElement("style");return e&&r.setAttribute("nonce",e),r.appendChild(document.createTextNode("*,*::before,*::after{-webkit-transition:none!important;-moz-transition:none!important;-o-transition:none!important;-ms-transition:none!important;transition:none!important}")),document.head.appendChild(r),()=>{window.getComputedStyle(document.body),setTimeout(()=>{document.head.removeChild(r)},1)}},f=e=>(e||(e=window.matchMedia(s)),e.matches?"dark":"light");function g({children:e,...t}){return(0,r.jsx)(l,{...t,children:e})}e.s(["ThemeProvider",()=>g],89554)},94433,e=>{"use strict";var r=e.i(43476),t=e.i(91432);function o({children:e}){return(0,r.jsx)(t.AuthProvider,{children:e})}e.s(["AuthProvider",()=>o])}]);