module.exports=[96851,e=>{"use strict";var t=e.i(47909),i=e.i(74017),a=e.i(96250),r=e.i(59756),n=e.i(61916),s=e.i(14444),o=e.i(37092),l=e.i(69741),c=e.i(16795),d=e.i(87718),u=e.i(95169),p=e.i(47587),v=e.i(66012),g=e.i(70101),A=e.i(26937),h=e.i(10372),m=e.i(93695);e.i(52474);var y=e.i(220),R=e.i(89171),f=e.i(81563),T=e.i(42513),I=e.i(73716),k=e.i(15270),E=e.i(83522);async function C(t,{params:i}){try{var a,r,n,s;let o,l,c,d=await (0,f.requireAuth)(t);if("status"in d)return d;let{user:u}=d,{id:p}=await i;console.log(`[QPRO Analysis Detail] Fetching analysis: ${p}`),await I.qproCacheService.getAnalysisCache(p)&&console.log(`[QPRO Analysis Detail] Cache hit for analysis: ${p}`);let v=await T.qproAnalysisService.getQPROAnalysisById(p);if(!v)return R.NextResponse.json({error:"Analysis not found"},{status:404});if(console.log(`[QPRO Analysis Detail] Status: ${v.status}`),console.log("[QPRO Analysis Detail] activities count:",v.activities?.length||0),console.log("[QPRO Analysis Detail] kras count:",v.kras?.length||0),console.log("[QPRO Analysis Detail] prescriptiveAnalysis exists:",!!v.prescriptiveAnalysis),v.prescriptiveAnalysis&&(console.log("[QPRO Analysis Detail] prescriptiveAnalysis type:",typeof v.prescriptiveAnalysis),console.log("[QPRO Analysis Detail] prescriptiveAnalysis keys:","object"==typeof v.prescriptiveAnalysis?Object.keys(v.prescriptiveAnalysis):"N/A")),v.activities&&Array.isArray(v.activities)&&v.activities.length>0){let e=v.activities[0];console.log("[QPRO Analysis Detail] First activity:",JSON.stringify(e,null,2))}if(v.kras&&Array.isArray(v.kras)&&v.kras.length>0){let e=v.kras[0];console.log("[QPRO Analysis Detail] First KRA:",JSON.stringify(e,null,2))}if(v.uploadedById!==u.id&&"ADMIN"!==u.role)return R.NextResponse.json({error:"Unauthorized"},{status:403});let g=v.analysisResult?"COMPLETED":"PENDING",A={id:v.id,title:v.documentTitle,year:v.year,quarter:v.quarter,uploadedDate:v.createdAt,status:g,extractedSections:(a=v,o=new Map,a.activities&&Array.isArray(a.activities)&&a.activities.forEach(e=>{let t,i=((t=(e.name||"").toLowerCase()).includes("train")||t.includes("seminar")||t.includes("workshop")?"TRAINING":t.includes("research")||t.includes("paper")||t.includes("publication")?"RESEARCH":t.includes("alumni")||t.includes("employment")||t.includes("graduate")?"ALUMNI_EMPLOYMENT":null)||"OTHER";o.has(i)||o.set(i,[]),o.get(i).push(e.name||"Unnamed activity")}),l=[],0===o.size?l.push({title:"Training Activities",type:"TRAINING",activities:["Training and professional development activities"]},{title:"Research Activities",type:"RESEARCH",activities:["Research outputs and publications"]},{title:"Alumni Engagement",type:"ALUMNI_EMPLOYMENT",activities:["Alumni employment and career tracking"]}):o.forEach((e,t)=>{var i;l.push({title:{TRAINING:"Training & Professional Development",RESEARCH:"Research & Publications",ALUMNI_EMPLOYMENT:"Alumni Engagement & Employment",OTHER:"Other Activities"}[i=t]||i,type:t,activities:e})}),l),kraClassifications:function(t){let i={},a={},r={},n={},s=e.r(23257).kras||[],o=t.year||2025;console.log("[formatKRAClassifications] activities count:",t.activities?.length||0),console.log("[formatKRAClassifications] kras count:",t.kras?.length||0);let l=!1;if(t.activities&&Array.isArray(t.activities)&&t.activities.length>0){let e=t.activities[0];l=!!(e.kraId||e.kra_id||e.kra)}if(console.log("[formatKRAClassifications] activitiesHaveKraId:",l),!l&&t.kras&&Array.isArray(t.kras)){let e=0;if(t.kras.forEach(t=>{let s=t.kraId||t.id||"",o=t.activities||[];e+=o.length,i[s]=o.length,a[s]||(a[s]=[]),o.forEach(e=>{a[s].push({reported:e.reported||0,target:e.target||0,achievement:e.achievement||0,targetType:e.targetType,initiativeId:e.initiativeId}),e.initiativeId&&!n[s]&&(n[s]=e.initiativeId)}),t.kraTitle&&(r[s]=t.kraTitle),t.initiativeId&&!n[s]&&(n[s]=t.initiativeId)}),0===e&&t.activities&&Array.isArray(t.activities)){let e=t.activities.length,r=t.kras;if(1===r.length&&e>0){let s=r[0].kraId||r[0].id;i[s]=e,console.log(`[formatKRAClassifications] Assigned ${e} activities to single KRA: ${s}`),a[s]||(a[s]=[]),t.activities.forEach(e=>{a[s].push({reported:e.reported||0,target:e.target||0,achievement:e.achievement||0,targetType:e.targetType,initiativeId:e.initiativeId}),e.initiativeId&&!n[s]&&(n[s]=e.initiativeId)}),r[0].initiativeId&&!n[s]&&(n[s]=r[0].initiativeId),console.log(`[formatKRAClassifications] Stored ${a[s].length} activities for aggregation`)}else e>0&&(i.UNCLASSIFIED=e,console.log(`[formatKRAClassifications] ${e} activities are unclassified (multiple KRAs)`))}console.log("[formatKRAClassifications] Final activity counts:",i)}else t.activities&&Array.isArray(t.activities)&&t.activities.forEach((e,t)=>{let s=e.kraId||e.kra_id||e.kra||"UNCLASSIFIED";t<3&&console.log(`[formatKRAClassifications] Activity ${t}:`,{name:e.name?.substring(0,30),kraId:e.kraId,kra_id:e.kra_id,kra:e.kra,resolved:s}),i[s]=(i[s]||0)+1,a[s]||(a[s]=[]),a[s].push({reported:e.reported||0,target:e.target||0,achievement:e.achievement||0,targetType:e.targetType,initiativeId:e.initiativeId}),e.initiativeId&&!n[s]&&(n[s]=e.initiativeId),!r[s]&&(e.kraTitle||e.kra_title)&&(r[s]=e.kraTitle||e.kra_title)});let c=(e,t)=>{if(0===t.length)return 0;let i=n[e],a=(0,E.getInitiativeTargetMeta)({kras:s},e,i,o),r="number"==typeof t[0]?.target?t[0].target:Number(t[0]?.target||0),l=a.targetValue??(Number.isFinite(r)&&r>0?r:0),c=(0,E.computeAggregatedAchievement)({targetType:a.targetType||t[0]?.targetType,targetValue:l,targetScope:a.targetScope,activities:t});return console.log(`[formatKRAClassifications] KRA ${e} aggregation:`,{targetType:a.targetType||t[0]?.targetType,targetValue:l,totalReported:c.totalReported,achievementPercent:c.achievementPercent}),c.achievementPercent};if(!t.kras||!Array.isArray(t.kras)||0===t.kras.length){let e=[];return Object.keys(i).forEach(t=>{let n=a[t]||[],s=c(t,n);e.push({id:t,title:S(t,r[t]),count:i[t]||0,achievementRate:Math.round(100*s)/100,strategicAlignment:""})}),e}return console.log("[formatKRAClassifications] kraActivityCounts:",i),t.kras.map((e,t)=>{let r=e.kraId||e.id||"";t<3&&console.log(`[formatKRAClassifications] KRA ${t}:`,{kraId:e.kraId,id:e.id,resolved:r,activitiesCount:e.activities?.length});let n=i[r]||0,s=e.activities&&Array.isArray(e.activities)?e.activities.length:0,o=n>0?n:s;console.log(`[formatKRAClassifications] KRA ${r}: countFromActivities=${n}, embeddedCount=${s}, finalCount=${o}`);let l=a[r]||[],d=0;return d=l.length>0?c(r,l):e.achievementRate||0,console.log(`[formatKRAClassifications] KRA ${r}: activitiesData.length=${l.length}, achievementRate=${d}`),{id:r||`kra-${Math.random()}`,title:S(r,e.kraTitle||e.title),count:o,achievementRate:Math.round(100*d)/100,strategicAlignment:e.strategicAlignment||""}})}(v),organizedActivities:function(t){let i={},a=e.r(23257).kras||[],r=(e,t,i,r)=>{let n=Array.from(new Set(t.map(e=>e.initiativeId).filter(Boolean).map(e=>String(e))))[0]||r,s=(0,E.getInitiativeTargetMeta)({kras:a},e,n,i),o="number"==typeof t?.[0]?.initiativeTarget?t[0].initiativeTarget:"number"==typeof t?.[0]?.target?t[0].target:Number(t?.[0]?.target||0),l=s.targetValue??(Number.isFinite(o)&&o>0?o:0),c=(0,E.computeAggregatedAchievement)({targetType:s.targetType,targetValue:l,targetScope:s.targetScope,activities:t}),d=c.achievementPercent;return{totalTarget:c.totalTarget,totalReported:c.totalReported,completionPercentage:Math.round(Math.min(100,Math.max(0,d))),isRateMetric:"percentage"===String(s.targetType||"").toLowerCase()}},n=!1;if(t.activities&&Array.isArray(t.activities)&&t.activities.length>0){let e=t.activities[0];n=!(e.kraId||e.kra_id||e.kra)}else n=!0;if(console.log(`[ORGANIZE] useEmbeddedActivities: ${n}`),n&&t.kras&&Array.isArray(t.kras)){let e=t.kras;console.log(`[ORGANIZE] Using embedded activities from ${e.length} KRAs`);let a=0;if(e.forEach(e=>{a+=(e.activities||[]).length}),0===a&&t.activities&&Array.isArray(t.activities)&&1===e.length){let a=e[0],n=a.kraId||a.id;console.log(`[ORGANIZE] Fallback: assigning ${t.activities.length} top-level activities to single KRA: ${n}`),i[n]={kraId:n,kraTitle:S(n,a.kraTitle||a.title),kpiId:a.initiativeId||"",kpiTitle:"",activities:[],activityCount:0,totalTarget:0,totalReported:0,completionPercentage:0},t.activities.forEach(e=>{let t=e.target||e.targetValue||0,a=e.reported||e.accomplishedValue||0,r=e.achievement||(t>0?a/t*100:0);i[n].activities.push({title:e.name||e.activityTitle||e.title||"Unnamed",initiativeId:e.initiativeId||e.initiative_id||i[n].kpiId||"",target:t,reported:a,achievement:Math.round(100*r)/100,status:r>=100?"MET":a>0?"PARTIAL":"NOT_STARTED",confidence:e.confidence||.75,description:e.description||`Target: ${t}, Reported: ${a}`,aiInsight:e.aiInsight||"",prescriptiveAnalysis:e.prescriptiveAnalysis||"",rootCause:e.rootCause||""}),i[n].activityCount++});let s=r(n,i[n].activities,Number(t.year)||2025,i[n].kpiId);return i[n].totalTarget=s.totalTarget,i[n].totalReported=s.totalReported,i[n].completionPercentage=s.completionPercentage,i[n].totalTarget>0||"number"!=typeof a.achievementRate||(i[n].completionPercentage=Math.round(a.achievementRate||0)),i[n].status=i[n].completionPercentage>=100?"MET":i[n].completionPercentage>=70?"ON_TRACK":i[n].completionPercentage>0?"PARTIAL":"NOT_STARTED",Object.values(i)}return e.forEach(e=>{let t=e.kraId||e.id;if(!t)return;let a=e.activities||[];i[t]||(i[t]={kraId:t,kraTitle:S(t,e.kraTitle||e.title),kpiId:e.initiativeId||"",kpiTitle:"",activities:[],activityCount:0,totalTarget:0,totalReported:0,completionPercentage:0}),a.forEach(e=>{let a=e.target||e.targetValue||0,r=e.reported||e.accomplishedValue||0,n=e.achievement||(a>0?r/a*100:0);i[t].activities.push({title:e.name||e.activityTitle||e.title||"Unnamed",initiativeId:e.initiativeId||e.initiative_id||i[t].kpiId||"",target:a,reported:r,achievement:Math.round(100*n)/100,status:n>=100?"MET":r>0?"PARTIAL":"NOT_STARTED",confidence:e.confidence||.75,description:e.description||`Target: ${a}, Reported: ${r}`,aiInsight:e.aiInsight||"",prescriptiveAnalysis:e.prescriptiveAnalysis||"",rootCause:e.rootCause||""}),i[t].activityCount++});let n=r(t,i[t].activities,i[t].kpiId);i[t].totalTarget=n.totalTarget,i[t].totalReported=n.totalReported,i[t].completionPercentage=n.completionPercentage,i[t].completionPercentage>=100?i[t].status="MET":i[t].completionPercentage>=70?i[t].status="ON_TRACK":i[t].completionPercentage>0?i[t].status="PARTIAL":i[t].status="NOT_STARTED"}),Object.values(i)}return t.activities&&Array.isArray(t.activities)?(console.log(`[ORGANIZE] Processing ${t.activities.length} activities from top-level`),t.activities.forEach(e=>{let t=e.kraId||e.kra_id||e.kra||"UNCLASSIFIED";if(!t||""===t)return void console.log("[ORGANIZE] Skipping activity with empty kraId:",e.name);let a=e.initiativeId||e.initiative_id||"";i[t]||(i[t]={kraId:t,kraTitle:S(t,e.kraTitle||e.kra_title),kpiId:a,kpiTitle:e.kpiTitle||e.kpi_title||a||"",activities:[],activityCount:0,totalTarget:0,totalReported:0,completionPercentage:0});let r=e.target||e.targetValue||e.target_value||0,n=e.reported||e.accomplishedValue||e.reported_value||0,s=e.achievement||(r>0?n/r*100:0);i[t].activities.push({title:e.name||e.activityTitle||e.title||"Unnamed",target:r,reported:n,achievement:Math.round(100*s)/100,status:s>=100?"MET":n>0?"PARTIAL":"NOT_STARTED",confidence:e.confidence||.75,description:e.description||`Target: ${r}, Reported: ${n}`,date:e.date||void 0,unit:e.unit||void 0,aiInsight:e.aiInsight||"",prescriptiveAnalysis:e.prescriptiveAnalysis||"",rootCause:e.rootCause||""}),i[t].activityCount++}),Object.keys(i).forEach(e=>{let t=i[e];if(t.totalTarget>0)t.completionPercentage=Math.round(t.totalReported/t.totalTarget*100);else if(t.activities.length>0){let e=t.activities.reduce((e,t)=>e+t.achievement,0)/t.activities.length;t.completionPercentage=Math.round(e)}else t.completionPercentage=0;t.completionPercentage>=100?t.status="MET":t.completionPercentage>=70?t.status="ON_TRACK":t.completionPercentage>0?t.status="PARTIAL":t.status="NOT_STARTED"}),Object.values(i)):(console.log("[ORGANIZE] No activities array found in analysis"),[])}(v),insights:v.analysisResult?(r=v.analysisResult,["Strong Faculty Skill Development Initiative: Faculty training across technical domains with focus on emerging technologies","Solid Research Output: Research papers published and aligned with institutional needs, supporting curriculum","Alumni Tracking System Functional: Initial tracking system operational with employment data collected"]):[],recommendations:v.recommendations&&(n=v.recommendations)&&Array.isArray(n)?n.map(e=>({number:e.id,priority:e.priority||"MEDIUM",title:e.title||e.recommendationText||"Recommendation",currentState:e.currentState||"Unknown",targetState:e.targetState||"Unknown",actions:e.actions||[],timeline:e.timeline||"1 month",owner:e.owner||"To be assigned",successMetric:e.successMetric||"Completion of action items"})):[],alignment:v.alignment||"",opportunities:v.opportunities||"",gaps:v.gaps||"",prescriptiveAnalysis:function(e){if(!e)return null;if("object"==typeof e&&("string"==typeof e.documentInsight||"string"==typeof e.prescriptiveAnalysis||Array.isArray(e.prescriptiveItems))||e.recommendations||e.action_items)return e;if("string"==typeof e)return{recommendations:e};let t=Object.values(e);if(0===t.length)return null;let i=[],a=[],r=[],n=[];return t.forEach(e=>{if(e.prescriptiveAnalysis){let t=e.kraTitle||e.kraId||"General",a=void 0!==e.achievementRate?` (${e.achievementRate.toFixed(1)}% achievement)`:"";i.push(`### ${t}${a}
${e.prescriptiveAnalysis}`)}if(e.rootCause){let t=e.kraTitle||e.kraId||"Unknown KRA";a.push(`**${t}**: ${e.rootCause}`)}e.actionItems&&Array.isArray(e.actionItems)&&r.push(...e.actionItems),e.missedActivities&&Array.isArray(e.missedActivities)&&e.missedActivities.forEach(e=>{let t=`${e.name}: ${e.achievement?.toFixed(1)||0}% achieved (${e.reported||0}/${e.target||0})`;n.push(t)})}),{recommendations:i.join("\n\n")||null,root_cause:a.join("\n\n")||null,gaps:a.length>0?a.join("\n\n"):null,action_items:r.length>0?r:null,missed_activities:n.length>0?n:null}}(v.prescriptiveAnalysis&&Object.keys(v.prescriptiveAnalysis).length>0?v.prescriptiveAnalysis:function(e){if(!e||!Array.isArray(e))return{};let t={};return e.forEach(e=>{let i=e.kraId||e.id;i&&(e.prescriptiveAnalysis||e.rootCause||e.actionItems?.length>0)&&(t[i]={kraId:i,kraTitle:e.kraTitle||e.title||i,achievementRate:e.achievementRate||0,prescriptiveAnalysis:e.prescriptiveAnalysis||"",rootCause:e.rootCause||"",actionItems:e.actionItems||[],missedActivities:(e.activities||[]).filter(e=>"MISSED"===e.status||void 0!==e.achievement&&e.achievement<100).map(e=>({name:e.name,reported:e.reported,target:e.target,achievement:e.achievement}))})}),console.log("[extractPrescriptiveFromKRAs] Extracted keys:",Object.keys(t)),t}(v.kras)),achievementMetrics:{overallScore:parseFloat((v.achievementScore||0).toFixed(2)),completeness:(s=v,c=0,s.activities&&c++,s.kras&&c++,s.alignment&&c++,s.opportunities&&c++,s.recommendations&&c++,Math.round(c/5*100)),currentState:`${v.kras&&Array.isArray(v.kras)?v.kras.length:0} KRAs with ${v.activities&&Array.isArray(v.activities)?v.activities.length:0} activities`,targetState:"Full alignment with strategic plan objectives"},activities:v.activities||[]};return R.NextResponse.json(A,{headers:{"Cache-Control":"no-store, no-cache, must-revalidate, proxy-revalidate",Pragma:"no-cache",Expires:"0"}})}catch(e){return console.error("[QPRO Analysis Detail] Error:",e),R.NextResponse.json({error:"Failed to fetch analysis details"},{status:500})}}let P={"KRA 1":"Development of New Curricula","KRA 2":"Accreditation","KRA 3":"Quality and Relevance of Instruction","KRA 4":"International Activities","KRA 5":"Research Outputs","KRA 6":"Extension Programs","KRA 7":"Community Partnerships","KRA 8":"Technology Transfer","KRA 9":"Revenue Generation","KRA 10":"Resource Mobilization","KRA 11":"Human Resource Management","KRA 12":"Student Development","KRA 13":"Health and Wellness","KRA 14":"Environmental Sustainability","KRA 15":"Quality Management","KRA 16":"Governance","KRA 17":"Digital Transformation",UNCLASSIFIED:"Uncategorized Activities"};function S(e,t){return P[e]||t||e}async function O(e,{params:t}){try{let i=await (0,f.requireAuth)(e);if("status"in i)return i;let{user:a}=i,{id:r}=await t;if(console.log(`[QPRO Analysis PATCH] Updating analysis: ${r}`),!["ADMIN","FACULTY"].includes(a.role))return R.NextResponse.json({error:"Insufficient permissions. Only ADMIN or FACULTY can edit analyses."},{status:403});let{activities:n,kras:s}=await e.json();console.log(`[QPRO Analysis PATCH] Received ${n?.length||0} activities, ${s?.length||0} kras`);let o=await k.default.qPROAnalysis.findUnique({where:{id:r}});if(!o)return R.NextResponse.json({error:"Analysis not found"},{status:404});if("DRAFT"!==o.status)return R.NextResponse.json({error:"Only DRAFT analyses can be edited. This analysis is already "+o.status},{status:400});let l={};if(n&&Array.isArray(n)){let e=n.map(e=>({name:e.name,kraId:e.kraId,initiativeId:e.initiativeId||"",reported:e.reported||0,target:e.target||0,achievement:e.achievement||0,status:e.status||"MISSED",confidence:e.confidence||.75,unit:e.unit||"",evidenceSnippet:e.evidenceSnippet||"",dataType:e.dataType||"count",aiInsight:e.aiInsight||"",prescriptiveAnalysis:e.prescriptiveAnalysis||"",rootCause:e.rootCause||"",authorizedStrategy:e.authorizedStrategy||""}));l.activities=e;let t=e.length;e.filter(e=>"MET"===e.status).length;let i=t>0?e.reduce((e,t)=>e+(t.achievement||0),0)/t:0;l.achievementScore=Math.round(100*i)/100,console.log(`[QPRO Analysis PATCH] Updated achievementScore: ${l.achievementScore}`)}if(s&&Array.isArray(s))l.kras=s;else if(n&&Array.isArray(n)){let e=new Map;n.forEach(t=>{let i=t.kraId;if(!i)return;e.has(i)||e.set(i,{kraId:i,kraTitle:S(i,t.kraTitle),initiativeId:t.initiativeId||"",activities:[],totalReported:0,totalTarget:0});let a=e.get(i);a.activities.push(t),a.totalReported+=t.reported||0,a.totalTarget+=t.target||0});let t=Array.from(e.values()).map(e=>({...e,achievementRate:e.totalTarget>0?Math.round(e.totalReported/e.totalTarget*1e4)/100:0,status:e.totalTarget>0&&e.totalReported/e.totalTarget>=1?"MET":"MISSED"}));l.kras=t,console.log(`[QPRO Analysis PATCH] Rebuilt ${t.length} KRAs from activities`)}let c=await k.default.qPROAnalysis.update({where:{id:r},data:l});if(n&&Array.isArray(n)){for(let e of n)await k.default.aggregationActivity.updateMany({where:{qpro_analysis_id:r,activity_name:e.name},data:{reported:e.reported,target:e.target,initiative_id:e.initiativeId}});console.log("[QPRO Analysis PATCH] Updated staged activities")}return await I.qproCacheService.invalidateAnalysisCache(r),o.uploadedById&&await I.qproCacheService.invalidateUserAnalysesCache(o.uploadedById),console.log(`[QPRO Analysis PATCH] Successfully updated analysis ${r}`),R.NextResponse.json({success:!0,message:"Analysis updated successfully",analysis:{id:c.id,status:c.status,achievementScore:c.achievementScore,activitiesCount:c.activities?.length||0,krasCount:c.kras?.length||0}})}catch(e){return console.error("[QPRO Analysis PATCH] Error:",e),R.NextResponse.json({error:"Failed to update analysis"},{status:500})}}e.s(["GET",()=>C,"PATCH",()=>O],45399);var N=e.i(45399);let w=new t.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/qpro/analyses/[id]/route",pathname:"/api/qpro/analyses/[id]",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/qpro/analyses/[id]/route.ts",nextConfigOutput:"standalone",userland:N}),{workAsyncStorage:M,workUnitAsyncStorage:b,serverHooks:$}=w;function K(){return(0,a.patchFetch)({workAsyncStorage:M,workUnitAsyncStorage:b})}async function _(e,t,a){w.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let R="/api/qpro/analyses/[id]/route";R=R.replace(/\/index$/,"")||"/";let f=await w.prepare(e,t,{srcPage:R,multiZoneDraftMode:!1});if(!f)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:T,params:I,nextConfig:k,parsedUrl:E,isDraftMode:C,prerenderManifest:P,routerServerContext:S,isOnDemandRevalidate:O,revalidateOnlyGenerated:N,resolvedPathname:M,clientReferenceManifest:b,serverActionsManifest:$}=f,K=(0,l.normalizeAppPath)(R),_=!!(P.dynamicRoutes[K]||P.routes[M]),x=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,E,!1):t.end("This page could not be found"),null);if(_&&!C){let e=!!P.routes[M],t=P.dynamicRoutes[K];if(t&&!1===t.fallback&&!e){if(k.experimental.adapterPath)return await x();throw new m.NoFallbackError}}let D=null;!_||w.isDev||C||(D="/index"===(D=M)?"/":D);let U=!0===w.isDev||!_,F=_&&!U;$&&b&&(0,s.setReferenceManifestsSingleton)({page:R,clientReferenceManifest:b,serverActionsManifest:$,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:$})});let H=e.method||"GET",j=(0,n.getTracer)(),q=j.getActiveScopeSpan(),L={params:I,prerenderManifest:P,renderOpts:{experimental:{authInterrupts:!!k.experimental.authInterrupts},cacheComponents:!!k.cacheComponents,supportsDynamicResponse:U,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:k.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,i,a)=>w.onRequestError(e,t,a,S)},sharedContext:{buildId:T}},Q=new c.NodeNextRequest(e),G=new c.NodeNextResponse(t),V=d.NextRequestAdapter.fromNodeNextRequest(Q,(0,d.signalFromNodeResponse)(t));try{let s=async e=>w.handle(V,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let i=j.getRootSpanAttributes();if(!i)return;if(i.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${i.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=i.get("next.route");if(a){let t=`${H} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${R}`)}),o=!!(0,r.getRequestMeta)(e,"minimalMode"),l=async r=>{var n,l;let c=async({previousCacheEntry:i})=>{try{if(!o&&O&&N&&!i)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await s(r);e.fetchMetrics=L.renderOpts.fetchMetrics;let l=L.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let c=L.renderOpts.collectedTags;if(!_)return await (0,v.sendResponse)(Q,G,n,L.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(n.headers);c&&(t[h.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let i=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,a=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:y.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:i,expire:a}}}}catch(t){throw(null==i?void 0:i.isStale)&&await w.onRequestError(e,t,{routerKind:"App Router",routePath:R,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:O})},S),t}},d=await w.handleResponse({req:e,nextConfig:k,cacheKey:D,routeKind:i.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:P,isRoutePPREnabled:!1,isOnDemandRevalidate:O,revalidateOnlyGenerated:N,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:o});if(!_)return null;if((null==d||null==(n=d.value)?void 0:n.kind)!==y.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",O?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),C&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,g.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&_||u.delete(h.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,A.getCacheControlHeader)(d.cacheControl)),await (0,v.sendResponse)(Q,G,new Response(d.value.body,{headers:u,status:d.value.status||200})),null};q?await l(q):await j.withPropagatedContext(e.headers,()=>j.trace(u.BaseServerSpan.handleRequest,{spanName:`${H} ${R}`,kind:n.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},l))}catch(t){if(t instanceof m.NoFallbackError||await w.onRequestError(e,t,{routerKind:"App Router",routePath:K,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:O})}),_)throw t;return await (0,v.sendResponse)(Q,G,new Response(null,{status:500})),null}}e.s(["handler",()=>_,"patchFetch",()=>K,"routeModule",()=>w,"serverHooks",()=>$,"workAsyncStorage",()=>M,"workUnitAsyncStorage",()=>b],96851)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_afad937b.js.map