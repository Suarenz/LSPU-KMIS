module.exports=[71542,e=>{"use strict";var t=e.i(47909),a=e.i(74017),i=e.i(96250),r=e.i(59756),n=e.i(61916),s=e.i(14444),o=e.i(37092),l=e.i(69741),d=e.i(16795),u=e.i(87718),p=e.i(95169),c=e.i(47587),v=e.i(66012),g=e.i(70101),y=e.i(26937),A=e.i(10372),h=e.i(93695);e.i(52474);var f=e.i(220),m=e.i(89171),w=e.i(81563),R=e.i(15270),_=e.i(84101),I=e.i(74382),C=e.i(73716),P=e.i(83522);async function q(e,{params:t}){try{console.log("[Approve API] POST request received");let a=await (0,w.requireAuth)(e);if("status"in a)return a;let{user:i}=a,{id:r}=await t;if(console.log(`[Approve API] Approving analysis ${r} by user ${i.email} (${i.role})`),!["ADMIN","FACULTY"].includes(i.role))return m.NextResponse.json({error:"Insufficient permissions. Only ADMIN or FACULTY can approve analyses."},{status:403});let n=await R.default.qPROAnalysis.findUnique({where:{id:r},include:{unit:!0,user:!0}});if(!n)return m.NextResponse.json({error:"Analysis not found"},{status:404});if("APPROVED"===n.status)return m.NextResponse.json({error:"Analysis is already approved"},{status:400});let s=await R.default.aggregationActivity.findMany({where:{qpro_analysis_id:r,isApproved:!1}}),o=e=>{if(null==e)return null;let t="number"==typeof e?e:Number(String(e).replace(/,/g,"").trim());return Number.isFinite(t)?t:null},l=(e,t)=>{let a=o(e);if(null===a)return null;if(a>=0&&a<=100)return a;let i=o(t);if(null!==i&&i>0&&a>=0){let e=a/i*100;if(e>=0&&e<=100)return e}return null};console.log(`[Approve API] Approving analysis ${r} with ${s.length} staged activities`);let d=n.kras;if(0===s.length)return m.NextResponse.json({error:"No staged activities found to approve"},{status:400});let u=new Map;for(let e of s)if(e.initiative_id){let t=e.initiative_id.match(/^(KRA\s?\d+)/i),a=t?t[1]:null;if(a){let t=`${a}|${e.initiative_id}`;u.has(t)||u.set(t,{kraId:a,initiativeId:e.initiative_id})}}console.log(`[Approve API] Found ${u.size} unique KRA+initiative pairs from staged activities`),await R.default.$transaction(async e=>{for(let[,t]of(console.log("[Approve API] Preserving prescriptiveAnalysis:",n.prescriptiveAnalysis?"exists":"null",typeof n.prescriptiveAnalysis),await e.qPROAnalysis.update({where:{id:r},data:{status:"APPROVED",approvedAt:new Date,approvedById:i.id,prescriptiveAnalysis:n.prescriptiveAnalysis||void 0}}),console.log(`[Approve API] Processing ${u.size} unique KRA+Initiative pairs`),u)){let{kraId:a,initiativeId:o}=t,u=(0,P.normalizeKraId)(a);console.log(`[Approve API] Processing pair: KRA=${a} (normalized: ${u}), Initiative=${o}`);let p=n.year||2025,c=n.quarter||1,v=await e.kPITarget.findFirst({where:{kra_id:u,initiative_id:o,year:p,quarter:c}}),g=await I.default.getInitiative(u,o),y=v?v.target_type.toLowerCase():(g?.targets?.type||"count").toLowerCase(),A=s.filter(e=>e.initiative_id===o),h=A.map(e=>"number"==typeof e.reported?e.reported:null).filter(e=>null!=e),f=(()=>{if("percentage"===y){let e=A.map(e=>l(e.reported,e.target)).filter(e=>null!==e);if(0===e.length)return 0;let t=e.reduce((e,t)=>e+t,0)/e.length;return Math.round(t)}return 0===h.length?0:h.reduce((e,t)=>e+t,0)})(),m=await e.kRAggregation.findUnique({where:{unique_aggregation:{year:p,quarter:c,kra_id:u,initiative_id:o}}}),w=m?.total_reported??0;m?.submission_count;let R=m?.participating_units||[],C=!n.unitId||R.includes(n.unitId)?R:[...R,n.unitId],q="snapshot"===y?f:w+f,E=v?v.target_value.toNumber():g?.targets?.timeline_data?.find(e=>e.year===p)?.target_value||1,x=(m?.submission_count??0)+1,T=(()=>{let e=y.toLowerCase();return"rate"===e||"percentage"===e?q/x:q})(),$=await _.default.calculateAggregation(u,o,p,T,y),N=d?.find(e=>(0,P.normalizeKraId)(e.kra_id||e.kraId)===u),k=N?.kra_title||N?.kraTitle||u,b=await (async()=>m?e.kRAggregation.update({where:{id:m.id},data:{total_reported:q,submission_count:{increment:1},target_type:y.toUpperCase(),achievement_percent:$.achievementPercent,status:$.status,last_updated:new Date,updated_by:i.id,participating_units:C}}):e.kRAggregation.create({data:{year:p,quarter:c,kra_id:u,kra_title:k,initiative_id:o,total_reported:q,target_value:E,target_type:y.toUpperCase(),achievement_percent:$.achievementPercent,submission_count:1,participating_units:C,status:$.status,updated_by:i.id}}))();if(await e.aggregationActivity.updateMany({where:{qpro_analysis_id:r,initiative_id:o,isApproved:!1},data:{aggregation_id:b.id,isApproved:!0}}),!y||"string"!=typeof y)throw console.error(`[Approve API] ⚠️  CRITICAL: Invalid target_type for ${o}. Got: ${y} (type: ${typeof y})`),Error(`Invalid target_type for ${o}: expected string, got ${typeof y}`);let S=y.toLowerCase().trim();["count","snapshot","rate","percentage","milestone","boolean","financial","text_condition"].includes(S)||console.warn(`[Approve API] ⚠️  Unusual target_type "${S}" for ${o}, defaulting to "count"`),console.log(`[Approve API] ✓ Validated target_type for ${o}: "${S}" (source: ${v?"database":"strategic plan"})`);let O=await e.kPIContribution.upsert({where:{unique_contribution_per_analysis_kpi:{analysis_id:r,initiative_id:o}},create:{kra_id:u,initiative_id:o,document_id:n.documentId,analysis_id:r,unit_id:n.unitId,value:f,year:p,quarter:c,target_type:S,created_by:i.id},update:{value:f,target_type:S}});console.log(`[Approve API] ✓ Created/Updated KPIContribution: analysis=${r}, unit=${n.unitId}, kpi=${o}, Q${c} ${p}, value=${f}, target_type="${S}", id=${O.id}`)}}),console.log(`[Approve API] Successfully approved analysis ${r} with ${u.size} KPI aggregations`);let p=await R.default.qPROAnalysis.findUnique({where:{id:r},select:{documentId:!0,uploadedById:!0}});p&&(await C.qproCacheService.invalidateAnalysisCache(p.documentId),await C.qproCacheService.invalidateUserAnalysesCache(p.uploadedById));let c=await R.default.qPROAnalysis.findUnique({where:{id:r},include:{unit:!0,user:!0}});return m.NextResponse.json({success:!0,message:"Analysis approved and committed to dashboard",analysis:{id:c?.id,status:c?.status,approvedAt:c?.approvedAt,achievementScore:c?.achievementScore}})}catch(e){return console.error("[Approve API] Error:",e),m.NextResponse.json({error:"Failed to approve analysis"},{status:500})}}async function E(e,{params:t}){try{let a=await (0,w.requireAuth)(e);if("status"in a)return a;let{user:i}=a,{id:r}=await t;if(!["ADMIN","FACULTY"].includes(i.role))return m.NextResponse.json({error:"Insufficient permissions. Only ADMIN or FACULTY can reject analyses."},{status:403});let n=(await e.json().catch(()=>({}))).reason||"Rejected by reviewer",s=await R.default.qPROAnalysis.update({where:{id:r},data:{status:"REJECTED",prescriptiveAnalysis:{rejectionReason:n,rejectedBy:i.id,rejectedAt:new Date().toISOString()}}});await R.default.aggregationActivity.deleteMany({where:{qpro_analysis_id:r,isApproved:!1}}),console.log(`[Approve API] Rejected analysis ${r}: ${n}`);let o=await R.default.qPROAnalysis.findUnique({where:{id:r},select:{documentId:!0,uploadedById:!0}});return o&&(await C.qproCacheService.invalidateAnalysisCache(o.documentId),await C.qproCacheService.invalidateUserAnalysesCache(o.uploadedById)),m.NextResponse.json({success:!0,message:"Analysis rejected",analysis:{id:s.id,status:s.status}})}catch(e){return console.error("[Approve API] Reject error:",e),m.NextResponse.json({error:"Failed to reject analysis"},{status:500})}}async function x(e,{params:t}){try{let a=await (0,w.requireAuth)(e);if("status"in a)return a;let{id:i}=await t,r=await R.default.qPROAnalysis.findUnique({where:{id:i},include:{unit:!0,user:!0}});if(!r)return m.NextResponse.json({error:"Analysis not found"},{status:404});let n=await R.default.aggregationActivity.findMany({where:{qpro_analysis_id:i},orderBy:{created_at:"asc"}}),s=r.kras||[],o=r.activities||[],l=r.prescriptiveAnalysis||{},d={id:r.id,documentTitle:r.documentTitle,documentType:r.documentType,status:r.status,uploadedBy:r.user?.name||"Unknown",unit:r.unit?.name||"Unknown",year:r.year,quarter:r.quarter,achievementScore:r.achievementScore,createdAt:r.createdAt,kras:s.map(e=>({kraId:e.kraId,kraTitle:e.kraTitle,initiativeId:e.initiativeId,achievementRate:e.achievementRate,status:e.status,prescriptive:l[e.kraId]||null})),activities:o.map(e=>{let t=n.find(t=>t.initiative_id===e.initiativeId&&t.activity_name===e.name);return{name:e.name,kraId:e.kraId,initiativeId:e.initiativeId,reported:e.reported,target:e.target,achievement:e.achievement,status:e.status||e.suggestedStatus,dataType:t?.dataType||e.dataType,evidenceSnippet:t?.evidenceSnippet||e.evidenceSnippet,confidence:t?.confidenceScore||e.confidence||.75,rootCause:e.rootCause,authorizedStrategy:e.authorizedStrategy}}),recommendations:r.recommendations,gaps:r.gaps,opportunities:r.opportunities,alignment:r.alignment,prescriptiveAnalysis:l};return m.NextResponse.json(d)}catch(e){return console.error("[Approve API] Get error:",e),m.NextResponse.json({error:"Failed to fetch analysis details"},{status:500})}}e.s(["DELETE",()=>E,"GET",()=>x,"POST",()=>q],89122);var T=e.i(89122);let $=new t.AppRouteRouteModule({definition:{kind:a.RouteKind.APP_ROUTE,page:"/api/qpro/approve/[id]/route",pathname:"/api/qpro/approve/[id]",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/qpro/approve/[id]/route.ts",nextConfigOutput:"standalone",userland:T}),{workAsyncStorage:N,workUnitAsyncStorage:k,serverHooks:b}=$;function S(){return(0,i.patchFetch)({workAsyncStorage:N,workUnitAsyncStorage:k})}async function O(e,t,i){$.isDev&&(0,r.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let m="/api/qpro/approve/[id]/route";m=m.replace(/\/index$/,"")||"/";let w=await $.prepare(e,t,{srcPage:m,multiZoneDraftMode:!1});if(!w)return t.statusCode=400,t.end("Bad Request"),null==i.waitUntil||i.waitUntil.call(i,Promise.resolve()),null;let{buildId:R,params:_,nextConfig:I,parsedUrl:C,isDraftMode:P,prerenderManifest:q,routerServerContext:E,isOnDemandRevalidate:x,revalidateOnlyGenerated:T,resolvedPathname:N,clientReferenceManifest:k,serverActionsManifest:b}=w,S=(0,l.normalizeAppPath)(m),O=!!(q.dynamicRoutes[S]||q.routes[N]),U=async()=>((null==E?void 0:E.render404)?await E.render404(e,t,C,!1):t.end("This page could not be found"),null);if(O&&!P){let e=!!q.routes[N],t=q.dynamicRoutes[S];if(t&&!1===t.fallback&&!e){if(I.experimental.adapterPath)return await U();throw new h.NoFallbackError}}let j=null;!O||$.isDev||P||(j="/index"===(j=N)?"/":j);let M=!0===$.isDev||!O,D=O&&!M;b&&k&&(0,s.setReferenceManifestsSingleton)({page:m,clientReferenceManifest:k,serverActionsManifest:b,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:b})});let F=e.method||"GET",H=(0,n.getTracer)(),K=H.getActiveScopeSpan(),L={params:_,prerenderManifest:q,renderOpts:{experimental:{authInterrupts:!!I.experimental.authInterrupts},cacheComponents:!!I.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,r.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:I.cacheLife,waitUntil:i.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,i)=>$.onRequestError(e,t,i,E)},sharedContext:{buildId:R}},B=new d.NodeNextRequest(e),z=new d.NodeNextResponse(t),G=u.NextRequestAdapter.fromNodeNextRequest(B,(0,u.signalFromNodeResponse)(t));try{let s=async e=>$.handle(G,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=H.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let i=a.get("next.route");if(i){let t=`${F} ${i}`;e.setAttributes({"next.route":i,"http.route":i,"next.span_name":t}),e.updateName(t)}else e.updateName(`${F} ${m}`)}),o=!!(0,r.getRequestMeta)(e,"minimalMode"),l=async r=>{var n,l;let d=async({previousCacheEntry:a})=>{try{if(!o&&x&&T&&!a)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await s(r);e.fetchMetrics=L.renderOpts.fetchMetrics;let l=L.renderOpts.pendingWaitUntil;l&&i.waitUntil&&(i.waitUntil(l),l=void 0);let d=L.renderOpts.collectedTags;if(!O)return await (0,v.sendResponse)(B,z,n,L.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,g.toNodeOutgoingHttpHeaders)(n.headers);d&&(t[A.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=A.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,i=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=A.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:f.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:i}}}}catch(t){throw(null==a?void 0:a.isStale)&&await $.onRequestError(e,t,{routerKind:"App Router",routePath:m,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:x})},E),t}},u=await $.handleResponse({req:e,nextConfig:I,cacheKey:j,routeKind:a.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:q,isRoutePPREnabled:!1,isOnDemandRevalidate:x,revalidateOnlyGenerated:T,responseGenerator:d,waitUntil:i.waitUntil,isMinimalMode:o});if(!O)return null;if((null==u||null==(n=u.value)?void 0:n.kind)!==f.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",x?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),P&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,g.fromNodeOutgoingHttpHeaders)(u.value.headers);return o&&O||p.delete(A.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,y.getCacheControlHeader)(u.cacheControl)),await (0,v.sendResponse)(B,z,new Response(u.value.body,{headers:p,status:u.value.status||200})),null};K?await l(K):await H.withPropagatedContext(e.headers,()=>H.trace(p.BaseServerSpan.handleRequest,{spanName:`${F} ${m}`,kind:n.SpanKind.SERVER,attributes:{"http.method":F,"http.target":e.url}},l))}catch(t){if(t instanceof h.NoFallbackError||await $.onRequestError(e,t,{routerKind:"App Router",routePath:S,routeType:"route",revalidateReason:(0,c.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:x})}),O)throw t;return await (0,v.sendResponse)(B,z,new Response(null,{status:500})),null}}e.s(["handler",()=>O,"patchFetch",()=>S,"routeModule",()=>$,"serverHooks",()=>b,"workAsyncStorage",()=>N,"workUnitAsyncStorage",()=>k],71542)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_97691ceb.js.map