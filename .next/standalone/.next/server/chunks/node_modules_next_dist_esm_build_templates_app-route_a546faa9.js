module.exports=[98307,e=>{"use strict";var t=e.i(47909),r=e.i(74017),a=e.i(96250),o=e.i(59756),n=e.i(61916),i=e.i(14444),s=e.i(37092),l=e.i(69741),c=e.i(16795),d=e.i(87718),u=e.i(95169),p=e.i(47587),g=e.i(66012),m=e.i(70101),R=e.i(26937),h=e.i(10372),f=e.i(93695);e.i(52474);var T=e.i(220),A=e.i(89171),v=e.i(81563),y=e.i(42513),E=e.i(74382);e.i(50612);var I=e.i(30831),O=e.i(29173),w=e.i(59952),P=e.i(83522);let N=new O.PrismaClient,C=I.BlobServiceClient.fromConnectionString(process.env.AZURE_STORAGE_CONNECTION_STRING);async function x(t){try{let r=await (0,v.requireAuth)(t);if("status"in r)return r;let{user:a}=r,o=await t.formData(),n=o.get("file"),i=o.get("documentTitle"),s=o.get("unitId"),l=parseInt(o.get("year"))||2025,c=parseInt(o.get("quarter"))||1;if(console.log("[QPRO-WITH-AGGREGATION] Request received:",{file:n?`File: ${n.name}`:"NO FILE",documentTitle:i?`Title: ${i}`:"NO TITLE",unitId:s,year:l,quarter:c}),!n||!(n instanceof File)||!i)return console.error("[QPRO-WITH-AGGREGATION] Validation failed:",{hasFile:!!n,isFile:n instanceof File,hasDocumentTitle:!!i}),A.NextResponse.json({error:"Missing required fields: file, documentTitle"},{status:400});if(!n.type||"application/pdf"!==n.type&&"application/vnd.openxmlformats-officedocument.wordprocessingml.document"!==n.type)return A.NextResponse.json({error:"Only PDF and DOCX files are allowed"},{status:400});if(n.size>0xa00000)return A.NextResponse.json({error:"File size exceeds 10MB limit"},{status:400});let d="qpro-files",u=`${(0,w.v4)()}_${n.name}`,p=`${a.id}/${u}`,g=C.getContainerClient(d).getBlockBlobClient(p),m=await n.arrayBuffer(),R=Buffer.from(m);console.log("[QPRO-WITH-AGGREGATION] Uploading file to blob storage:",{containerName:d,blobName:p}),await g.uploadData(R,{blobHTTPHeaders:{blobContentType:n.type}}),console.log("[QPRO-WITH-AGGREGATION] File uploaded successfully to:",p);let h=(0,w.v4)(),f=await N.document.create({data:{id:h,title:i,description:`QPRO document uploaded by ${a.name||a.email} for Q${c} ${l}`,category:"QPRO",tags:[],uploadedBy:a.name||a.email,uploadedById:a.id,fileUrl:g.url,fileName:u,fileType:n.type,fileSize:n.size,blobName:p,unitId:s||a.unitId||null,year:l,quarter:c,isQproDocument:!0,colivaraProcessingStatus:"PENDING",status:"ACTIVE"}});console.log("[QPRO-WITH-AGGREGATION] Document record created:",h,`for Q${c} ${l} in unit:`,s||a.unitId);try{console.log(`[QPRO-WITH-AGGREGATION] Starting Colivara indexing for document ${h}`);let t=R.toString("base64"),r=new(await e.A(99606)).default;await r.initialize(),r.indexDocument(h,t).then(e=>{e?console.log(`[QPRO-WITH-AGGREGATION] ✅ Colivara indexing started for document ${h}`):console.error(`[QPRO-WITH-AGGREGATION] ❌ Colivara indexing failed for document ${h}`)}).catch(e=>{console.error(`[QPRO-WITH-AGGREGATION] ❌ Colivara indexing error:`,e)})}catch(e){console.error(`[QPRO-WITH-AGGREGATION] ❌ Error starting Colivara indexing:`,e)}let T=await y.qproAnalysisService.createQPROAnalysis({documentId:f.id,documentTitle:f.title,documentPath:p,documentType:n.type,uploadedById:a.id,unitId:s||void 0,year:l,quarter:c});console.log("[QPRO-WITH-AGGREGATION] QPROAnalysis created:",{id:T.id,documentId:T.documentId,documentTitle:T.documentTitle,hasKras:!!T.kras});let E=await G(T.kras,l,c),I={success:!0,analysis:{id:T.id,title:T.documentTitle,alignment:T.alignment,opportunities:T.opportunities,gaps:T.gaps,recommendations:T.recommendations,achievementScore:T.achievementScore,createdAt:T.createdAt},kras:T.kras,aggregation:{metrics:E.summary,byKra:E.byKra,dashboard:{totalKRAs:E.summary.totalKRAs,metKRAs:E.summary.metKRAs,missedKRAs:E.summary.missedKRAs,onTrackKRAs:E.summary.onTrackKRAs,overallAchievementPercent:E.summary.overallAchievementPercent}},message:"QPRO analysis completed with aggregation metrics calculated and dashboard ready for display"};return console.log("[QPRO-WITH-AGGREGATION] Response about to be sent:",{success:I.success,analysisId:I.analysis.id,hasAggregation:!!I.aggregation}),A.NextResponse.json(I,{status:200})}catch(t){console.error("========== ERROR IN QPRO WITH AGGREGATION =========="),console.error("Error type:",t instanceof Error?t.constructor.name:typeof t),console.error("Error message:",t instanceof Error?t.message:String(t)),console.error("Full error:",t),t instanceof Error&&t.stack&&console.error("Stack trace:",t.stack),console.error("===================================================="),t instanceof Error?t.message:String(t);let e=t instanceof Error?t.message:"Unknown error occurred";return A.NextResponse.json({error:"Failed to process QPRO analysis",details:e,errorType:t instanceof Error?t.constructor.name:typeof t},{status:500})}}async function G(e,t,r){try{let a=await E.strategicPlanService.getStrategicPlan(),o=[],n=0,i=0,s=0,l=0,c=0;for(let r of e||[]){let e=r.kraId||r.kra_id,d=r.kraTitle||r.kra_title||"Unknown";if(e)try{let u=Array.isArray(r.activities)?r.activities:[],p=new Map;for(let t of u){let r=String(t.initiativeId||t.initiative_id||"").trim()||`${e}-KPI1`;p.has(r)||p.set(r,[]),p.get(r).push(t)}let g=Array.from(p.entries()).map(([r,o])=>{let n=(0,P.getInitiativeTargetMeta)(a,String(e),r,t),i="number"==typeof o[0]?.initiativeTarget?o[0].initiativeTarget:"number"==typeof o[0]?.target?o[0].target:Number(o[0]?.target||0),s=n.targetValue??(Number.isFinite(i)&&i>0?i:0),l=(0,P.computeAggregatedAchievement)({targetType:n.targetType,targetValue:s,targetScope:n.targetScope,activities:o});return{initiativeId:r,targetType:n.targetType,totalReported:l.totalReported,totalTarget:l.totalTarget,achievementPercent:l.achievementPercent}}),m=g.length>0?g.reduce((e,t)=>e+(t.achievementPercent||0),0)/g.length:0,R=g.reduce((e,t)=>e+("number"==typeof t.totalReported?t.totalReported:0),0),h=g.reduce((e,t)=>e+("number"==typeof t.totalTarget?t.totalTarget:0),0),f="MISSED";m>=100?f="MET":m>=80&&(f="ON_TRACK");let T="";if("MET"===f)T=`Target exceeded with ${m.toFixed(1)}% achievement (Reported: ${R}, Target: ${h})`;else if("ON_TRACK"===f)T=`On track with ${m.toFixed(1)}% achievement (Reported: ${R}, Target: ${h})`;else{let e=h-R;T=`Gap of ${e} units to target (${m.toFixed(1)}% achievement, Reported: ${R}, Target: ${h})`}switch(o.push({kraId:e,kraTitle:d,reported:R,target:h,achieved:R,achievementPercent:m,status:f,message:T}),n++,c+=m,f){case"MET":i++;break;case"MISSED":s++;break;case"ON_TRACK":l++}}catch(t){console.error(`Error processing KRA ${e}:`,t)}}let d=n>0?c/n:0;return console.log("[AGGREGATION METRICS] Calculation complete:",{totalKRAs:n,metKRAs:i,onTrackKRAs:l,missedKRAs:s,overallAchievementPercent:Math.round(100*d)/100}),{summary:{totalKRAs:n,metKRAs:i,missedKRAs:s,onTrackKRAs:l,overallAchievementPercent:Math.round(100*d)/100,year:t,quarter:r},byKra:o}}catch(e){return console.error("Error in getAggregationMetricsForDisplay:",e),{summary:{totalKRAs:0,metKRAs:0,missedKRAs:0,onTrackKRAs:0,overallAchievementPercent:0,year:t,quarter:r},byKra:[]}}}e.s(["POST",()=>x],12973);var b=e.i(12973);let S=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/qpro-with-aggregation/route",pathname:"/api/qpro-with-aggregation",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/qpro-with-aggregation/route.ts",nextConfigOutput:"standalone",userland:b}),{workAsyncStorage:$,workUnitAsyncStorage:k,serverHooks:H}=S;function _(){return(0,a.patchFetch)({workAsyncStorage:$,workUnitAsyncStorage:k})}async function K(e,t,a){S.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let A="/api/qpro-with-aggregation/route";A=A.replace(/\/index$/,"")||"/";let v=await S.prepare(e,t,{srcPage:A,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:y,params:E,nextConfig:I,parsedUrl:O,isDraftMode:w,prerenderManifest:P,routerServerContext:N,isOnDemandRevalidate:C,revalidateOnlyGenerated:x,resolvedPathname:G,clientReferenceManifest:b,serverActionsManifest:$}=v,k=(0,l.normalizeAppPath)(A),H=!!(P.dynamicRoutes[k]||P.routes[G]),_=async()=>((null==N?void 0:N.render404)?await N.render404(e,t,O,!1):t.end("This page could not be found"),null);if(H&&!w){let e=!!P.routes[G],t=P.dynamicRoutes[k];if(t&&!1===t.fallback&&!e){if(I.experimental.adapterPath)return await _();throw new f.NoFallbackError}}let K=null;!H||S.isDev||w||(K="/index"===(K=G)?"/":K);let M=!0===S.isDev||!H,q=H&&!M;$&&b&&(0,i.setReferenceManifestsSingleton)({page:A,clientReferenceManifest:b,serverActionsManifest:$,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:$})});let D=e.method||"GET",F=(0,n.getTracer)(),Q=F.getActiveScopeSpan(),U={params:E,prerenderManifest:P,renderOpts:{experimental:{authInterrupts:!!I.experimental.authInterrupts},cacheComponents:!!I.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:I.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>S.onRequestError(e,t,a,N)},sharedContext:{buildId:y}},W=new c.NodeNextRequest(e),B=new c.NodeNextResponse(t),j=d.NextRequestAdapter.fromNodeNextRequest(W,(0,d.signalFromNodeResponse)(t));try{let i=async e=>S.handle(j,U).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${D} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${D} ${A}`)}),s=!!(0,o.getRequestMeta)(e,"minimalMode"),l=async o=>{var n,l;let c=async({previousCacheEntry:r})=>{try{if(!s&&C&&x&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let n=await i(o);e.fetchMetrics=U.renderOpts.fetchMetrics;let l=U.renderOpts.pendingWaitUntil;l&&a.waitUntil&&(a.waitUntil(l),l=void 0);let c=U.renderOpts.collectedTags;if(!H)return await (0,g.sendResponse)(W,B,n,U.renderOpts.pendingWaitUntil),null;{let e=await n.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(n.headers);c&&(t[h.NEXT_CACHE_TAGS_HEADER]=c),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==U.renderOpts.collectedRevalidate&&!(U.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&U.renderOpts.collectedRevalidate,a=void 0===U.renderOpts.collectedExpire||U.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:U.renderOpts.collectedExpire;return{value:{kind:T.CachedRouteKind.APP_ROUTE,status:n.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await S.onRequestError(e,t,{routerKind:"App Router",routePath:A,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:C})},N),t}},d=await S.handleResponse({req:e,nextConfig:I,cacheKey:K,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:P,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:x,responseGenerator:c,waitUntil:a.waitUntil,isMinimalMode:s});if(!H)return null;if((null==d||null==(n=d.value)?void 0:n.kind)!==T.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",C?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),w&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,m.fromNodeOutgoingHttpHeaders)(d.value.headers);return s&&H||u.delete(h.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,R.getCacheControlHeader)(d.cacheControl)),await (0,g.sendResponse)(W,B,new Response(d.value.body,{headers:u,status:d.value.status||200})),null};Q?await l(Q):await F.withPropagatedContext(e.headers,()=>F.trace(u.BaseServerSpan.handleRequest,{spanName:`${D} ${A}`,kind:n.SpanKind.SERVER,attributes:{"http.method":D,"http.target":e.url}},l))}catch(t){if(t instanceof f.NoFallbackError||await S.onRequestError(e,t,{routerKind:"App Router",routePath:k,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:C})}),H)throw t;return await (0,g.sendResponse)(W,B,new Response(null,{status:500})),null}}e.s(["handler",()=>K,"patchFetch",()=>_,"routeModule",()=>S,"serverHooks",()=>H,"workAsyncStorage",()=>$,"workUnitAsyncStorage",()=>k],98307)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_a546faa9.js.map