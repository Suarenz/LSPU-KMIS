{"version":3,"sources":["../../../node_modules/next/dist/esm/build/templates/app-route.js","../../../app/api/generate/route.ts","../../../lib/services/gemini-generation-service.ts"],"sourcesContent":["import { AppRouteRouteModule } from \"next/dist/esm/server/route-modules/app-route/module.compiled\";\nimport { RouteKind } from \"next/dist/esm/server/route-kind\";\nimport { patchFetch as _patchFetch } from \"next/dist/esm/server/lib/patch-fetch\";\nimport { addRequestMeta, getRequestMeta } from \"next/dist/esm/server/request-meta\";\nimport { getTracer, SpanKind } from \"next/dist/esm/server/lib/trace/tracer\";\nimport { setReferenceManifestsSingleton } from \"next/dist/esm/server/app-render/encryption-utils\";\nimport { createServerModuleMap } from \"next/dist/esm/server/app-render/action-utils\";\nimport { normalizeAppPath } from \"next/dist/esm/shared/lib/router/utils/app-paths\";\nimport { NodeNextRequest, NodeNextResponse } from \"next/dist/esm/server/base-http/node\";\nimport { NextRequestAdapter, signalFromNodeResponse } from \"next/dist/esm/server/web/spec-extension/adapters/next-request\";\nimport { BaseServerSpan } from \"next/dist/esm/server/lib/trace/constants\";\nimport { getRevalidateReason } from \"next/dist/esm/server/instrumentation/utils\";\nimport { sendResponse } from \"next/dist/esm/server/send-response\";\nimport { fromNodeOutgoingHttpHeaders, toNodeOutgoingHttpHeaders } from \"next/dist/esm/server/web/utils\";\nimport { getCacheControlHeader } from \"next/dist/esm/server/lib/cache-control\";\nimport { INFINITE_CACHE, NEXT_CACHE_TAGS_HEADER } from \"next/dist/esm/lib/constants\";\nimport { NoFallbackError } from \"next/dist/esm/shared/lib/no-fallback-error.external\";\nimport { CachedRouteKind } from \"next/dist/esm/server/response-cache\";\nimport * as userland from \"INNER_APP_ROUTE\";\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"standalone\"\nconst routeModule = new AppRouteRouteModule({\n    definition: {\n        kind: RouteKind.APP_ROUTE,\n        page: \"/api/generate/route\",\n        pathname: \"/api/generate\",\n        filename: \"route\",\n        bundlePath: \"\"\n    },\n    distDir: process.env.__NEXT_RELATIVE_DIST_DIR || '',\n    relativeProjectDir: process.env.__NEXT_RELATIVE_PROJECT_DIR || '',\n    resolvedPagePath: \"[project]/app/api/generate/route.ts\",\n    nextConfigOutput,\n    userland\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { workAsyncStorage, workUnitAsyncStorage, serverHooks } = routeModule;\nfunction patchFetch() {\n    return _patchFetch({\n        workAsyncStorage,\n        workUnitAsyncStorage\n    });\n}\nexport { routeModule, workAsyncStorage, workUnitAsyncStorage, serverHooks, patchFetch,  };\nexport async function handler(req, res, ctx) {\n    if (routeModule.isDev) {\n        addRequestMeta(req, 'devRequestTimingInternalsEnd', process.hrtime.bigint());\n    }\n    let srcPage = \"/api/generate/route\";\n    // turbopack doesn't normalize `/index` in the page name\n    // so we need to to process dynamic routes properly\n    // TODO: fix turbopack providing differing value from webpack\n    if (process.env.TURBOPACK) {\n        srcPage = srcPage.replace(/\\/index$/, '') || '/';\n    } else if (srcPage === '/index') {\n        // we always normalize /index specifically\n        srcPage = '/';\n    }\n    const multiZoneDraftMode = process.env.__NEXT_MULTI_ZONE_DRAFT_MODE;\n    const prepareResult = await routeModule.prepare(req, res, {\n        srcPage,\n        multiZoneDraftMode\n    });\n    if (!prepareResult) {\n        res.statusCode = 400;\n        res.end('Bad Request');\n        ctx.waitUntil == null ? void 0 : ctx.waitUntil.call(ctx, Promise.resolve());\n        return null;\n    }\n    const { buildId, params, nextConfig, parsedUrl, isDraftMode, prerenderManifest, routerServerContext, isOnDemandRevalidate, revalidateOnlyGenerated, resolvedPathname, clientReferenceManifest, serverActionsManifest } = prepareResult;\n    const normalizedSrcPage = normalizeAppPath(srcPage);\n    let isIsr = Boolean(prerenderManifest.dynamicRoutes[normalizedSrcPage] || prerenderManifest.routes[resolvedPathname]);\n    const render404 = async ()=>{\n        // TODO: should route-module itself handle rendering the 404\n        if (routerServerContext == null ? void 0 : routerServerContext.render404) {\n            await routerServerContext.render404(req, res, parsedUrl, false);\n        } else {\n            res.end('This page could not be found');\n        }\n        return null;\n    };\n    if (isIsr && !isDraftMode) {\n        const isPrerendered = Boolean(prerenderManifest.routes[resolvedPathname]);\n        const prerenderInfo = prerenderManifest.dynamicRoutes[normalizedSrcPage];\n        if (prerenderInfo) {\n            if (prerenderInfo.fallback === false && !isPrerendered) {\n                if (nextConfig.experimental.adapterPath) {\n                    return await render404();\n                }\n                throw new NoFallbackError();\n            }\n        }\n    }\n    let cacheKey = null;\n    if (isIsr && !routeModule.isDev && !isDraftMode) {\n        cacheKey = resolvedPathname;\n        // ensure /index and / is normalized to one key\n        cacheKey = cacheKey === '/index' ? '/' : cacheKey;\n    }\n    const supportsDynamicResponse = // If we're in development, we always support dynamic HTML\n    routeModule.isDev === true || // If this is not SSG or does not have static paths, then it supports\n    // dynamic HTML.\n    !isIsr;\n    // This is a revalidation request if the request is for a static\n    // page and it is not being resumed from a postponed render and\n    // it is not a dynamic RSC request then it is a revalidation\n    // request.\n    const isStaticGeneration = isIsr && !supportsDynamicResponse;\n    // Before rendering (which initializes component tree modules), we have to\n    // set the reference manifests to our global store so Server Action's\n    // encryption util can access to them at the top level of the page module.\n    if (serverActionsManifest && clientReferenceManifest) {\n        setReferenceManifestsSingleton({\n            page: srcPage,\n            clientReferenceManifest,\n            serverActionsManifest,\n            serverModuleMap: createServerModuleMap({\n                serverActionsManifest\n            })\n        });\n    }\n    const method = req.method || 'GET';\n    const tracer = getTracer();\n    const activeSpan = tracer.getActiveScopeSpan();\n    const context = {\n        params,\n        prerenderManifest,\n        renderOpts: {\n            experimental: {\n                authInterrupts: Boolean(nextConfig.experimental.authInterrupts)\n            },\n            cacheComponents: Boolean(nextConfig.cacheComponents),\n            supportsDynamicResponse,\n            incrementalCache: getRequestMeta(req, 'incrementalCache'),\n            cacheLifeProfiles: nextConfig.cacheLife,\n            waitUntil: ctx.waitUntil,\n            onClose: (cb)=>{\n                res.on('close', cb);\n            },\n            onAfterTaskError: undefined,\n            onInstrumentationRequestError: (error, _request, errorContext)=>routeModule.onRequestError(req, error, errorContext, routerServerContext)\n        },\n        sharedContext: {\n            buildId\n        }\n    };\n    const nodeNextReq = new NodeNextRequest(req);\n    const nodeNextRes = new NodeNextResponse(res);\n    const nextReq = NextRequestAdapter.fromNodeNextRequest(nodeNextReq, signalFromNodeResponse(res));\n    try {\n        const invokeRouteModule = async (span)=>{\n            return routeModule.handle(nextReq, context).finally(()=>{\n                if (!span) return;\n                span.setAttributes({\n                    'http.status_code': res.statusCode,\n                    'next.rsc': false\n                });\n                const rootSpanAttributes = tracer.getRootSpanAttributes();\n                // We were unable to get attributes, probably OTEL is not enabled\n                if (!rootSpanAttributes) {\n                    return;\n                }\n                if (rootSpanAttributes.get('next.span_type') !== BaseServerSpan.handleRequest) {\n                    console.warn(`Unexpected root span type '${rootSpanAttributes.get('next.span_type')}'. Please report this Next.js issue https://github.com/vercel/next.js`);\n                    return;\n                }\n                const route = rootSpanAttributes.get('next.route');\n                if (route) {\n                    const name = `${method} ${route}`;\n                    span.setAttributes({\n                        'next.route': route,\n                        'http.route': route,\n                        'next.span_name': name\n                    });\n                    span.updateName(name);\n                } else {\n                    span.updateName(`${method} ${srcPage}`);\n                }\n            });\n        };\n        const isMinimalMode = Boolean(process.env.MINIMAL_MODE || getRequestMeta(req, 'minimalMode'));\n        const handleResponse = async (currentSpan)=>{\n            var _cacheEntry_value;\n            const responseGenerator = async ({ previousCacheEntry })=>{\n                try {\n                    if (!isMinimalMode && isOnDemandRevalidate && revalidateOnlyGenerated && !previousCacheEntry) {\n                        res.statusCode = 404;\n                        // on-demand revalidate always sets this header\n                        res.setHeader('x-nextjs-cache', 'REVALIDATED');\n                        res.end('This page could not be found');\n                        return null;\n                    }\n                    const response = await invokeRouteModule(currentSpan);\n                    req.fetchMetrics = context.renderOpts.fetchMetrics;\n                    let pendingWaitUntil = context.renderOpts.pendingWaitUntil;\n                    // Attempt using provided waitUntil if available\n                    // if it's not we fallback to sendResponse's handling\n                    if (pendingWaitUntil) {\n                        if (ctx.waitUntil) {\n                            ctx.waitUntil(pendingWaitUntil);\n                            pendingWaitUntil = undefined;\n                        }\n                    }\n                    const cacheTags = context.renderOpts.collectedTags;\n                    // If the request is for a static response, we can cache it so long\n                    // as it's not edge.\n                    if (isIsr) {\n                        const blob = await response.blob();\n                        // Copy the headers from the response.\n                        const headers = toNodeOutgoingHttpHeaders(response.headers);\n                        if (cacheTags) {\n                            headers[NEXT_CACHE_TAGS_HEADER] = cacheTags;\n                        }\n                        if (!headers['content-type'] && blob.type) {\n                            headers['content-type'] = blob.type;\n                        }\n                        const revalidate = typeof context.renderOpts.collectedRevalidate === 'undefined' || context.renderOpts.collectedRevalidate >= INFINITE_CACHE ? false : context.renderOpts.collectedRevalidate;\n                        const expire = typeof context.renderOpts.collectedExpire === 'undefined' || context.renderOpts.collectedExpire >= INFINITE_CACHE ? undefined : context.renderOpts.collectedExpire;\n                        // Create the cache entry for the response.\n                        const cacheEntry = {\n                            value: {\n                                kind: CachedRouteKind.APP_ROUTE,\n                                status: response.status,\n                                body: Buffer.from(await blob.arrayBuffer()),\n                                headers\n                            },\n                            cacheControl: {\n                                revalidate,\n                                expire\n                            }\n                        };\n                        return cacheEntry;\n                    } else {\n                        // send response without caching if not ISR\n                        await sendResponse(nodeNextReq, nodeNextRes, response, context.renderOpts.pendingWaitUntil);\n                        return null;\n                    }\n                } catch (err) {\n                    // if this is a background revalidate we need to report\n                    // the request error here as it won't be bubbled\n                    if (previousCacheEntry == null ? void 0 : previousCacheEntry.isStale) {\n                        await routeModule.onRequestError(req, err, {\n                            routerKind: 'App Router',\n                            routePath: srcPage,\n                            routeType: 'route',\n                            revalidateReason: getRevalidateReason({\n                                isStaticGeneration,\n                                isOnDemandRevalidate\n                            })\n                        }, routerServerContext);\n                    }\n                    throw err;\n                }\n            };\n            const cacheEntry = await routeModule.handleResponse({\n                req,\n                nextConfig,\n                cacheKey,\n                routeKind: RouteKind.APP_ROUTE,\n                isFallback: false,\n                prerenderManifest,\n                isRoutePPREnabled: false,\n                isOnDemandRevalidate,\n                revalidateOnlyGenerated,\n                responseGenerator,\n                waitUntil: ctx.waitUntil,\n                isMinimalMode\n            });\n            // we don't create a cacheEntry for ISR\n            if (!isIsr) {\n                return null;\n            }\n            if ((cacheEntry == null ? void 0 : (_cacheEntry_value = cacheEntry.value) == null ? void 0 : _cacheEntry_value.kind) !== CachedRouteKind.APP_ROUTE) {\n                var _cacheEntry_value1;\n                throw Object.defineProperty(new Error(`Invariant: app-route received invalid cache entry ${cacheEntry == null ? void 0 : (_cacheEntry_value1 = cacheEntry.value) == null ? void 0 : _cacheEntry_value1.kind}`), \"__NEXT_ERROR_CODE\", {\n                    value: \"E701\",\n                    enumerable: false,\n                    configurable: true\n                });\n            }\n            if (!isMinimalMode) {\n                res.setHeader('x-nextjs-cache', isOnDemandRevalidate ? 'REVALIDATED' : cacheEntry.isMiss ? 'MISS' : cacheEntry.isStale ? 'STALE' : 'HIT');\n            }\n            // Draft mode should never be cached\n            if (isDraftMode) {\n                res.setHeader('Cache-Control', 'private, no-cache, no-store, max-age=0, must-revalidate');\n            }\n            const headers = fromNodeOutgoingHttpHeaders(cacheEntry.value.headers);\n            if (!(isMinimalMode && isIsr)) {\n                headers.delete(NEXT_CACHE_TAGS_HEADER);\n            }\n            // If cache control is already set on the response we don't\n            // override it to allow users to customize it via next.config\n            if (cacheEntry.cacheControl && !res.getHeader('Cache-Control') && !headers.get('Cache-Control')) {\n                headers.set('Cache-Control', getCacheControlHeader(cacheEntry.cacheControl));\n            }\n            await sendResponse(nodeNextReq, nodeNextRes, // @ts-expect-error - Argument of type 'Buffer<ArrayBufferLike>' is not assignable to parameter of type 'BodyInit | null | undefined'.\n            new Response(cacheEntry.value.body, {\n                headers,\n                status: cacheEntry.value.status || 200\n            }));\n            return null;\n        };\n        // TODO: activeSpan code path is for when wrapped by\n        // next-server can be removed when this is no longer used\n        if (activeSpan) {\n            await handleResponse(activeSpan);\n        } else {\n            await tracer.withPropagatedContext(req.headers, ()=>tracer.trace(BaseServerSpan.handleRequest, {\n                    spanName: `${method} ${srcPage}`,\n                    kind: SpanKind.SERVER,\n                    attributes: {\n                        'http.method': method,\n                        'http.target': req.url\n                    }\n                }, handleResponse));\n        }\n    } catch (err) {\n        if (!(err instanceof NoFallbackError)) {\n            await routeModule.onRequestError(req, err, {\n                routerKind: 'App Router',\n                routePath: normalizedSrcPage,\n                routeType: 'route',\n                revalidateReason: getRevalidateReason({\n                    isStaticGeneration,\n                    isOnDemandRevalidate\n                })\n            });\n        }\n        // rethrow so that we can handle serving error page\n        // If this is during static generation, throw the error again.\n        if (isIsr) throw err;\n        // Otherwise, send a 500 response.\n        await sendResponse(nodeNextReq, nodeNextRes, new Response(null, {\n            status: 500\n        }));\n        return null;\n    }\n}\n\n//# sourceMappingURL=app-route.js.map\n","import { NextRequest } from 'next/server';\r\nimport { NextResponse } from 'next/server';\r\nimport GeminiGenerationService from '@/lib/services/gemini-generation-service';\r\nimport ColivaraService from '@/lib/services/colivara-service';\r\nimport { requireAuth } from '@/lib/middleware/auth-middleware';\r\n\r\nconst geminiService = new GeminiGenerationService();\r\nconst colivaraService = new ColivaraService();\r\n\r\nexport async function POST(request: NextRequest) {\r\n  try {\r\n    // Verify authentication\r\n    const authResult = await requireAuth(request);\r\n    if ('status' in authResult) { // Check if it's a NextResponse (error case)\r\n      return authResult;\r\n    }\r\n    \r\n    const { user } = authResult;\r\n\r\n    // Parse request body\r\n    const body = await request.json();\r\n    const { \r\n      query, \r\n      searchResults, \r\n      generationType = 'text-only', // 'text-only' or 'multimodal'\r\n      maxResults = 5,\r\n      customPrompt \r\n    } = body;\r\n\r\n    if (!query) {\r\n      return NextResponse.json(\r\n        { error: 'Query parameter is required' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    if (!Array.isArray(searchResults) || searchResults.length === 0) {\r\n      return NextResponse.json(\r\n        { error: 'Search results are required and must be an array' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const userId = user.id;\r\n\r\n    try {\r\n    // Generate response based on the requested generation type\r\n    let generatedResponse;\r\n    \r\n    if (generationType === 'multimodal') {\r\n      // For multimodal generation, we would need to process visual content\r\n      // For now, we'll use the enhanced search results that include visual content\r\n      generatedResponse = await geminiService.generateResponse(\r\n        query,\r\n        searchResults,\r\n        {\r\n          textOnly: false,\r\n          maxResults,\r\n          customPrompt\r\n        },\r\n        userId\r\n      );\r\n    } else {\r\n      // Text-only generation\r\n      generatedResponse = await geminiService.generateResponse(\r\n        query,\r\n        searchResults,\r\n        {\r\n          textOnly: true,\r\n          maxResults,\r\n          customPrompt\r\n        },\r\n        userId\r\n      );\r\n    }\r\n\r\n    // Return the generated response\r\n    return NextResponse.json({\r\n      query,\r\n      generatedResponse,\r\n      generationType,\r\n      searchResultsUsed: searchResults.length,\r\n      userId,\r\n      timestamp: new Date().toISOString()\r\n    });\r\n  } catch (geminiError) {\r\n    console.error('Gemini generation failed:', geminiError);\r\n    \r\n    return NextResponse.json(\r\n      {\r\n        error: 'Failed to generate response with Gemini AI',\r\n        details: geminiError instanceof Error ? geminiError.message : 'Unknown error'\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n } catch (error) {\r\n    console.error('Error in generation API:', error);\r\n    return NextResponse.json(\r\n      { error: 'Internal server error during generation' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n// Health check endpoint for the generation service\r\nexport async function GET(request: NextRequest) {\r\n  try {\r\n    // Verify authentication\r\n    const authResult = await requireAuth(request);\r\n    if ('status' in authResult) { // Check if it's a NextResponse (error case)\r\n      return authResult;\r\n    }\r\n\r\n    // Check if both services are healthy\r\n    const geminiHealthy = await geminiService.healthCheck();\r\n    const colivaraHealthy = await colivaraService.validateApiKey();\r\n\r\n    return NextResponse.json({\r\n      status: 'healthy',\r\n      services: {\r\n        gemini: geminiHealthy,\r\n        colivara: colivaraHealthy\r\n      },\r\n      timestamp: new Date().toISOString()\r\n    });\r\n  } catch (error) {\r\n    console.error('Health check failed:', error);\r\n    return NextResponse.json(\r\n      { \r\n        status: 'unhealthy',\r\n        error: error instanceof Error ? error.message : 'Health check failed'\r\n      },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}","// DEPRECATED: Legacy Gemini service - Use QwenGenerationService instead\r\nimport { GoogleGenerativeAI, GenerativeModel } from '@google/generative-ai';\r\nimport { HarmCategory, HarmBlockThreshold } from '@google/generative-ai';\r\nimport ConfigService from './config-service';\r\nimport MonitoringService from './monitoring-service';\r\n\r\n// Define the SearchResult interface to match what's expected\r\ninterface SearchResult {\r\n  documentId: string;\r\n  title: string;\r\n  content: string;\r\n  score: number;\r\n  pageNumbers: number[];\r\n  documentSection?: string;\r\n  confidenceScore?: number;\r\n  snippet: string;\r\n  document: any; // Replace with actual Document type if available\r\n  visualContent?: string; // Base64 encoded visual content\r\n  extractedText?: string; // Extracted text content\r\n  screenshots?: string[]; // Array of screenshot base64 strings\r\n  mimeType?: string; // MIME type for the screenshots (e.g., 'image/jpeg', 'image/png')\r\n}\r\n\r\ninterface GeminiConfig {\r\n  apiKey: string;\r\n  model?: string;\r\n  generationConfig?: {\r\n    temperature?: number;\r\n    maxOutputTokens?: number;\r\n    topP?: number;\r\n    topK?: number;\r\n  };\r\n safetySettings?: Array<{\r\n    category: HarmCategory;\r\n    threshold: HarmBlockThreshold;\r\n  }>;\r\n}\r\n\r\ninterface GenerationOptions {\r\n textOnly?: boolean;\r\n maxResults?: number;\r\n  customPrompt?: string;\r\n}\r\n\r\nclass GeminiGenerationService {\r\n  private genAI: GoogleGenerativeAI;\r\n  private model: GenerativeModel;\r\n  private config: GeminiConfig;\r\n private configService: ConfigService;\r\n  private monitoringService: MonitoringService;\r\n\r\n  constructor(config?: Partial<GeminiConfig>) {\r\n    const apiKey = process.env.GOOGLE_AI_API_KEY || config?.apiKey || '';\r\n    if (!apiKey) {\r\n      throw new Error('Google AI API key is required for Gemini Generation Service');\r\n    }\r\n\r\n    this.config = {\r\n      apiKey,\r\n      model: config?.model || 'gemini-2.0-flash-001',\r\n      generationConfig: config?.generationConfig || {\r\n        temperature: 0.2,\r\n        maxOutputTokens: 8192,\r\n        topP: 0.95,\r\n        topK: 40,\r\n      },\r\n      safetySettings: config?.safetySettings || [\r\n        {\r\n          category: HarmCategory.HARM_CATEGORY_HATE_SPEECH,\r\n          threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE,\r\n        },\r\n        {\r\n          category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT,\r\n          threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE,\r\n        },\r\n        {\r\n          category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT,\r\n          threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE,\r\n        },\r\n        {\r\n          category: HarmCategory.HARM_CATEGORY_HARASSMENT,\r\n          threshold: HarmBlockThreshold.BLOCK_MEDIUM_AND_ABOVE,\r\n        },\r\n      ],\r\n    };\r\n\r\n    // Enforce a safe cap for gpt-4o-mini / 4o style models\r\n    try {\r\n      const GPT4O_MINI_MAX_OUTPUT = 4096;\r\n      if (this.config.model && this.config.model.includes('4o')) {\r\n        this.config.generationConfig = this.config.generationConfig || {};\r\n        this.config.generationConfig.maxOutputTokens = Math.min(this.config.generationConfig.maxOutputTokens || GPT4O_MINI_MAX_OUTPUT, GPT4O_MINI_MAX_OUTPUT);\r\n      }\r\n    } catch (e) {\r\n      // Defensive: ignore if anything goes wrong here\r\n    }\r\n\r\n    this.genAI = new GoogleGenerativeAI(this.config.apiKey);\r\n    \r\n    // DISABLE ALL SAFETY FILTERS - Required for processing student data/grades\r\n    this.model = this.genAI.getGenerativeModel({\r\n      model: this.config.model!,\r\n      // DISABLE ALL SAFETY FILTERS\r\n      safetySettings: [\r\n        { category: HarmCategory.HARM_CATEGORY_HARASSMENT, threshold: HarmBlockThreshold.BLOCK_NONE },\r\n        { category: HarmCategory.HARM_CATEGORY_HATE_SPEECH, threshold: HarmBlockThreshold.BLOCK_NONE },\r\n        { category: HarmCategory.HARM_CATEGORY_SEXUALLY_EXPLICIT, threshold: HarmBlockThreshold.BLOCK_NONE },\r\n        { category: HarmCategory.HARM_CATEGORY_DANGEROUS_CONTENT, threshold: HarmBlockThreshold.BLOCK_NONE },\r\n      ]\r\n    });\r\n    \r\n    this.configService = ConfigService.getInstance();\r\n    this.monitoringService = MonitoringService.getInstance();\r\n  }\r\n\r\n  /**\r\n   * Generate a response based on search results and user query\r\n   * @param query User's search query\r\n   * @param searchResults Results from Colivara semantic search\r\n   * @param options Generation options\r\n   * @param userId User identifier for rate limiting\r\n   */\r\n async generateResponse(\r\n    query: string,\r\n    searchResults: SearchResult[],\r\n    options: GenerationOptions = {},\r\n    userId?: string\r\n  ): Promise<string> {\r\n    const startTime = Date.now();\r\n    try {\r\n      // Use user ID for rate limiting, fallback to a general identifier if not provided\r\n      const identifier = userId || 'anonymous';\r\n      \r\n      // Check if request is allowed based on rate limiting\r\n      if (!this.configService.isRequestAllowed(identifier)) {\r\n        const remainingRequests = this.configService.getRemainingRequests(identifier);\r\n        const resetTime = this.configService.getResetTime(identifier);\r\n        const resetTimeFormatted = new Date(resetTime).toLocaleTimeString();\r\n        \r\n        const error = new Error(\r\n          `Rate limit exceeded. You can make ${remainingRequests} more requests after ${resetTimeFormatted}.`\r\n        );\r\n        \r\n        // Track the failed request\r\n        this.monitoringService.trackGeneration(\r\n          userId || 'unknown',\r\n          query,\r\n          Date.now() - startTime,\r\n          false,\r\n          error.message,\r\n          this.config.model\r\n        );\r\n        \r\n        throw error;\r\n      }\r\n\r\n      // Limit the number of results to process\r\n      const maxResults = options.maxResults || 6; // Increased from 5 to 6 for Gemini 2.0 Flash\r\n      const limitedResults = searchResults.slice(0, maxResults);\r\n\r\n      if (limitedResults.length === 0) {\r\n        const response = \"I couldn't find any relevant documents to answer your query. Please try a different search term.\";\r\n        \r\n        // Track the successful request with no results\r\n        this.monitoringService.trackGeneration(\r\n          userId || 'unknown',\r\n          query,\r\n          Date.now() - startTime,\r\n          true,\r\n          undefined,\r\n          this.config.model\r\n        );\r\n        \r\n        return response;\r\n      }\r\n\r\n      // Check if the query is asking for comprehensive information (like lists of faculty/trainings)\r\n      const isComprehensiveQuery = query.toLowerCase().includes('list') ||\r\n                                   query.toLowerCase().includes('all') ||\r\n                                   query.toLowerCase().includes('every') ||\r\n                                   query.toLowerCase().includes('faculty') ||\r\n                                   query.toLowerCase().includes('training') ||\r\n                                   query.toLowerCase().includes('seminar') ||\r\n                                   query.toLowerCase().includes('attended') ||\r\n                                   query.toLowerCase().includes('presentation') ||\r\n                                   query.toLowerCase().includes('research') ||\r\n                                   (query.toLowerCase().includes('what') && query.toLowerCase().includes('training')) ||\r\n                                   (query.toLowerCase().includes('what') && query.toLowerCase().includes('seminar')) ||\r\n                                   (query.toLowerCase().includes('which') && query.toLowerCase().includes('training')) ||\r\n                                   (query.toLowerCase().includes('which') && query.toLowerCase().includes('seminar'));\r\n      \r\n      // For comprehensive queries, ensure we use more results\r\n      const resultsForGeneration = isComprehensiveQuery ?\r\n        searchResults.slice(0, 6) : // Use up to 6 results for comprehensive queries\r\n        limitedResults; // Use the limited results for specific queries\r\n      \r\n      // Prepare the content for the model based on options\r\n      // Check if any results have visual content to determine if we should use multimodal processing\r\n      const hasVisualContent = resultsForGeneration.some(result => result.visualContent || (result.screenshots && result.screenshots.length > 0));\r\n      \r\n      let result: string;\r\n      if (options.textOnly || !hasVisualContent) {\r\n        result = await this.generateTextOnlyResponse(query, resultsForGeneration, options);\r\n      } else {\r\n        result = await this.generateMultimodalResponse(query, resultsForGeneration, options);\r\n      }\r\n      \r\n      // Track the successful request\r\n      this.monitoringService.trackGeneration(\r\n        userId || 'unknown',\r\n        query,\r\n        Date.now() - startTime,\r\n        true,\r\n        undefined,\r\n        this.config.model\r\n      );\r\n      \r\n      return result;\r\n    } catch (error) {\r\n      console.error('Error generating response with Gemini:', error);\r\n      \r\n      // Track the failed request\r\n      this.monitoringService.trackGeneration(\r\n        userId || 'unknown',\r\n        query,\r\n        Date.now() - startTime,\r\n        false,\r\n        error instanceof Error ? error.message : 'Unknown error',\r\n        this.config.model\r\n      );\r\n      \r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generate a text-only response using search results\r\n   */\r\n  private async generateTextOnlyResponse(\r\n    query: string,\r\n    searchResults: SearchResult[],\r\n    options: GenerationOptions\r\n  ): Promise<string> {\r\n    // Format the search results into a context string\r\n    const context = searchResults\r\n      .map((result, index) => {\r\n        const content = result.content || result.snippet || '';\r\n        const title = result.title || 'Untitled Document';\r\n        const pageNumbers = result.pageNumbers?.length ? ` (pages: ${result.pageNumbers.join(', ')})` : '';\r\n        const score = result.confidenceScore ? ` (relevance: ${(result.confidenceScore * 100).toFixed(1)}%)` : '';\r\n        const hasVisuals = result.screenshots && result.screenshots.length > 0;\r\n        \r\n        let resultText = `Document ${index + 1}: ${title}${pageNumbers}${score}\\n`;\r\n        \r\n        if (hasVisuals) {\r\n          resultText += `[VISUAL DATA: This document contains ${result.screenshots!.length} image(s). Read any tables, numbers, or text visually present in the images.]\\n`;\r\n        }\r\n        \r\n        resultText += `Content: ${content}\\n`;\r\n        \r\n        return resultText;\r\n      })\r\n      .join('\\n---\\n');\r\n\r\n    // Check if the query is asking for comprehensive information (like lists of faculty/trainings)\r\n    const isComprehensiveQuery = query.toLowerCase().includes('list') ||\r\n                                 query.toLowerCase().includes('all') ||\r\n                                 query.toLowerCase().includes('every') ||\r\n                                 query.toLowerCase().includes('faculty') ||\r\n                                 query.toLowerCase().includes('training') ||\r\n                                 query.toLowerCase().includes('seminar') ||\r\n                                 query.toLowerCase().includes('attended') ||\r\n                                 query.toLowerCase().includes('presentation') ||\r\n                                 query.toLowerCase().includes('research') ||\r\n                                 (query.toLowerCase().includes('what') && query.toLowerCase().includes('training')) ||\r\n                                 (query.toLowerCase().includes('what') && query.toLowerCase().includes('seminar')) ||\r\n                                 (query.toLowerCase().includes('which') && query.toLowerCase().includes('training')) ||\r\n                                 (query.toLowerCase().includes('which') && query.toLowerCase().includes('seminar'));\r\n\r\n    // Create the prompt with specific instructions for comprehensive queries\r\n    const prompt = options.customPrompt || `Based on the following documents, provide a clear, direct answer to the user's query. If the documents don't contain the information needed to answer the query, state this clearly.\r\n\r\nDocuments:\r\n${context}\r\n\r\nUser Query: ${query}\r\n\r\n${isComprehensiveQuery ? `### SPECIAL INSTRUCTION FOR COMPREHENSIVE QUERIES: When the user asks for a list of items (such as faculty and their trainings/seminars), you MUST provide ALL the information found in the documents. Do not summarize or abbreviate. If multiple documents contain relevant information, combine and present ALL the data from all documents. Use a clear format like bullet points or structured lists to make the information easy to read. CRITICAL: If you state that you are providing a list, you MUST actually provide the complete list content. Do not just say \"Here is the list...\" without providing the actual items in the list. READ EVERY DOCUMENT CAREFULLY and extract ALL relevant information BEFORE forming your response. Do not stop at the first few items you find - continue reading through all documents to ensure you have collected all relevant information.` : ''}\r\n\r\nPlease provide a straightforward, direct answer to the query based on the provided documents. Focus on information that directly addresses the question. If the information is not available in the documents, say so clearly.`;\r\n\r\n    // Generate content using the model\r\n    const result = await this.model.generateContent({\r\n      contents: [{ role: 'user', parts: [{ text: prompt }] }],\r\n      generationConfig: this.config.generationConfig!,\r\n      safetySettings: this.config.safetySettings!,\r\n    });\r\n\r\n    const response = await result.response;\r\n    return response.text();\r\n  }\r\n\r\n /**\r\n  * Generate a multimodal response using search results that may include visual content\r\n  */\r\n private async generateMultimodalResponse(\r\n   query: string,\r\n   searchResults: SearchResult[],\r\n   options: GenerationOptions\r\n ): Promise<string> {\r\n   // Check if the query is asking for comprehensive information (like lists of faculty/trainings)\r\n   const isComprehensiveQuery = query.toLowerCase().includes('list') ||\r\n                               query.toLowerCase().includes('all') ||\r\n                               query.toLowerCase().includes('every') ||\r\n                               query.toLowerCase().includes('faculty') ||\r\n                               query.toLowerCase().includes('training') ||\r\n                               query.toLowerCase().includes('seminar') ||\r\n                               query.toLowerCase().includes('attended') ||\r\n                               query.toLowerCase().includes('presentation') ||\r\n                               query.toLowerCase().includes('research') ||\r\n                               (query.toLowerCase().includes('what') && query.toLowerCase().includes('training')) ||\r\n                               (query.toLowerCase().includes('what') && query.toLowerCase().includes('seminar')) ||\r\n                               (query.toLowerCase().includes('which') && query.toLowerCase().includes('training')) ||\r\n                               (query.toLowerCase().includes('which') && query.toLowerCase().includes('seminar'));\r\n\r\n   // Format the search results into a context string with visual content\r\n   const multimodalParts = [];\r\n   \r\n   multimodalParts.push({\r\n     text: `\r\nYou are an intelligent assistant capable of reading documents and extracting specific details.\r\nYour goal is to answer the user's question accurately based ONLY on the provided document images.\r\n\r\n### DATA EXTRACTION RULES:\r\n1. **Read the Visuals:** The documents may contain tables, lists, or spreadsheets. Scan them carefully row-by-row.\r\n2. **Be Thorough:** If the user asks for a list (e.g., \"all faculty\"), extract EVERY name you see in the document images. Do not summarize.\r\n3. ** OCR Handling:** If text is slightly blurry, use your best judgment to correct obvious spelling errors (e.g., interpret \"M@rk\" as \"Mark\").\r\n\r\n### OUTPUT FORMATTING:\r\nIf the data involves multiple items (like names and trainings), you must use a **Nested Bullet List** format:\r\n\r\n* **Name of Person**\r\n  * Training Title A\r\n  * Training Title B\r\n\r\nIf the answer is simple text, use a natural paragraph.\r\n\r\n${isComprehensiveQuery ? `### SPECIAL INSTRUCTION FOR COMPREHENSIVE QUERIES: When the user asks for a list of items (such as faculty and their trainings/seminars), you MUST provide ALL the information found in the documents. Do not summarize or abbreviate. If multiple documents contain relevant information, combine and present ALL the data from all documents. Use a clear format like bullet points or structured lists to make the information easy to read. CRITICAL: If you state that you are providing a list, you MUST actually provide the complete list content. Do not just say \"Here is the list...\" without providing the actual items in the list. READ EVERY DOCUMENT CAREFULLY and extract ALL relevant information BEFORE forming your response. Do not stop at the first few items you find - continue reading through all documents to ensure you have collected all relevant information.` : ''}\r\n-------------------------------------------------------\r\n`\r\n   });\r\n\r\n   // Process each result to provide to the model\r\n   for (const result of searchResults.slice(0, 6)) {\r\n     \r\n     const hasVisuals = result.screenshots && result.screenshots.length > 0;\r\n     const hasText = result.extractedText && result.extractedText.trim().length > 0;\r\n\r\n     // Divider\r\n     multimodalParts.push({\r\n       text: `\\n\\n=== Document: \"${result.title}\" ===\\n`\r\n     });\r\n\r\n     // 1. Provide the Visuals (Universal for PDF, PNG, Excel, etc.)\r\n     if (hasVisuals && result.screenshots) {\r\n       for (const screenshot of result.screenshots) {\r\n           \r\n       // MAGIC FIX: Detect Type from the string signature\r\n       // Colivara converts PDFs to PNG screenshots, so we must detect 'iVBOR'\r\n       let realMimeType = 'image/jpeg';\r\n       if (typeof screenshot === 'string') {\r\n           if (screenshot.startsWith('iVBOR')) {\r\n               realMimeType = 'image/png'; // <--- This is the key fix for your PDFs\r\n           } else if (screenshot.startsWith('/9j/')) {\r\n               realMimeType = 'image/jpeg';\r\n           } else if (screenshot.startsWith('iVBO')) {\r\n               realMimeType = 'image/png';\r\n           }\r\n       }\r\n\r\n       console.log(`Sending to Gemini as: ${realMimeType}`); // Debug log\r\n\r\n       multimodalParts.push({\r\n         inlineData: {\r\n           data: screenshot,\r\n           mimeType: realMimeType\r\n         }\r\n       });\r\n       }\r\n       // Prompt for Visuals\r\n       multimodalParts.push({\r\n         text: `\\n[VISUAL CONTENT: The above image contains the document content. Extract relevant information to answer: \"${query}\"]\\n`\r\n       });\r\n     }\r\n\r\n     // 2. Provide the Text (Universal for PDF, Word, etc.)\r\n     if (hasText) {\r\n       multimodalParts.push({\r\n         text: `\\n[TEXT CONTENT: ${result.extractedText}]\\n`\r\n       });\r\n     } else {\r\n       // 3. Handle \"Visual Only\" Files (Scans/Images)\r\n       multimodalParts.push({\r\n         text: `\\n[NO TEXT EXTRACTED: Focus on visual content to answer: \"${query}\"]\\n`\r\n       });\r\n     }\r\n   }\r\n\r\n   // Add final instruction to ensure the model responds directly to the query\r\n   multimodalParts.push({\r\n     text: `\\n\\n${isComprehensiveQuery ? `### SPECIAL INSTRUCTION FOR COMPREHENSIVE QUERIES: When the user asks for a list of items (such as faculty and their trainings/seminars), you MUST provide ALL the information found in the documents. Do not summarize or abbreviate. If multiple documents contain relevant information, combine and present ALL the data from all documents. Use a clear format like bullet points or structured lists to make the information easy to read. CRITICAL: If you state that you are providing a list, you MUST actually provide the complete list content. Do not just say \"Here is the list...\" without providing the actual items in the list. READ EVERY DOCUMENT CAREFULLY and extract ALL relevant information BEFORE forming your response. Do not stop at the first few items you find - continue reading through all documents to ensure you have collected all relevant information.` : ''}\\n\\nBased on the above documents, provide a clear, direct answer to this query: \"${query}\". Answer the question directly using specific information from the documents. If the documents don't contain the answer, say so clearly.`\r\n   });\r\n\r\n   // Generate content using the model\r\n   const result = await this.model.generateContent({\r\n     contents: [{ role: 'user', parts: multimodalParts }],\r\n     generationConfig: this.config.generationConfig!,\r\n     safetySettings: this.config.safetySettings!,\r\n   });\r\n\r\n   const response = await result.response;\r\n   return response.text();\r\n }\r\n\r\n /**\r\n  * Generate insights from search results\r\n  * @param query User's search query\r\n  * @param searchResults Results from Colivara semantic search\r\n  * @param userId User identifier for rate limiting\r\n  */\r\nasync generateInsights(\r\n   query: string,\r\n   searchResults: SearchResult[],\r\n   userId?: string\r\n ): Promise<{\r\n   summary: string;\r\n   keyPoints: string[];\r\n   sources: Array<{ title: string; documentId: string; confidence: number }>;\r\n }> {\r\n   const startTime = Date.now();\r\n   try {\r\n     // Use user ID for rate limiting, fallback to a general identifier if not provided\r\n     const identifier = userId || 'anonymous';\r\n     \r\n     // Check if request is allowed based on rate limiting\r\n     if (!this.configService.isRequestAllowed(identifier)) {\r\n       const remainingRequests = this.configService.getRemainingRequests(identifier);\r\n       const resetTime = this.configService.getResetTime(identifier);\r\n       const resetTimeFormatted = new Date(resetTime).toLocaleTimeString();\r\n       \r\n       const error = new Error(\r\n         `Rate limit exceeded. You can make ${remainingRequests} more requests after ${resetTimeFormatted}.`\r\n       );\r\n       \r\n       // Track the failed request\r\n       this.monitoringService.trackGeneration(\r\n         userId || 'unknown',\r\n         query,\r\n         Date.now() - startTime,\r\n         false,\r\n         error.message,\r\n         this.config.model\r\n       );\r\n       \r\n       throw error;\r\n     }\r\n\r\n     const maxResults = 6; // Increased from 5 to 6 for Gemini 2.0 Flash\r\n     const limitedResults = searchResults.slice(0, maxResults);\r\n\r\n     if (limitedResults.length === 0) {\r\n       const result = {\r\n         summary: \"No relevant documents found to generate insights.\",\r\n         keyPoints: [],\r\n         sources: [],\r\n       };\r\n       \r\n       // Track the successful request with no results\r\n       this.monitoringService.trackGeneration(\r\n         userId || 'unknown',\r\n         query,\r\n         Date.now() - startTime,\r\n         true,\r\n         undefined,\r\n         this.config.model\r\n       );\r\n       \r\n       return result;\r\n     }\r\n\r\n     // For JSON responses, we need to handle multimodal content differently\r\n     // since we can't easily embed images in a JSON response context\r\n     // So we'll use a text-only approach for JSON responses but still indicate visual content\r\n     \r\n     // For insights, we'll use a different approach that better handles multimodal content\r\n     // Since we can't easily embed images in JSON responses, we'll use the multimodal approach but structured for insights\r\n     \r\n     // Format the search results into a context string with visual content for insights\r\n     const multimodalParts = [];\r\n     \r\n     multimodalParts.push({\r\n       text: `\r\n You are an intelligent assistant capable of reading documents and extracting specific details.\r\n Your goal is to answer the user's question accurately based ONLY on the provided document images.\r\n\r\n ### DATA EXTRACTION RULES:\r\n 1. **Read the Visuals:** The documents may contain tables, lists, or spreadsheets. Scan them carefully row-by-row.\r\n 2. **Be Thorough:** If the user asks for a list (e.g., \"all faculty\"), extract EVERY name you see in the document images. Do not summarize.\r\n 3. ** OCR Handling:** If text is slightly blurry, use your best judgment to correct obvious spelling errors (e.g., interpret \"M@rk\" as \"Mark\").\r\n\r\n ### OUTPUT FORMATTING:\r\n If the data involves multiple items (like names and trainings), you must use a **Nested Bullet List** format:\r\n\r\n * **Name of Person**\r\n   * Training Title A\r\n   * Training Title B\r\n\r\n If the answer is simple text, use a natural paragraph.\r\n -------------------------------------------------------\r\n `\r\n     });\r\n     \r\n     // Process each result\r\n     for (const result of limitedResults) {\r\n       const hasVisuals = result.screenshots && result.screenshots.length > 0;\r\n       const hasText = result.extractedText && result.extractedText.trim().length > 0;\r\n       const title = result.title || 'Untitled Document';\r\n       const confidence = result.confidenceScore || 0;\r\n       \r\n       // Add document header\r\n       multimodalParts.push({\r\n         text: `\\n\\n=== Document: \"${title}\" (relevance: ${(confidence * 100).toFixed(1)}%) ===\\n`\r\n       });\r\n\r\n       // 1. Provide the Visuals (Universal for PDF, PNG, Excel, etc.)\r\n       if (hasVisuals && result.screenshots) {\r\n         for (const screenshot of result.screenshots) {\r\n             \r\n         // MAGIC FIX: Detect Type from the string signature\r\n         let realMimeType = 'image/jpeg';\r\n         if (typeof screenshot === 'string') {\r\n             if (screenshot.startsWith('iVBOR')) {\r\n                 realMimeType = 'image/png';\r\n             } else if (screenshot.startsWith('/9j/')) {\r\n                 realMimeType = 'image/jpeg';\r\n             } else if (screenshot.startsWith('iVBO')) {\r\n                 realMimeType = 'image/png';\r\n             }\r\n         }\r\n\r\n         console.log(`Sending to Gemini as: ${realMimeType}`); // Debug log\r\n\r\n         multimodalParts.push({\r\n           inlineData: {\r\n             data: screenshot,\r\n             mimeType: realMimeType\r\n           }\r\n         });\r\n         }\r\n         // Prompt for Visuals\r\n         multimodalParts.push({\r\n           text: `\\n[VISUAL CONTENT: The above image contains document information. Extract data relevant to: \"${query}\"]\\n`\r\n         });\r\n       }\r\n\r\n       // 2. Provide the Text (Universal for PDF, Word, etc.)\r\n       if (hasText) {\r\n         multimodalParts.push({\r\n           text: `\\n[TEXT CONTENT: ${result.extractedText}]\\n`\r\n         });\r\n       } else {\r\n         // 3. Handle \"Visual Only\" Files (Scans/Images)\r\n         multimodalParts.push({\r\n           text: `\\n[NO TEXT EXTRACTED: Focus on visual content to answer: \"${query}\"]\\n`\r\n         });\r\n       }\r\n     }\r\n\r\n     // Check if the query is asking for comprehensive information (like lists of faculty/trainings)\r\n     const isComprehensiveQuery = query.toLowerCase().includes('list') ||\r\n                                 query.toLowerCase().includes('all') ||\r\n                                 query.toLowerCase().includes('every') ||\r\n                                 query.toLowerCase().includes('faculty') ||\r\n                                 query.toLowerCase().includes('training') ||\r\n                                 query.toLowerCase().includes('seminar') ||\r\n                                 query.toLowerCase().includes('attended') ||\r\n                                 query.toLowerCase().includes('presentation') ||\r\n                                 query.toLowerCase().includes('research') ||\r\n                                 (query.toLowerCase().includes('what') && query.toLowerCase().includes('training')) ||\r\n                                 (query.toLowerCase().includes('what') && query.toLowerCase().includes('seminar')) ||\r\n                                 (query.toLowerCase().includes('which') && query.toLowerCase().includes('training')) ||\r\n                                 (query.toLowerCase().includes('which') && query.toLowerCase().includes('seminar'));\r\n\r\n     // Add special instruction for comprehensive queries\r\n     multimodalParts.push({\r\n       text: `\\n\\n${isComprehensiveQuery ? `### SPECIAL INSTRUCTION FOR COMPREHENSIVE QUERIES: When the user asks for a list of items (such as faculty and their trainings/seminars), you MUST provide ALL the information found in the documents. Do not summarize or abbreviate. If multiple documents contain relevant information, combine and present ALL the data from all documents. Use a clear format like bullet points or structured lists to make the information easy to read. CRITICAL: If you state that you are providing a list, you MUST actually provide the complete list content. Do not just say \"Here is the list...\" without providing the actual items in the list. READ EVERY DOCUMENT CAREFULLY and extract ALL relevant information BEFORE forming your response. Do not stop at the first few items you find - continue reading through all documents to ensure you have collected all relevant information.` : ''}\\n\\nBased on the above documents, provide a clear, direct answer to \"${query}\". Format your response as JSON with the following structure: { \"summary\": \"Direct answer to the user's query based on document content\", \"keyPoints\": [\"Concise points that directly address the query\", \"Relevant information from documents\"], \"sources\": [ { \"title\": \"Document title\", \"documentId\": \"Document ID if available\", \"confidence\": \"Confidence score between 0 and 1\" } ] }`\r\n     });\r\n\r\n     const prompt = `Based on the following documents, please provide a summary, key points, and sources related to the query: ${query}\r\n\r\nDocuments:\r\n[MULTIMODAL CONTENT PROVIDED IN THE REQUEST]\r\n\r\nPlease format your response as JSON with the following structure:\r\n{\r\n \"summary\": \"Brief summary of the documents in relation to the query\",\r\n \"keyPoints\": [\"List of key points from the documents\", \"Each point should be concise and informative\"],\r\n \"sources\": [\r\n   {\r\n     \"title\": \"Document title\",\r\n     \"documentId\": \"Document ID if available\",\r\n     \"confidence\": \"Confidence score between 0 and 1\"\r\n   }\r\n ]\r\n}`;\r\n\r\n     const insightsResult = await this.model.generateContent({\r\n       contents: [{ role: 'user', parts: multimodalParts }], // Use multimodalParts instead of just text prompt\r\n       generationConfig: {\r\n         ...this.config.generationConfig,\r\n         responseMimeType: 'application/json',\r\n       },\r\n       safetySettings: this.config.safetySettings,\r\n     });\r\n\r\n     const response = await insightsResult.response;\r\n     const text = response.text();\r\n     \r\n     // Parse the JSON response\r\n     try {\r\n       const parsed = JSON.parse(text);\r\n       \r\n       // Track the successful request\r\n       this.monitoringService.trackGeneration(\r\n         userId || 'unknown',\r\n         query,\r\n         Date.now() - startTime,\r\n         true,\r\n         undefined,\r\n         this.config.model\r\n       );\r\n       \r\n       return parsed;\r\n     } catch (parseError) {\r\n       console.error('Error parsing Gemini JSON response:', parseError);\r\n       // Fallback: return a basic structure\r\n       const fallbackResult = {\r\n         summary: text.substring(0, 500) + (text.length > 500 ? '...' : ''),\r\n         keyPoints: [text.substring(0, 200)],\r\n         sources: limitedResults.map(result => ({\r\n           title: result.title || 'Untitled Document',\r\n           documentId: result.documentId || '',\r\n           confidence: result.confidenceScore || 0\r\n         }))\r\n       };\r\n       \r\n       // Track the successful request with fallback\r\n       this.monitoringService.trackGeneration(\r\n         userId || 'unknown',\r\n         query,\r\n         Date.now() - startTime,\r\n         true,\r\n         'Fallback due to JSON parsing error',\r\n         this.config.model\r\n       );\r\n       \r\n       return fallbackResult;\r\n     }\r\n   } catch (error) {\r\n     console.error('Error generating insights with Gemini:', error);\r\n     \r\n     // Track the failed request\r\n     this.monitoringService.trackGeneration(\r\n       userId || 'unknown',\r\n       query,\r\n       Date.now() - startTime,\r\n       false,\r\n       error instanceof Error ? error.message : 'Unknown error',\r\n       this.config.model\r\n     );\r\n     \r\n     throw error;\r\n   }\r\n}\r\n\r\n  /**\r\n   * Check if the service is properly initialized and API key is valid\r\n   */\r\n  async healthCheck(): Promise<boolean> {\r\n    const startTime = Date.now();\r\n    try {\r\n      // Try to get model information as a basic health check\r\n      await this.model.generateContent({\r\n        contents: [{ role: 'user', parts: [{ text: 'Hello' }] }],\r\n        generationConfig: {\r\n          temperature: 0,\r\n          maxOutputTokens: 5,\r\n        },\r\n        safetySettings: this.config.safetySettings,\r\n      });\r\n      \r\n      // Track the successful health check\r\n      this.monitoringService.logMetric({\r\n        endpoint: 'gemini-health-check',\r\n        responseTime: Date.now() - startTime,\r\n        success: true,\r\n        model: this.config.model\r\n      });\r\n      \r\n      return true;\r\n    } catch (error) {\r\n      console.error('Gemini service health check failed:', error);\r\n      \r\n      // Track the failed health check\r\n      this.monitoringService.logMetric({\r\n        endpoint: 'gemini-health-check',\r\n        responseTime: Date.now() - startTime,\r\n        success: false,\r\n        error: error instanceof Error ? error.message : 'Unknown error',\r\n        model: this.config.model\r\n      });\r\n      \r\n      return false;\r\n    }\r\n  }\r\n}\r\n\r\nexport default GeminiGenerationService;"],"names":[],"mappings":"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","ignoreList":[0]}