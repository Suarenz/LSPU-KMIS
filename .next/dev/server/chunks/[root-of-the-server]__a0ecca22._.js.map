{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///D:/downloads/Downloads%20from%20web/LSPU%20KMIS/lib/services/jwt-service.ts"],"sourcesContent":["// This service is for handling custom JWT tokens for database authentication\r\n\r\nexport interface TokenPayload {\r\n  userId: string;\r\n  email: string;\r\n  role: string;\r\n  iat: number;\r\n  exp: number;\r\n}\r\n\r\nclass JWTService {\r\n  private readonly secret: string;\r\n\r\n  constructor() {\r\n    this.secret = process.env.JWT_SECRET || '6dFk5d0vbyLnZC0Amy83LtI47DsNr/KB4M+FgbUc6njd4cjk7XB2/8nTuhQDWW8OOgQ6fI74huxJE3a/RP2giw==';\r\n  }\r\n\r\n  /**\r\n   * Convert a string to a Uint8Array (which can be used with Web Crypto API)\r\n   */\r\n private stringToUint8Array(str: string): Uint8Array {\r\n    return new TextEncoder().encode(str);\r\n }\r\n\r\n /**\r\n  * Convert a Uint8Array to a base64url encoded string\r\n  */\r\n private uint8ArrayToBase64Url(uint8Array: Uint8Array): string {\r\n   let binary = '';\r\n   for (let i = 0; i < uint8Array.byteLength; i++) {\r\n     binary += String.fromCharCode(uint8Array[i]);\r\n   }\r\n   return btoa(binary)\r\n     .replace(/\\+/g, '-')\r\n     .replace(/\\//g, '_')\r\n     .replace(/=/g, '');\r\n }\r\n\r\n  /**\r\n   * Import the secret as a CryptoKey for use with Web Crypto API\r\n   */\r\n  private async importSecret(): Promise<CryptoKey> {\r\n    const encoder = new TextEncoder();\r\n    const keyBuffer = encoder.encode(this.secret);\r\n    \r\n    return await crypto.subtle.importKey(\r\n      'raw',\r\n      keyBuffer,\r\n      { name: 'HMAC', hash: 'SHA-256' },\r\n      false,\r\n      ['sign', 'verify']\r\n    );\r\n  }\r\n\r\n /**\r\n   * Generate a JWT token using Web Crypto API\r\n   */\r\n  async generateToken(payload: Omit<TokenPayload, 'iat' | 'exp'>): Promise<string> {\r\n    try {\r\n      // Create the header\r\n      const header = {\r\n        alg: 'HS256',\r\n        typ: 'JWT'\r\n      };\r\n\r\n      // Add timestamp and expiration (1 hour from now)\r\n      const timestamp = Math.floor(Date.now() / 1000);\r\n      const expiration = timestamp + 3600; // 1 hour in seconds\r\n\r\n      // Create the payload with the provided data and timestamps\r\n      const fullPayload = {\r\n        ...payload,\r\n        iat: timestamp,\r\n        exp: expiration\r\n      };\r\n\r\n      // Encode header and payload to base64url\r\n      const encodedHeader = this.uint8ArrayToBase64Url(\r\n        this.stringToUint8Array(JSON.stringify(header))\r\n      );\r\n      const encodedPayload = this.uint8ArrayToBase64Url(\r\n        this.stringToUint8Array(JSON.stringify(fullPayload))\r\n      );\r\n\r\n      // Create the signing input\r\n      const signingInput = `${encodedHeader}.${encodedPayload}`;\r\n\r\n      // Import the secret as a crypto key\r\n      const key = await this.importSecret();\r\n\r\n      // Create signing input buffer in the proper format for Web Crypto API\r\n      const encoder = new TextEncoder();\r\n      const signingInputBuffer = encoder.encode(signingInput);\r\n      \r\n      // Sign the token - use type assertion to handle TypeScript compatibility issues\r\n      const signatureBuffer = await crypto.subtle.sign(\r\n        'HMAC',\r\n        key,\r\n        signingInputBuffer as BufferSource\r\n      );\r\n\r\n      // Encode the signature - signatureBuffer is an ArrayBuffer, convert to base64url\r\n      const signatureUint8Array = new Uint8Array(signatureBuffer);\r\n      const encodedSignature = this.uint8ArrayToBase64Url(signatureUint8Array);\r\n\r\n      // Return the complete JWT token\r\n      return `${signingInput}.${encodedSignature}`;\r\n    } catch (error) {\r\n      console.error('JWT token generation failed:', error);\r\n      throw new Error('Failed to generate JWT token');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Verify a JWT token using Web Crypto API\r\n   */\r\n  async verifyToken(token: string): Promise<TokenPayload | null> {\r\n    try {\r\n      // Check if token is valid before attempting to verify\r\n      if (!token || typeof token !== 'string' || token.trim() === '') {\r\n        console.error('Invalid token provided for verification');\r\n        return null;\r\n      }\r\n      \r\n      // Check if token has proper format (3 parts separated by dots)\r\n      const tokenParts = token.split('.');\r\n      if (tokenParts.length !== 3) {\r\n        console.error('Token format is invalid');\r\n        return null;\r\n      }\r\n\r\n      const [encodedHeader, encodedPayload, encodedSignature] = tokenParts;\r\n\r\n      // Decode header\r\n      const decodedHeader = this.base64UrlDecode(encodedHeader);\r\n      if (!decodedHeader) {\r\n        console.error('Failed to decode token header');\r\n        return null;\r\n      }\r\n\r\n      // Decode payload\r\n      const decodedPayloadStr = this.base64UrlDecode(encodedPayload);\r\n      if (!decodedPayloadStr) {\r\n        console.error('Failed to decode token payload');\r\n        return null;\r\n      }\r\n\r\n      // Parse payload\r\n      const payloadObj = JSON.parse(decodedPayloadStr) as TokenPayload;\r\n      \r\n      // Check if token is expired\r\n      const currentTime = Math.floor(Date.now() / 1000);\r\n      if (payloadObj.exp && payloadObj.exp < currentTime) {\r\n        console.error('Token has expired');\r\n        return null;\r\n      }\r\n\r\n      // Import the secret as a crypto key\r\n      const key = await this.importSecret();\r\n\r\n      // Verify the signature\r\n      const isValid = await this.verifySignature(\r\n        `${encodedHeader}.${encodedPayload}`,\r\n        encodedSignature,\r\n        key\r\n      );\r\n\r\n      if (!isValid) {\r\n        console.error('Token signature verification failed');\r\n        return null;\r\n      }\r\n\r\n      return payloadObj;\r\n    } catch (error: any) {\r\n      console.error('Token verification failed:', error?.message || error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Verify the JWT signature using Web Crypto API\r\n   */\r\n  private async verifySignature(\r\n    signingInput: string,\r\n    signature: string,\r\n    key: CryptoKey\r\n  ): Promise<boolean> {\r\n    try {\r\n      // Decode the signature from base64url to Uint8Array\r\n      const signatureBytes = this.base64UrlDecodeToUint8Array(signature);\r\n      if (!signatureBytes) {\r\n        return false;\r\n      }\r\n\r\n      // Create proper buffers for Web Crypto API\r\n      const encoder = new TextEncoder();\r\n      const verificationInputBuffer = encoder.encode(signingInput);\r\n      \r\n      // Use ArrayBufferView for signatureBytes and input buffer\r\n      // Cast to appropriate types to handle TypeScript issues\r\n      const signatureView = new Uint8Array(signatureBytes.buffer, signatureBytes.byteOffset, signatureBytes.byteLength);\r\n      const inputView = new Uint8Array(verificationInputBuffer.buffer, verificationInputBuffer.byteOffset, verificationInputBuffer.byteLength);\r\n      \r\n      // Verify the signature - use type assertion to handle TypeScript compatibility issues\r\n      const isValid = await crypto.subtle.verify(\r\n        'HMAC',\r\n        key,\r\n        signatureView as BufferSource,\r\n        inputView as BufferSource\r\n      );\r\n\r\n      return isValid;\r\n    } catch (error) {\r\n      console.error('Signature verification error:', error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n /**\r\n   * Decode a JWT token without verification (for edge runtime compatibility)\r\n   * This only extracts the payload without validating the signature\r\n   * Use carefully - only for non-sensitive operations like checking expiration\r\n   */\r\n  decodeToken(token: string): TokenPayload | null {\r\n    try {\r\n      if (!token || typeof token !== 'string' || token.trim() === '') {\r\n        return null;\r\n      }\r\n      \r\n      const tokenParts = token.split('.');\r\n      if (tokenParts.length !== 3) {\r\n        console.error('Token format is invalid');\r\n        return null;\r\n      }\r\n\r\n      const payload = tokenParts[1];\r\n      const decodedPayload = this.base64UrlDecode(payload);\r\n      if (!decodedPayload) {\r\n        return null;\r\n      }\r\n      \r\n      return JSON.parse(decodedPayload) as TokenPayload;\r\n    } catch (error: any) {\r\n      console.error('Token decoding failed:', error?.message || error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Check if a token is expired without full verification\r\n   * This uses the decode method which doesn't require the secret\r\n   */\r\n  isTokenExpired(token: string): boolean {\r\n    try {\r\n      const decoded = this.decodeToken(token);\r\n      if (!decoded || !decoded.exp) {\r\n        return true; // If we can't decode or there's no expiration, consider it expired\r\n      }\r\n      // Compare expiration timestamp with current time (in seconds)\r\n      const currentTime = Math.floor(Date.now() / 1000);\r\n      return decoded.exp < currentTime;\r\n    } catch (error) {\r\n      console.error('Error checking token expiration:', error);\r\n      return true; // If there's an error, assume token is expired\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Helper function to decode base64url encoded strings\r\n   */\r\n  private base64UrlDecode(str: string): string | null {\r\n    try {\r\n      // Add padding if needed\r\n      const padding = '='.repeat((4 - (str.length % 4)) % 4);\r\n      const base64 = str.replace(/-/g, '+').replace(/_/g, '/') + padding;\r\n      const rawData = atob(base64);\r\n      return decodeURIComponent(escape(rawData));\r\n    } catch (error) {\r\n      console.error('Base64 URL decode error:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Helper function to decode base64url string to Uint8Array\r\n   */\r\n  private base64UrlDecodeToUint8Array(str: string): Uint8Array | null {\r\n    try {\r\n      // Add padding if needed\r\n      const padding = '='.repeat((4 - (str.length % 4)) % 4);\r\n      const base64 = str.replace(/-/g, '+').replace(/_/g, '/') + padding;\r\n      const rawData = atob(base64);\r\n      \r\n      const buffer = new Uint8Array(rawData.length);\r\n      for (let i = 0; i < rawData.length; i++) {\r\n        buffer[i] = rawData.charCodeAt(i);\r\n      }\r\n      \r\n      return buffer;\r\n    } catch (error) {\r\n      console.error('Base64 URL decode to Uint8Array error:', error);\r\n      return null;\r\n    }\r\n  }\r\n}\r\n\r\nexport default new JWTService();"],"names":[],"mappings":"AAAA,6EAA6E;;;;;AAU7E,MAAM;IACa,OAAe;IAEhC,aAAc;QACZ,IAAI,CAAC,MAAM,GAAG,QAAQ,GAAG,CAAC,UAAU,IAAI;IAC1C;IAEA;;GAEC,GACF,AAAQ,mBAAmB,GAAW,EAAc;QACjD,OAAO,IAAI,cAAc,MAAM,CAAC;IACnC;IAEA;;EAEC,GACD,AAAQ,sBAAsB,UAAsB,EAAU;QAC5D,IAAI,SAAS;QACb,IAAK,IAAI,IAAI,GAAG,IAAI,WAAW,UAAU,EAAE,IAAK;YAC9C,UAAU,OAAO,YAAY,CAAC,UAAU,CAAC,EAAE;QAC7C;QACA,OAAO,KAAK,QACT,OAAO,CAAC,OAAO,KACf,OAAO,CAAC,OAAO,KACf,OAAO,CAAC,MAAM;IACnB;IAEC;;GAEC,GACD,MAAc,eAAmC;QAC/C,MAAM,UAAU,IAAI;QACpB,MAAM,YAAY,QAAQ,MAAM,CAAC,IAAI,CAAC,MAAM;QAE5C,OAAO,MAAM,OAAO,MAAM,CAAC,SAAS,CAClC,OACA,WACA;YAAE,MAAM;YAAQ,MAAM;QAAU,GAChC,OACA;YAAC;YAAQ;SAAS;IAEtB;IAED;;GAEE,GACD,MAAM,cAAc,OAA0C,EAAmB;QAC/E,IAAI;YACF,oBAAoB;YACpB,MAAM,SAAS;gBACb,KAAK;gBACL,KAAK;YACP;YAEA,iDAAiD;YACjD,MAAM,YAAY,KAAK,KAAK,CAAC,KAAK,GAAG,KAAK;YAC1C,MAAM,aAAa,YAAY,MAAM,oBAAoB;YAEzD,2DAA2D;YAC3D,MAAM,cAAc;gBAClB,GAAG,OAAO;gBACV,KAAK;gBACL,KAAK;YACP;YAEA,yCAAyC;YACzC,MAAM,gBAAgB,IAAI,CAAC,qBAAqB,CAC9C,IAAI,CAAC,kBAAkB,CAAC,KAAK,SAAS,CAAC;YAEzC,MAAM,iBAAiB,IAAI,CAAC,qBAAqB,CAC/C,IAAI,CAAC,kBAAkB,CAAC,KAAK,SAAS,CAAC;YAGzC,2BAA2B;YAC3B,MAAM,eAAe,GAAG,cAAc,CAAC,EAAE,gBAAgB;YAEzD,oCAAoC;YACpC,MAAM,MAAM,MAAM,IAAI,CAAC,YAAY;YAEnC,sEAAsE;YACtE,MAAM,UAAU,IAAI;YACpB,MAAM,qBAAqB,QAAQ,MAAM,CAAC;YAE1C,gFAAgF;YAChF,MAAM,kBAAkB,MAAM,OAAO,MAAM,CAAC,IAAI,CAC9C,QACA,KACA;YAGF,iFAAiF;YACjF,MAAM,sBAAsB,IAAI,WAAW;YAC3C,MAAM,mBAAmB,IAAI,CAAC,qBAAqB,CAAC;YAEpD,gCAAgC;YAChC,OAAO,GAAG,aAAa,CAAC,EAAE,kBAAkB;QAC9C,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,gCAAgC;YAC9C,MAAM,IAAI,MAAM;QAClB;IACF;IAEA;;GAEC,GACD,MAAM,YAAY,KAAa,EAAgC;QAC7D,IAAI;YACF,sDAAsD;YACtD,IAAI,CAAC,SAAS,OAAO,UAAU,YAAY,MAAM,IAAI,OAAO,IAAI;gBAC9D,QAAQ,KAAK,CAAC;gBACd,OAAO;YACT;YAEA,+DAA+D;YAC/D,MAAM,aAAa,MAAM,KAAK,CAAC;YAC/B,IAAI,WAAW,MAAM,KAAK,GAAG;gBAC3B,QAAQ,KAAK,CAAC;gBACd,OAAO;YACT;YAEA,MAAM,CAAC,eAAe,gBAAgB,iBAAiB,GAAG;YAE1D,gBAAgB;YAChB,MAAM,gBAAgB,IAAI,CAAC,eAAe,CAAC;YAC3C,IAAI,CAAC,eAAe;gBAClB,QAAQ,KAAK,CAAC;gBACd,OAAO;YACT;YAEA,iBAAiB;YACjB,MAAM,oBAAoB,IAAI,CAAC,eAAe,CAAC;YAC/C,IAAI,CAAC,mBAAmB;gBACtB,QAAQ,KAAK,CAAC;gBACd,OAAO;YACT;YAEA,gBAAgB;YAChB,MAAM,aAAa,KAAK,KAAK,CAAC;YAE9B,4BAA4B;YAC5B,MAAM,cAAc,KAAK,KAAK,CAAC,KAAK,GAAG,KAAK;YAC5C,IAAI,WAAW,GAAG,IAAI,WAAW,GAAG,GAAG,aAAa;gBAClD,QAAQ,KAAK,CAAC;gBACd,OAAO;YACT;YAEA,oCAAoC;YACpC,MAAM,MAAM,MAAM,IAAI,CAAC,YAAY;YAEnC,uBAAuB;YACvB,MAAM,UAAU,MAAM,IAAI,CAAC,eAAe,CACxC,GAAG,cAAc,CAAC,EAAE,gBAAgB,EACpC,kBACA;YAGF,IAAI,CAAC,SAAS;gBACZ,QAAQ,KAAK,CAAC;gBACd,OAAO;YACT;YAEA,OAAO;QACT,EAAE,OAAO,OAAY;YACnB,QAAQ,KAAK,CAAC,8BAA8B,OAAO,WAAW;YAC9D,OAAO;QACT;IACF;IAEA;;GAEC,GACD,MAAc,gBACZ,YAAoB,EACpB,SAAiB,EACjB,GAAc,EACI;QAClB,IAAI;YACF,oDAAoD;YACpD,MAAM,iBAAiB,IAAI,CAAC,2BAA2B,CAAC;YACxD,IAAI,CAAC,gBAAgB;gBACnB,OAAO;YACT;YAEA,2CAA2C;YAC3C,MAAM,UAAU,IAAI;YACpB,MAAM,0BAA0B,QAAQ,MAAM,CAAC;YAE/C,0DAA0D;YAC1D,wDAAwD;YACxD,MAAM,gBAAgB,IAAI,WAAW,eAAe,MAAM,EAAE,eAAe,UAAU,EAAE,eAAe,UAAU;YAChH,MAAM,YAAY,IAAI,WAAW,wBAAwB,MAAM,EAAE,wBAAwB,UAAU,EAAE,wBAAwB,UAAU;YAEvI,sFAAsF;YACtF,MAAM,UAAU,MAAM,OAAO,MAAM,CAAC,MAAM,CACxC,QACA,KACA,eACA;YAGF,OAAO;QACT,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,iCAAiC;YAC/C,OAAO;QACT;IACF;IAED;;;;GAIE,GACD,YAAY,KAAa,EAAuB;QAC9C,IAAI;YACF,IAAI,CAAC,SAAS,OAAO,UAAU,YAAY,MAAM,IAAI,OAAO,IAAI;gBAC9D,OAAO;YACT;YAEA,MAAM,aAAa,MAAM,KAAK,CAAC;YAC/B,IAAI,WAAW,MAAM,KAAK,GAAG;gBAC3B,QAAQ,KAAK,CAAC;gBACd,OAAO;YACT;YAEA,MAAM,UAAU,UAAU,CAAC,EAAE;YAC7B,MAAM,iBAAiB,IAAI,CAAC,eAAe,CAAC;YAC5C,IAAI,CAAC,gBAAgB;gBACnB,OAAO;YACT;YAEA,OAAO,KAAK,KAAK,CAAC;QACpB,EAAE,OAAO,OAAY;YACnB,QAAQ,KAAK,CAAC,0BAA0B,OAAO,WAAW;YAC1D,OAAO;QACT;IACF;IAEA;;;GAGC,GACD,eAAe,KAAa,EAAW;QACrC,IAAI;YACF,MAAM,UAAU,IAAI,CAAC,WAAW,CAAC;YACjC,IAAI,CAAC,WAAW,CAAC,QAAQ,GAAG,EAAE;gBAC5B,OAAO,MAAM,mEAAmE;YAClF;YACA,8DAA8D;YAC9D,MAAM,cAAc,KAAK,KAAK,CAAC,KAAK,GAAG,KAAK;YAC5C,OAAO,QAAQ,GAAG,GAAG;QACvB,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,oCAAoC;YAClD,OAAO,MAAM,+CAA+C;QAC9D;IACF;IAEA;;GAEC,GACD,AAAQ,gBAAgB,GAAW,EAAiB;QAClD,IAAI;YACF,wBAAwB;YACxB,MAAM,UAAU,IAAI,MAAM,CAAC,CAAC,IAAK,IAAI,MAAM,GAAG,CAAE,IAAI;YACpD,MAAM,SAAS,IAAI,OAAO,CAAC,MAAM,KAAK,OAAO,CAAC,MAAM,OAAO;YAC3D,MAAM,UAAU,KAAK;YACrB,OAAO,mBAAmB,OAAO;QACnC,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,4BAA4B;YAC1C,OAAO;QACT;IACF;IAEA;;GAEC,GACD,AAAQ,4BAA4B,GAAW,EAAqB;QAClE,IAAI;YACF,wBAAwB;YACxB,MAAM,UAAU,IAAI,MAAM,CAAC,CAAC,IAAK,IAAI,MAAM,GAAG,CAAE,IAAI;YACpD,MAAM,SAAS,IAAI,OAAO,CAAC,MAAM,KAAK,OAAO,CAAC,MAAM,OAAO;YAC3D,MAAM,UAAU,KAAK;YAErB,MAAM,SAAS,IAAI,WAAW,QAAQ,MAAM;YAC5C,IAAK,IAAI,IAAI,GAAG,IAAI,QAAQ,MAAM,EAAE,IAAK;gBACvC,MAAM,CAAC,EAAE,GAAG,QAAQ,UAAU,CAAC;YACjC;YAEA,OAAO;QACT,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,0CAA0C;YACxD,OAAO;QACT;IACF;AACF;uCAEe,IAAI"}},
    {"offset": {"line": 283, "column": 0}, "map": {"version":3,"sources":["file:///D:/downloads/Downloads%20from%20web/LSPU%20KMIS/lib/prisma.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client'\r\n\r\n// Create Prisma client instance\r\nconst createPrismaClient = () => {\r\n  return new PrismaClient({\r\n    log: ['query', 'info', 'warn', 'error'], // Enable detailed logging\r\n  })\r\n}\r\n\r\ndeclare global {\r\n  // eslint-disable-next-line no-var\r\n  var prisma: PrismaClient | undefined\r\n}\r\n\r\n// Use the global instance in development to prevent exceeding connection limits\r\nconst client = globalThis.prisma || createPrismaClient()\r\nif (process.env.NODE_ENV !== 'production') globalThis.prisma = client\r\n\r\nexport default client"],"names":[],"mappings":";;;;AAAA;;AAEA,gCAAgC;AAChC,MAAM,qBAAqB;IACzB,OAAO,IAAI,6IAAY,CAAC;QACtB,KAAK;YAAC;YAAS;YAAQ;YAAQ;SAAQ;IACzC;AACF;AAOA,gFAAgF;AAChF,MAAM,SAAS,WAAW,MAAM,IAAI;AACpC,wCAA2C,WAAW,MAAM,GAAG;uCAEhD"}},
    {"offset": {"line": 308, "column": 0}, "map": {"version":3,"sources":["file:///D:/downloads/Downloads%20from%20web/LSPU%20KMIS/lib/utils/rbac.ts"],"sourcesContent":["/**\r\n * Role-Based Access Control (RBAC) utilities for LSPU KMIS\r\n * Defines role hierarchies and permission checks\r\n */\r\n\r\nexport type UserRole = 'ADMIN' | 'FACULTY' | 'STUDENT' | 'EXTERNAL';\r\n\r\n// Define role hierarchy - ADMIN has highest privileges, followed by FACULTY, STUDENT, then EXTERNAL\r\nconst ROLE_HIERARCHY: Record<UserRole, number> = {\r\n  'ADMIN': 4,\r\n  'FACULTY': 3,\r\n  'STUDENT': 2,\r\n  'EXTERNAL': 1\r\n};\r\n\r\n/**\r\n * Check if a user has a specific role\r\n */\r\nexport function hasRole(userRole: UserRole, requiredRole: UserRole): boolean {\r\n  return userRole === requiredRole;\r\n}\r\n\r\n/**\r\n * Check if a user has any of the specified roles\r\n */\r\nexport function hasAnyRole(userRole: UserRole, requiredRoles: UserRole[]): boolean {\r\n  return requiredRoles.includes(userRole);\r\n}\r\n\r\n/**\r\n * Check if a user's role has higher or equal hierarchy than required role\r\n */\r\nexport function hasRoleHierarchy(userRole: UserRole, requiredRole: UserRole): boolean {\r\n  return ROLE_HIERARCHY[userRole] >= ROLE_HIERARCHY[requiredRole];\r\n}\r\n\r\n/**\r\n * Check if user has admin privileges\r\n */\r\nexport function isAdmin(userRole: UserRole): boolean {\r\n  return userRole === 'ADMIN';\r\n}\r\n\r\n/**\r\n * Check if user has faculty privileges\r\n */\r\nexport function isFaculty(userRole: UserRole): boolean {\r\n  return userRole === 'FACULTY' || userRole === 'ADMIN';\r\n}\r\n\r\n/**\r\n * Check if user has student privileges\r\n */\r\nexport function isStudent(userRole: UserRole): boolean {\r\n  return userRole === 'STUDENT' || userRole === 'FACULTY' || userRole === 'ADMIN';\r\n}\r\n\r\n/**\r\n * Check if user has external privileges\r\n */\r\nexport function isExternal(userRole: UserRole): boolean {\r\n  return userRole === 'EXTERNAL' || userRole === 'STUDENT' || userRole === 'FACULTY' || userRole === 'ADMIN';\r\n}\r\n\r\n/**\r\n * Get allowed actions based on user role\r\n */\r\nexport function getAllowedActions(userRole: UserRole): string[] {\r\n  switch (userRole) {\r\n    case 'ADMIN':\r\n      return [\r\n        'CREATE_DOCUMENT',\r\n        'READ_DOCUMENT',\r\n        'UPDATE_DOCUMENT',\r\n        'DELETE_DOCUMENT',\r\n        'CREATE_USER',\r\n        'READ_USER',\r\n        'UPDATE_USER',\r\n        'DELETE_USER',\r\n        'CREATE_UNIT',\r\n        'READ_UNIT',\r\n        'UPDATE_UNIT',\r\n        'DELETE_UNIT',\r\n        'MANAGE_PERMISSIONS',\r\n        'VIEW_ANALYTICS'\r\n      ];\r\n    case 'FACULTY':\r\n      return [\r\n        'CREATE_DOCUMENT',\r\n        'READ_DOCUMENT',\r\n        'UPDATE_DOCUMENT',\r\n        'READ_USER',\r\n        'READ_UNIT',\r\n        'VIEW_ANALYTICS'\r\n      ];\r\n    case 'STUDENT':\r\n      return [\r\n        'READ_DOCUMENT',\r\n        'READ_USER',\r\n        'READ_UNIT'\r\n      ];\r\n    case 'EXTERNAL':\r\n      return [\r\n        'READ_DOCUMENT'\r\n      ];\r\n    default:\r\n      return [];\r\n  }\r\n}\r\n\r\n/**\r\n * Check if a user has permission to perform an action\r\n */\r\nexport function hasPermission(userRole: UserRole, action: string): boolean {\r\n  const allowedActions = getAllowedActions(userRole);\r\n  return allowedActions.includes(action);\r\n}\r\n\r\n/**\r\n * Get all roles that can perform a specific action\r\n */\r\nexport function getRolesForAction(action: string): UserRole[] {\r\n  const roles: UserRole[] = [];\r\n  (Object.keys(ROLE_HIERARCHY) as UserRole[]).forEach(role => {\r\n    if (hasPermission(role, action)) {\r\n      roles.push(role);\r\n    }\r\n  });\r\n  return roles;\r\n}"],"names":[],"mappings":"AAAA;;;CAGC;;;;;;;;;;;;;;;;;;;;;;AAID,oGAAoG;AACpG,MAAM,iBAA2C;IAC/C,SAAS;IACT,WAAW;IACX,WAAW;IACX,YAAY;AACd;AAKO,SAAS,QAAQ,QAAkB,EAAE,YAAsB;IAChE,OAAO,aAAa;AACtB;AAKO,SAAS,WAAW,QAAkB,EAAE,aAAyB;IACtE,OAAO,cAAc,QAAQ,CAAC;AAChC;AAKO,SAAS,iBAAiB,QAAkB,EAAE,YAAsB;IACzE,OAAO,cAAc,CAAC,SAAS,IAAI,cAAc,CAAC,aAAa;AACjE;AAKO,SAAS,QAAQ,QAAkB;IACxC,OAAO,aAAa;AACtB;AAKO,SAAS,UAAU,QAAkB;IAC1C,OAAO,aAAa,aAAa,aAAa;AAChD;AAKO,SAAS,UAAU,QAAkB;IAC1C,OAAO,aAAa,aAAa,aAAa,aAAa,aAAa;AAC1E;AAKO,SAAS,WAAW,QAAkB;IAC3C,OAAO,aAAa,cAAc,aAAa,aAAa,aAAa,aAAa,aAAa;AACrG;AAKO,SAAS,kBAAkB,QAAkB;IAClD,OAAQ;QACN,KAAK;YACH,OAAO;gBACL;gBACA;gBACA;gBACA;gBACA;gBACA;gBACA;gBACA;gBACA;gBACA;gBACA;gBACA;gBACA;gBACA;aACD;QACH,KAAK;YACH,OAAO;gBACL;gBACA;gBACA;gBACA;gBACA;gBACA;aACD;QACH,KAAK;YACH,OAAO;gBACL;gBACA;gBACA;aACD;QACH,KAAK;YACH,OAAO;gBACL;aACD;QACH;YACE,OAAO,EAAE;IACb;AACF;AAKO,SAAS,cAAc,QAAkB,EAAE,MAAc;IAC9D,MAAM,iBAAiB,kBAAkB;IACzC,OAAO,eAAe,QAAQ,CAAC;AACjC;AAKO,SAAS,kBAAkB,MAAc;IAC9C,MAAM,QAAoB,EAAE;IAC3B,OAAO,IAAI,CAAC,gBAA+B,OAAO,CAAC,CAAA;QAClD,IAAI,cAAc,MAAM,SAAS;YAC/B,MAAM,IAAI,CAAC;QACb;IACF;IACA,OAAO;AACT"}},
    {"offset": {"line": 420, "column": 0}, "map": {"version":3,"sources":["file:///D:/downloads/Downloads%20from%20web/LSPU%20KMIS/lib/middleware/auth-middleware.ts"],"sourcesContent":["import { NextRequest } from 'next/server';\r\nimport { NextResponse } from 'next/server';\r\nimport jwtService from '@/lib/services/jwt-service';\r\nimport prisma from '@/lib/prisma';\r\nimport { hasAnyRole, type UserRole } from '@/lib/utils/rbac';\r\n\r\nexport async function requireAuth(request: NextRequest, roles?: string[]): Promise<{ user: any } | NextResponse> {\r\n  // Extract the token from the Authorization header or cookies\r\n  const authHeader = request.headers.get('authorization');\r\n  let token = null;\r\n  \r\n  if (authHeader && authHeader.startsWith('Bearer ')) {\r\n    token = authHeader.substring(7);\r\n  } else {\r\n    // Try to get token from cookies\r\n    const cookies = request.cookies;\r\n    token = cookies.get('access_token')?.value;\r\n  }\r\n\r\n  if (!token) {\r\n    // For API routes, return a 401 response instead of redirecting\r\n    if (request.nextUrl.pathname.startsWith('/api/')) {\r\n      return NextResponse.json({ error: 'Authentication required' }, { status: 401 });\r\n    }\r\n    // For regular routes, redirect to login\r\n    const response = NextResponse.redirect(new URL('/login', request.url));\r\n    return response;\r\n  }\r\n\r\n  // Verify the JWT token\r\n  const decoded = await jwtService.verifyToken(token);\r\n  if (!decoded) {\r\n    console.error('Token verification failed:', token ? token.substring(0, 20) + '...' : 'null');\r\n    // Token is invalid, return appropriate response based on request type\r\n    if (request.nextUrl.pathname.startsWith('/api/')) {\r\n      return NextResponse.json({ error: 'Invalid or expired token' }, { status: 401 });\r\n    } else {\r\n      // For regular routes, redirect to login\r\n      const response = NextResponse.redirect(new URL('/', request.url));\r\n      return response;\r\n    }\r\n }\r\n\r\n  console.log('Decoded token:', decoded);\r\n\r\n  // Check if decoded.userId is valid\r\n  if (!decoded.userId) {\r\n    console.error('Token does not contain userId:', decoded);\r\n    // Token doesn't contain a valid userId, return error\r\n    if (request.nextUrl.pathname.startsWith('/api/')) {\r\n      return NextResponse.json({ error: 'Invalid token: missing user ID' }, { status: 401 });\r\n    }\r\n    const response = NextResponse.redirect(new URL('/login', request.url));\r\n    return response;\r\n }\r\n\r\n  // Get user profile from database using the user ID from the token\r\n  const user = await prisma.user.findUnique({\r\n    where: {\r\n      id: decoded.userId,\r\n    },\r\n    select: {\r\n      id: true,\r\n      email: true,\r\n      name: true,\r\n      role: true,\r\n      unitId: true,\r\n    }\r\n  });\r\n\r\n  if (!user) {\r\n    console.error('User not found with ID from token:', decoded.userId);\r\n    // User doesn't exist in the database, redirect to login\r\n    const response = NextResponse.redirect(new URL('/login', request.url));\r\n    return response;\r\n }\r\n\r\n  // Check if user has required roles\r\n  if (roles && roles.length > 0 && !hasAnyRole(user.role as UserRole, roles as UserRole[])) {\r\n    // User doesn't have required role, return error for API routes\r\n    if (request.nextUrl.pathname.startsWith('/api/')) {\r\n      return NextResponse.json({ error: 'User does not have required role to perform this action' }, { status: 403 });\r\n    }\r\n    // For regular routes, redirect to unauthorized page\r\n    const response = NextResponse.redirect(new URL('/unauthorized', request.url));\r\n    return response;\r\n  }\r\n\r\n  return { user };\r\n}"],"names":[],"mappings":";;;;AACA;AACA;AACA;AACA;;;;;AAEO,eAAe,YAAY,OAAoB,EAAE,KAAgB;IACtE,6DAA6D;IAC7D,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;IACvC,IAAI,QAAQ;IAEZ,IAAI,cAAc,WAAW,UAAU,CAAC,YAAY;QAClD,QAAQ,WAAW,SAAS,CAAC;IAC/B,OAAO;QACL,gCAAgC;QAChC,MAAM,UAAU,QAAQ,OAAO;QAC/B,QAAQ,QAAQ,GAAG,CAAC,iBAAiB;IACvC;IAEA,IAAI,CAAC,OAAO;QACV,+DAA+D;QAC/D,IAAI,QAAQ,OAAO,CAAC,QAAQ,CAAC,UAAU,CAAC,UAAU;YAChD,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA0B,GAAG;gBAAE,QAAQ;YAAI;QAC/E;QACA,wCAAwC;QACxC,MAAM,WAAW,gJAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,UAAU,QAAQ,GAAG;QACpE,OAAO;IACT;IAEA,uBAAuB;IACvB,MAAM,UAAU,MAAM,8IAAU,CAAC,WAAW,CAAC;IAC7C,IAAI,CAAC,SAAS;QACZ,QAAQ,KAAK,CAAC,8BAA8B,QAAQ,MAAM,SAAS,CAAC,GAAG,MAAM,QAAQ;QACrF,sEAAsE;QACtE,IAAI,QAAQ,OAAO,CAAC,QAAQ,CAAC,UAAU,CAAC,UAAU;YAChD,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA2B,GAAG;gBAAE,QAAQ;YAAI;QAChF,OAAO;YACL,wCAAwC;YACxC,MAAM,WAAW,gJAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,KAAK,QAAQ,GAAG;YAC/D,OAAO;QACT;IACH;IAEC,QAAQ,GAAG,CAAC,kBAAkB;IAE9B,mCAAmC;IACnC,IAAI,CAAC,QAAQ,MAAM,EAAE;QACnB,QAAQ,KAAK,CAAC,kCAAkC;QAChD,qDAAqD;QACrD,IAAI,QAAQ,OAAO,CAAC,QAAQ,CAAC,UAAU,CAAC,UAAU;YAChD,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAAiC,GAAG;gBAAE,QAAQ;YAAI;QACtF;QACA,MAAM,WAAW,gJAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,UAAU,QAAQ,GAAG;QACpE,OAAO;IACV;IAEC,kEAAkE;IAClE,MAAM,OAAO,MAAM,0HAAM,CAAC,IAAI,CAAC,UAAU,CAAC;QACxC,OAAO;YACL,IAAI,QAAQ,MAAM;QACpB;QACA,QAAQ;YACN,IAAI;YACJ,OAAO;YACP,MAAM;YACN,MAAM;YACN,QAAQ;QACV;IACF;IAEA,IAAI,CAAC,MAAM;QACT,QAAQ,KAAK,CAAC,sCAAsC,QAAQ,MAAM;QAClE,wDAAwD;QACxD,MAAM,WAAW,gJAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,UAAU,QAAQ,GAAG;QACpE,OAAO;IACV;IAEC,mCAAmC;IACnC,IAAI,SAAS,MAAM,MAAM,GAAG,KAAK,CAAC,IAAA,oIAAU,EAAC,KAAK,IAAI,EAAc,QAAsB;QACxF,+DAA+D;QAC/D,IAAI,QAAQ,OAAO,CAAC,QAAQ,CAAC,UAAU,CAAC,UAAU;YAChD,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;YAA0D,GAAG;gBAAE,QAAQ;YAAI;QAC/G;QACA,oDAAoD;QACpD,MAAM,WAAW,gJAAY,CAAC,QAAQ,CAAC,IAAI,IAAI,iBAAiB,QAAQ,GAAG;QAC3E,OAAO;IACT;IAEA,OAAO;QAAE;IAAK;AAChB"}},
    {"offset": {"line": 528, "column": 0}, "map": {"version":3,"sources":["turbopack:///[project]/lib/data/strategic_plan.json"],"sourcesContent":["{\"strategic_plan_meta\":{\"university\":\"Laguna State Polytechnic University\",\"period\":\"2025-2029\",\"vision\":\"A transformative university for the sustainable development of Laguna, CALABARZON, and ASEAN Region\",\"total_kras\":22},\"kras\":[{\"kra_id\":\"KRA 1\",\"kra_title\":\"Development of New Curricula Incorporating Emerging Technologies\",\"guiding_principle\":\"Excellence and Relevance in Education\",\"initiatives\":[{\"id\":\"KRA1-KPI1\",\"key_performance_indicator\":{\"outputs\":\"enhanced curricula integrated with emerging technologies (e.g., AI, IoT, drone technology, and biotechnology) into the agriculture, fisheries, forestry, engineering, medicine, law, arts, IT and education program)\",\"outcomes\":\"students equipped with cutting-edge skills and knowledge, increasing their employability and ability to contribute to modern agricultural and fisheries practices\"},\"strategies\":[\"conduct a needs assessment to identify gaps in the current curricula and opportunities for incorporating emerging technologies\",\"collaborate with industry experts, tech companies, and research institutions to design relevant course content\",\"pilot new courses and gather feedback from students and faculty to refine content and delivery methods\"],\"programs_activities\":[\"organize workshops with faculty members to assess the current curriculum\",\"initiate partnerships with relevant tech companies and research institutions to identify trends in emerging technologies\",\"form content development teams comprising faculty and industry partners to create course materials integrating emerging technologies\"],\"responsible_offices\":[\"Office of the Vice President for Academic Affairs\",\"Curriculum and Instruction Development Unit\",\"Deans\"],\"targets\":{\"type\":\"milestone\",\"timeline_data\":[{\"year\":2025,\"target_value\":\"Curriculum Updated\"},{\"year\":2026,\"target_value\":\"Curriculum Updated\"},{\"year\":2027,\"target_value\":\"Curriculum Updated\"},{\"year\":2028,\"target_value\":\"Curriculum Updated\"},{\"year\":2029,\"target_value\":\"Curriculum Updated\"}]}},{\"id\":\"KRA1-KPI2\",\"key_performance_indicator\":{\"outputs\":\"training sessions for faculty on the latest technological advancements and their applications in these fields\",\"outcomes\":\"enhanced faculty expertise in emerging technologies, leading to improved teaching quality and program relevance\"},\"strategies\":[\"collaborate with industry experts, tech companies and research institutions to design relevant course content\",\"pilot new courses and gather feedback from students and faculty to refine content and delivery methods\"],\"programs_activities\":[\"organize specialized training workshops on emerging technologies relevant to your curricula.\"],\"responsible_offices\":[\"Office of the Vice President for Academic Affairs\",\"HRMO\",\"Deans\",\"Faculty\",\"Curriculum and Instruction Development Unit\"],\"targets\":{\"type\":\"count\",\"unit_basis\":\"per program/college\",\"timeline_data\":[{\"year\":2025,\"target_value\":1},{\"year\":2026,\"target_value\":1},{\"year\":2027,\"target_value\":1},{\"year\":2028,\"target_value\":1},{\"year\":2029,\"target_value\":1}]}}]},{\"kra_id\":\"KRA 2\",\"kra_title\":\"Market-Driven Program Design and Implementation\",\"guiding_principle\":\"Excellence and Relevance in Education\",\"initiatives\":[{\"id\":\"KRA2-KPI1\",\"key_performance_indicator\":{\"outputs\":\"establishment of advisory boards comprising industry leaders and alumni, and community stakeholders to provide insights and feedback on program development\",\"outcomes\":\"programs that align closely with market demands, ensuring graduates possess the skills and knowledge required by employers\"},\"strategies\":[\"form advisory boards for agriculture, fisheries, and technology programs to facilitate ongoing dialogue with industry stakeholders\"],\"programs_activities\":[\"establish formal partnerships with industry leaders for internship placements\"],\"responsible_offices\":[\"Office of the Vice President for Academic Affairs\",\"Deans\",\"Alumni Affairs and Placement Services, Curriculum and Instruction Development Unit\"],\"targets\":{\"type\":\"milestone\",\"timeline_data\":[{\"year\":2025,\"target_value\":\"Advisory Board Established\"},{\"year\":2026,\"target_value\":\"Advisory Board Established\"},{\"year\":2027,\"target_value\":\"Advisory Board Established\"},{\"year\":2028,\"target_value\":\"Advisory Board Established\"},{\"year\":2029,\"target_value\":\"Advisory Board Established\"}]}},{\"id\":\"KRA2-KPI2\",\"key_performance_indicator\":{\"outputs\":\"regular updates to curricula based on market trends and industry needs assessments\",\"outcomes\":\"increased enrollment and retention rates as programs gain a reputation for relevance and quality\"},\"strategies\":[\"integrate experiential learning opportunities, such as internships and cooperative education, to provide students with real-world experience\",\"regularly review and update program curricula  based on feedback from advisory boards and market research findings\"],\"programs_activities\":[\"establish a framework to regularly assess program outcomes, student employment rates, and industry satisfaction\",\"create a feedback system involving students, alumni, and industry stakeholders\"],\"responsible_offices\":[\"Office of the Vice President for Academic Affairs\",\"Deans\",\"Alumni Affairs and Placement Services, Curriculum and Instruction Development Unit\"],\"targets\":{\"type\":\"milestone\",\"timeline_data\":[{\"year\":2025,\"target_value\":\"Curriculum Review Completed\"},{\"year\":2026,\"target_value\":\"Curriculum Review Completed\"},{\"year\":2027,\"target_value\":\"Curriculum Review Completed\"},{\"year\":2028,\"target_value\":\"Curriculum Review Completed\"},{\"year\":2029,\"target_value\":\"Curriculum Review Completed\"}]}}]},{\"kra_id\":\"KRA 3\",\"kra_title\":\"Quality and Relevance of Instruction\",\"guiding_principle\":\"Excellence and Relevance in Education\",\"initiatives\":[{\"id\":\"KRA3-KPI1\",\"key_performance_indicator\":{\"outputs\":\"above national passing rate for all board programs\",\"outcomes\":\"improved average percentage of passers in the licensure examination above the national passing percentage\"},\"strategies\":[\"establish an institutional in-house review center\",\"strict implementation of admission and retention policies\",\"awarding of incentives and recognition to top successful examinees\"],\"programs_activities\":[\"in-house review programs\",\"incentive grant program\"],\"responsible_offices\":[\"Office of the Vice President for Academic Affairs\",\"Deans\",\"Quality Assurance Unit\"],\"targets\":{\"type\":\"text_condition\",\"timeline_data\":[{\"year\":2025,\"target_value\":\"Above National Passing Rate\"},{\"year\":2026,\"target_value\":\"Above National Passing Rate\"},{\"year\":2027,\"target_value\":\"Above National Passing Rate\"},{\"year\":2028,\"target_value\":\"Above National Passing Rate\"},{\"year\":2029,\"target_value\":\"Above National Passing Rate\"}]}},{\"id\":\"KRA3-KPI2\",\"key_performance_indicator\":{\"outputs\":\"percentage of OJT students in related industries/institutions\",\"outcomes\":\"enhanced practical learning of students\"},\"strategies\":[\"promote student welfare through relevant programs and support services\"],\"programs_activities\":[\"host events such as career fairs, industry panels, or networking sessions\",\"regularly assess the effectiveness of OJT programs through feedback from students, industry partners, and academic staff\",\"offer incentives or recognition for industry partners who provide OJT opportunities\"],\"responsible_offices\":[\"Office of the Vice President for Academic Affairs\",\"Deans\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2025,\"target_value\":80},{\"year\":2026,\"target_value\":83},{\"year\":2027,\"target_value\":85},{\"year\":2028,\"target_value\":88},{\"year\":2029,\"target_value\":90}]}},{\"id\":\"KRA3-KPI3\",\"key_performance_indicator\":{\"outputs\":\"100% compliance of Center of Flexible Learning\",\"outcomes\":\"resilience\"},\"strategies\":[\"provide market-driven programs through responsive, relevant, and comprehensive curricula\"],\"programs_activities\":[\"monitoring of the preparation and submission of SLMs\"],\"responsible_offices\":[\"Office of the Vice Presidents\",\"Information Communication and Technology Services\",\"Curriculum Instruction Development\",\"Office of the Campus Directors\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2029,\"target_value\":100}]}},{\"id\":\"KRA3-KPI4\",\"key_performance_indicator\":{\"outputs\":\"number of courses integrated with extension learning technologies\",\"outcomes\":\"extended reach to provide quality service\"},\"strategies\":[\"build partnerships with local organizations, government agencies, and other stakeholders to enhance program reach and impact\",\"leverage the institution’s expertise and resources to design and implement programs that address community needs\"],\"programs_activities\":[\"form MOU/MOA with community groups\",\"use faculty and staff expertise in relevant fields to create programs that capitalize on the institution’s strengths\"],\"responsible_offices\":[\"Office of the Vice President for Academic Affairs\",\"Research, Extension and Innovation\",\"Deans\"],\"targets\":{\"type\":\"count\",\"timeline_data\":[{\"year\":2025,\"target_value\":70},{\"year\":2026,\"target_value\":75},{\"year\":2027,\"target_value\":80},{\"year\":2028,\"target_value\":85},{\"year\":2029,\"target_value\":90}]}},{\"id\":\"KRA3-KPI5\",\"key_performance_indicator\":{\"outputs\":\"achieve 75% employment or entrepreneurial engagement rate among graduates 2 years after graduation, including those who start their own business or create employment opportunities (employment, entrepreneurial ventures)\",\"outcomes\":\"develop LSPU graduates who demonstrate high employability rate and are in demand across various sectors, while also functioning as key contributors to societal and economic development\"},\"strategies\":[\"enhance curriculum and program relevance\",\"strengthen career services and job\",\"alumni and employer feedback loop\"],\"programs_activities\":[\"annual graduate employability survey\",\"job fair and career expo\",\"alumni career support network\"],\"responsible_offices\":[\"Office of the Vice President for Academic Affairs\",\"Alumni Affairs and Placement Services\",\"Deans\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2025,\"target_value\":73},{\"year\":2026,\"target_value\":73},{\"year\":2027,\"target_value\":74},{\"year\":2028,\"target_value\":74},{\"year\":2029,\"target_value\":75}]}},{\"id\":\"KRA3-KPI6\",\"key_performance_indicator\":{\"outputs\":\"continuous tracer studies that assess graduates' employability, mobility, entrepreneurial activities and international career opportunities\",\"outcomes\":[\" increased understanding of graduate employability and career trajectories leading to data-driven program improvements\",\"alumni engagement strengthened\"]},\"strategies\":[\"regularly conduct of tracer study, with integration of mobility and international opportunities\",\"graduate engagement and follow-up\"],\"programs_activities\":[\"graduate support career services development\",\"development of Alumni Management System\",\"tracer studies and graduate career mobility tracking\"],\"responsible_offices\":[\"Office of the Vice President for Academic Affairs\",\"Alumni Affairs and Placement Services\",\"Research and Development Services\"],\"targets\":{\"type\":\"count\",\"timeline_data\":[{\"year\":2025,\"target_value\":1},{\"year\":2026,\"target_value\":1},{\"year\":2027,\"target_value\":1},{\"year\":2028,\"target_value\":1},{\"year\":2029,\"target_value\":1}]}},{\"id\":\"KRA3-KPI7\",\"key_performance_indicator\":{\"outputs\":\"percentage of compliance with IA-based instrument for other campuses\",\"outcomes\":[\"increased compliance rates\",\"standardized processes\"]},\"strategies\":[\"training and awareness\",\"standardization\",\"monitoring and reporting\",\"feedback and improvement\"],\"programs_activities\":[\"compliance workshops\",\"audit simulations\",\"compliance audits\",\"feedback sessions\"],\"responsible_offices\":[\"Office of the Vice Presidents\",\"Quality Assurance Unit\",\"Office of the Campus Directors\"],\"targets\":{\"type\":\"milestone\",\"timeline_data\":[{\"year\":2028,\"target_value\":\"100% compliance Institutional Accreditation all campus\"}]}},{\"id\":\"KRA3-KPI8\",\"key_performance_indicator\":{\"outputs\":\"percentage of compliance with SUC Level IV based on SUC Levelling  Instrument\",\"outcomes\":[\"increased compliance rates\",\"standardized processes\"]},\"strategies\":[\"training and awareness\",\"standardization\",\"monitoring and reporting\",\"feedback and improvement\"],\"programs_activities\":[\"compliance workshops\",\"audit simulations\",\"compliance audits\",\"feedback sessions\"],\"responsible_offices\":[\"Office of the Vice Presidents\",\"Quality Assurance Unit\",\"Office of the Campus Directors\"],\"targets\":{\"type\":\"milestone\",\"timeline_data\":[{\"year\":2029,\"target_value\":\"SUC Level IV Compliance\"}]}},{\"id\":\"KRA3-KPI9\",\"key_performance_indicator\":{\"outputs\":\"programs accredited/candidate (Level 1 - 4)\",\"outcomes\":\"enhanced quality of education  and graduates’ competence\"},\"strategies\":[\"regularly review and update curricula to align with industry standards and technological advancements\",\"implement robust internal and external quality assurance mechanisms\",\"foster a culture of continuous improvement among faculty and staff\"],\"programs_activities\":[\"curriculum enhancement workshops\",\"faculty training and development programs\",\"research and innovation initiatives\",\"industry partnerships and internships\",\"student development programs\",\"community engagement and extension services\"],\"responsible_offices\":[\"Office of the Vice President for Academic Affairs\",\"Quality Assurance Unit\",\"Deans\",\"Curriculum and Instruction Development Unit\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2029,\"target_value\":100,\"note\":\"accredited programs\"}]}},{\"id\":\"KRA3-KPI10\",\"key_performance_indicator\":{\"outputs\":\"COD/COE program\",\"outcomes\":[\"compliance rates\",\"standardized processes\"]},\"strategies\":[\"training and awareness\",\"standardization\",\"monitoring and reporting\",\"feedback and improvement\",\"benchmark on top universities\"],\"programs_activities\":[\"assess the current state of the program and perform a gap analysis to identify areas that need improvement\",\"revise the curriculum, course content, and program structure\",\"ensure that faculty members meet the required qualifications\"],\"responsible_offices\":[\"Office of the Vice President for Academic Affairs\",\"Deans\",\"Quality Assurance Unit\",\"Curriculum and Instruction Development Unit\"],\"targets\":{\"type\":\"count\",\"timeline_data\":[{\"year\":2029,\"target_value\":1,\"note\":\"1 new COD/COE\"}]}},{\"id\":\"KRA3-KPI11\",\"key_performance_indicator\":{\"outputs\":\"percentage of developed instructional material (IM) per program\",\"outcomes\":\"increased quantity and quality of IM\"},\"strategies\":[\"professional development: provide ongoing training for teachers on creating high-quality instructional materials\",\"feedback mechanisms: Implement systems for regular feedback on instructional materials from both teachers and students.\"],\"programs_activities\":[\"workshops and training sessions: regular workshops focused on instructional design, use of digital tools, and curriculum alignment\",\"peer review sessions: Scheduled sessions where teachers can review and provide feedback on each other’s materials.\"],\"responsible_offices\":[\"Office of the Vice President for Academic Affairs\",\"Deans\",\"Quality Assurance Unit\",\"Curriculum and Instruction Development Unit\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2025,\"target_value\":30},{\"year\":2026,\"target_value\":33},{\"year\":2027,\"target_value\":35},{\"year\":2028,\"target_value\":38},{\"year\":2029,\"target_value\":40}]}},{\"id\":\"KRA3-KPI12\",\"key_performance_indicator\":{\"outputs\":\"ISO certification for Management Systems for Educational Organizations (ISO 21001:2018) and Quality Management System (ISO 9001:2015))\",\"outcomes\":[\"increased compliance rates\",\"standardized processes\"]},\"strategies\":[\"training and awareness\",\"standardization\",\"monitoring and reporting\",\"feedback and improvement\"],\"programs_activities\":[\"compliance workshops\",\"audit simulations\",\"compliance audits\",\"feedback sessions\"],\"responsible_offices\":[\"Office of the Vice Presidents\",\"Quality Assurance Unit\",\"Office of the Campus Directors\"],\"targets\":{\"type\":\"milestone\",\"timeline_data\":[{\"year\":2025,\"target_value\":\"Recertification\"},{\"year\":2026,\"target_value\":\"Recertification\"},{\"year\":2027,\"target_value\":\"Recertification\"},{\"year\":2028,\"target_value\":\"Recertification\"},{\"year\":2029,\"target_value\":\"Recertification\"}]}},{\"id\":\"KRA3-KPI13\",\"key_performance_indicator\":{\"outputs\":\"number of completed GAD-initiated programs every year\",\"outcomes\":\"4 activities/year\"},\"strategies\":[\"conduct trainings, seminars, fora, focus group discussions\"],\"programs_activities\":[\"trainings\",\"seminars\",\"fora\",\"focus group discussions\"],\"responsible_offices\":[\"Offices of the Vice President\",\"Gender and Development\"],\"targets\":{\"type\":\"count\",\"unit_basis\":\"per year\",\"timeline_data\":[{\"year\":2025,\"target_value\":4},{\"year\":2026,\"target_value\":4},{\"year\":2027,\"target_value\":4},{\"year\":2028,\"target_value\":4},{\"year\":2029,\"target_value\":4}]}},{\"id\":\"KRA3-KPI14\",\"key_performance_indicator\":{\"outputs\":\"percentage of faculty and staff who attended GAD mainstreaming and issue\",\"outcomes\":\"95% faculty and staff attended the GAD mainstreaming and issue\"},\"strategies\":[\"conduct of training/seminar on GAD mainstreaming\"],\"programs_activities\":[\"trainings\",\"seminars\",\"fora\",\"focus group discussions\"],\"responsible_offices\":[\"HRMO\",\"Gender and Development\",\"Offices of the Vice President\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2025,\"target_value\":95},{\"year\":2026,\"target_value\":95},{\"year\":2027,\"target_value\":95},{\"year\":2028,\"target_value\":95},{\"year\":2029,\"target_value\":95}]}},{\"id\":\"KRA3-KPI15\",\"key_performance_indicator\":{\"outputs\":\"number of enrolled foreign students\",\"outcomes\":[\"increased number of foreign students graduates across curriculum and employment after a year or two of graduation\",\"students’ very satisfactory evaluation\"]},\"strategies\":[\"offering English as a Foreign Language (EFL) as a coursework to foreign students who come for cultural immersion and summer camps, and freshmen who will enroll in any curricular program\",\"offering lower tuition and other related fees\",\"offering or assisting students in finding scholarships\",\"offering ODL\"],\"programs_activities\":[\"enrolment of students\",\"orientation for foreign students\",\"application or renewal of visa and other Bureau of Immigration & DFA documents\",\"development of Instructional materials\",\"educational tours\",\"close monitoring of students’ performance\"],\"responsible_offices\":[\"Office of the Vice President for Academic Affairs\",\"International/Local Affairs\",\"Deans\"],\"targets\":{\"type\":\"count\",\"timeline_data\":[{\"year\":2025,\"target_value\":5,\"note\":\"new students per year\"},{\"year\":2026,\"target_value\":5,\"note\":\"new students per year\"}]}},{\"id\":\"KRA3-KPI16\",\"key_performance_indicator\":{\"outputs\":\"number of Student enrolled in CHED/RDC Priority programs\",\"outcomes\":\"increased the number of student enrolled in CHED/RDC priority programs\"},\"strategies\":[\"enhanced outreach and awareness campaigns\",\"program enhancement and innovation\",\"enhancing student support services\"],\"programs_activities\":[\"conduct of outreach and awareness campaign\",\"regularly update and enhance the curriculum of priority programs\",\"provide strong academic advising services, mentoring, monitoring and counseling\"],\"responsible_offices\":[\"Office of the Vice President for Academic Affairs\",\"International/Local Affairs\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2025,\"target_value\":55},{\"year\":2026,\"target_value\":57},{\"year\":2027,\"target_value\":58},{\"year\":2028,\"target_value\":60},{\"year\":2029,\"target_value\":62}]}}]},{\"kra_id\":\"KRA 4\",\"kra_title\":\"College and Office International Activities and Projects\",\"guiding_principle\":\"Excellence and Relevance in Education\",\"initiatives\":[{\"id\":\"KRA4-KPI1\",\"key_performance_indicator\":{\"outputs\":\"number of MOUs/MOAs per year with top 1000 World Universities\",\"outcomes\":\"increased number of international partners including one (1 per year) polytechnic university in the ASEAN region and/or international university among the top 1000 universities in the world\"},\"strategies\":[\"invite prospective international university\",\"renew old partnerships with performing universities\",\"promote LSPU through social media\",\"international conferences attendees ROI\"],\"programs_activities\":[\"benchmarking\",\"employees’ participation in international conferences\",\"constant and continued communications with the prospective partner\",\"endorsement to internal and external Offices & BOR\",\"signing\"],\"responsible_offices\":[\"Office of the Vice President for Academic Affairs\",\"International/Local Affairs\",\"Deans/Colleges\"],\"targets\":{\"type\":\"count\",\"timeline_data\":[{\"year\":2025,\"target_value\":2},{\"year\":2026,\"target_value\":2},{\"year\":2027,\"target_value\":2},{\"year\":2028,\"target_value\":2},{\"year\":2029,\"target_value\":2}]}},{\"id\":\"KRA4-KPI2\",\"key_performance_indicator\":{\"outputs\":\"internationalization accomplishments (per college/office)\",\"outcomes\":[\"recognition from national and international award-giving organizations\",\"impact on the community\",\"secured position in World University Ranking\"]},\"strategies\":[\"coordinate university-wide international initiatives to ensure integration and coordination across the University’s international partnerships, collaborations, programs, and services\"],\"programs_activities\":[\"monitoring of international activities project\",\"regular meetings with deans & directors\",\"public promotions of internationalization accomplishments\"],\"responsible_offices\":[\"Office of the Vice President for Academic Affairs\",\"International Local/Affairs\",\"Information Office\",\"Deans\"],\"targets\":{\"type\":\"count\",\"timeline_data\":[{\"year\":2025,\"target_value\":1},{\"year\":2026,\"target_value\":2},{\"year\":2027,\"target_value\":3},{\"year\":2028,\"target_value\":4},{\"year\":2029,\"target_value\":5}]}}]},{\"kra_id\":\"KRA 5\",\"kra_title\":\"Research, Extension, and Innovation Productivity\",\"guiding_principle\":\"Advancing Research Excellence and Community Engagement\",\"initiatives\":[{\"id\":\"KRA5-KPI1\",\"key_performance_indicator\":{\"outputs\":\"number of IP (patent, UM, copyrights, etc.) generated\",\"outcomes\":\"IP Protections and IP registrations of the university researches\"},\"strategies\":[\"assessment of researches for IP registration for potential commercialization\"],\"programs_activities\":[\"conduct of IP foundation courses, patent search trainings and patent draft training\"],\"responsible_offices\":[\"Vice President for Research Development and Extension\",\"SAO Finance\",\"Budget and Finance\",\"Center of Innovation and Emerging Technologies\"],\"targets\":{\"type\":\"count\",\"timeline_data\":[{\"year\":2025,\"target_value\":47},{\"year\":2026,\"target_value\":50},{\"year\":2027,\"target_value\":53},{\"year\":2028,\"target_value\":56},{\"year\":2029,\"target_value\":59}]}},{\"id\":\"KRA5-KPI2\",\"key_performance_indicator\":{\"outputs\":\"number of income-generating research-based products/outputs\",\"outcomes\":\"establish more innovative research (faculty and students) for income generation of the university, continuity of technology commercialization\"},\"strategies\":[\"secure income generating projects to strengthen industry-academic partnerships through collaboration\",\"focus on market-relevant research to identify gaps, trends, and opportunities to addressed through research-based products\",\"enhance technology transfer offices to support researchers in the commercialization process, including patenting, licensing, and marketing\"],\"programs_activities\":[\"technology transfer programs that focused on transferring research innovations, including support for patenting, licensing, and partnership development\",\"incubation and acceleration programs awareness campaign\"],\"responsible_offices\":[\"Vice President for Research Development and Extension\",\"SAO Finance\",\"Budget and Finance\",\"Center of Innovation and Emerging Technologies\"],\"targets\":{\"type\":\"count\",\"timeline_data\":[{\"year\":2025,\"target_value\":6},{\"year\":2026,\"target_value\":8},{\"year\":2027,\"target_value\":10},{\"year\":2028,\"target_value\":12},{\"year\":2029,\"target_value\":14}]}},{\"id\":\"KRA5-KPI3\",\"key_performance_indicator\":{\"outputs\":\"number of spinoff/start-up companies established for faculty and students\",\"outcomes\":[\"commercialization journey will encourage faculty researchers to enroll in the incubation process\",\"spin-off companies will help the community develop entrepreneurs to improved their livelihood and to improve economic status\"]},\"strategies\":[\"promote a culture of innovation – foster a culture that encourages innovation and risktaking by celebrating successful start-ups and promoting entrepreneurial success stories\",\"craft policy advocacy that supports start-ups and spin-offs, such as tax incentives, research funding, and supportive regulatory frameworks\",\"enhance IP policy manual on incentives/benefits for technology developers/creators\"],\"programs_activities\":[\"value formation through training and development for sustainability of entrepreneurial mindset\",\"offer entrepreneurship courses through seminars and workshop, business development, and commercialization for faculty and students\",\"Commercialization Assistance: Provide resources and support for turning research findings into commercial products\"],\"responsible_offices\":[\"Vice President for Research Development and Extension\",\"SAO Finance\",\"Budget Office\",\"Center of Innovation and Emerging Technologies\"],\"targets\":{\"type\":\"count\",\"timeline_data\":[{\"year\":2025,\"target_value\":2},{\"year\":2026,\"target_value\":3},{\"year\":2027,\"target_value\":4},{\"year\":2028,\"target_value\":5},{\"year\":2029,\"target_value\":6}]}},{\"id\":\"KRA5-KPI4\",\"key_performance_indicator\":{\"outputs\":\"number of research-based programs/projects delivered for extension to the community\",\"outcomes\":\"enhanced local knowledge and 3-5 year sustainable solutions addressing community needs\"},\"strategies\":[\"conduct in-house review of PPAs\",\"enhance REI funding and support\"],\"programs_activities\":[\"annual REI proposal writeshop\",\"monitoring of on-going PPAs\"],\"responsible_offices\":[\"Vice President for Research Development and Extension\",\"Extension and Training Services\",\"Research and Development Services\"],\"targets\":{\"type\":\"count\",\"timeline_data\":[{\"year\":2025,\"target_value\":3},{\"year\":2026,\"target_value\":4},{\"year\":2027,\"target_value\":5},{\"year\":2028,\"target_value\":6},{\"year\":2029,\"target_value\":7}]}},{\"id\":\"KRA5-KPI5\",\"key_performance_indicator\":{\"outputs\":\"number of faculty members with national/international awards and recognition\",\"outcomes\":\"personal and institutional prestige gained and will establish the credibility that are acknowledged by the community\"},\"strategies\":\"support for REI professional development and strengthen collaboration and partnerships with international and national organizations\",\"programs_activities\":\"nominations to REI-related award recognitions\",\"responsible_offices\":[\"Vice President for Research Development and Extension\",\"SAO Finance\",\"Budget Office\",\"Research, Extension and Innovation Unit\"],\"targets\":{\"type\":\"count\",\"timeline_data\":[{\"year\":2025,\"target_value\":1},{\"year\":2026,\"target_value\":1},{\"year\":2027,\"target_value\":2},{\"year\":2028,\"target_value\":2},{\"year\":2029,\"target_value\":2}]}},{\"id\":\"KRA5-KPI6\",\"key_performance_indicator\":{\"outputs\":\"number of institutional awards and recognition\",\"outcomes\":\"institutional prestige gained and will help leverage to get more funds through the trust of the funding agencies\"},\"strategies\":\"partnerships with international and national institution and organizations\",\"programs_activities\":[\"continuous effort with IP filling and registration\",\"excellent service of REI unit\"],\"responsible_offices\":[\"Vice President for Research Development and Extension\",\"Research, Extension and Innovation Unit\"],\"targets\":{\"type\":\"count\",\"timeline_data\":[{\"year\":2025,\"target_value\":1},{\"year\":2026,\"target_value\":1},{\"year\":2027,\"target_value\":2},{\"year\":2028,\"target_value\":2},{\"year\":2029,\"target_value\":2}]}},{\"id\":\"KRA5-KPI7\",\"key_performance_indicator\":{\"outputs\":\"number of research based policy recommendations on Fisheries, Agriculture, Academic, Gender & Development, and other emerging disciplines\",\"outcomes\":\"data-driven decisions and policies\"},\"strategies\":\"collaboration with government and industry stakeholders\",\"programs_activities\":\"conduct of trainings for policy making and establishment of a compendium for policy briefs\",\"responsible_offices\":[\"Vice President for Research Development and Extension\",\"Research and Development Services\"],\"targets\":{\"type\":\"count\",\"timeline_data\":[{\"year\":2025,\"target_value\":2},{\"year\":2026,\"target_value\":2},{\"year\":2027,\"target_value\":2},{\"year\":2028,\"target_value\":3},{\"year\":2029,\"target_value\":3}]}},{\"id\":\"KRA5-KPI8\",\"key_performance_indicator\":{\"outputs\":\"number of university refereed research journals\",\"outcomes\":\"enhancing the institution's academic reputation and contributing to global knowledge dissemination\"},\"strategies\":[\"promotion of the journal to attract highquality submissions\",\"given incentives to faculty researchers who published, and incentives to faculty serving as evaluators\"],\"programs_activities\":\"establish a peer-review system and support for a dedicated editorial board and review panel\",\"responsible_offices\":[\"Vice President for Research Development and Extension\",\"Research and Development Services\"],\"targets\":{\"type\":\"count\",\"timeline_data\":[{\"year\":2025,\"target_value\":1},{\"year\":2026,\"target_value\":1},{\"year\":2027,\"target_value\":1},{\"year\":2028,\"target_value\":1},{\"year\":2029,\"target_value\":1}]}},{\"id\":\"KRA5-KPI9\",\"key_performance_indicator\":{\"outputs\":\"number of faculty research outputs\",\"outcomes\":\"greater contribution to academic advancements and practical solutions for societal challenges\"},\"strategies\":\"deliver quality programs, projects and activities that will lead to extension, commercialization, and policy recommendations\",\"programs_activities\":\"monitoring of internally and externally funded research\",\"responsible_offices\":[\"Vice President for Research Development and Extension\",\"SAO Finance\",\"Budget Office\"],\"targets\":{\"type\":\"count\",\"timeline_data\":[{\"year\":2025,\"target_value\":150},{\"year\":2026,\"target_value\":152},{\"year\":2027,\"target_value\":155},{\"year\":2028,\"target_value\":157},{\"year\":2029,\"target_value\":160}]}},{\"id\":\"KRA5-KPI10\",\"key_performance_indicator\":{\"outputs\":\"number of research findings presented in reputable conferences\",\"outcomes\":\"increased visibility and recognition of research, fostering collaborations and advancing knowledge through presentations at reputable conferences\"},\"strategies\":\"provide research presentation grants and target networking opportunities\",\"programs_activities\":[\"endorse faculty researchers to international and national conferences\",\"conduct institutional REI conferences\"],\"responsible_offices\":[\"Vice President for Research Development and Extension\",\"Research and Development Services\"],\"targets\":{\"type\":\"count\",\"timeline_data\":[{\"year\":2025,\"target_value\":15},{\"year\":2026,\"target_value\":16},{\"year\":2027,\"target_value\":20},{\"year\":2028,\"target_value\":20},{\"year\":2029,\"target_value\":24}]}}]},{\"kra_id\":\"KRA 6\",\"kra_title\":\"Research, Extension, and Innovation Linkages\",\"guiding_principle\":\"Advancing Research Excellence and Community Engagement\",\"initiatives\":[{\"id\":\"KRA6-KPI1\",\"key_performance_indicator\":{\"outputs\":\"number of active partnerships with LGUs, industries, NGOs, NGAs, SMEs and other stakeholders\",\"outcomes\":[\"strong linkages with partner agencies\",\"enhance existing relations with community and partner agencies, locally and internationally\"]},\"strategies\":[\"increase and intensify linkages with partner institutions, community stakeholders and industries, local and international, for REI PPAs\"],\"programs_activities\":[\"conduct of needs assessments with potential partner agencies\",\"conduct of PPAs requested by partner agencies\"],\"responsible_offices\":[\"Vice President for Research Development and Extension\",\"Research, Extension and Innovation Unit\"],\"targets\":{\"type\":\"count\",\"unit_basis\":\"total active\",\"timeline_data\":[{\"year\":2025,\"target_value\":120,\"note\":\"10 existing + 20 new\"},{\"year\":2026,\"target_value\":160},{\"year\":2027,\"target_value\":220},{\"year\":2028,\"target_value\":300},{\"year\":2029,\"target_value\":400}]}},{\"id\":\"KRA6-KPI2\",\"key_performance_indicator\":{\"outputs\":\"number of MOA/MOU with established or organized associations\",\"outcomes\":\"shared resources\"},\"strategies\":[\"forge MOA/MOU with all the partner agencies\"],\"programs_activities\":[\"conduct of REI PPAs with partner agencies\"],\"responsible_offices\":[\"Vice President for Research Development and Extension\",\"Research, Extension and Innovation Unit\"],\"targets\":{\"type\":\"count\",\"unit_basis\":\"total active\",\"timeline_data\":[{\"year\":2025,\"target_value\":100,\"note\":\"80 existing + 20 new\"},{\"year\":2026,\"target_value\":130},{\"year\":2027,\"target_value\":170},{\"year\":2028,\"target_value\":220},{\"year\":2029,\"target_value\":280}]}}]},{\"kra_id\":\"KRA 7\",\"kra_title\":\"Research, Extension, and Innovation Resources\",\"guiding_principle\":\"Advancing Research Excellence and Community Engagement\",\"initiatives\":[{\"id\":\"KRA7-KPI1\",\"key_performance_indicator\":{\"outputs\":\"technologies/innovations adopted by the intended stakeholders. The adoption by which people become users of a technology or product, that is usable and useful and enable them to become long-term business goals\",\"outcomes\":\"increased number of technology/innovation on adopters\"},\"strategies\":[\"ensure the adoption of the technologies/innovations by the intended stakeholders\"],\"programs_activities\":[\"conduct PPAs that are needed and are beneficial to the targeted stakeholders\"],\"responsible_offices\":[\"Vice President for Research Development and Extension\",\"Center of Innovation and Emerging Technologies\",\"Extension and Training Services\"],\"targets\":{\"type\":\"count\",\"timeline_data\":[{\"year\":2025,\"target_value\":6},{\"year\":2026,\"target_value\":8},{\"year\":2027,\"target_value\":10},{\"year\":2028,\"target_value\":12},{\"year\":2029,\"target_value\":14}]}},{\"id\":\"KRA7-KPI2\",\"key_performance_indicator\":{\"outputs\":\"number of generated partnerships from externally-funded research\",\"outcomes\":\"sustainable projects and improved REI facilities\"},\"strategies\":[\"establish partnership with industry players, policy, and innovation centers\"],\"programs_activities\":[\"research grants and projects\"],\"responsible_offices\":[\"Vice President for Research Development and Extension\",\"Research, Extension and Innovation Unit\"],\"targets\":{\"type\":\"count\",\"timeline_data\":[{\"year\":2025,\"target_value\":5},{\"year\":2026,\"target_value\":7},{\"year\":2027,\"target_value\":9},{\"year\":2028,\"target_value\":11},{\"year\":2029,\"target_value\":13}]}},{\"id\":\"KRA7-KPI3\",\"key_performance_indicator\":{\"outputs\":\"established 5 state-of-the-art laboratories on fisheries, agriculture, and otheremerging disciplines\",\"outcomes\":\"more technology innovations\"},\"strategies\":[\"establish partnership with industry players, policy, and innovation center\"],\"programs_activities\":[\"submission of proposal to funding agencies\",\"establishment of REI Centers\"],\"responsible_offices\":[\"Vice President for Research Development and Extension\",\"Project Management Office\",\"Extension and Innovation Unit\",\"Planning Office\",\"Budget and Finance Unit\"],\"targets\":{\"type\":\"count\",\"timeline_data\":[{\"year\":2025,\"target_value\":1},{\"year\":2026,\"target_value\":1},{\"year\":2027,\"target_value\":1},{\"year\":2028,\"target_value\":1},{\"year\":2029,\"target_value\":1}]}},{\"id\":\"KRA7-KPI4\",\"key_performance_indicator\":{\"outputs\":\"number of operational/institutionalized research and development centers\",\"outcomes\":\"more technology innovations\"},\"strategies\":\"established partnership with industry players\",\"programs_activities\":[\"submission of proposal to funding agencies\",\"establishment of REI Centers\"],\"responsible_offices\":[\"Vice President for Research Development and Extension\",\"Research and Development Services\"],\"targets\":{\"type\":\"count\",\"timeline_data\":[{\"year\":2025,\"target_value\":0},{\"year\":2026,\"target_value\":1},{\"year\":2027,\"target_value\":1},{\"year\":2028,\"target_value\":1},{\"year\":2029,\"target_value\":1}]}},{\"id\":\"KRA7-KPI5\",\"key_performance_indicator\":{\"outputs\":\"total income from commercialized technologies (pesos)\",\"outcomes\":[\"subsidized services of the University\",\"encourage faculty researchers to enroll in the incubation process\"]},\"strategies\":[\"market expansion thru segment your market that tailor to technology that meet the specific needs of different market segments\",\"innovations - continually improved researches\"],\"programs_activities\":[\"innovation and commercialization programs thru commercialization grants\",\"technology transfer programs\",\"entrepreneurship workshops\",\"incubation and acceleration programs\",\"entrepreneurship workshops and seminars: conduct training sessions on entrepreneurship, business development, and commercialization strategies tailored for researchers and innovators\"],\"responsible_offices\":[\"Vice President for Research Development and Extension\",\"Research, Extension and Innovation Unit\"],\"targets\":{\"type\":\"financial\",\"currency\":\"PHP\",\"timeline_data\":[{\"year\":2025,\"target_value\":375000},{\"year\":2026,\"target_value\":425000},{\"year\":2027,\"target_value\":475000},{\"year\":2028,\"target_value\":525000},{\"year\":2029,\"target_value\":550000}]}}]},{\"kra_id\":\"KRA 8\",\"kra_title\":\"Service to the Community\",\"guiding_principle\":\"Advancing Research Excellence and Community Engagement\",\"initiatives\":[{\"id\":\"KRA8-KPI1\",\"key_performance_indicator\":{\"outputs\":\"extension programs organized and supported, consistent with mandated and priority programs\",\"outcomes\":\"improved quality of life of the target beneficiaries\"},\"strategies\":\"ensure that extension programs/projects to be conducted are in line with the expertise of the faculty, and at the same time supports the mandated and priority programs offered by the University\",\"programs_activities\":[\"conduct of needs assessment among target beneficiaries\",\"conduct of in-house review for proposals\"],\"responsible_offices\":[\"Vice President for Research Development and Extension\",\"Extension and Training Services\",\"Budget and Finance Unit\",\"SAO Finance\"],\"targets\":{\"type\":\"count\",\"note\":\"new programs\",\"timeline_data\":[{\"year\":2025,\"target_value\":40},{\"year\":2026,\"target_value\":50},{\"year\":2027,\"target_value\":60},{\"year\":2028,\"target_value\":70},{\"year\":2029,\"target_value\":80}]}},{\"id\":\"KRA8-KPI2\",\"key_performance_indicator\":{\"outputs\":\"number of GAD-related research and extension PPAs\",\"outcomes\":\"improved quality of life of beneficiaries increase in the number of GADrelated research and extension PPAs\"},\"strategies\":\"conduct gender research and extension workshops/write shops\",\"programs_activities\":\"implementation of GAD-related REI programs, projects, and activities\",\"responsible_offices\":[\"Vice President for Research Development and Extension\",\"Gender and Development Office\",\"SAO Finance\",\"Budget and Finance\",\"Research and Development Services\",\"Extension and Training Services\"],\"targets\":{\"type\":\"count\",\"timeline_data\":[{\"year\":2025,\"target_value\":17},{\"year\":2026,\"target_value\":19},{\"year\":2027,\"target_value\":20},{\"year\":2028,\"target_value\":23},{\"year\":2029,\"target_value\":25}]}},{\"id\":\"KRA8-KPI3\",\"key_performance_indicator\":{\"outputs\":\"number of trainees weighted by the length of training\",\"outcomes\":[\"application of skills learned for employment or livelihood\",\"employment or entrepreneurial activities that resulted from training\"]},\"strategies\":\"ensure conduct of PPAs that are beneficial to community\",\"programs_activities\":[\"conduct PPAs that are requested by the partners agencies\",\"conduct of BOR-approved extension programs/projects\"],\"responsible_offices\":[\"Vice President for Research Development and Extension\",\"SAO Finance\",\"Budget and Finance Unit\",\"Extension and Training Services\"],\"targets\":{\"type\":\"count\",\"timeline_data\":[{\"year\":2025,\"target_value\":17630},{\"year\":2026,\"target_value\":18030},{\"year\":2027,\"target_value\":18230},{\"year\":2028,\"target_value\":18430},{\"year\":2029,\"target_value\":18630}]}},{\"id\":\"KRA8-KPI4\",\"key_performance_indicator\":{\"outputs\":\"number of extension information materials (IEC/ICT) produced, disseminated, and utilized\",\"outcomes\":\"increase in the number of extension information materials (IEC/ICT) produced, disseminated, and utilized\"},\"strategies\":\"ensure the production, dissemination, and utilization of IEC/ICT materials\",\"programs_activities\":[\"prepare IEC/ICT materials for each and every PPA\",\"provide IEC/ICT materials on the PPAs conducted\"],\"responsible_offices\":[\"Vice President for Research Development and Extension\",\"Extension and Training Services\"],\"targets\":{\"type\":\"count\",\"timeline_data\":[{\"year\":2025,\"target_value\":30},{\"year\":2026,\"target_value\":35},{\"year\":2027,\"target_value\":40},{\"year\":2028,\"target_value\":45},{\"year\":2029,\"target_value\":50}]}},{\"id\":\"KRA8-KPI5\",\"key_performance_indicator\":{\"outputs\":\"100% of beneficiaries rate the training course/s and advisory services as satisfactory or higher in terms of quality and relevance\",\"outcomes\":\"quality and relevant extension PPAs\"},\"strategies\":\"boost the implementation of PPAs and ensure that such PPAs are of high quality and are relevant to the target beneficiaries\",\"programs_activities\":\"conduct of extension PPAs\",\"responsible_offices\":[\"Vice President for Research Development and Extension\",\"Extension and Training Services\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2029,\"target_value\":100}]}}]},{\"kra_id\":\"KRA 9\",\"kra_title\":\"Implementation of Sustainable Governance\",\"guiding_principle\":\"Shaping a Sustainable Future\",\"initiatives\":[{\"id\":\"KRA9-KPI1\",\"key_performance_indicator\":{\"outputs\":\"approved harmonized manuals of operations by 2029\",\"outcomes\":[\"efficient transactions, services, and operations\",\"standard procedure\"]},\"strategies\":[\"monitoring\",\"consultation\",\"crafting/revision of university policies, standards, and guidelines\"],\"programs_activities\":[\"enhance and extended technology infrastructure towards a wireless paperless and efficient computer network\",\"build capacity of staff on operations\"],\"responsible_offices\":[\"Vice President for Administration\",\"Office of the Campus Directors\",\"All offices/units\"],\"targets\":{\"type\":\"milestone\",\"timeline_data\":[{\"year\":2029,\"target_value\":\"Approved Harmonized Manual\"}]}}]},{\"kra_id\":\"KRA 10\",\"kra_title\":\"Transforming into Green University\",\"guiding_principle\":\"Shaping a Sustainable Future\",\"initiatives\":[{\"id\":\"KRA10-KPI1\",\"key_performance_indicator\":{\"outputs\":\"100% facilities compliant with green building code by 2029\",\"outcomes\":\"climate-change conscious environment\"},\"strategies\":[\"assessment and rehabilitation of facilities\",\"adaptation of renewable energy like solar enery (solar panels)\",\"establishment of sustainable waste management system\",\"construction of MRF\"],\"programs_activities\":[\"implementation of LUDIP\",\"implementation of waste management system\"],\"responsible_offices\":[\"Office of the University President\",\"Office of the Vice Presidents\",\"Office of the Campus Director\",\"Project Management Unit\",\"Planning Office\",\"General Services Unit\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2029,\"target_value\":100}]}}]},{\"kra_id\":\"KRA 11\",\"kra_title\":\"Judicious Management of Human Resources\",\"guiding_principle\":\"Shaping a Sustainable Future\",\"initiatives\":[{\"id\":\"KRA11-KPI1\",\"key_performance_indicator\":{\"outputs\":\"aligned and specialized doctorate graduates for faculty and master's degree for non-teaching personnel by 2029\",\"outcomes\":[\"faculty and non-teaching personnel are proficient in their subject and work areas\",\"doctorate/master degree holders/unit-earners\"]},\"strategies\":[\"strengthen intellectual capital\",\"strengthen professional development program\"],\"programs_activities\":[\"scholarship program, both internal and external\"],\"responsible_offices\":[\"Vice President for Administration\",\"HRMO\",\"Office of the Campus Directors\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2025,\"target_value\":5},{\"year\":2026,\"target_value\":10},{\"year\":2027,\"target_value\":15},{\"year\":2028,\"target_value\":20},{\"year\":2029,\"target_value\":30}]}}]},{\"kra_id\":\"KRA 12\",\"kra_title\":\"Internationalized/Global University Stakeholders\",\"guiding_principle\":\"Shaping a Sustainable Future\",\"initiatives\":[{\"id\":\"KRA12-KPI1\",\"key_performance_indicator\":{\"outputs\":\"10% students, 15% faculty, 5% staff are involved in intercountry mobility across the curriculum\",\"outcomes\":\"increase number of students, staff and faculty involved in intercountry mobility across the curriculum\"},\"strategies\":[\"facilitate the early endorsement of employees’ travels\",\"offer incentives/recognition to faculty and staff who participate in international programs\",\"scout and identify international conferences held in the Philippines\"],\"programs_activities\":[\"attendance/Participation in international training programs, conferences or symposia\",\"co-organizing local and international training/seminar workshops and conferences.\"],\"responsible_offices\":[\"Office of the Vice Presidents\",\"International Local/Affairs\",\"All colleges and Offices\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2029,\"target_value\":10,\"note\":\"students\"},{\"year\":2029,\"target_value\":15,\"note\":\"faculty\"},{\"year\":2029,\"target_value\":5,\"note\":\"staff\"}]}}]},{\"kra_id\":\"KRA 13\",\"kra_title\":\"Competitive Global Human Resources\",\"guiding_principle\":\"Shaping a Sustainable Future\",\"initiatives\":[{\"id\":\"KRA13-KPI1\",\"key_performance_indicator\":{\"outputs\":\"increase in the percentage of certified faculty, personnel, and trainers (local and international certifications)\",\"outcomes\":\"graduates/professionals aligned or sustainable to the needs of the industry\"},\"strategies\":[\"offer local and international scholarships\",\"faculty and staff development plan\"],\"programs_activities\":[\"submission of application and screening\",\"partnership scholarship with external funding agencies\"],\"responsible_offices\":[\"Vice President for Administration\",\"HRMO\",\"Office of the Campus Directors\",\"International/Local Affairs\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2025,\"target_value\":5},{\"year\":2026,\"target_value\":10},{\"year\":2027,\"target_value\":15},{\"year\":2028,\"target_value\":20},{\"year\":2029,\"target_value\":25}]}},{\"id\":\"KRA13-KPI2\",\"key_performance_indicator\":{\"outputs\":\"95% of positions filled by 2029\",\"outcomes\":\"university is operating at maximum capacity a.) for personnel - efficiency of transactions b.) for faculties - proportion of student to faculty members\"},\"strategies\":[\"revisit compensation packages based on existing laws in industry\"],\"programs_activities\":[\"competency-based recruitment\",\"job satisfaction\"],\"responsible_offices\":[\"Vice President for Administration\",\"HRMO\",\"Office of the Campus Directors\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2025,\"target_value\":80},{\"year\":2026,\"target_value\":82},{\"year\":2027,\"target_value\":85},{\"year\":2028,\"target_value\":90},{\"year\":2029,\"target_value\":95}]}},{\"id\":\"KRA13-KPI3\",\"key_performance_indicator\":{\"outputs\":\"100% faculty and staff attended health and wellness program twice a week during school days\",\"outcomes\":\"improvements in fitness levels, weight management, disease prevention, and overall vitality\"},\"strategies\":[\"conduct health and wellness program twice a week\",\"survey on the wellness program to be focus on\"],\"programs_activities\":[\"health and wellness program for faculty and staff\"],\"responsible_offices\":[\"Vice President for Administration\",\"HRMO\",\"Office of the Campus Directors\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2029,\"target_value\":100}]}}]},{\"kra_id\":\"KRA 14\",\"kra_title\":\"Improved Satisfaction Rating of the Students, Faculty, and Personnel\",\"guiding_principle\":\"Shaping a Sustainable Future\",\"initiatives\":[{\"id\":\"KRA14-KPI1\",\"key_performance_indicator\":{\"outputs\":\"95% satisfaction rating on all services\",\"outcomes\":\"sustain very satisfactory or higher rating on all services annually\"},\"strategies\":[\"regular monitoring and ensuring that the client completes the CCSS survey form\",\"addressing the negative feedback from the client regarding the service of a unit\"],\"programs_activities\":[\"client satisfaction\"],\"responsible_offices\":[\"Vice President for Administration\",\"Office of the Campus Directors\",\"Management Information System\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2025,\"target_value\":95},{\"year\":2026,\"target_value\":95},{\"year\":2027,\"target_value\":95},{\"year\":2028,\"target_value\":95},{\"year\":2029,\"target_value\":95}]}}]},{\"kra_id\":\"KRA 15\",\"kra_title\":\"Certification and Compliance to Regulatory Requirements\",\"guiding_principle\":\"Shaping a Sustainable Future\",\"initiatives\":[{\"id\":\"KRA15-KPI1\",\"key_performance_indicator\":{\"outputs\":\"100% of security personnel responsible for security equipment obtained the required licenses and certifications, demonstrating full compliance with regulatory requirements\",\"outcomes\":\"highly professional security personnel maintaining peace and order in all campuses\"},\"strategies\":[\"license of security personnel-in-charge to security equipment\"],\"programs_activities\":[\"ensure proper and legal use of security equipment\"],\"responsible_offices\":[\"Vice President for Administration\",\"Office of the Campus Directors\",\"Security Management and Services\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2029,\"target_value\":100}]}}]},{\"kra_id\":\"KRA 16\",\"kra_title\":\"Updating of Learning Materials and Facilities\",\"guiding_principle\":\"Shaping a Sustainable Future\",\"initiatives\":[{\"id\":\"KRA16-KPI1\",\"key_performance_indicator\":{\"outputs\":\"increase in the percentage of subjects have at least 5 updated references, including books, journals, and electronic books available\",\"outcomes\":[\"higher user satisfaction\",\"electronic document downloads frequency\"]},\"strategies\":[\"revisit the Collection Development Plan and revise it for 2025-2029\",\"ensure that the fiduciary library funds only be used for the acquisition of Library Reference Material. Monitor and report\",\"prioritize the subscription to electronic databases with comprehensive subjects relevant to LSPU curricula\"],\"programs_activities\":[\"collection development program\",\"acquisition and linkages\"],\"responsible_offices\":[\"Vice President for Administration\",\"Library\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2025,\"target_value\":70},{\"year\":2026,\"target_value\":75},{\"year\":2027,\"target_value\":80},{\"year\":2028,\"target_value\":85},{\"year\":2029,\"target_value\":90}]}},{\"id\":\"KRA16-KPI2\",\"key_performance_indicator\":{\"outputs\":\"new building for academic space for students\",\"outcomes\":\"go beyond the minimum standard of providing enough reading space to 10% of the student population\"},\"strategies\":[\"coordinate closely with design planning to ensure planned study spaces are up to standards set by AACCUP and CHED\",\"take feedback from students and library users\",\"create welldocumented project proposals with forecasts on student population\",\"begin planning the library system towards establishing various college or separate libraries.\"],\"programs_activities\":[\"library development plan\"],\"responsible_offices\":[\"Office of the University President\",\"Library\",\"Project Management Office\",\"Planning Office\",\"Vice President for Administration\"],\"targets\":{\"type\":\"milestone\",\"timeline_data\":[{\"year\":2025,\"target_value\":\"renovate the library to accommodate 250 students\"},{\"year\":2026,\"target_value\":\"planning and benchmarking for library building standards and organization of college libraries\"},{\"year\":2027,\"target_value\":\"long term planning and design of a system of libraries and academic spaces\"},{\"year\":2028,\"target_value\":\"Phase 1 of implementing immediate plans to increase library space\"},{\"year\":2029,\"target_value\":\"New buildings to accommodate at least 1,200 students\"}]}}]},{\"kra_id\":\"KRA 17\",\"kra_title\":\"Digital Transformation and Smart Campus Enablement\",\"guiding_principle\":\"Shaping a Sustainable Future\",\"initiatives\":[{\"id\":\"KRA17-KPI1\",\"key_performance_indicator\":{\"outputs\":\"100% of offices included in the coverage area of internet\",\"outcomes\":\"improved network speed and reliability\"},\"strategies\":[\"network infrastructure improvement/maintenance\"],\"programs_activities\":[\"connection of offices to the University’s fiber backbone\",\"investment in high-quality networking devices that can retain the bandwidth and throughput of a gigabit network.\"],\"responsible_offices\":[\"Vice President for Administration\",\"Office of the CampusDirectors\",\"Information Communication and Technology Services\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2029,\"target_value\":100}]}},{\"id\":\"KRA17-KPI2\",\"key_performance_indicator\":{\"outputs\":\"100% of ICT-related projects/requests are procured/implemented\",\"outcomes\":\"enhanced performance and capacity of technology\"},\"strategies\":[\"futures planning\",\"procurement of ICT-related equipment\"],\"programs_activities\":[\"upgrade/maintenance of ICT equipment\"],\"responsible_offices\":[\"Vice President for Administration\",\"Office of the Campus Directors\",\"Information Communication and Technology Services\",\"Procurement Bids and Awards\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2025,\"target_value\":80},{\"year\":2026,\"target_value\":88},{\"year\":2027,\"target_value\":90},{\"year\":2028,\"target_value\":93},{\"year\":2029,\"target_value\":95}]}},{\"id\":\"KRA17-KPI3\",\"key_performance_indicator\":{\"outputs\":\"digitalized processes and systems in operation\",\"outcomes\":\"improved operational efficiency, with a measurable reduction in manual processes\"},\"strategies\":\"digitalization of manual workflows\",\"programs_activities\":[\"development, procurement and/or subscription of Information System modules to help in transformation of the manual processes which also aligns to the university’s ISSP\"],\"responsible_offices\":[\"Vice President for Administration\",\"Office of the Campus Directors\",\"Information Communication and Technology Services\"],\"targets\":{\"type\":\"count\",\"timeline_data\":[{\"year\":2025,\"target_value\":6},{\"year\":2026,\"target_value\":6},{\"year\":2027,\"target_value\":6},{\"year\":2028,\"target_value\":6},{\"year\":2029,\"target_value\":6}]}},{\"id\":\"KRA17-KPI4\",\"key_performance_indicator\":{\"outputs\":\"Conduct of orientations/workshops/training sessions for the end-users of digitalized process\",\"outcomes\":\"increased staff competency in using new technologies\"},\"strategies\":[\"develop comprehensive training programs to upskill staff and faculty\"],\"programs_activities\":[\"organize ICT-related workshops and training sessions for staff and faculty\"],\"responsible_offices\":[\"Vice President for Administration\",\"Office of the Campus Directors\",\"HRMO\",\"Information Communication and Technology\"],\"targets\":{\"type\":\"count\",\"timeline_data\":[{\"year\":2025,\"target_value\":2},{\"year\":2026,\"target_value\":2},{\"year\":2027,\"target_value\":2},{\"year\":2028,\"target_value\":2},{\"year\":2029,\"target_value\":2}]}}]},{\"kra_id\":\"KRA 18\",\"kra_title\":\"Risk Management and Compliance\",\"guiding_principle\":\"Resource Optimization and Management\",\"initiatives\":[{\"id\":\"KRA18-KPI1\",\"key_performance_indicator\":{\"outputs\":\"conducted risk assessments with zero incidence of non-compliance on financial issues\",\"outcomes\":\"smooth flow of operations and processes (full compliance)\"},\"strategies\":[\"ensure 0% incidence of non-compliance\",\"conduct regular risk assessments, internal audits, and third-party reviews\",\"Implement automated monitoring tools\",\"Provide ongoing compliance training and clear reporting channels\"],\"programs_activities\":[\"observe the protocol concerning spending and financial reporting\",\"comply with the required documentation, etc. regarding financial matters\"],\"responsible_offices\":[\"Vice President for Administration\",\"Budget Office\",\"SAO Finance\"],\"targets\":{\"type\":\"text_condition\",\"timeline_data\":[{\"year\":2029,\"target_value\":\"Zero incidence of non-compliance\"}]}}]},{\"kra_id\":\"KRA 19\",\"kra_title\":\"Revenue Growth and Operational Efficiency\",\"guiding_principle\":\"Resource Optimization and Management\",\"initiatives\":[{\"id\":\"KRA19-KPI1\",\"key_performance_indicator\":{\"outputs\":\"increase in income generated from approved IGPs\",\"outcomes\":\"increased internal funding for special funds\"},\"strategies\":[\"identify and evaluate new IGP opportunities\",\"formulation of IGP manual and financial management framework\",\"regular monitoring,evaluation and audit\"],\"programs_activities\":[\"procurement planning; implementation\",\"monitoring of planned procurement activities\",\"evaluation\",\"policy and program making for IGP *proposal making/planning for new IGPs\"],\"responsible_offices\":[\"Vice President for Administration\",\"Budget Office\",\"SAO Finance\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2025,\"target_value\":5},{\"year\":2026,\"target_value\":5},{\"year\":2027,\"target_value\":7},{\"year\":2028,\"target_value\":9},{\"year\":2029,\"target_value\":11}]}},{\"id\":\"KRA19-KPI2\",\"key_performance_indicator\":{\"outputs\":\"reduction in operational costs\",\"outcomes\":\"funds can be allocated for other important projects\"},\"strategies\":[\"develop resource utilization plans\",\"regular inventory and preventive maintenance\"],\"programs_activities\":[\"procurement planning; implementation\",\"monitoring of planned procurement activities\",\"evaluation\"],\"responsible_offices\":[\"Vice President for Administration\",\"Budget Office\",\"SAO Finance\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2025,\"target_value\":2},{\"year\":2026,\"target_value\":4},{\"year\":2027,\"target_value\":6},{\"year\":2028,\"target_value\":8},{\"year\":2029,\"target_value\":10}]}}]},{\"kra_id\":\"KRA 20\",\"kra_title\":\"Related IGP Industry Engagement\",\"guiding_principle\":\"Resource Optimization and Management\",\"initiatives\":[{\"id\":\"KRA20-KPI1\",\"key_performance_indicator\":{\"outputs\":\"total revenue generated from partnerships and collaborations\",\"outcomes\":[\"acquired expertise and investments\",\"quality of partnership agreements\",\"increased in total revenue generated from strategic partnerships and collaborations\"]},\"strategies\":[\"resource and expertise sharing\",\"joint revenue-generating initiatives\",\"strengthen human resources, organizational, and financial capital of the university\",\"strengthen intellectual capital from capital royalties from developed technologies\"],\"programs_activities\":[\"consultancy and training\",\"joint ventures using developed technologies\"],\"responsible_offices\":[\"Vice President for Administration\",\"Budget Office\",\"SAO Finance\",\"Extension and Training Services\"],\"targets\":{\"type\":\"financial\",\"currency\":\"PHP\",\"timeline_data\":[{\"year\":2025,\"target_value\":0},{\"year\":2026,\"target_value\":0},{\"year\":2027,\"target_value\":300000},{\"year\":2028,\"target_value\":330000},{\"year\":2029,\"target_value\":363000}]}},{\"id\":\"KRA20-KPI2\",\"key_performance_indicator\":{\"outputs\":\"increase in net income from non-traditional sources\",\"outcomes\":\"generate additional income from non-traditional sources\"},\"strategies\":[\"create entrepreneurial ventures\",\"strengthen the existing income-generating projects\"],\"programs_activities\":[\"events place\",\"coffee shops\",\"rental spaces\",\"commercialization of research products and services\",\"printing and binding\",\"gasoline station\",\"clothing shop\",\"grocery-style store\"],\"responsible_offices\":[\"Vice President for Administration\",\"Business Affairs Office\",\"SAO Finance\",\"Budget Office\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2025,\"target_value\":5},{\"year\":2026,\"target_value\":8},{\"year\":2027,\"target_value\":12},{\"year\":2028,\"target_value\":20},{\"year\":2029,\"target_value\":30}]}}]},{\"kra_id\":\"KRA 21\",\"kra_title\":\"Responsive Management of Resources\",\"guiding_principle\":\"Resource Optimization and Management\",\"initiatives\":[{\"id\":\"KRA21-KPI1\",\"key_performance_indicator\":{\"outputs\":\"100% budget utilization rate (disbursement)\",\"outcomes\":\"established functional and operational system for resource generation and management of resources\"},\"strategies\":[\"ensure prudent use of resources\",\"improve spending efficiency, absorptive capacity\"],\"programs_activities\":\"monitoring of the planned procurement activities\",\"responsible_offices\":[\"Vice President for Administration\",\"Budget Office\",\"SAO Finance\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2029,\"target_value\":100}]}},{\"id\":\"KRA21-KPI2\",\"key_performance_indicator\":{\"outputs\":\"100% budget utilization rate (obligation)\",\"outcomes\":\"established functional and operational system for resource generation and management of resources\"},\"strategies\":[\"ensure prudent use of resources\",\"Improve the spending efficiency; absorptive capacity\"],\"programs_activities\":[\"implementation of the planned programs, projects, and activities (PPAs)\",\"monitoring of planned procurement activities\",\"Conduct a workshop for all the offices involved\"],\"responsible_offices\":[\"Vice President for Administration\",\"Budget Office\",\"SAO Finance\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2029,\"target_value\":100}]}}]},{\"kra_id\":\"KRA 22\",\"kra_title\":\"Management of Financial Resources\",\"guiding_principle\":\"Resource Optimization and Management\",\"initiatives\":[{\"id\":\"KRA22-KPI1\",\"key_performance_indicator\":{\"outputs\":\"internally generated income\",\"outcomes\":\"established functional and operational system for resource generation and management of resources\"},\"strategies\":[\"availability of a systematic plan of action to justify every budget proposal\",\"continual improvement process\"],\"programs_activities\":[\"submit justifications to the Department of Budget and Management for the release of the actual billing\",\"training and seminars for the human resources\"],\"responsible_offices\":[\"Vice President for Administration\",\"Budget Office\",\"SAO Finance\"],\"targets\":{\"type\":\"financial\",\"currency\":\"PHP\",\"timeline_data\":[{\"year\":2025,\"target_value\":263426000},{\"year\":2026,\"target_value\":277000000},{\"year\":2027,\"target_value\":291000000},{\"year\":2028,\"target_value\":320000000},{\"year\":2029,\"target_value\":336000000}]}},{\"id\":\"KRA22-KPI2\",\"key_performance_indicator\":{\"outputs\":\"100% fund utilization on infrastructure projects\",\"outcomes\":[\"improved productivity of the human resources\",\"developed facilities, services, and systems\"]},\"strategies\":\"strengthen construction or manufacture capital\",\"programs_activities\":[\"monitoring of the planned programs\",\"conduct of Early Procurement Activities (EPA)\",\"approval of PPMP/APP\",\"BOR approval\"],\"responsible_offices\":[\"Vice President for Administration\",\"Project Management Unit\",\"Planning Unit\",\"SAO Finance\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2029,\"target_value\":100}]}},{\"id\":\"KRA22-KPI3\",\"key_performance_indicator\":{\"outputs\":\"100% fund utilization on repairs/rehabilitation of buildings, vehicles, drainage and roads, land, material recovery facilities and electrical facilities\",\"outcomes\":[\"less funds for repair and rehabilitation\",\"less disruption to operation\"]},\"strategies\":[\"strengthen construction or manufacture capital\",\"implement regular preventive maintenance\"],\"programs_activities\":[\"conduct of Early Procurement Activities (EPA)\",\"approval of the Head of Agency\",\"approval of PPMP/APP\",\"bidding\",\"contracting by Administration\"],\"responsible_offices\":[\"Vice President for Administration\",\"General Services Office\",\"SAO Finance\",\"Budget Office\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2029,\"target_value\":100}]}},{\"id\":\"KRA22-KPI4\",\"key_performance_indicator\":{\"outputs\":\"100% fund utilization in the acquisition of new equipment\",\"outcomes\":[\"responsive to the needs of the end-users\",\"efficiency in the procurement of equipment needed\"]},\"strategies\":[\"assessment of the needs of the end-users\",\"consider the budget and maintenance cost\"],\"programs_activities\":[\"conduct of Early Procurement Activities (EPA)\",\"approval of the Head of Agency\",\"approval of PPMP/APP\",\"bidding\"],\"responsible_offices\":[\"Vice President for Administration\",\"Budget Office\",\"SAO Finance\"],\"targets\":{\"type\":\"percentage\",\"timeline_data\":[{\"year\":2029,\"target_value\":100}]}}]}]}"],"names":[],"mappings":"AAAA"}},
    {"offset": {"line": 528, "column": 68348}, "map": {"version":3,"sources":[],"names":[],"mappings":"A"}},
    {"offset": {"line": 532, "column": 0}, "map": {"version":3,"sources":["file:///D:/downloads/Downloads%20from%20web/LSPU%20KMIS/lib/utils/qpro-aggregation.ts"],"sourcesContent":["export type TargetScope = 'INSTITUTIONAL' | 'PER_UNIT';\r\n\r\nexport type TargetType = 'count' | 'percentage' | 'financial' | 'milestone' | 'text_condition' | string;\r\n\r\nexport interface TimelineDatum {\r\n  year: number;\r\n  target_value: string | number;\r\n}\r\n\r\nexport interface InitiativeLike {\r\n  id: string;\r\n  key_performance_indicator?: {\r\n    outputs?: string;\r\n    outcomes?: string | string[];\r\n  };\r\n  targets?: {\r\n    type?: TargetType;\r\n    unit_basis?: string;\r\n    target_scope?: TargetScope;\r\n    timeline_data?: TimelineDatum[];\r\n  };\r\n}\r\n\r\nexport interface StrategicPlanLike {\r\n  kras?: Array<{\r\n    kra_id: string;\r\n    kra_title?: string;\r\n    initiatives?: InitiativeLike[];\r\n  }>;\r\n}\r\n\r\nexport function toNumberOrNull(value: unknown): number | null {\r\n  if (value === null || value === undefined) return null;\r\n  if (typeof value === 'number') return Number.isFinite(value) ? value : null;\r\n  const cleaned = String(value).replace(/,/g, '').trim();\r\n  if (!cleaned) return null;\r\n  const parsed = Number(cleaned);\r\n  return Number.isFinite(parsed) ? parsed : null;\r\n}\r\n\r\nexport function getTargetValueForYear(timeline: any[] | undefined, year: number): number | null {\r\n  if (!Array.isArray(timeline) || timeline.length === 0) return null;\r\n\r\n  const exact = timeline.find((t: any) => Number(t?.year) === year);\r\n  const exactValue = toNumberOrNull(exact?.target_value);\r\n  if (exactValue !== null) return exactValue;\r\n\r\n  const candidates = timeline\r\n    .map((t: any) => ({ year: Number(t?.year), target: toNumberOrNull(t?.target_value) }))\r\n    .filter((t: any) => Number.isFinite(t.year) && t.target !== null) as Array<{ year: number; target: number }>;\r\n\r\n  const pastOrEqual = candidates.filter((t) => t.year <= year).sort((a, b) => b.year - a.year);\r\n  if (pastOrEqual.length > 0) return pastOrEqual[0].target;\r\n\r\n  const future = candidates.sort((a, b) => a.year - b.year);\r\n  return future.length > 0 ? future[0].target : null;\r\n}\r\n\r\nexport function normalizeInitiativeId(id: string): string {\r\n  return String(id || '').replace(/\\s+/g, '');\r\n}\r\n\r\n/**\r\n * Normalize KRA ID by removing extra spaces and ensuring consistent format.\r\n * Handles: \"KRA5\", \"KRA 5\", \"KRA  5\" → \"KRA 5\" (canonical format in strategic_plan.json)\r\n */\r\nexport function normalizeKraId(kraId: string): string {\r\n  const cleaned = String(kraId || '').trim().replace(/\\s+/g, ' ');\r\n  // Match \"KRA\" followed by number(s), normalize to \"KRA {number}\"\r\n  const match = cleaned.match(/^KRA\\s*(\\d+)$/i);\r\n  if (match) {\r\n    return `KRA ${match[1]}`;\r\n  }\r\n  return cleaned;\r\n}\r\n\r\nexport function findInitiative(\r\n  plan: StrategicPlanLike,\r\n  kraId: string,\r\n  initiativeId: string | undefined | null\r\n): InitiativeLike | null {\r\n  if (!kraId || !initiativeId) return null;\r\n  const kras = plan?.kras || [];\r\n  const normalizedKraId = normalizeKraId(kraId);\r\n  const kra = kras.find((k) => normalizeKraId(k.kra_id) === normalizedKraId);\r\n  if (!kra?.initiatives) return null;\r\n\r\n  const normalizedId = normalizeInitiativeId(String(initiativeId));\r\n  let initiative = kra.initiatives.find((i) => normalizeInitiativeId(String(i.id)) === normalizedId);\r\n\r\n  if (!initiative) {\r\n    const kpiMatch = String(initiativeId).match(/KPI(\\d+)/i);\r\n    if (kpiMatch) {\r\n      initiative = kra.initiatives.find((i) => String(i.id).includes(`KPI${kpiMatch[1]}`));\r\n    }\r\n  }\r\n\r\n  return initiative || null;\r\n}\r\n\r\nexport function getInitiativeTargetMeta(\r\n  plan: StrategicPlanLike,\r\n  kraId: string,\r\n  initiativeId: string | undefined | null,\r\n  year: number\r\n): {\r\n  targetType: TargetType | null;\r\n  targetValue: number | null;\r\n  targetScope: TargetScope;\r\n  unitBasis: string | null;\r\n} {\r\n  const initiative = findInitiative(plan, kraId, initiativeId);\r\n  const targetType = initiative?.targets?.type ?? null;\r\n  const unitBasis = typeof initiative?.targets?.unit_basis === 'string' ? initiative.targets.unit_basis : null;\r\n\r\n  // IMPORTANT DEFAULT:\r\n  // If strategic_plan.json doesn't explicitly specify scope, treat targets as INSTITUTIONAL\r\n  // to prevent accidental inflation (e.g., multiplying by activities/programs).\r\n  const targetScope: TargetScope = initiative?.targets?.target_scope === 'PER_UNIT' ? 'PER_UNIT' : 'INSTITUTIONAL';\r\n\r\n  const timeline = (initiative?.targets?.timeline_data || []) as any[];\r\n  const targetValue = getTargetValueForYear(timeline, year);\r\n\r\n  return { targetType, targetValue, targetScope, unitBasis };\r\n}\r\n\r\nexport interface ActivityValueLike {\r\n  reported?: number | string | null;\r\n  target?: number | string | null;\r\n  dataType?: string | null;\r\n  initiativeId?: string | null;\r\n}\r\n\r\nexport function sumNumbers(values: Array<number | null | undefined>): number {\r\n  return values.reduce<number>(\r\n    (acc, v) => acc + (typeof v === 'number' && Number.isFinite(v) ? v : 0),\r\n    0\r\n  );\r\n}\r\n\r\nexport function averageNumbers(values: Array<number | null | undefined>): number {\r\n  const nums = values.filter((v): v is number => typeof v === 'number' && Number.isFinite(v));\r\n  if (nums.length === 0) return 0;\r\n  return nums.reduce<number>((acc, n) => acc + n, 0) / nums.length;\r\n}\r\n\r\nexport function computeAggregatedAchievement(args: {\r\n  targetType: TargetType | null;\r\n  targetValue: number;\r\n  targetScope?: TargetScope;\r\n  unitMultiplier?: number;\r\n  activities: ActivityValueLike[];\r\n}): {\r\n  totalReported: number;\r\n  totalTarget: number;\r\n  achievementPercent: number;\r\n} {\r\n  const {\r\n    targetType,\r\n    targetValue,\r\n    targetScope = 'INSTITUTIONAL',\r\n    unitMultiplier,\r\n    activities,\r\n  } = args;\r\n\r\n  const normalizedType = String(targetType || '').toLowerCase();\r\n\r\n  // IMPORTANT: targets are applied ONCE per KPI by default.\r\n  // If a KPI explicitly declares PER_UNIT scope, callers should pass a true unitMultiplier\r\n  // (e.g., number of programs/units). We intentionally default to 1 (not activities.length)\r\n  // because an activity count is not the same as a unit count.\r\n  const effectiveTarget =\r\n    targetScope === 'PER_UNIT'\r\n      ? targetValue * (typeof unitMultiplier === 'number' && Number.isFinite(unitMultiplier) ? unitMultiplier : 1)\r\n      : targetValue;\r\n\r\n  // Rate metrics: use mean reported against single target\r\n  if (normalizedType === 'percentage') {\r\n    // Percent KPIs need special handling:\r\n    // - If reported is already 0..100, use it.\r\n    // - If reported is a count (e.g., 154 employed) and activity.target is a denominator (e.g., 200 graduates),\r\n    //   convert to percent: (reported/target)*100.\r\n    // - Ignore invalid values we can't normalize (prevents nonsense like 154% being treated as a percent).\r\n    const toNormalizedPercent = (a: ActivityValueLike): number | null => {\r\n      const reported = toNumberOrNull(a.reported);\r\n      if (reported === null) return null;\r\n\r\n      // Already a valid percent\r\n      if (reported >= 0 && reported <= 100) return reported;\r\n\r\n      // Try to normalize count/denominator into a percent\r\n      const denom = toNumberOrNull(a.target);\r\n      if (denom !== null && denom > 0 && reported >= 0) {\r\n        const pct = (reported / denom) * 100;\r\n        if (pct >= 0 && pct <= 100) return pct;\r\n      }\r\n\r\n      return null;\r\n    };\r\n\r\n    const avgReported = averageNumbers(activities.map(toNormalizedPercent));\r\n    const achievementPercent = effectiveTarget > 0 ? (avgReported / effectiveTarget) * 100 : 0;\r\n    return { totalReported: avgReported, totalTarget: effectiveTarget, achievementPercent };\r\n  }\r\n\r\n  // Financial and counts: additive\r\n  if (normalizedType === 'financial' || normalizedType === 'count') {\r\n    const sumReported = sumNumbers(activities.map((a) => toNumberOrNull(a.reported)));\r\n    const achievementPercent = effectiveTarget > 0 ? (sumReported / effectiveTarget) * 100 : 0;\r\n    return { totalReported: sumReported, totalTarget: effectiveTarget, achievementPercent };\r\n  }\r\n\r\n  // Milestone / text_condition: interpret as completed if any reported is truthy\r\n  if (normalizedType === 'milestone' || normalizedType === 'text_condition') {\r\n    const anyReported = activities.some((a) => {\r\n      const v = a.reported;\r\n      if (typeof v === 'number') return v > 0;\r\n      if (typeof v === 'string') return v.trim().length > 0;\r\n      return false;\r\n    });\r\n    const achievementPercent = anyReported ? 100 : 0;\r\n    return { totalReported: anyReported ? 1 : 0, totalTarget: 1, achievementPercent };\r\n  }\r\n\r\n  // Default: treat as additive numeric\r\n  const sumReported = sumNumbers(activities.map((a) => toNumberOrNull(a.reported)));\r\n  const achievementPercent = effectiveTarget > 0 ? (sumReported / effectiveTarget) * 100 : 0;\r\n  return { totalReported: sumReported, totalTarget: effectiveTarget, achievementPercent };\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 701, "column": 0}, "map": {"version":3,"sources":["file:///D:/downloads/Downloads%20from%20web/LSPU%20KMIS/lib/services/document-section-detector.ts"],"sourcesContent":["/**\r\n * DocumentSectionDetector Service\r\n * \r\n * Identifies and extracts document sections (e.g., Alumni Employment, Research Projects, Training)\r\n * before text extraction to provide context for LLM analysis.\r\n * \r\n * Solves Problem #1: Missing Document Sections\r\n * - Detects document structure before processing\r\n * - Provides section boundaries to LLM\r\n * - Enables targeted extraction per section\r\n */\r\n\r\nexport interface DocumentSection {\r\n  type: 'TRAINING' | 'ALUMNI_EMPLOYMENT' | 'RESEARCH' | 'COMMUNITY_ENGAGEMENT' | 'NARRATIVE' | 'UNKNOWN';\r\n  title: string;\r\n  startIndex: number;\r\n  endIndex: number;\r\n  content: string;\r\n  confidence: number; // 0-1 confidence score for section type detection\r\n}\r\n\r\nexport interface SectionDetectionResult {\r\n  sections: DocumentSection[];\r\n  documentType: 'TABLE' | 'NARRATIVE' | 'MIXED' | 'UNSTRUCTURED';\r\n  totalSections: number;\r\n  analysisMetadata: {\r\n    textLength: number;\r\n    detectionConfidence: number;\r\n    sectionsDetected: string[];\r\n  };\r\n}\r\n\r\nclass DocumentSectionDetector {\r\n  /**\r\n   * Section patterns organized by type with priority ordering\r\n   * Higher priority patterns are checked first\r\n   */\r\n  private readonly sectionPatterns = {\r\n    TRAINING: [\r\n      // Primary patterns - highest confidence\r\n      { pattern: /(?:training|seminar|workshop|conference)[\\s\\w]*(?:report|accomplished)?(?:\\n|:|$)/i, priority: 1, confidence: 0.95 },\r\n      { pattern: /training.*table|training.*entries/i, priority: 1, confidence: 0.95 },\r\n      { pattern: /^(faculty|staff)?\\s*training\\s+(report|activities)?/im, priority: 1, confidence: 0.90 },\r\n      \r\n      // Secondary patterns\r\n      { pattern: /conducted\\s+(training|workshop|seminar)/i, priority: 2, confidence: 0.85 },\r\n      { pattern: /participants?\\s*:.*\\d+|attendee|trained/i, priority: 2, confidence: 0.80 },\r\n      { pattern: /introduction\\s+to|orientation|skill\\s+development/i, priority: 2, confidence: 0.75 },\r\n    ],\r\n    \r\n    ALUMNI_EMPLOYMENT: [\r\n      // Primary patterns\r\n      { pattern: /alumni\\s+(employment|tracking|survey|profile|database)/i, priority: 1, confidence: 0.98 },\r\n      { pattern: /graduate.*employment|employment.*graduate/i, priority: 1, confidence: 0.95 },\r\n      { pattern: /alumni\\s+(?:activities|report|data)/i, priority: 1, confidence: 0.92 },\r\n      \r\n      // Secondary patterns\r\n      { pattern: /employed|placement|job\\s+placement|career/i, priority: 2, confidence: 0.80 },\r\n      { pattern: /alumni|graduate\\s+tracking/i, priority: 2, confidence: 0.78 },\r\n    ],\r\n    \r\n    RESEARCH: [\r\n      // Primary patterns\r\n      { pattern: /research\\s+(output|project|publication|activity|paper|study)/i, priority: 1, confidence: 0.97 },\r\n      { pattern: /published|publication|journal.*article/i, priority: 1, confidence: 0.95 },\r\n      { pattern: /research\\s+(?:accomplishment|report|result)/i, priority: 1, confidence: 0.93 },\r\n      \r\n      // Secondary patterns\r\n      { pattern: /study|investigation|scholarly\\s+work/i, priority: 2, confidence: 0.75 },\r\n      { pattern: /conference\\s+paper|research\\s+grant/i, priority: 2, confidence: 0.85 },\r\n    ],\r\n    \r\n    COMMUNITY_ENGAGEMENT: [\r\n      // Primary patterns\r\n      { pattern: /extension|outreach|community\\s+(service|program|engagement)/i, priority: 1, confidence: 0.96 },\r\n      { pattern: /community.*service|outreach.*program/i, priority: 1, confidence: 0.94 },\r\n      { pattern: /livelihood|skills?\\s+training.*community/i, priority: 1, confidence: 0.92 },\r\n      \r\n      // Secondary patterns\r\n      { pattern: /beneficiary|assisted|served.*community/i, priority: 2, confidence: 0.80 },\r\n      { pattern: /program.*community|community.*initiative/i, priority: 2, confidence: 0.78 },\r\n    ],\r\n  };\r\n\r\n  /**\r\n   * Detects document format by analyzing structural patterns\r\n   */\r\n  private detectDocumentType(text: string): 'TABLE' | 'NARRATIVE' | 'MIXED' | 'UNSTRUCTURED' {\r\n    // Count table indicators\r\n    const tableIndicators = (text.match(/\\t|\\|/g) || []).length;\r\n    const lineBreaks = (text.match(/\\n/g) || []).length;\r\n    const tableRatio = tableIndicators / Math.max(lineBreaks, 1);\r\n\r\n    // Count narrative indicators\r\n    const sentences = (text.match(/\\.\\s+[A-Z]/g) || []).length;\r\n    const paragraphs = (text.match(/\\n\\n+/g) || []).length;\r\n\r\n    // Determine type based on ratios\r\n    if (tableRatio > 0.3) {\r\n      return 'TABLE';\r\n    } else if (sentences > 5 && paragraphs > 2) {\r\n      return 'NARRATIVE';\r\n    } else if (tableRatio > 0.1 && sentences > 3) {\r\n      return 'MIXED';\r\n    } else {\r\n      return 'UNSTRUCTURED';\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Identifies section boundaries using pattern matching\r\n   */\r\n  private identifySectionBoundaries(\r\n    text: string\r\n  ): Array<{ startIndex: number; endIndex: number; title: string; type: string }> {\r\n    const boundaries: Array<{\r\n      startIndex: number;\r\n      endIndex: number;\r\n      title: string;\r\n      type: string;\r\n    }> = [];\r\n\r\n    // Search for each section type\r\n    for (const [sectionType, patterns] of Object.entries(this.sectionPatterns)) {\r\n      for (const { pattern } of patterns) {\r\n        let match;\r\n        const regex = new RegExp(pattern.source, 'gi');\r\n\r\n        while ((match = regex.exec(text)) !== null) {\r\n          const startIndex = match.index;\r\n          \r\n          // Find next section boundary or end of text\r\n          let endIndex = text.length;\r\n          const nextSectionMatch = this.findNextSectionBoundary(text, startIndex + match[0].length);\r\n          if (nextSectionMatch) {\r\n            endIndex = nextSectionMatch;\r\n          }\r\n\r\n          boundaries.push({\r\n            startIndex,\r\n            endIndex,\r\n            title: match[0].trim(),\r\n            type: sectionType,\r\n          });\r\n        }\r\n      }\r\n    }\r\n\r\n    // Remove overlapping boundaries and sort by start index\r\n    return this.deduplicateBoundaries(boundaries).sort((a, b) => a.startIndex - b.startIndex);\r\n  }\r\n\r\n  /**\r\n   * Finds the next section boundary by looking for section headers\r\n   */\r\n  private findNextSectionBoundary(text: string, startFrom: number): number | null {\r\n    const headerPattern = /\\n[A-Z][A-Z\\s:]+\\n/g;\r\n    let match;\r\n\r\n    while ((match = headerPattern.exec(text)) !== null) {\r\n      if (match.index > startFrom) {\r\n        return match.index;\r\n      }\r\n    }\r\n\r\n    return null;\r\n  }\r\n\r\n  /**\r\n   * Removes overlapping boundaries, keeping the one with higher priority\r\n   */\r\n  private deduplicateBoundaries(\r\n    boundaries: Array<{ startIndex: number; endIndex: number; title: string; type: string }>\r\n  ): Array<{ startIndex: number; endIndex: number; title: string; type: string }> {\r\n    const sorted = boundaries.sort((a, b) => {\r\n      // Sort by start index, then by span size\r\n      if (a.startIndex !== b.startIndex) {\r\n        return a.startIndex - b.startIndex;\r\n      }\r\n      return a.endIndex - b.endIndex;\r\n    });\r\n\r\n    const deduplicated: Array<{ startIndex: number; endIndex: number; title: string; type: string }> = [];\r\n    for (const boundary of sorted) {\r\n      const overlaps = deduplicated.some(\r\n        (b) => boundary.startIndex >= b.startIndex && boundary.startIndex < b.endIndex\r\n      );\r\n      if (!overlaps) {\r\n        deduplicated.push(boundary);\r\n      }\r\n    }\r\n\r\n    return deduplicated;\r\n  }\r\n\r\n  /**\r\n   * Calculates confidence score for section type detection\r\n   */\r\n  private calculateConfidence(content: string, sectionType: keyof typeof this.sectionPatterns): number {\r\n    const patterns = this.sectionPatterns[sectionType];\r\n    let maxConfidence = 0;\r\n    let matchCount = 0;\r\n\r\n    for (const { pattern, confidence } of patterns) {\r\n      if (pattern.test(content)) {\r\n        matchCount++;\r\n        maxConfidence = Math.max(maxConfidence, confidence);\r\n      }\r\n    }\r\n\r\n    // Boost confidence if multiple patterns match\r\n    const confidenceBoost = Math.min(matchCount * 0.05, 0.1);\r\n    return Math.min(maxConfidence + confidenceBoost, 1.0);\r\n  }\r\n\r\n  /**\r\n   * Main method: Detects all sections in a document\r\n   */\r\n  async detectSections(text: string): Promise<SectionDetectionResult> {\r\n    if (!text || text.trim().length === 0) {\r\n      return {\r\n        sections: [],\r\n        documentType: 'UNSTRUCTURED',\r\n        totalSections: 0,\r\n        analysisMetadata: {\r\n          textLength: 0,\r\n          detectionConfidence: 0,\r\n          sectionsDetected: [],\r\n        },\r\n      };\r\n    }\r\n\r\n    // Detect document type\r\n    const documentType = this.detectDocumentType(text);\r\n\r\n    // Identify section boundaries\r\n    const boundaries = this.identifySectionBoundaries(text);\r\n\r\n    // Extract sections with content\r\n    const sections: DocumentSection[] = boundaries.map((boundary) => ({\r\n      type: this.mapSectionType(boundary.type),\r\n      title: boundary.title,\r\n      startIndex: boundary.startIndex,\r\n      endIndex: boundary.endIndex,\r\n      content: text.substring(boundary.startIndex, boundary.endIndex),\r\n      confidence: this.calculateConfidence(text.substring(boundary.startIndex, boundary.endIndex), boundary.type as keyof typeof this.sectionPatterns),\r\n    }));\r\n\r\n    // Calculate overall detection confidence\r\n    const overallConfidence =\r\n      sections.length > 0\r\n        ? sections.reduce((sum, s) => sum + s.confidence, 0) / sections.length\r\n        : 0;\r\n\r\n    return {\r\n      sections,\r\n      documentType,\r\n      totalSections: sections.length,\r\n      analysisMetadata: {\r\n        textLength: text.length,\r\n        detectionConfidence: overallConfidence,\r\n        sectionsDetected: [...new Set(sections.map((s) => s.type))],\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Maps section type string to enum value\r\n   */\r\n  private mapSectionType(\r\n    type: string\r\n  ): 'TRAINING' | 'ALUMNI_EMPLOYMENT' | 'RESEARCH' | 'COMMUNITY_ENGAGEMENT' | 'NARRATIVE' | 'UNKNOWN' {\r\n    const typeMap: {\r\n      [key: string]: 'TRAINING' | 'ALUMNI_EMPLOYMENT' | 'RESEARCH' | 'COMMUNITY_ENGAGEMENT' | 'NARRATIVE' | 'UNKNOWN';\r\n    } = {\r\n      TRAINING: 'TRAINING',\r\n      ALUMNI_EMPLOYMENT: 'ALUMNI_EMPLOYMENT',\r\n      RESEARCH: 'RESEARCH',\r\n      COMMUNITY_ENGAGEMENT: 'COMMUNITY_ENGAGEMENT',\r\n    };\r\n\r\n    return typeMap[type] || 'UNKNOWN';\r\n  }\r\n\r\n  /**\r\n   * Extracts specific section by type\r\n   */\r\n  getSectionByType(\r\n    sections: DocumentSection[],\r\n    type: DocumentSection['type']\r\n  ): DocumentSection | undefined {\r\n    return sections.find((s) => s.type === type);\r\n  }\r\n\r\n  /**\r\n   * Extracts all sections of a specific type\r\n   */\r\n  getSectionsByType(\r\n    sections: DocumentSection[],\r\n    type: DocumentSection['type']\r\n  ): DocumentSection[] {\r\n    return sections.filter((s) => s.type === type);\r\n  }\r\n\r\n  /**\r\n   * Generates section summary for logging/debugging\r\n   */\r\n  generateSectionSummary(result: SectionDetectionResult): string {\r\n    const lines = [\r\n      `Document Type: ${result.documentType}`,\r\n      `Total Sections Detected: ${result.totalSections}`,\r\n      `Overall Detection Confidence: ${(result.analysisMetadata.detectionConfidence * 100).toFixed(1)}%`,\r\n      `Document Length: ${result.analysisMetadata.textLength} characters`,\r\n      '',\r\n      'Sections Found:',\r\n    ];\r\n\r\n    for (const section of result.sections) {\r\n      lines.push(\r\n        `  - ${section.type} (${section.title}): ${section.content.length} chars, ${(section.confidence * 100).toFixed(1)}% confidence`\r\n      );\r\n    }\r\n\r\n    return lines.join('\\n');\r\n  }\r\n}\r\n\r\n// Export singleton instance\r\nexport const documentSectionDetector = new DocumentSectionDetector();\r\nexport default documentSectionDetector;\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1028, "column": 0}, "map": {"version":3,"sources":["file:///D:/downloads/Downloads%20from%20web/LSPU%20KMIS/lib/services/summary-extractor.ts"],"sourcesContent":["/**\r\n * SummaryExtractor Service\r\n * \r\n * Extracts summary metrics and aggregate values from documents\r\n * (e.g., \"Total No. of Attendees: 9\") to use for achievement calculations\r\n * instead of counting extracted rows.\r\n * \r\n * Solves Problems #2 and #3:\r\n * - Problem #2: Incomplete Data Extraction (system should use summary totals)\r\n * - Problem #3: Wrong Achievement Calculations (prioritize summary metrics)\r\n */\r\n\r\nexport interface ExtractedSummary {\r\n  metricType: 'COUNT' | 'TOTAL' | 'PERCENTAGE' | 'FINANCIAL' | 'MILESTONE' | 'UNKNOWN';\r\n  metricName: string;\r\n  value: number | string;\r\n  unit?: string;\r\n  confidence: number; // 0-1 confidence score\r\n  rawText: string; // Original text where metric was found\r\n}\r\n\r\nexport interface SummaryExtractionResult {\r\n  summaries: ExtractedSummary[];\r\n  totalExtracted: number;\r\n  prioritizedValue?: {\r\n    metricName: string;\r\n    value: number | string;\r\n    metricType: string;\r\n    confidence: number;\r\n  };\r\n  extractionMetadata: {\r\n    textLength: number;\r\n    metricsFound: number;\r\n    highConfidenceCount: number;\r\n    recommendedTargetValue?: number;\r\n  };\r\n}\r\n\r\nclass SummaryExtractor {\r\n  /**\r\n   * Patterns for extracting summary metrics\r\n   * Organized by priority and metric type\r\n   */\r\n  private readonly summaryPatterns = {\r\n    // Highest priority: \"Total No. of X\" patterns\r\n    totalMetrics: [\r\n      {\r\n        pattern: /total\\s+(?:no\\.|number)\\s+(?:of\\s+)?([a-z\\s]+)[\\s:]*(\\d+)/gi,\r\n        metricType: 'TOTAL',\r\n        confidence: 0.98,\r\n        valueGroup: 2,\r\n      },\r\n      {\r\n        pattern: /total\\s+([a-z\\s]+)[\\s:]*(\\d+)/gi,\r\n        metricType: 'TOTAL',\r\n        confidence: 0.95,\r\n        valueGroup: 2,\r\n      },\r\n      {\r\n        pattern: /(?:total|sum|cumulative)\\s+([a-z\\s]+)[\\s:]*(\\d+)/gi,\r\n        metricType: 'COUNT',\r\n        confidence: 0.92,\r\n        valueGroup: 2,\r\n      },\r\n    ],\r\n\r\n    // Attendance/participant metrics\r\n    participantMetrics: [\r\n      {\r\n        pattern: /attendee|participant|trained|beneficiary[\\s\\w]*[\\s:]*(\\d+)/gi,\r\n        metricType: 'COUNT',\r\n        confidence: 0.90,\r\n        valueGroup: 1,\r\n      },\r\n      {\r\n        pattern: /(?:no\\.|number)\\s+of\\s+(?:attendee|participant|trainee|beneficiary)[\\s:]*(\\d+)/gi,\r\n        metricType: 'COUNT',\r\n        confidence: 0.93,\r\n        valueGroup: 1,\r\n      },\r\n      {\r\n        pattern: /attended|participated[\\s\\w]*:\\s*(\\d+)/gi,\r\n        metricType: 'COUNT',\r\n        confidence: 0.88,\r\n        valueGroup: 1,\r\n      },\r\n    ],\r\n\r\n    // Financial metrics\r\n    financialMetrics: [\r\n      {\r\n        pattern: /(?:budget|cost|amount|fund)[\\s\\w]*[\\s:]*(?:php|₱)?[\\s]*([0-9,\\.]+)/gi,\r\n        metricType: 'FINANCIAL',\r\n        confidence: 0.90,\r\n        valueGroup: 1,\r\n      },\r\n      {\r\n        pattern: /(?:peso|php)[\\s]*([0-9,\\.]+)/gi,\r\n        metricType: 'FINANCIAL',\r\n        confidence: 0.92,\r\n        valueGroup: 1,\r\n      },\r\n    ],\r\n\r\n    // Percentage metrics\r\n    percentageMetrics: [\r\n      {\r\n        pattern: /(\\d+(?:\\.\\d+)?)\\s*%/g,\r\n        metricType: 'PERCENTAGE',\r\n        confidence: 0.85,\r\n        valueGroup: 1,\r\n      },\r\n      {\r\n        pattern: /(?:completion|success|achievement)\\s+rate[\\s:]*(\\d+(?:\\.\\d+)?)\\s*%/gi,\r\n        metricType: 'PERCENTAGE',\r\n        confidence: 0.92,\r\n        valueGroup: 1,\r\n      },\r\n    ],\r\n\r\n    // Milestone metrics (yes/no, completed, achieved)\r\n    milestoneMetrics: [\r\n      {\r\n        pattern: /(?:completed|achieved|accomplished|finished|done)[\\s\\w]*[:=]\\s*(?:yes|true|1|done|completed)/gi,\r\n        metricType: 'MILESTONE',\r\n        confidence: 0.90,\r\n        valueGroup: 0,\r\n      },\r\n    ],\r\n  };\r\n\r\n  /**\r\n   * Extracts all summary metrics from text\r\n   */\r\n  async extractSummaries(text: string): Promise<SummaryExtractionResult> {\r\n    if (!text || text.trim().length === 0) {\r\n      return {\r\n        summaries: [],\r\n        totalExtracted: 0,\r\n        extractionMetadata: {\r\n          textLength: 0,\r\n          metricsFound: 0,\r\n          highConfidenceCount: 0,\r\n        },\r\n      };\r\n    }\r\n\r\n    const summaries: ExtractedSummary[] = [];\r\n    const seenMetrics = new Set<string>();\r\n\r\n    // Extract from each pattern category\r\n    for (const [categoryName, patterns] of Object.entries(this.summaryPatterns)) {\r\n      for (const patternObj of patterns) {\r\n        let match;\r\n        const regex = new RegExp(patternObj.pattern.source, 'gi');\r\n\r\n        while ((match = regex.exec(text)) !== null) {\r\n          // Extract value from the appropriate group\r\n          const rawValue = patternObj.valueGroup === 0 ? 1 : match[patternObj.valueGroup];\r\n          \r\n          // Skip if value doesn't exist\r\n          if (rawValue === undefined) {\r\n            continue;\r\n          }\r\n          \r\n          const value = String(rawValue);\r\n          const metricName = match[1] || categoryName;\r\n          const metricKey = `${patternObj.metricType}:${metricName}:${value}`;\r\n\r\n          // Skip duplicates\r\n          if (seenMetrics.has(metricKey)) {\r\n            continue;\r\n          }\r\n          seenMetrics.add(metricKey);\r\n\r\n          const extractedSummary: ExtractedSummary = {\r\n            metricType: patternObj.metricType as ExtractedSummary['metricType'],\r\n            metricName: this.normalizeName(metricName),\r\n            value: this.parseValue(value, patternObj.metricType),\r\n            confidence: patternObj.confidence,\r\n            rawText: match[0],\r\n            unit: this.extractUnit(match[0], patternObj.metricType),\r\n          };\r\n\r\n          summaries.push(extractedSummary);\r\n        }\r\n      }\r\n    }\r\n\r\n    // Remove near-duplicates and sort by confidence\r\n    const deduplicated = this.deduplicateSummaries(summaries);\r\n    deduplicated.sort((a, b) => b.confidence - a.confidence);\r\n\r\n    // Identify prioritized/recommended value\r\n    let prioritizedValue: SummaryExtractionResult['prioritizedValue'] | undefined;\r\n    if (deduplicated.length > 0) {\r\n      // Priority: TOTAL > COUNT > PERCENTAGE > FINANCIAL > MILESTONE\r\n      const priorityOrder = ['TOTAL', 'COUNT', 'PERCENTAGE', 'FINANCIAL', 'MILESTONE'];\r\n      const topMetric = deduplicated.sort((a, b) => {\r\n        const priorityDiff =\r\n          priorityOrder.indexOf(a.metricType) - priorityOrder.indexOf(b.metricType);\r\n        if (priorityDiff !== 0) return priorityDiff;\r\n        return b.confidence - a.confidence;\r\n      })[0];\r\n\r\n      prioritizedValue = {\r\n        metricName: topMetric.metricName,\r\n        value: topMetric.value,\r\n        metricType: topMetric.metricType,\r\n        confidence: topMetric.confidence,\r\n      };\r\n    }\r\n\r\n    const highConfidenceCount = deduplicated.filter((s) => s.confidence >= 0.9).length;\r\n\r\n    return {\r\n      summaries: deduplicated,\r\n      totalExtracted: deduplicated.length,\r\n      prioritizedValue,\r\n      extractionMetadata: {\r\n        textLength: text.length,\r\n        metricsFound: deduplicated.length,\r\n        highConfidenceCount,\r\n        recommendedTargetValue:\r\n          prioritizedValue && typeof prioritizedValue.value === 'number'\r\n            ? prioritizedValue.value\r\n            : undefined,\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Extracts summary metrics from a specific section\r\n   */\r\n  async extractFromSection(sectionContent: string, sectionType: string): Promise<SummaryExtractionResult> {\r\n    const result = await this.extractSummaries(sectionContent);\r\n\r\n    // Filter metrics relevant to this section type\r\n    const contextualSummaries = result.summaries.filter((summary) => {\r\n      return this.isRelevantToSection(summary.metricName, sectionType);\r\n    });\r\n\r\n    return {\r\n      summaries: contextualSummaries,\r\n      totalExtracted: contextualSummaries.length,\r\n      prioritizedValue: contextualSummaries[0]\r\n        ? {\r\n            metricName: contextualSummaries[0].metricName,\r\n            value: contextualSummaries[0].value,\r\n            metricType: contextualSummaries[0].metricType,\r\n            confidence: contextualSummaries[0].confidence,\r\n          }\r\n        : undefined,\r\n      extractionMetadata: {\r\n        textLength: sectionContent.length,\r\n        metricsFound: contextualSummaries.length,\r\n        highConfidenceCount: contextualSummaries.filter((s) => s.confidence >= 0.9).length,\r\n        recommendedTargetValue:\r\n          contextualSummaries[0] && typeof contextualSummaries[0].value === 'number'\r\n            ? contextualSummaries[0].value\r\n            : undefined,\r\n      },\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Normalizes metric names to standard format\r\n   */\r\n  private normalizeName(name: string): string {\r\n    return name\r\n      .toLowerCase()\r\n      .trim()\r\n      .replace(/\\s+/g, ' ')\r\n      .replace(/^(of|no\\.|number)\\s+/i, '')\r\n      .split(' ')\r\n      .map((word) => word.charAt(0).toUpperCase() + word.slice(1))\r\n      .join(' ');\r\n  }\r\n\r\n  /**\r\n   * Parses value to appropriate type\r\n   */\r\n  private parseValue(value: string, metricType: string): number | string {\r\n    if (metricType === 'FINANCIAL') {\r\n      // Remove currency symbols and commas\r\n      const cleaned = value.replace(/[^0-9.]/g, '');\r\n      return parseFloat(cleaned) || value;\r\n    }\r\n\r\n    if (metricType === 'PERCENTAGE') {\r\n      return parseFloat(value) || 0;\r\n    }\r\n\r\n    if (metricType === 'COUNT' || metricType === 'TOTAL') {\r\n      // Remove commas and parse as number\r\n      const cleaned = value.replace(/,/g, '');\r\n      return parseInt(cleaned, 10) || 0;\r\n    }\r\n\r\n    if (metricType === 'MILESTONE') {\r\n      return 1; // Milestone achieved = 1\r\n    }\r\n\r\n    return value;\r\n  }\r\n\r\n  /**\r\n   * Extracts unit from metric text\r\n   */\r\n  private extractUnit(text: string, metricType: string): string | undefined {\r\n    if (metricType === 'FINANCIAL') {\r\n      if (text.match(/php|₱/i)) return 'PHP';\r\n      if (text.match(/peso/i)) return 'PHP';\r\n    }\r\n\r\n    if (metricType === 'PERCENTAGE') {\r\n      return '%';\r\n    }\r\n\r\n    if (metricType === 'COUNT' || metricType === 'TOTAL') {\r\n      const unitMatch = text.match(/(?:unit|person|participant|attendee|session)/i);\r\n      if (unitMatch) return unitMatch[0];\r\n    }\r\n\r\n    return undefined;\r\n  }\r\n\r\n  /**\r\n   * Removes near-duplicate summaries\r\n   */\r\n  private deduplicateSummaries(summaries: ExtractedSummary[]): ExtractedSummary[] {\r\n    const seen = new Map<string, ExtractedSummary>();\r\n\r\n    for (const summary of summaries) {\r\n      const key = `${summary.metricType}:${summary.metricName}`;\r\n      \r\n      if (!seen.has(key)) {\r\n        seen.set(key, summary);\r\n      } else {\r\n        // Keep the one with higher confidence\r\n        const existing = seen.get(key)!;\r\n        if (summary.confidence > existing.confidence) {\r\n          seen.set(key, summary);\r\n        }\r\n      }\r\n    }\r\n\r\n    return Array.from(seen.values());\r\n  }\r\n\r\n  /**\r\n   * Checks if metric is relevant to section type\r\n   */\r\n  private isRelevantToSection(metricName: string, sectionType: string): boolean {\r\n    const relevanceMap: { [key: string]: RegExp } = {\r\n      TRAINING: /attendee|participant|trained|person|session/i,\r\n      ALUMNI_EMPLOYMENT: /employed|placement|graduate|alumni|job/i,\r\n      RESEARCH: /publication|paper|study|research|output/i,\r\n      COMMUNITY_ENGAGEMENT: /beneficiary|participant|community|served|assisted/i,\r\n    };\r\n\r\n    const pattern = relevanceMap[sectionType];\r\n    return !pattern || pattern.test(metricName);\r\n  }\r\n\r\n  /**\r\n   * Generates extraction summary for logging/debugging\r\n   */\r\n  generateExtractionSummary(result: SummaryExtractionResult): string {\r\n    const lines = [\r\n      `Total Metrics Extracted: ${result.totalExtracted}`,\r\n      `High Confidence (≥90%): ${result.extractionMetadata.highConfidenceCount}`,\r\n      `Document Length: ${result.extractionMetadata.textLength} characters`,\r\n      '',\r\n      'Extracted Summaries:',\r\n    ];\r\n\r\n    for (const summary of result.summaries) {\r\n      lines.push(\r\n        `  - ${summary.metricType}: ${summary.metricName} = ${summary.value}${summary.unit ? ' ' + summary.unit : ''} (${(summary.confidence * 100).toFixed(0)}% confidence)`\r\n      );\r\n    }\r\n\r\n    if (result.prioritizedValue) {\r\n      lines.push('');\r\n      lines.push(\r\n        `Recommended Target Value: ${result.prioritizedValue.value} (${result.prioritizedValue.metricType})`\r\n      );\r\n    }\r\n\r\n    return lines.join('\\n');\r\n  }\r\n}\r\n\r\n// Export singleton instance\r\nexport const summaryExtractor = new SummaryExtractor();\r\nexport default summaryExtractor;\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 1347, "column": 0}, "map": {"version":3,"sources":["file:///D:/downloads/Downloads%20from%20web/LSPU%20KMIS/lib/services/redis-service.ts"],"sourcesContent":["import { Redis } from '@upstash/redis';\r\n\r\nclass RedisService {\r\n  public redis: Redis;\r\n\r\n  constructor() {\r\n    this.redis = new Redis({\r\n      url: process.env.UPSTASH_REDIS_REST_URL!,\r\n      token: process.env.UPSTASH_REDIS_REST_TOKEN!,\r\n    });\r\n  }\r\n\r\n  // Generic methods for common operations\r\n  async get<T>(key: string): Promise<T | null> {\r\n    try {\r\n      const value = await this.redis.get(key);\r\n      return value as T | null;\r\n    } catch (error) {\r\n      console.error(`Error getting key ${key}:`, error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  async set(key: string, value: any, ttl?: number): Promise<boolean> {\r\n    try {\r\n      if (ttl) {\r\n        await this.redis.setex(key, ttl, value);\r\n      } else {\r\n        await this.redis.set(key, value);\r\n      }\r\n      return true;\r\n    } catch (error) {\r\n      console.error(`Error setting key ${key}:`, error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async del(key: string): Promise<boolean> {\r\n    try {\r\n      await this.redis.del(key);\r\n      return true;\r\n    } catch (error) {\r\n      console.error(`Error deleting key ${key}:`, error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async exists(key: string): Promise<boolean> {\r\n    try {\r\n      const result = await this.redis.exists(key);\r\n      return result === 1;\r\n    } catch (error) {\r\n      console.error(`Error checking key ${key}:`, error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async expire(key: string, ttl: number): Promise<boolean> {\r\n    try {\r\n      await this.redis.expire(key, ttl);\r\n      return true;\r\n    } catch (error) {\r\n      console.error(`Error setting expiration for key ${key}:`, error);\r\n      return false;\r\n    }\r\n  }\r\n\r\n  async keys(pattern: string): Promise<string[]> {\r\n    try {\r\n      return await this.redis.keys(pattern);\r\n    } catch (error) {\r\n      console.error(`Error getting keys with pattern ${pattern}:`, error);\r\n      return [];\r\n    }\r\n  }\r\n}\r\n\r\nexport const redisService = new RedisService();\r\nexport default RedisService;"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM;IACG,MAAa;IAEpB,aAAc;QACZ,IAAI,CAAC,KAAK,GAAG,IAAI,wKAAK,CAAC;YACrB,KAAK,QAAQ,GAAG,CAAC,sBAAsB;YACvC,OAAO,QAAQ,GAAG,CAAC,wBAAwB;QAC7C;IACF;IAEA,wCAAwC;IACxC,MAAM,IAAO,GAAW,EAAqB;QAC3C,IAAI;YACF,MAAM,QAAQ,MAAM,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC;YACnC,OAAO;QACT,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,CAAC,kBAAkB,EAAE,IAAI,CAAC,CAAC,EAAE;YAC3C,OAAO;QACT;IACF;IAEA,MAAM,IAAI,GAAW,EAAE,KAAU,EAAE,GAAY,EAAoB;QACjE,IAAI;YACF,IAAI,KAAK;gBACP,MAAM,IAAI,CAAC,KAAK,CAAC,KAAK,CAAC,KAAK,KAAK;YACnC,OAAO;gBACL,MAAM,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC,KAAK;YAC5B;YACA,OAAO;QACT,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,CAAC,kBAAkB,EAAE,IAAI,CAAC,CAAC,EAAE;YAC3C,OAAO;QACT;IACF;IAEA,MAAM,IAAI,GAAW,EAAoB;QACvC,IAAI;YACF,MAAM,IAAI,CAAC,KAAK,CAAC,GAAG,CAAC;YACrB,OAAO;QACT,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,CAAC,mBAAmB,EAAE,IAAI,CAAC,CAAC,EAAE;YAC5C,OAAO;QACT;IACF;IAEA,MAAM,OAAO,GAAW,EAAoB;QAC1C,IAAI;YACF,MAAM,SAAS,MAAM,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC;YACvC,OAAO,WAAW;QACpB,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,CAAC,mBAAmB,EAAE,IAAI,CAAC,CAAC,EAAE;YAC5C,OAAO;QACT;IACF;IAEA,MAAM,OAAO,GAAW,EAAE,GAAW,EAAoB;QACvD,IAAI;YACF,MAAM,IAAI,CAAC,KAAK,CAAC,MAAM,CAAC,KAAK;YAC7B,OAAO;QACT,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,CAAC,iCAAiC,EAAE,IAAI,CAAC,CAAC,EAAE;YAC1D,OAAO;QACT;IACF;IAEA,MAAM,KAAK,OAAe,EAAqB;QAC7C,IAAI;YACF,OAAO,MAAM,IAAI,CAAC,KAAK,CAAC,IAAI,CAAC;QAC/B,EAAE,OAAO,OAAO;YACd,QAAQ,KAAK,CAAC,CAAC,gCAAgC,EAAE,QAAQ,CAAC,CAAC,EAAE;YAC7D,OAAO,EAAE;QACX;IACF;AACF;AAEO,MAAM,eAAe,IAAI;uCACjB"}},
    {"offset": {"line": 1524, "column": 0}, "map": {"version":3,"sources":["file:///D:/downloads/Downloads%20from%20web/LSPU%20KMIS/lib/services/analysis-engine-service.ts"],"sourcesContent":["// Router-Extractor Architecture: JSON-Guided Deterministic Flow\r\n// This replaces the fuzzy vector search with a deterministic logic flow using strategic_plan.json\r\n\r\n// Import Strategic Plan JSON (deterministic source of truth)\r\n// Use the lib/data copy to keep API + UI consistent.\r\nimport strategicPlan from '@/lib/data/strategic_plan.json';\r\n\r\nimport { computeAggregatedAchievement, getInitiativeTargetMeta, normalizeKraId } from '@/lib/utils/qpro-aggregation';\r\n\r\n// Keep these for section detection and summary extraction (useful preprocessing)\r\nimport { documentSectionDetector } from './document-section-detector';\r\nimport { summaryExtractor } from './summary-extractor';\r\n\r\n// LangChain imports\r\nimport { BaseLanguageModel } from \"@langchain/core/language_models/base\";\r\nimport { ChatOpenAI } from \"@langchain/openai\";\r\nimport { PromptTemplate } from \"@langchain/core/prompts\";\r\nimport { z } from 'zod';\r\nimport { redisService } from './redis-service';\r\nimport { createHash } from 'crypto';\r\n\r\n// Import pdf2json and mammoth using CommonJS style since they use export = syntax\r\nimport mammoth from 'mammoth';\r\nconst PDFParser = require('pdf2json');\r\n\r\n// ========== ROUTER-EXTRACTOR MODELS ==========\r\n// Router Model: Fast/cheap for classification (gpt-4o-mini)\r\nconst routerModel = new ChatOpenAI({\r\n  modelName: \"gpt-4o-mini\",\r\n  temperature: 0,\r\n  maxTokens: 500, // Router output is short\r\n  modelKwargs: {\r\n    response_format: { type: \"json_object\" },\r\n    seed: 42,\r\n  },\r\n});\r\n\r\n// Extractor Model: Use gpt-4o-mini for extraction (cost/speed parity with router)\r\nconst extractorModel = new ChatOpenAI({\r\n  modelName: \"gpt-4o-mini\",\r\n  temperature: 0,\r\n  maxTokens: 3500,\r\n  modelKwargs: {\r\n    response_format: { type: \"json_object\" },\r\n    seed: 42,\r\n  },\r\n});\r\n\r\n// ========== HELPER FUNCTIONS ==========\r\n/**\r\n * Safely converts string or string[] to a single text block.\r\n * Handles inconsistent JSON data types in strategic_plan.json\r\n */\r\nfunction formatList(data: string | string[] | undefined | null): string {\r\n  if (!data) return \"N/A\";\r\n  if (Array.isArray(data)) {\r\n    return data.join(\"; \");\r\n  }\r\n  return data; // It's already a string\r\n}\r\n\r\nfunction normalizePercentageReported(raw: unknown): number {\r\n  const n = typeof raw === 'number' ? raw : Number(String(raw ?? '').replace(/,/g, '').trim());\r\n  if (!Number.isFinite(n)) return 0;\r\n\r\n  // Common extraction artifact: decimals stripped (e.g., \"19.2%\" -> 192)\r\n  let v = n;\r\n  while (v > 100 && v <= 1000) {\r\n    v = v / 10;\r\n  }\r\n\r\n  // Clamp to valid percentage range\r\n  v = Math.min(100, Math.max(0, v));\r\n\r\n  // DB uses Int for reported; store whole-number percent\r\n  return Math.round(v);\r\n}\r\n\r\n// ========== ROUTER FUNCTION ==========\r\n/**\r\n * Phase 1: Router - Classify document to a single dominant KRA\r\n * Analyzes filename and text preview to deterministically select ONE KRA\r\n * This replaces the fuzzy vector search step\r\n */\r\nasync function classifyDominantKRA(filename: string, textPreview: string): Promise<{ kraId: string; confidence: number } | null> {\r\n  console.log(\"🚀 [ROUTER] Classifying document...\");\r\n  console.log(`[ROUTER] Filename: \"${filename}\"`);\r\n  console.log(`[ROUTER] Text preview length: ${textPreview.length} chars`);\r\n\r\n  // 1. Build the \"Menu\" from Strategic Plan JSON\r\n  // Include Responsible Offices as strong signals (e.g., \"HRMO\" -> KRA 11/13)\r\n  const kraMenu = strategicPlan.kras.map((kra: any) => {\r\n    const offices = [...new Set(kra.initiatives.flatMap((i: any) => i.responsible_offices))].join(', ');\r\n    const kpiOutputs = kra.initiatives.map((i: any) => i.key_performance_indicator?.outputs || '').filter(Boolean).join('; ').substring(0, 200);\r\n    return `ID: \"${kra.kra_id}\" | Title: \"${kra.kra_title}\" | Offices: [${offices}] | KPIs: [${kpiOutputs}...]`;\r\n  }).join('\\n');\r\n\r\n  // 2. Strict Classification Prompt\r\n  const prompt = `\r\nROLE: Strategic Document Router for Laguna State Polytechnic University.\r\nTASK: Map the uploaded document to EXACTLY ONE Key Result Area (KRA) from the list below.\r\n\r\nDOCUMENT CONTEXT:\r\nTitle/Filename: \"${filename}\"\r\nExcerpt (first 1500 chars): \"${textPreview.substring(0, 1500)}...\"\r\n\r\nAVAILABLE KRAS:\r\n${kraMenu}\r\n\r\nLOGIC RULES (Follow in order):\r\n1. **Check Document Title First (HIGHEST PRIORITY)**:\r\n   - \"Alumni\" or \"Employment\" or \"Graduate Tracer\" -> KRA 3\r\n   - \"Research\" or \"Publication\" or \"Citation\" -> KRA 5\r\n   - \"Training\" or \"Seminar\" or \"Workshop\" or \"Faculty Development\" -> KRA 11\r\n   - \"International\" or \"MOU\" or \"Exchange\" or \"Global\" -> KRA 4\r\n   - \"Curriculum\" or \"Course\" or \"Program\" -> KRA 1\r\n   - \"Extension\" or \"Community\" -> KRA 6, 7, or 8\r\n   - \"Health\" or \"Wellness\" or \"Fitness\" -> KRA 13\r\n   - \"Budget\" or \"Financial\" or \"Utilization\" -> KRA 21 or 22\r\n   - \"Licensure\" or \"Board Exam\" -> KRA 2\r\n\r\n2. **Check Responsible Offices (if title unclear)**:\r\n   - Document mentions \"HR\", \"HRMO\" -> KRA 11 or KRA 13\r\n   - Document mentions \"Research Office\" -> KRA 5\r\n   - Document mentions \"Registrar\" -> KRA 2 or KRA 3\r\n   - Document mentions \"OVPAA\", \"Academic Affairs\" -> KRA 1\r\n\r\n3. **Content Keywords**:\r\n   - Employment rates, tracer study, alumni -> KRA 3\r\n   - Research papers, publications, citations -> KRA 5\r\n   - Training attended, seminars, workshops -> KRA 11\r\n   - Health programs, wellness activities -> KRA 13\r\n   - International partnerships, foreign exchange -> KRA 4\r\n\r\nOUTPUT FORMAT (JSON):\r\n{\r\n  \"kraId\": \"KRA X\",\r\n  \"confidence\": 0.95,\r\n  \"reasoning\": \"Brief explanation of why this KRA was selected\"\r\n}\r\n\r\nIf genuinely unsure, return: { \"kraId\": \"UNKNOWN\", \"confidence\": 0.0, \"reasoning\": \"explanation\" }\r\n`;\r\n\r\n  try {\r\n    const result = await routerModel.invoke([\r\n      { role: \"system\", content: \"You are a document classifier that outputs only JSON.\" },\r\n      { role: \"user\", content: prompt }\r\n    ]);\r\n\r\n    const responseText = typeof result.content === 'string' ? result.content : JSON.stringify(result.content);\r\n    const parsed = JSON.parse(responseText);\r\n    \r\n    const kraId = parsed.kraId?.trim().replace(/['\"]/g, '');\r\n    const confidence = parsed.confidence || 0.5;\r\n    \r\n    console.log(`[ROUTER] Classification result: ${kraId} (confidence: ${confidence})`);\r\n    console.log(`[ROUTER] Reasoning: ${parsed.reasoning || 'N/A'}`);\r\n\r\n    // Validate ID exists in JSON (use normalized KRA ID for comparison)\r\n    const normalizedKraId = normalizeKraId(kraId);\r\n    const exists = strategicPlan.kras.find((k: any) => normalizeKraId(k.kra_id) === normalizedKraId);\r\n    if (exists) {\r\n      return { kraId: normalizedKraId, confidence }; // Return normalized kraId\r\n    } else if (kraId === 'UNKNOWN') {\r\n      console.log('[ROUTER] Document could not be classified to a specific KRA');\r\n      return null;\r\n    } else {\r\n      console.warn(`[ROUTER] KRA ID \"${kraId}\" not found in strategic plan`);\r\n      return null;\r\n    }\r\n  } catch (error) {\r\n    console.error('[ROUTER] Classification failed:', error);\r\n    return null;\r\n  }\r\n}\r\n\r\n// ========== EXTRACTOR FUNCTION ==========\r\n/**\r\n * Phase 2: Extractor - Extract activities using only the relevant KRA's KPIs\r\n * This provides the AI with focused context, eliminating KRA confusion\r\n */\r\nasync function extractActivitiesForKRA(\r\n  fullText: string, \r\n  kraId: string, \r\n  reportYear: number = 2025\r\n): Promise<any[]> {\r\n  console.log(`🚀 [EXTRACTOR] Extracting for ${kraId} (Year: ${reportYear})...`);\r\n\r\n  // 1. Get the Specific KRA from JSON (use normalized KRA ID for comparison)\r\n  const normalizedKraIdVal = normalizeKraId(kraId);\r\n  const targetKRA = strategicPlan.kras.find((k: any) => normalizeKraId(k.kra_id) === normalizedKraIdVal);\r\n  if (!targetKRA) {\r\n    throw new Error(`Invalid KRA ID: ${kraId}`);\r\n  }\r\n\r\n  console.log(`[EXTRACTOR] Target KRA: \"${targetKRA.kra_title}\"`);\r\n  console.log(`[EXTRACTOR] Number of initiatives: ${targetKRA.initiatives.length}`);\r\n\r\n  // 2. Build Context ONLY for this KRA and Year\r\n  const kpiContext = targetKRA.initiatives.map((init: any) => {\r\n    const yearTarget = init.targets?.timeline_data?.find((t: any) => t.year === reportYear);\r\n    const targetValue = yearTarget?.target_value ?? 'N/A';\r\n    \r\n    // Use the formatList helper to handle both Arrays and Strings safely\r\n    const strategiesText = formatList(init.strategies);\r\n    const activitiesText = formatList(init.programs_activities);\r\n    \r\n    return `\r\n--------------------------------\r\nKPI ID: \"${init.id}\"\r\nDescription: \"${init.key_performance_indicator?.outputs || 'N/A'}\"\r\nExpected Outcomes: \"${init.key_performance_indicator?.outcomes || 'N/A'}\"\r\nContext (Strategies): \"${strategiesText}\"\r\nContext (Activities): \"${activitiesText}\"\r\nTarget Value (${reportYear}): \"${targetValue}\"\r\nUnit: \"${init.targets?.type || 'count'}\"\r\n    `;\r\n  }).join('\\n--------------------------------\\n');\r\n\r\n  // 3. The Extraction Prompt with strict rules\r\n  const prompt = `\r\nROLE: Strategic Data Analyst for Laguna State Polytechnic University.\r\nCONTEXT: Analyzing QPRO report for \"${targetKRA.kra_title}\" (${targetKRA.kra_id}).\r\n\r\nTASK: Extract ALL activities/accomplishments from the document that relate to the KPIs below.\r\n\r\nTARGET KPIs FOR THIS KRA:\r\n${kpiContext}\r\n\r\nDOCUMENT TYPE DETECTION:\r\n- If this is a **Research Report**: Each completed research/publication/study = 1 activity\r\n- If this is a **Training Report**: Each training/seminar attended = 1 activity  \r\n- If this is an **Employment/Tracer Report**: Each program's employment rate = 1 activity\r\n- If this is a **Financial Report**: Each budget item = 1 activity\r\n\r\nCRITICAL EXTRACTION RULES:\r\n\r\n1. **For Research/Publication Documents:**\r\n   - Each research title = 1 activity with reported_value = 1\r\n   - Count total completed researches for the aggregate\r\n   - Extract: researcher name, title, date completed, publication venue\r\n   - Match to KPIs about \"research outputs\", \"publications\", \"completed researches\"\r\n\r\n2. **For Training Documents:**\r\n   - Each training session attended = 1 activity\r\n   - Extract: training title, attendee count, date\r\n   - Match to KPIs about \"training\", \"capacity building\", \"faculty development\"\r\n\r\n3. **For Academic/Employment Reports:**\r\n   - Extract actual percentages or counts from tables\r\n   - Match to KPIs about \"employment rate\", \"licensure passing\", \"graduates\"\r\n\r\n4. **Value Extraction:**\r\n   - For counts (research, training): reported_value = number of items (e.g., 5 researches = 5)\r\n   - For percentages: reported_value = the percentage number (e.g., 85.5)\r\n   - For milestones: reported_value = 1 if completed, 0 if not\r\n\r\n5. **Target Lookup:**\r\n   - Use Target values from KPI context above for year ${reportYear}\r\n   - Calculate: achievement = (reported_value / target_value) * 100\r\n\r\n6. **MUST EXTRACT SOMETHING:**\r\n   - If the document mentions ANY accomplishments related to this KRA, extract them\r\n   - Even if exact values aren't clear, estimate based on listed items\r\n   - Count rows/entries if they represent individual accomplishments\r\n\r\nOUTPUT FORMAT (JSON):\r\n{\r\n  \"activities\": [\r\n    {\r\n      \"name\": \"Completed Research: IT Infrastructure Assessment Study\",\r\n      \"reported_value\": 1,\r\n      \"target_value\": 10,\r\n      \"achievement\": 10,\r\n      \"status\": \"MISSED\",\r\n      \"kpi_id\": \"KRA5-KPI1\",\r\n      \"data_type\": \"count\",\r\n      \"evidence_snippet\": \"REYNALEN C. JUSTO - IT Infrastructure Assessment...\",\r\n      \"unit\": \"LSPU - Santa Cruz Campus\"\r\n    }\r\n  ],\r\n  \"summary\": {\r\n    \"total_activities\": 5,\r\n    \"met_count\": 2,\r\n    \"missed_count\": 3\r\n  }\r\n}\r\n\r\nNOTE FOR PERCENTAGE VALUES:\r\n- Keep reported_value within 0-100.\r\n- If you extracted something like 192 but it likely means 19.2%, interpret it as 19.2 (and round to 19 if needed).\r\n\r\nIMPORTANT: You MUST extract at least 1 activity if the document contains any accomplishments.\r\nIf you see a list of researches, each research = 1 activity.\r\nIf you see a table, each meaningful row = 1 activity.\r\n\r\nDOCUMENT TEXT:\r\n${fullText}\r\n`;\r\n\r\n  try {\r\n    const response = await extractorModel.invoke([\r\n      { role: \"system\", content: \"You are a precise data extractor that outputs only valid JSON.\" },\r\n      { role: \"user\", content: prompt }\r\n    ]);\r\n\r\n    const responseText = typeof response.content === 'string' ? response.content : JSON.stringify(response.content);\r\n    const parsed = JSON.parse(responseText);\r\n    \r\n    const activities = parsed.activities || [];\r\n    console.log(`[EXTRACTOR] Extracted ${activities.length} activities for ${kraId}`);\r\n    \r\n    // Enrich with KRA metadata\r\n    return activities.map((act: any) => ({\r\n      ...act,\r\n      kraId: kraId,\r\n      kraTitle: targetKRA.kra_title,\r\n      initiativeId: act.kpi_id || act.initiativeId,\r\n      reported: act.reported_value ?? act.reported ?? 0,\r\n      target: act.target_value ?? act.target ?? 0,\r\n      dataType: act.data_type || act.dataType || 'count',\r\n      evidenceSnippet: act.evidence_snippet || act.evidenceSnippet || ''\r\n    }));\r\n  } catch (error) {\r\n    console.error('[EXTRACTOR] Extraction failed:', error);\r\n    throw error;\r\n  }\r\n}\r\n\r\n// ========== PRESCRIPTIVE ANALYSIS GENERATOR ==========\r\n/**\r\n * Phase 3: Generate prescriptive analysis based on extracted activities\r\n */\r\nasync function generatePrescriptiveAnalysis(\r\n  activities: any[],\r\n  kraId: string,\r\n  kraTitle: string,\r\n  reportYear: number\r\n): Promise<{ \r\n  documentInsight: string;\r\n  prescriptiveItems: Array<{ title: string; issue: string; action: string; nextStep?: string }>;\r\n  alignment: string; \r\n  opportunities: string; \r\n  gaps: string; \r\n  recommendations: string;\r\n  overallAchievement: number;\r\n}> {\r\n  const extractJsonObjectCandidate = (rawText: string): string => {\r\n    const text = String(rawText || '').trim();\r\n    if (!text) return '';\r\n\r\n    // Strip markdown fences if present\r\n    const unfenced = text\r\n      .replace(/^```(?:json)?\\s*/i, '')\r\n      .replace(/```\\s*$/i, '')\r\n      .trim();\r\n\r\n    // If it already looks like JSON, keep it\r\n    if (unfenced.startsWith('{') && unfenced.endsWith('}')) return unfenced;\r\n\r\n    // Try to extract the first JSON object-like block\r\n    const start = unfenced.indexOf('{');\r\n    const end = unfenced.lastIndexOf('}');\r\n    if (start >= 0 && end > start) return unfenced.slice(start, end + 1);\r\n    return unfenced;\r\n  };\r\n\r\n  const tryParseJson = (rawText: string): any | null => {\r\n    const candidate = extractJsonObjectCandidate(rawText);\r\n    if (!candidate) return null;\r\n\r\n    // Common LLM issues: smart quotes + trailing commas\r\n    const normalized = candidate\r\n      .replace(/[\\u201C\\u201D]/g, '\"')\r\n      .replace(/[\\u2018\\u2019]/g, \"'\")\r\n      .replace(/,\\s*([}\\]])/g, '$1');\r\n\r\n    try {\r\n      return JSON.parse(normalized);\r\n    } catch {\r\n      return null;\r\n    }\r\n  };\r\n  console.log(`🚀 [PRESCRIPTIVE] Generating analysis for ${kraId}...`);\r\n\r\n  // Use normalized KRA ID for consistent lookup\r\n  const normalizedKraIdForPrescriptive = normalizeKraId(kraId);\r\n  const targetKRA = strategicPlan.kras.find((k: any) => normalizeKraId(k.kra_id) === normalizedKraIdForPrescriptive);\r\n  const strategies = targetKRA?.initiatives.flatMap((i: any) => i.strategies || []).join('; ') || 'N/A';\r\n\r\n  // KPI-level aggregation (prevents per-item target inflation and average-of-tiny-percent bug)\r\n  const byInitiative = new Map<string, any[]>();\r\n  for (const a of activities) {\r\n    const initiativeId = String(a.initiativeId || a.kpi_id || '').trim() || `${normalizedKraIdForPrescriptive}-KPI1`;\r\n    if (!byInitiative.has(initiativeId)) byInitiative.set(initiativeId, []);\r\n    byInitiative.get(initiativeId)!.push(a);\r\n  }\r\n\r\n  const kpiSummaries = Array.from(byInitiative.entries()).map(([initiativeId, acts]) => {\r\n    const meta = getInitiativeTargetMeta(strategicPlan as any, normalizedKraIdForPrescriptive, initiativeId, reportYear);\r\n    const fallbackTarget = typeof acts[0]?.initiativeTarget === 'number'\r\n      ? acts[0].initiativeTarget\r\n      : (typeof acts[0]?.target === 'number' ? acts[0].target : Number(acts[0]?.target || 0));\r\n    const targetValue = meta.targetValue ?? (Number.isFinite(fallbackTarget) && fallbackTarget > 0 ? fallbackTarget : 0);\r\n\r\n    const aggregated = computeAggregatedAchievement({\r\n      targetType: meta.targetType,\r\n      targetValue,\r\n      targetScope: meta.targetScope,\r\n      activities: acts,\r\n    });\r\n\r\n    const achievement = Math.min(100, Math.max(0, aggregated.achievementPercent));\r\n    const status = achievement >= 100 ? 'MET' : achievement >= 80 ? 'ON_TRACK' : 'MISSED';\r\n\r\n    // Provide sample outputs (titles) but avoid repeating target/gap per item.\r\n    const samples = acts\r\n      .map((x) => String(x.name || '').trim())\r\n      .filter(Boolean)\r\n      .slice(0, 5);\r\n\r\n    return {\r\n      initiativeId,\r\n      targetType: meta.targetType || acts[0]?.dataType || acts[0]?.data_type || 'count',\r\n      totalReported: aggregated.totalReported,\r\n      totalTarget: aggregated.totalTarget,\r\n      achievementPercent: achievement,\r\n      status,\r\n      samples,\r\n    };\r\n  });\r\n\r\n  const overallAchievement = kpiSummaries.length > 0\r\n    ? kpiSummaries.reduce((sum, k) => sum + (k.achievementPercent || 0), 0) / kpiSummaries.length\r\n    : 0;\r\n\r\n  const maxAchievement = kpiSummaries.length > 0\r\n    ? Math.max(...kpiSummaries.map((k) => Number(k.achievementPercent || 0)))\r\n    : 0;\r\n\r\n  const metCount = kpiSummaries.filter((k) => k.status === 'MET').length;\r\n  const missedCount = kpiSummaries.filter((k) => k.status === 'MISSED').length;\r\n\r\n  const normalizeId = (value: unknown) => String(value || '').replace(/\\s+/g, '').trim().toLowerCase();\r\n  const planSnapshotText = kpiSummaries.map((k) => {\r\n    const initiative = targetKRA?.initiatives?.find((i: any) => normalizeId(i.id) === normalizeId(k.initiativeId));\r\n    const outputs = initiative?.key_performance_indicator?.outputs || 'N/A';\r\n    const outcomes = initiative?.key_performance_indicator?.outcomes || 'N/A';\r\n    const yearTarget = initiative?.targets?.timeline_data?.find((t: any) => t.year === reportYear)?.target_value;\r\n    const unit = initiative?.targets?.type || k.targetType || 'count';\r\n    const strategiesText = formatList(initiative?.strategies);\r\n    return `- ${k.initiativeId}: Outputs=\"${outputs}\" | Outcomes=\"${outcomes}\" | Target(${reportYear})=${yearTarget ?? 'N/A'} (${unit}) | Strategies=\"${strategiesText}\"`;\r\n  }).join('\\n');\r\n\r\n  const kpiSummaryText = kpiSummaries.map((k) => {\r\n    const reportedStr = typeof k.totalReported === 'number' ? k.totalReported.toFixed(k.targetType === 'percentage' ? 1 : 0) : String(k.totalReported);\r\n    const targetStr = typeof k.totalTarget === 'number' ? k.totalTarget.toFixed(k.targetType === 'percentage' ? 1 : 0) : String(k.totalTarget);\r\n    const sampleText = k.samples.length > 0 ? ` | Examples: ${k.samples.join('; ')}` : '';\r\n    return `- ${k.initiativeId}: ${reportedStr} vs ${targetStr} (${k.achievementPercent.toFixed(1)}%) [${k.status}]${sampleText}`;\r\n  }).join('\\n');\r\n\r\n  const prompt = `\r\nROLE: Strategic Planning Advisor for LSPU.\r\nCONTEXT: Analyzing performance for \"${kraTitle}\" (${kraId}).\r\n\r\nSTRATEGIC PLAN SNAPSHOT (KRA-only, authoritative):\r\n${planSnapshotText || 'N/A'}\r\n\r\nPERFORMANCE DATA:\r\n${kpiSummaryText}\r\n\r\nSUMMARY:\r\n- Total Extracted Items (evidence): ${activities.length}\r\n- KPIs Evaluated: ${kpiSummaries.length}\r\n- KPIs Met: ${metCount}\r\n- KPIs Missed: ${missedCount}\r\n- Overall Achievement (KPI-level): ${overallAchievement.toFixed(1)}%\r\n- Highest KPI Achievement: ${maxAchievement.toFixed(1)}%\r\n\r\nAUTHORIZED STRATEGIES FOR THIS KRA:\r\n${strategies}\r\n\r\nTASK:\r\n1) Write a single Document Insight paragraph (2–4 sentences) grounded on the performance data and the strategic plan snapshot.\r\n   - Must reference the overall achievement percentage.\r\n   - Must identify the primary bottleneck KPI (lowest achievement) using the KPI ID and its reported vs target.\r\n2) Produce Prescriptive Analysis as 2–3 items, each with:\r\n   - title (short)\r\n   - issue (one sentence)\r\n   - action (specific, with timeframe when possible)\r\n   - nextStep (optional, immediate next action)\r\n  RULE: Only include a \"Sustain\"/\"high performers\" item if at least one KPI has >80% achievement. If none are >80%, DO NOT generate that item.\r\n3) Also provide brief supporting fields (alignment/opportunities/gaps/recommendations) for backward compatibility.\r\n\r\nOUTPUT FORMAT (JSON):\r\n{\r\n  \"documentInsight\": \"...\",\r\n  \"prescriptiveItems\": [\r\n    { \"title\": \"...\", \"issue\": \"...\", \"action\": \"...\", \"nextStep\": \"...\" }\r\n  ],\r\n  \"alignment\": \"2-3 sentences on strategic alignment\",\r\n  \"opportunities\": [\"...\"],\r\n  \"gaps\": \"Specific gaps with numbers\",\r\n  \"recommendations\": [\"...\"]\r\n}\r\n\r\nIMPORTANT GUIDANCE:\r\n- Do NOT critique individual documents/files as if each one must meet the full institutional target.\r\n- For count-based KPIs (e.g., research outputs), interpret gaps as volume shortfalls at the KRA/KPI level (\"need X more outputs\"), not \"improve Paper A by 149\".\r\n- Avoid repetitive per-item gap statements; synthesize patterns and provide 3-6 concise bullets.\r\n\r\nSTRICT OUTPUT RULES:\r\n- Output MUST be valid JSON only (no extra commentary, no markdown code fences).\r\n- All JSON string values must be single-line. Do not include literal line breaks inside strings (use spaces or \\\\n).\r\n`;\r\n\r\n  try {\r\n    const response = await routerModel.invoke([\r\n      { role: \"system\", content: \"You are a strategic planning advisor. Output only JSON.\" },\r\n      { role: \"user\", content: prompt }\r\n    ]);\r\n\r\n    const responseText = typeof response.content === 'string' ? response.content : JSON.stringify(response.content);\r\n    const parsed = tryParseJson(responseText);\r\n    if (!parsed) {\r\n      throw new Error('LLM returned non-JSON or invalid JSON.');\r\n    }\r\n\r\n    const safeString = (v: any) => (typeof v === 'string' ? v.trim() : '');\r\n    type PrescriptiveItem = {\r\n      title: string;\r\n      issue: string;\r\n      action: string;\r\n      nextStep?: string;\r\n    };\r\n\r\n    const rawItems: PrescriptiveItem[] = Array.isArray(parsed.prescriptiveItems)\r\n      ? parsed.prescriptiveItems\r\n          .filter((x: any) => x && typeof x === 'object')\r\n          .slice(0, 5)\r\n          .map((x: any) => ({\r\n            title: safeString(x.title) || 'Recommendation',\r\n            issue: safeString(x.issue) || 'Issue not specified.',\r\n            action: safeString(x.action) || 'Action not specified.',\r\n            nextStep: safeString(x.nextStep) || undefined,\r\n          }))\r\n      : [];\r\n\r\n    const shouldAllowSustain = maxAchievement > 80;\r\n    const prescriptiveItems = shouldAllowSustain\r\n      ? rawItems\r\n      : rawItems.filter((x: PrescriptiveItem) => !/\\bsustain\\b|high\\s*perform(er|ers)|preserv(e|ing)\\s+strong/i.test(`${x.title} ${x.issue} ${x.action}`));\r\n\r\n    return {\r\n      documentInsight: safeString(parsed.documentInsight) || 'Insight pending.',\r\n      prescriptiveItems,\r\n      alignment: parsed.alignment || 'Analysis pending.',\r\n      opportunities: parsed.opportunities || 'No opportunities identified.',\r\n      gaps: parsed.gaps || 'No gaps identified.',\r\n      recommendations: parsed.recommendations || 'No recommendations.',\r\n      overallAchievement: Math.round(overallAchievement * 100) / 100\r\n    };\r\n  } catch (error) {\r\n    console.error('[PRESCRIPTIVE] Analysis generation failed:', error);\r\n\r\n    // Deterministic fallback: never return empty insights just because JSON parsing failed.\r\n    const bottleneck = kpiSummaries\r\n      .slice()\r\n      .sort((a, b) => Number(a.achievementPercent || 0) - Number(b.achievementPercent || 0))[0];\r\n\r\n    const strongest = kpiSummaries\r\n      .filter((k) => Number(k.achievementPercent || 0) > 80)\r\n      .slice()\r\n      .sort((a, b) => Number(b.achievementPercent || 0) - Number(a.achievementPercent || 0))[0];\r\n\r\n    const bottleneckReported = bottleneck\r\n      ? (typeof bottleneck.totalReported === 'number'\r\n          ? bottleneck.totalReported.toFixed(bottleneck.targetType === 'percentage' ? 1 : 0)\r\n          : String(bottleneck.totalReported ?? 'N/A'))\r\n      : 'N/A';\r\n    const bottleneckTarget = bottleneck\r\n      ? (typeof bottleneck.totalTarget === 'number'\r\n          ? bottleneck.totalTarget.toFixed(bottleneck.targetType === 'percentage' ? 1 : 0)\r\n          : String(bottleneck.totalTarget ?? 'N/A'))\r\n      : 'N/A';\r\n\r\n    const documentInsightParts: string[] = [];\r\n    documentInsightParts.push(\r\n      `Overall achievement is ${overallAchievement.toFixed(1)}% across ${kpiSummaries.length} KPI(s) for ${kraId}.`\r\n    );\r\n    if (bottleneck?.initiativeId) {\r\n      documentInsightParts.push(\r\n        `The primary bottleneck is ${bottleneck.initiativeId} at ${Number(bottleneck.achievementPercent || 0).toFixed(1)}% (reported ${bottleneckReported} vs target ${bottleneckTarget}).`\r\n      );\r\n    }\r\n    if (strongest?.initiativeId) {\r\n      documentInsightParts.push(\r\n        `A relative strength is ${strongest.initiativeId} at ${Number(strongest.achievementPercent || 0).toFixed(1)}%.`\r\n      );\r\n    }\r\n\r\n    const fallbackItems: Array<{ title: string; issue: string; action: string; nextStep?: string }> = [];\r\n    fallbackItems.push({\r\n      title: 'Address the primary performance gap',\r\n      issue: bottleneck?.initiativeId\r\n        ? `${bottleneck.initiativeId} is at ${Number(bottleneck.achievementPercent || 0).toFixed(1)}% (reported ${bottleneckReported} vs target ${bottleneckTarget}), limiting overall achievement.`\r\n        : 'At least one KPI remains below target, limiting overall achievement.',\r\n      action: 'Assign an owner to the lowest-performing KPI, confirm the data pipeline and evidence rules, and implement a corrective plan within the next reporting cycle (2–4 weeks).',\r\n      nextStep: bottleneck?.initiativeId\r\n        ? `Validate the latest reported/target values for ${bottleneck.initiativeId} within 7 days.`\r\n        : 'Validate the latest reported/target values within 7 days.',\r\n    });\r\n\r\n    if (strongest?.initiativeId) {\r\n      fallbackItems.push({\r\n        title: 'Sustain and operationalize high performers',\r\n        issue: `${strongest.initiativeId} is performing relatively well (${Number(strongest.achievementPercent || 0).toFixed(1)}%) and should be protected from regression while gaps are addressed.`,\r\n        action: 'Document the operating steps and evidence artifacts, then standardize reporting and accountability within the next quarter.',\r\n        nextStep: `Assign an evidence custodian for ${strongest.initiativeId} within 2 weeks.`,\r\n      });\r\n    }\r\n\r\n    fallbackItems.push({\r\n      title: 'Data quality review',\r\n      issue: 'Minor definition or measurement mismatches (rate vs count, evidence criteria, year alignment) can materially distort KPI achievement calculations.',\r\n      action: 'Confirm KPI measurement definitions and evidence rules, then update reporting instructions before the next submission window.',\r\n    });\r\n\r\n    return {\r\n      documentInsight: documentInsightParts.join(' '),\r\n      prescriptiveItems: fallbackItems.slice(0, 3),\r\n      alignment: `Analysis completed for ${kraTitle} (${kraId}) based on extracted KPI performance and the strategic plan snapshot.`,\r\n      opportunities: strongest?.initiativeId\r\n        ? `High-performing KPI observed: ${strongest.initiativeId} (${Number(strongest.achievementPercent || 0).toFixed(1)}%).`\r\n        : 'No KPI exceeded the high-performer threshold (>80%).',\r\n      gaps: bottleneck?.initiativeId\r\n        ? `Largest gap is ${bottleneck.initiativeId}: ${Number(bottleneck.achievementPercent || 0).toFixed(1)}% achieved (reported ${bottleneckReported} vs target ${bottleneckTarget}).`\r\n        : `${missedCount} KPI(s) are below target.`,\r\n      recommendations: 'Use the structured prescriptive items as the immediate action plan for the next reporting cycle.',\r\n      overallAchievement: Math.round(overallAchievement * 100) / 100,\r\n    };\r\n  }\r\n}\r\n\r\n// Helper to sanitize AI status values: convert spaces to underscores, normalize to uppercase\r\nconst sanitizeStatus = (val: unknown): string => {\r\n  if (typeof val !== 'string') return String(val);\r\n  return val.trim().toUpperCase().replace(/\\s+/g, '_');\r\n};\r\n\r\n// Phase 2: Enhanced Noise Filtering with Regex (Universal)\r\nconst NOISE_REGEX = /^(REMARKS|TOTAL|GRAND TOTAL|NOTE|NOTES|PREPARED BY|APPROVED BY|TARGET|ACCOMPLISHMENT|VARIANCE|QUARTER|YEAR|N\\/A|NA|NONE|TBD|GRADUATED|OUTCOME|SE|NO\\.|NUMBER|COLUMN|ROW|HEADER)$/i;\r\n\r\n/**\r\n * Filter noise entries from extracted activities\r\n * Removes headers, generic terms, and invalid entries\r\n */\r\nfunction filterNoiseActivities(activities: any[]): any[] {\r\n  const beforeCount = activities.length;\r\n  \r\n  const filtered = activities.filter((act: any) => {\r\n    if (!act.name || typeof act.name !== 'string') return false;\r\n    const name = act.name.trim();\r\n    const nameUpper = name.toUpperCase();\r\n    \r\n    // 1. Regex blocklist check for exact matches\r\n    if (NOISE_REGEX.test(nameUpper)) {\r\n      console.log(`[NOISE FILTER] Removed: \"${name}\" (regex blocklist)`);\r\n      return false;\r\n    }\r\n    \r\n    // 2. Header Heuristic: If value is 1 and name is short/generic, likely a table header\r\n    if (Number(act.reported) === 1 && name.split(' ').length <= 2 && name.length < 15) {\r\n      // Check if it looks like a column header\r\n      const headerPatterns = /^(total|count|number|amount|rate|percentage|status|date|year|quarter)/i;\r\n      if (headerPatterns.test(name)) {\r\n        console.log(`[NOISE FILTER] Removed: \"${name}\" (header pattern with value=1)`);\r\n        return false;\r\n      }\r\n    }\r\n    \r\n    // 3. Drop entries that are just numbers, single letters, or special characters\r\n    if (/^[\\d\\s.,%₱$]+$/.test(name) || /^[A-Z]$/i.test(name)) {\r\n      console.log(`[NOISE FILTER] Removed: \"${name}\" (numeric/single letter)`);\r\n      return false;\r\n    }\r\n    \r\n    // 4. Drop entries with parenthetical column references like \"(1)\", \"(2)\", \"[(4/2)]*100\"\r\n    if (/^\\(?\\d+\\)?$/.test(name) || /\\[\\(.*\\)\\]\\*\\d+/.test(name)) {\r\n      console.log(`[NOISE FILTER] Removed: \"${name}\" (column reference pattern)`);\r\n      return false;\r\n    }\r\n    \r\n    // 5. Drop very short names (less than 3 chars) unless they have actual values > 1\r\n    if (name.length < 3 && Number(act.reported) <= 1) {\r\n      console.log(`[NOISE FILTER] Removed: \"${name}\" (too short)`);\r\n      return false;\r\n    }\r\n    \r\n    return true;\r\n  });\r\n  \r\n  console.log(`[NOISE FILTER] Filtered: ${beforeCount} -> ${filtered.length} activities (removed ${beforeCount - filtered.length})`);\r\n  return filtered;\r\n}\r\n\r\n/**\r\n * Consolidate KRAs using \"Dominant KRA\" logic\r\n * Ensures all activities from the same document use consistent KRA assignment\r\n * Prevents mismatch where alumni employment appears under international MOUs\r\n */\r\nfunction consolidateKRAs(activities: any[]): any[] {\r\n  if (activities.length === 0) return activities;\r\n  \r\n  // 1. Count frequency of detected KRAs\r\n  const counts: Record<string, number> = {};\r\n  activities.forEach(a => {\r\n    if (a.kraId) {\r\n      counts[a.kraId] = (counts[a.kraId] || 0) + 1;\r\n    }\r\n  });\r\n  \r\n  // 2. Find the dominant KRA (the one with most activities)\r\n  const dominantKRA = Object.keys(counts).reduce((a, b) => \r\n    counts[a] > counts[b] ? a : b, Object.keys(counts)[0] || ''\r\n  );\r\n  \r\n  if (!dominantKRA) return activities;\r\n  \r\n  // 3. Check for outliers - if a KRA has < 20% of the dominant, it might be misclassified\r\n  const dominantCount = counts[dominantKRA] || 0;\r\n  const threshold = Math.max(1, dominantCount * 0.2);\r\n  \r\n  console.log(`[KRA CONSOLIDATE] Dominant KRA: ${dominantKRA} (${dominantCount} activities)`);\r\n  \r\n  return activities.map(act => {\r\n    // If activity has no KRA or has a rare KRA, consider reassignment\r\n    if (!act.kraId) {\r\n      console.log(`[KRA CONSOLIDATE] Assigned missing KRA to dominant: ${dominantKRA} for \"${act.name}\"`);\r\n      return { ...act, kraId: dominantKRA };\r\n    }\r\n    \r\n    // If this KRA appears very rarely compared to dominant, flag it but don't force change\r\n    // (User can override in review modal)\r\n    if (counts[act.kraId] < threshold && act.kraId !== dominantKRA) {\r\n      console.log(`[KRA CONSOLIDATE] Potential mismatch: \"${act.name}\" has ${act.kraId} but dominant is ${dominantKRA}`);\r\n      // Add a flag for review\r\n      return { ...act, kraConflict: true, suggestedKraId: dominantKRA };\r\n    }\r\n    \r\n    return act;\r\n  });\r\n}\r\n\r\n// Zod schemas for structured output validation\r\nexport const ActivitySchema = z.object({\r\n  name: z.string().describe('Activity description from QPRO document'),\r\n  kraId: z.string().describe('Matched KRA ID (e.g., \"KRA 1\")'),\r\n  initiativeId: z.string().optional().describe('Matched initiative ID (e.g., \"KRA1-KPI1\")'),\r\n  reported: z.number().describe('Reported/accomplished value'),\r\n  target: z.number().describe('Target value from Strategic Plan timeline_data for the reporting year'),\r\n  achievement: z.number().min(0).max(100).describe('Achievement percentage'),\r\n  status: z.preprocess(sanitizeStatus, z.enum([\"MET\", \"MISSED\"])).describe('Status of target achievement - MET if achievement >= 100%, MISSED otherwise'),\r\n  authorizedStrategy: z.string().describe('Exact strategy text copied from Strategic Plan context'),\r\n  aiInsight: z.string().describe('AI-generated insight for this activity'),\r\n  prescriptiveAnalysis: z.string().describe('Prescriptive analysis based on CALCULATED status (not raw numbers). Always reference the status field. For MET: focus on sustainability. For MISSED: focus on immediate corrective actions.'),\r\n  confidence: z.number().min(0).max(1).describe('Confidence score for KRA matching (0-1)'),\r\n  unit: z.string().optional().describe('Unit mentioned in context'),\r\n  evidenceSnippet: z.string().optional().describe('Exact text snippet from QPRO document that supports this value'),\r\n  dataType: z.preprocess(\r\n    (val) => typeof val === 'string' ? val.trim().toLowerCase().replace(/\\s+/g, '_') : val,\r\n    z.enum(['percentage', 'currency', 'low_count', 'high_count', 'milestone'])\r\n  ).optional().describe('Data type for visualization: percentage (%), currency (PHP), low_count (<=10), high_count (>10), milestone (text/yes-no)'),\r\n  rootCause: z.string().optional().describe('Inferred root cause if target is missed (e.g., budget delay, lack of participants)'),\r\n  suggestedStatus: z.preprocess(sanitizeStatus, z.enum(['MET', 'ON_TRACK', 'DELAYED', 'AT_RISK'])).optional().describe('Suggested status for review'),\r\n});\r\n\r\nexport const KRASummarySchema = z.object({\r\n  kraId: z.string(),\r\n  kraTitle: z.string(),\r\n  achievementRate: z.number().min(0).max(100),\r\n  activities: z.union([\r\n    z.array(ActivitySchema),\r\n    z.array(z.string()),\r\n    z.array(z.any())\r\n  ]).transform((val: any) => {\r\n    // If activities are strings, convert to activity name references\r\n    if (Array.isArray(val) && val.length > 0 && typeof val[0] === 'string') {\r\n      return val.map((name: string) => ({\r\n        name: name,\r\n        kraId: '',\r\n        reported: 0,\r\n        target: 0,\r\n        achievement: 0,\r\n        status: 'MISSED',\r\n        authorizedStrategy: '',\r\n        aiInsight: '',\r\n        prescriptiveAnalysis: '',\r\n        confidence: 0\r\n      }));\r\n    }\r\n    return val;\r\n  }),\r\n  strategicAlignment: z.string().describe('How this KRA aligns with strategic plan'),\r\n  prescriptiveAnalysis: z.string().optional().describe('Overall prescriptive analysis for this KRA if behind target'),\r\n  rootCause: z.string().optional().describe('Inferred root cause for gaps in this KRA'),\r\n  actionItems: z.array(z.string()).optional().describe('Specific action items to address gaps'),\r\n});\r\n\r\nexport const PrescriptiveItemSchema = z.object({\r\n  title: z.string().min(1).describe('Short title for the prescriptive item'),\r\n  issue: z.string().min(1).describe('The concrete issue or constraint identified'),\r\n  action: z.string().min(1).describe('Concrete action to address the issue (with timeframe when possible)'),\r\n  nextStep: z.string().optional().describe('Optional immediate next step to execute the action'),\r\n});\r\n\r\nexport const QPROAnalysisOutputSchema = z.object({\r\n  activities: z.array(ActivitySchema).describe('All extracted activities with KRA matches'),\r\n  kras: z.array(KRASummarySchema).describe('Summary grouped by KRA'),\r\n  documentInsight: z.string().default('').describe('Document-level insight paragraph grounded on KPI performance and the strategic plan'),\r\n  prescriptiveItems: z.array(PrescriptiveItemSchema).default([]).describe('Document-level prescriptive analysis items (Issue/Action/Next Step)'),\r\n  alignment: z.string().describe('Overall strategic alignment analysis'),\r\n  opportunities: z.union([z.string(), z.array(z.string())]).transform((val: any) => {\r\n    // Convert array to bullet-point string\r\n    return Array.isArray(val) ? '• ' + val.join('\\n• ') : val;\r\n  }).describe('Strategic opportunities identified'),\r\n  gaps: z.string().describe('Gaps or conflicts identified'),\r\n  recommendations: z.union([z.string(), z.array(z.string())]).transform((val: any) => {\r\n    // Convert array to bullet-point string\r\n    return Array.isArray(val) ? '• ' + val.join('\\n• ') : val;\r\n  }).describe('Actionable recommendations'),\r\n  overallAchievement: z.number().min(0).max(100).describe('Overall achievement score'),\r\n});\r\n\r\nexport type QPROAnalysisOutput = z.infer<typeof QPROAnalysisOutputSchema>;\r\n\r\nclass AnalysisEngineService {\r\n  private llm: BaseLanguageModel;\r\n  private promptTemplate: PromptTemplate;\r\n\r\n  constructor() {\r\n    const modelName = \"gpt-4o-mini\";\r\n    // Enforce a safe output cap for gpt-4o-mini to avoid overly long outputs\r\n    const GPT4O_MINI_MAX_OUTPUT = 4096;\r\n    const modelKwargs: any = {\r\n      response_format: { type: \"json_object\" },\r\n      seed: 42,\r\n    };\r\n\r\n    this.llm = new ChatOpenAI({\r\n      modelName,\r\n      temperature: 0,\r\n      maxTokens: GPT4O_MINI_MAX_OUTPUT, // LangChain uses camelCase maxTokens\r\n      modelKwargs,\r\n    });\r\n    \r\n    this.promptTemplate = PromptTemplate.fromTemplate(`\r\nYou are an expert strategic planning analyst for Laguna State Polytechnic University. Analyze a Quarterly Physical Report of Operations (QPRO) document against the university's strategic plan.\r\n\r\n## Strategic Plan Context (Top 10 Most Relevant KRAs/Initiatives):\r\n{strategic_context}\r\n\r\n## QPRO Document Text:\r\n{user_input}\r\n\r\n## Document Section Analysis:\r\n{section_analysis}\r\n\r\n## Document Format Recognition:\r\n- If the document is a **table/spreadsheet format** (e.g., \"Training/Seminar Report\", \"Faculty/Staff Training\"), extract EVERY single row as a separate activity\r\n- If the document is a **narrative format**, extract all mentioned activities with quantifiable metrics\r\n- Each row in a training table = one individual activity entry\r\n- **CRITICAL**: For summary metrics (e.g., \"Total No. of Attendees: 9\"), prioritize using summary totals for achievement calculations instead of counting extracted rows\r\n\r\n## Your Task:\r\nExtract ALL activities from the QPRO document. For training tables, create one activity entry per row (do not skip any rows).\r\n\r\n**CRITICAL - EXTRACT EVERY ACTIVITY**: This is a table-format document with many rows. You MUST extract every single training/seminar/activity mentioned. If you see a table, count the rows and extract exactly that many activities. Do NOT summarize, consolidate, or skip any rows. Each row = one activity entry.\r\n\r\n**IMPORTANT - Summary Metrics Priority**: If the document contains summary sections with aggregate metrics (e.g., \"Total No. of X: Y\"), use these summary values as the primary reported value instead of counting individual rows. This ensures achievement calculations are based on official summaries.\r\n\r\nFor each activity:\r\n1. **Identify the activity name** (exact title from the document, e.g., \"Introduction to AI, ML and DP\")\r\n2. **Extract reported/accomplished value**:\r\n   - For training tables: reported = 1 (one instance of this training attended)\r\n   - For narrative reports: extract the actual number from the text\r\n   - **IMPORTANT**: If the same training appears multiple times in the table (multiple faculty attended), create SEPARATE activity entries for each row - do NOT consolidate\r\n3. **Look up target value** from the Strategic Plan Context above. Find the matched initiative's \"Targets\" object and use the target_value from timeline_data for year 2025. DO NOT extract targets from the QPRO document text. The target MUST come from the Strategic Plan's timeline_data.\r\n\r\n## CRITICAL: KRA MATCHING STRATEGY - PRIORITIZE KPI & STRATEGIES\r\n**Match activities to KRAs using this PRIORITY ORDER:**\r\n\r\n## STRICT KRA ALIGNMENT DEFINITIONS (MUST FOLLOW):\r\nBefore matching, understand what each KRA category covers:\r\n\r\n**KRA 3 (Quality of Instruction):** \r\n- Graduate employment rates, licensure exam results, curriculum effectiveness\r\n- Alumni tracer studies, employment statistics\r\n- *INCLUDES*: \"Alumni Employment\", \"Graduate Tracer\", \"Licensure Passing Rate\"\r\n\r\n**KRA 4 (International Activities):**\r\n- MUST involve foreign partners, international exchange, or cross-border MOUs\r\n- International students, faculty exchange programs, global partnerships\r\n- *EXCLUDES*: Local degree programs, domestic employment rates\r\n- *If document says \"Alumni Employment\" or \"Graduate Employment\", it is NOT KRA 4*\r\n\r\n**KRA 5 (Research):**\r\n- Research publications, citations, patents, research awards\r\n- *INCLUDES*: Papers published, citation counts, research grants\r\n\r\n**KRA 11 (Human Resource Management):**\r\n- Faculty training, staff development, HR policies\r\n- *INCLUDES*: Training reports, seminar attendance, faculty development\r\n\r\n**KRA 13 (Competitive HR):**\r\n- Health and wellness programs, employee satisfaction\r\n- *INCLUDES*: Wellness activities, fitness programs\r\n\r\n**DOCUMENT TITLE CHECK (CRITICAL):**\r\n- If document title contains \"Alumni\" or \"Employment\" or \"Graduate Tracer\" -> Use KRA 3\r\n- If document title contains \"International\" or \"MOU\" or \"Exchange\" -> Use KRA 4\r\n- If document title contains \"Research\" or \"Publication\" -> Use KRA 5\r\n- If document title contains \"Training\" or \"Seminar\" or \"Workshop\" -> Use KRA 11\r\n\r\n**STEP 1: STRATEGY MATCHING (Highest Priority)**\r\n- First, check if the QPRO activity directly implements one of the **Strategies** listed in the KRA\r\n- Example: If KRA 13 has strategy \"conduct health and wellness program twice a week\" and QPRO reports \"health and wellness program\", this is a STRONG match\r\n- Use exact or near-exact keyword matching for strategy alignment\r\n\r\n**STEP 2: KPI VALIDATION (Second Priority)**\r\n- Verify if the activity contributes to the **Key Performance Indicator (KPI)** outputs/outcomes\r\n- Example: If KRA 13 KPI output is \"100% faculty and staff attended health and wellness program\" and QPRO reports staff attending health program, this validates the KRA match\r\n- Check if reported outcomes align with expected KPI outcomes (e.g., improvements in fitness levels, wellness metrics)\r\n\r\n**STEP 3: TYPE-BASED CATEGORIZATION (Tertiary Priority)**\r\n- If neither strategy nor KPI directly match, use activity TYPE to narrow down:\r\n  - **Training/Seminars/Workshops/Conferences** → Only KRA 11 or KRA 13 (HR Development)\r\n  - **Curriculum Development/Course Updates** → Only KRA 1\r\n  - **Research/Publications** → Only KRA 3, 4, 5 (Research KRAs)\r\n  - **Digital Systems/Infrastructure** → Only KRA 17\r\n  - **Health/Wellness Programs** → Only KRA 13\r\n  - **Community/Extension Programs** → Only KRA 6, 7, 8 (Community Engagement)\r\n  - **Alumni/Graduate Employment** → ONLY KRA 3 (NEVER KRA 4)\r\n\r\n**STEP 4: SEMANTIC SIMILARITY (Lowest Priority)**\r\n- Only use general semantic similarity if strategies and KPI don't provide clear alignment\r\n- Ensure the selected KRA is compatible with the activity type from Step 3\r\n\r\n4. **Calculate achievement percentage** = (reported / target) * 100\r\n5. **Determine status**: If achievement >= 100%, status = \"MET\"; otherwise, status = \"MISSED\".\r\n6. **Copy authorized strategy**: Select and copy the EXACT text of the most relevant strategy from the \"Strategies\" field in the Strategic Plan Context above for the specific KRA being matched. Do not paraphrase or create new strategies.\r\n7. **AI Insight**: Write a concise, data-driven insight for this activity (1-2 sentences). BE SPECIFIC with actual numbers.\r\n   - **BAD**: \"Good research output.\"\r\n   - **GOOD**: \"Strong research performance with 5 new papers published (target: 3) achieving 167% of goal.\"\r\n   - Always include the actual reported value and target in the insight text.\r\n8. **Prescriptive Analysis**: Based on the CALCULATED STATUS and authorized strategy, write ACTION-ORIENTED prescriptive analysis (do NOT just state the gap - provide concrete steps). CRITICAL: Use the status value, NOT raw number comparison:\r\n   - If status is \"MET\": \"To sustain this achievement, continue implementing [exact authorized strategy]. Consider [specific sustainability action like expanding scope, documenting best practices, or mentoring other units].\"\r\n   - If status is \"MISSED\": \"To close this gap, immediately implement [exact authorized strategy]. Specific actions: [concrete steps with timeline like 'Schedule 2 additional sessions before Q4 ends' or 'Partner with 3 industry experts by December 2025'].\"\r\n   - Be SPECIFIC with timelines (e.g., \"by Q4 2025\", \"before semester end\", \"by [month] [year]\") and quantifiable actions (e.g., \"2 additional sessions\", \"3 partner organizations\", \"increase by 50%\")\r\n   - NEVER use the raw comparison (reported vs target) to determine advice tone; ALWAYS use the calculated status field.\r\n9. **Assign confidence score** (0.0-1.0) for the KRA match based on strategy alignment first, then KPI validation, then semantic similarity:\r\n   - 0.95-1.0: Perfect strategy + KPI match\r\n   - 0.85-0.94: Strong strategy match + partial KPI alignment\r\n   - 0.75-0.84: Type match + some semantic alignment\r\n   - Below 0.75: Only semantic similarity available\r\n10. **Extract unit/office** mentioned if available.\r\n\r\n## VALIDATION BEFORE OUTPUT:\r\n1. **Keep ALL activities**: Do NOT delete duplicates even if activity names are similar. Each row entry must be preserved.\r\n2. **Verify target source**: Ensure every target value comes from the Strategic Plan's timeline_data, NOT from counting QPRO entries.\r\n3. **Verify KRA matching**: For each activity, verify it was matched to an appropriate KRA using the priority order above.\r\n4. **Count check**: Your activities array should have at least 70+ entries for training table documents.\r\n\r\n## Important Guidelines:\r\n- **COUNT ALL TRAINING SESSIONS**: For training/seminar tables, extract EVERY single row as individual activities with reported=1 each\r\n- **KEEP ALL ACTIVITIES - DO NOT DEDUPLICATE FOR DISPLAY**: Each row in the table is a separate activity entry, even if the training name appears multiple times (different faculty may have attended the same training). Include all of them.\r\n- **CRITICAL - TARGETS FROM STRATEGIC PLAN JSON**: \r\n  - Targets MUST come from the Strategic Plan's timeline_data for year 2025, NOT from QPRO document content\r\n  - For each activity, look up the matched KRA's initiative and extract target_value from timeline_data[2025]\r\n  - If the KRA has multiple initiatives (KPIs), select the one with highest semantic match to the activity\r\n\r\n## FINAL OUTPUT REQUIREMENTS:\r\n- **Minimum activities in array**: At least 70 activities if the document has a training table with 90+ rows\r\n- **Include ALL unique attendance records**: If \"Data Privacy Training\" appears in 5 rows (5 different faculty), create 5 separate activity entries (one per row)\r\n- **No consolidation or grouping**: Each row = one activity, period\r\n  - If target_value is non-numeric (e.g., \"Curriculum Updated\"), convert to 1 (treat as 1 milestone unit)\r\n  - DO NOT count how many activities you extracted as the target\r\n  - DO NOT use the number of rows in the QPRO document as the target\r\n  - The target is a FIXED number from the strategic plan JSON, independent of the QPRO document content\r\n  - Example: If Strategic Plan says target_value = 2 for 2025, use 2 even if QPRO has 9 training entries. Achievement = 9/2 = 450%\r\n- **STRATEGY-FIRST MATCHING**: Always check the Strategies field first before considering semantic similarity\r\n- **SINGLE BEST-FIT KRA**: Each activity matches to ONLY ONE KRA based on strategy alignment first, then type matching\r\n- **Return initiativeId**: Include the specific initiative/KPI ID (e.g., \"KRA13-KPI1\") to enable post-processing validation and proper target lookup\r\n- The authorizedStrategy field MUST be an exact copy from the Strategic Plan Context strategies list for the matched KRA\r\n\r\n## DATA TYPE DETECTION:\r\nFor each KPI, identify the data type based on the target value:\r\n- **percentage**: If target contains \"%\" or is a rate/ratio (e.g., \"80% passing rate\")\r\n- **currency**: If target contains \"PHP\", \"Php\", \"₱\" or is a monetary value (e.g., \"Php 375,000\")\r\n- **low_count**: If target is a number <= 10 (e.g., \"2 MOUs\", \"1 tracer study\")\r\n- **high_count**: If target is a number > 10 (e.g., \"47 IP generated\", \"150 research findings\")\r\n- **milestone**: If target is text-based/qualitative (e.g., \"ISO Recertified\", \"Curriculum Updated\")\r\n\r\n## PRESCRIPTIVE ANALYSIS REQUIREMENTS:\r\nFor EVERY activity where status is \"MISSED\" or achievement < 100%, generate:\r\n1. **rootCause**: Infer the likely root cause from the document text (e.g., \"budget delay\", \"lack of participants\", \"scheduling conflicts\", \"resource constraints\")\r\n2. **actionItems**: Suggest 1-3 specific, actionable interventions with timelines\r\n\r\n## EVIDENCE EXTRACTION:\r\nFor each activity, extract the **evidenceSnippet** - the exact text from the document that proves/supports the reported value. This should be a direct quote from the QPRO document.\r\n\r\n## Output Format:\r\nReturn ONLY a valid JSON object (no markdown, no code blocks) with this exact structure:\r\n\r\n{{\r\n  \"activities\": [\r\n    {{\r\n      \"name\": \"Faculty training workshops\",\r\n      \"kraId\": \"KRA 1\",\r\n      \"initiativeId\": \"KRA1-KPI1\",\r\n      \"reported\": 8,\r\n      \"target\": 10,\r\n      \"achievement\": 80.0,\r\n      \"status\": \"MISSED\",\r\n      \"suggestedStatus\": \"DELAYED\",\r\n      \"dataType\": \"low_count\",\r\n      \"evidenceSnippet\": \"Table 2 shows 8 faculty members completed the training program...\",\r\n      \"rootCause\": \"Limited budget allocation for Q3 training activities\",\r\n      \"authorizedStrategy\": \"collaborate with industry experts, tech companies and research institutions to design relevant course content\",\r\n      \"aiInsight\": \"Training completion at 80% indicates good progress but falls short of the annual target.\",\r\n      \"prescriptiveAnalysis\": \"Based on Strategic Plan strategy: collaborate with industry experts, tech companies and research institutions to design relevant course content. To address the gap of 2 workshops, prioritize partnerships with at least 2 additional industry experts before Q4.\",\r\n      \"confidence\": 0.95,\r\n      \"unit\": \"Office of the VP for Academic Affairs\"\r\n    }}\r\n  ],\r\n  \"kras\": [\r\n    {{\r\n      \"kraId\": \"KRA 1\",\r\n      \"kraTitle\": \"Development of New Curricula...\",\r\n      \"achievementRate\": 75.5,\r\n      \"activities\": [...activities for this KRA...],\r\n      \"strategicAlignment\": \"This KRA shows strong alignment with curriculum development initiatives...\",\r\n      \"prescriptiveAnalysis\": \"Overall KRA is behind target. Focus on accelerating curriculum updates and faculty training.\",\r\n      \"rootCause\": \"Delayed curriculum review process\",\r\n      \"actionItems\": [\"Schedule 2 additional curriculum workshops by Q4 2025\", \"Partner with 3 industry experts by December 2025\"]\r\n    }}\r\n  ],\r\n  \"alignment\": \"Overall strategic alignment analysis (2-3 paragraphs)\",\r\n  \"opportunities\": \"Strategic opportunities identified (bullet points or paragraphs)\",\r\n  \"gaps\": \"Gaps or conflicts between QPRO and strategic plan (specific gaps with numbers)\",\r\n  \"recommendations\": \"Actionable recommendations (prioritized list)\",\r\n  \"overallAchievement\": 72.3\r\n}}\r\n\r\n## Calculation Notes:\r\n- **achievementRate per KRA** = average of all activities' achievement % for that KRA\r\n- **overallAchievement** = weighted average of all KRAs' achievementRate\r\n\r\nReturn ONLY the JSON object. No additional text.\r\n    `);\r\n  }\r\n\r\n  /**\r\n   * Extract ALL activities from QPRO document WITHOUT KRA matching\r\n   * This is pass 1 of the two-pass approach for better accuracy with large documents\r\n   * Results are cached in Redis to avoid re-extracting from identical documents\r\n   */\r\n  async extractAllActivities(userText: string): Promise<any[]> {\r\n    try {\r\n      // Generate cache key from document content hash\r\n      const contentHash = createHash('sha256').update(userText).digest('hex');\r\n      const cacheKey = `qpro:extract:${contentHash}`;\r\n\r\n      // Check if we have cached results\r\n      const cachedActivities = await redisService.get<any[]>(cacheKey);\r\n      if (cachedActivities && cachedActivities.length > 0) {\r\n        console.log(`[EXTRACTION] Cache HIT: Retrieved ${cachedActivities.length} activities from Redis`);\r\n        return cachedActivities;\r\n      }\r\n\r\n      console.log('[EXTRACTION] Cache MISS: Extracting activities from LLM...');\r\n\r\n      const extractionPrompt = PromptTemplate.fromTemplate(`\r\nROLE: Strategic Data Analyst for Laguna State Polytechnic University.\r\nTASK: Extract specific performance metrics from the provided QPRO document text/tables.\r\n\r\n## QPRO Document Text:\r\n{user_input}\r\n\r\n## CRITICAL RULES FOR EXTRACTION:\r\n\r\n### 1. SUBJECT-METRIC MAPPING (Row + Column):\r\n   - Do NOT extract Row Labels as standalone activities.\r\n   - COMBINE the Row Label with the Column Header to form the Activity Name.\r\n   - Examples:\r\n     * Academic: Row=\"BS CS\", Col=\"Employment %\" -> Activity=\"BS CS Employment Rate\"\r\n     * Financial: Row=\"ICT Equipment\", Col=\"Obligated\" -> Activity=\"ICT Equipment Obligation\"\r\n     * Research: Row=\"Engineering Dept\", Col=\"Papers Published\" -> Activity=\"Engineering Research Papers\"\r\n     * Training: Row=\"Faculty Name\", Col=\"Training Title\" -> Activity=\"[Training Title] Attendance\"\r\n\r\n### 2. VALUE EXTRACTION:\r\n   - Extract the ACTUAL quantitative number/percentage found in the cell (e.g., 16.36, 50000, 85%).\r\n   - **NEVER** default to \"1\" unless the report is explicitly counting a single occurrence.\r\n   - If the value is a percentage, extract the number (e.g., \"16.36%\" -> reported: 16.36, dataType: \"percentage\").\r\n   - If the value is currency, extract the number (e.g., \"₱50,000\" -> reported: 50000, dataType: \"currency\").\r\n\r\n### 3. NOISE EXCLUSION (STRICT):\r\n   - IGNORE these completely - do NOT create activities for:\r\n     * Generic headers: \"Remarks\", \"Total\", \"Grand Total\", \"Note\", \"Target\", \"Accomplishment\", \"Variance\"\r\n     * Column labels: \"(1)\", \"(2)\", \"[(4/2)]*100\", \"Number of\", \"Total Number of\"\r\n     * Empty or N/A values\r\n     * Summary rows at the bottom of tables\r\n   - If you're unsure whether something is data or a header, check if it has a meaningful numeric value.\r\n\r\n### 4. DOCUMENT TYPE DETECTION:\r\n   - Look at the document title to understand context:\r\n     * \"Alumni Employment\" / \"Graduate Tracer\" -> This is academic/employment data\r\n     * \"Financial Report\" / \"Budget\" -> This is financial data\r\n     * \"Research Output\" / \"Publications\" -> This is research data\r\n     * \"Training Report\" / \"Seminar\" -> This is HR development data\r\n\r\nReturn a JSON object with this structure:\r\n{{\r\n  \"documentType\": \"academic|financial|research|training|other\",\r\n  \"activities\": [\r\n    {{\r\n      \"name\": \"BS CS Employment Rate\",\r\n      \"reported\": 16.36,\r\n      \"unit\": \"Campus Name or Department\",\r\n      \"description\": \"Employment rate for BS CS graduates within 2 years\",\r\n      \"dataType\": \"percentage\"\r\n    }}\r\n  ]\r\n}}\r\n\r\nCRITICAL REMINDERS:\r\n- Combine row + column context to form meaningful activity names\r\n- Use the ACTUAL numerical value from the document\r\n- Skip all header rows and summary rows\r\n- Return ONLY valid JSON, no other text\r\n      `);\r\n\r\n      const chain = extractionPrompt.pipe(this.llm);\r\n      const result = await chain.invoke({ user_input: userText });\r\n\r\n      // Parse the response\r\n      const responseText = typeof result === 'string' ? result : result.content;\r\n      let activities = [];\r\n\r\n      try {\r\n        const parsed = JSON.parse(responseText);\r\n        activities = parsed.activities || [];\r\n        console.log('[EXTRACTION] Extracted', activities.length, 'activities from document');\r\n      } catch (parseError) {\r\n        console.error('[EXTRACTION] Failed to parse LLM response:', parseError);\r\n        // Fallback: try to extract activities from the text response\r\n        const lines = responseText.split('\\n').filter((line: string) => \r\n          line.match(/^\\d+\\.\\s+/) || line.includes('Activity') || line.includes('Training')\r\n        );\r\n        activities = lines.map((line: string) => ({\r\n          name: line.replace(/^\\d+\\.\\s+/, '').trim(),\r\n          reported: 1,\r\n          unit: null,\r\n          description: ''\r\n        }));\r\n      }\r\n\r\n      // Apply enhanced noise filtering using the global filterNoiseActivities function\r\n      activities = filterNoiseActivities(activities);\r\n\r\n      // Apply Dominant KRA consolidation to prevent mismatched KRA assignments\r\n      // e.g., Alumni Employment should all be KRA 3, not split between KRA 3 and KRA 4\r\n      activities = consolidateKRAs(activities);\r\n\r\n      // Cache results for 24 hours (86400 seconds)\r\n      const ttl = 24 * 60 * 60;\r\n      await redisService.set(cacheKey, activities, ttl);\r\n      console.log(`[EXTRACTION] Cached ${activities.length} activities in Redis with TTL=${ttl}s`);\r\n\r\n      return activities;\r\n    } catch (error) {\r\n      console.error('[EXTRACTION] Error extracting activities:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async processQPRO(fileBuffer: Buffer, fileType: string, unitId?: string, reportYearOverride?: number): Promise<QPROAnalysisOutput> {\r\n    try {\r\n      // Validate input\r\n      if (!fileBuffer || fileBuffer.length === 0) {\r\n        throw new Error('File buffer is empty');\r\n      }\r\n\r\n      let userText: string;\r\n\r\n      // Extract text based on file type\r\n      if (fileType.toLowerCase() === 'application/pdf') {\r\n        // Extract text from PDF using pdf2json\r\n        const pdfParser = new PDFParser();\r\n        // Create a promise to handle the event-driven pdf2json\r\n        userText = await new Promise((resolve, reject) => {\r\n          pdfParser.on('pdfParser_dataError', (errData: any) => {\r\n            reject(errData.parserError);\r\n          });\r\n          pdfParser.on('pdfParser_dataReady', (pdfData: any) => {\r\n            let textContent = '';\r\n            if (pdfData && pdfData.formImage && pdfData.formImage.Pages) {\r\n              pdfData.formImage.Pages.forEach((page: any) => {\r\n                if (page.Texts) {\r\n                  page.Texts.forEach((textItem: any) => {\r\n                    textContent += (textItem.R && Array.isArray(textItem.R)) ?\r\n                      textItem.R.map((run: any) => this.decodeText(run.T)).join(' ') + ' ' :\r\n                      this.decodeText(textItem.T) + ' ';\r\n                  });\r\n                  textContent += '\\n';\r\n                }\r\n              });\r\n            }\r\n            resolve(textContent);\r\n          });\r\n          pdfParser.parseBuffer(fileBuffer);\r\n        });\r\n      } else if (fileType.toLowerCase() === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document') {\r\n        // Enhanced DOCX extraction - extract both raw text AND convert to HTML for table content\r\n        const rawTextResult = await mammoth.extractRawText({ buffer: fileBuffer });\r\n        const userTextRaw = rawTextResult.value || '';\r\n        \r\n        // Also extract HTML to better preserve table structure\r\n        const htmlResult = await mammoth.convertToHtml({ buffer: fileBuffer });\r\n        const htmlContent = htmlResult.value || '';\r\n        \r\n        console.log('[QPRO DIAGNOSTIC] HTML content length:', htmlContent.length);\r\n        \r\n        // More robust table extraction - handle nested HTML and complex structures\r\n        let tableText = '';\r\n        \r\n        // Method 1: Extract table rows with improved regex\r\n        const tableRowsRegex = /<tr[^>]*>([\\s\\S]*?)<\\/tr>/gi;\r\n        let rowMatch;\r\n        let rowCount = 0;\r\n        \r\n        while ((rowMatch = tableRowsRegex.exec(htmlContent)) !== null) {\r\n          const rowContent = rowMatch[1];\r\n          \r\n          // Extract cell content from <td> and <th> tags\r\n          const cellRegex = /<t[dh][^>]*>([\\s\\S]*?)<\\/t[dh]>/gi;\r\n          const cells = [];\r\n          let cellMatch;\r\n          \r\n          while ((cellMatch = cellRegex.exec(rowContent)) !== null) {\r\n            // Remove all HTML tags and decode entities\r\n            let cellText = cellMatch[1]\r\n              .replace(/<[^>]*>/g, ' ')  // Remove all HTML tags\r\n              .replace(/&nbsp;/g, ' ')   // Replace non-breaking spaces\r\n              .replace(/&amp;/g, '&')\r\n              .replace(/&lt;/g, '<')\r\n              .replace(/&gt;/g, '>')\r\n              .replace(/&quot;/g, '\"')\r\n              .trim();\r\n            \r\n            // Clean up multiple spaces\r\n            cellText = cellText.replace(/\\s+/g, ' ');\r\n            \r\n            if (cellText.length > 0) {\r\n              cells.push(cellText);\r\n            }\r\n          }\r\n          \r\n          if (cells.length > 0) {\r\n            tableText += cells.join(' | ') + '\\n';\r\n            rowCount++;\r\n          }\r\n        }\r\n        \r\n        console.log('[QPRO DIAGNOSTIC] Extracted', rowCount, 'table rows from HTML');\r\n        \r\n        // Pre-process table text to make it LLM-friendly\r\n        // Convert pipe-separated rows into numbered list format\r\n        const tableLines = tableText.split('\\n').filter(line => line.trim().length > 0);\r\n        let processedTableText = 'EXTRACTED TABLE ACTIVITIES (COMPLETE LIST):\\n';\r\n        processedTableText += '='.repeat(50) + '\\n';\r\n        tableLines.forEach((line, idx) => {\r\n          // Skip header rows (lines with pipes that are mostly short text)\r\n          const cells = line.split('|').map(c => c.trim());\r\n          const avgCellLength = cells.reduce((sum, c) => sum + c.length, 0) / cells.length;\r\n          \r\n          // Only include rows that have meaningful content (not headers)\r\n          if (avgCellLength > 3 && cells.some(c => c.length > 5)) {\r\n            // Extract the activity name (usually first or most descriptive cell)\r\n            const activityName = cells.find(c => c.length > 10) || cells[0];\r\n            if (activityName && activityName.length > 3) {\r\n              processedTableText += `${idx + 1}. ${activityName}\\n`;\r\n            }\r\n          }\r\n        });\r\n        processedTableText += '='.repeat(50) + '\\n';\r\n        \r\n        // Combine raw text with processed table content\r\n        userText = userTextRaw + '\\n\\n' + processedTableText + '\\n\\n' + tableText;\r\n      } else {\r\n        throw new Error(`Unsupported file type: ${fileType}`);\r\n      }\r\n\r\n      // Diagnostic logging: output raw extracted text metadata\r\n      console.log('[QPRO DIAGNOSTIC] ========== RAW TEXT EXTRACTION ==========');\r\n      console.log('[QPRO DIAGNOSTIC] File type:', fileType);\r\n      console.log('[QPRO DIAGNOSTIC] Raw text length (chars):', userText?.length || 0);\r\n      console.log('[QPRO DIAGNOSTIC] Raw text preview (first 500 chars):', userText?.substring(0, 500));\r\n      console.log('[QPRO DIAGNOSTIC] Raw text preview (last 500 chars):', userText?.substring(userText.length - 500));\r\n      \r\n      // Count extracted activities from the preprocessed list\r\n      const activityListMatches = userText.match(/^\\d+\\.\\s+.+$/gm);\r\n      console.log('[QPRO DIAGNOSTIC] Total activities in preprocessed list:', activityListMatches ? activityListMatches.length : 0);\r\n      \r\n      // Also count lines with content (each line might be an activity in a table)\r\n      const nonEmptyLines = userText.split('\\n').filter(line => line.trim().length > 5).length;\r\n      console.log('[QPRO DIAGNOSTIC] Non-empty content lines:', nonEmptyLines);\r\n      \r\n      console.log('[QPRO DIAGNOSTIC] ==========================================');\r\n\r\n      // Validate extracted text\r\n      if (!userText || userText.trim().length === 0) {\r\n        throw new Error('No text could be extracted from the document');\r\n      }\r\n\r\n      // ========== NEW ROUTER-EXTRACTOR ARCHITECTURE ==========\r\n      // This replaces the fuzzy vector search with deterministic JSON-guided logic\r\n      \r\n      // ========== PHASE 1: SECTION DETECTION (Preprocessing) ==========\r\n      console.log('[QPRO DIAGNOSTIC] ========== SECTION DETECTION ==========');\r\n      const sectionDetectionResult = await documentSectionDetector.detectSections(userText);\r\n      console.log(documentSectionDetector.generateSectionSummary(sectionDetectionResult));\r\n      console.log('[QPRO DIAGNOSTIC] ==========================================');\r\n\r\n      // ========== PHASE 2: SUMMARY EXTRACTION (Preprocessing) ==========\r\n      console.log('[QPRO DIAGNOSTIC] ========== SUMMARY EXTRACTION ==========');\r\n      const summaryExtractionResult = await summaryExtractor.extractSummaries(userText);\r\n      console.log(summaryExtractor.generateExtractionSummary(summaryExtractionResult));\r\n      console.log('[QPRO DIAGNOSTIC] ==========================================');\r\n\r\n      // Extract document title from section detection or use generic title\r\n      const documentTitle = sectionDetectionResult.sections[0]?.title || \r\n                           sectionDetectionResult.documentType || \r\n                           'QPRO Document';\r\n      \r\n      // Determine report year (prefer caller-provided year)\r\n      const reportYear = Number.isFinite(reportYearOverride as any)\r\n        ? Math.trunc(Number(reportYearOverride))\r\n        : new Date().getFullYear();\r\n      console.log(`[QPRO DIAGNOSTIC] Document Title: \"${documentTitle}\"`);\r\n      console.log(`[QPRO DIAGNOSTIC] Report Year: ${reportYear}`);\r\n\r\n      // ========== PHASE 3: ROUTER - Classify to Single Dominant KRA ==========\r\n      console.log('[QPRO DIAGNOSTIC] ========== ROUTER: KRA CLASSIFICATION ==========');\r\n      const routerResult = await classifyDominantKRA(documentTitle, userText);\r\n      \r\n      if (!routerResult) {\r\n        console.error('[ROUTER] Could not classify document to a specific KRA');\r\n        throw new Error('Document could not be classified into a Strategic Plan KRA. Please ensure the document contains relevant content.');\r\n      }\r\n      \r\n      const { kraId: dominantKRA, confidence: routerConfidence } = routerResult;\r\n      // Use normalized KRA ID for consistent lookup\r\n      const normalizedDominantKRA = normalizeKraId(dominantKRA);\r\n      const targetKRA = strategicPlan.kras.find((k: any) => normalizeKraId(k.kra_id) === normalizedDominantKRA);\r\n      \r\n      console.log(`[ROUTER] ✅ Dominant KRA: ${normalizedDominantKRA} - \"${targetKRA?.kra_title}\"`);\r\n      console.log(`[ROUTER] Confidence: ${(routerConfidence * 100).toFixed(1)}%`);\r\n      console.log('[QPRO DIAGNOSTIC] ==========================================');\r\n\r\n      // ========== PHASE 4: EXTRACTOR - Extract Activities for This KRA Only ==========\r\n      console.log('[QPRO DIAGNOSTIC] ========== EXTRACTOR: ACTIVITY EXTRACTION ==========');\r\n      const extractedActivities = await extractActivitiesForKRA(userText, normalizedDominantKRA, reportYear);\r\n      console.log(`[EXTRACTOR] Extracted ${extractedActivities.length} activities for ${normalizedDominantKRA}`);\r\n      console.log('[QPRO DIAGNOSTIC] ==========================================');\r\n\r\n      // ========== PHASE 5: NOISE FILTER - Clean Extracted Activities ==========\r\n      console.log('[QPRO DIAGNOSTIC] ========== NOISE FILTER ==========');\r\n      const cleanedActivities = filterNoiseActivities(extractedActivities);\r\n      console.log(`[NOISE FILTER] After filtering: ${cleanedActivities.length} activities`);\r\n      console.log('[QPRO DIAGNOSTIC] ==========================================');\r\n\r\n      // ========== PHASE 6: ENRICH ACTIVITIES - Add Required Fields ==========\r\n      console.log('[QPRO DIAGNOSTIC] ========== ACTIVITY ENRICHMENT ==========');\r\n      const enrichedActivities = cleanedActivities.map((act: any) => {\r\n        let reported: any = act.reported || act.reported_value || 0;\r\n        const initiativeId = act.initiativeId || act.kpi_id || `${normalizedDominantKRA}-KPI1`;\r\n\r\n        // Resolve KPI target meta (single institutional target per KPI)\r\n        const meta = getInitiativeTargetMeta(strategicPlan as any, normalizedDominantKRA, initiativeId, reportYear);\r\n        const initiativeTarget = typeof act.target === 'number'\r\n          ? act.target\r\n          : (act.target_value !== undefined ? Number(act.target_value) : Number(act.target || 0));\r\n        const resolvedInitiativeTarget = meta.targetValue ?? (Number.isFinite(initiativeTarget) && initiativeTarget > 0 ? initiativeTarget : 0);\r\n\r\n        // Activity-level semantics:\r\n        // - For count-based KPIs where each extracted row/title is an item, each item is a contribution (target=1).\r\n        //   KPI-level progress is computed by summing items and comparing to the single institutional target.\r\n        const targetType = String(meta.targetType || act.dataType || act.data_type || 'count').toLowerCase();\r\n\r\n        // Ensure percentage KPIs remain in 0-100 range (and avoid decimal-stripping artifacts)\r\n        if (targetType === 'percentage') {\r\n          reported = normalizePercentageReported(reported);\r\n        }\r\n        // Activity achievement/status should be computed against the KPI's institutional target.\r\n        // Using a per-row target of 1 for count KPIs incorrectly marks partial progress as \"MET\"\r\n        // (e.g., 4 outputs vs 150 target would appear as 100%).\r\n        const activityTarget = resolvedInitiativeTarget || 1;\r\n\r\n        const achievementRaw = activityTarget > 0 ? (Number(reported) / activityTarget) * 100 : 0;\r\n        const achievement = Math.min(100, Math.max(0, achievementRaw));\r\n        const status: 'MET' | 'MISSED' = achievement >= 100 ? 'MET' : 'MISSED';\r\n        \r\n        // Get authorized strategy from the KRA\r\n        const initiative = targetKRA?.initiatives.find((i: any) => i.id === act.initiativeId || i.id === act.kpi_id);\r\n        const authorizedStrategy = initiative?.strategies?.[0] || 'Strategy from Strategic Plan';\r\n        \r\n        // Activity-level AI messages must not treat each document as needing to meet the full target.\r\n        // For count KPIs, show the current contribution vs the institutional target.\r\n        const aiInsight = targetType === 'count'\r\n          ? `Recorded ${reported} toward the KPI target (${resolvedInitiativeTarget || 'N/A'} for ${reportYear}).`\r\n          : (status === 'MET'\r\n            ? `Target achieved: ${reported} vs ${resolvedInitiativeTarget || activityTarget} (${achievement.toFixed(1)}%).`\r\n            : `Below target: ${reported} vs ${resolvedInitiativeTarget || activityTarget} (${achievement.toFixed(1)}%).`);\r\n\r\n        const prescriptiveAnalysis = targetType === 'count'\r\n          ? `Continue implementing: \"${authorizedStrategy}\". Focus on increasing total outputs toward the KPI target across the reporting period.`\r\n          : (status === 'MET'\r\n            ? `Sustain performance by continuing: \"${authorizedStrategy}\".`\r\n            : `Improve results by implementing: \"${authorizedStrategy}\" within the current reporting period.`);\r\n\r\n        // Determine suggested status with proper typing\r\n        const suggestedStatus: 'MET' | 'ON_TRACK' | 'DELAYED' | 'AT_RISK' = \r\n          status === 'MET' ? 'MET' : \r\n          achievement >= 75 ? 'ON_TRACK' : \r\n          achievement >= 50 ? 'DELAYED' : 'AT_RISK';\r\n\r\n        return {\r\n          name: act.name,\r\n          kraId: normalizedDominantKRA,\r\n          initiativeId: act.initiativeId || act.kpi_id || `${normalizedDominantKRA}-KPI1`,\r\n          reported: reported,\r\n          target: activityTarget,\r\n          initiativeTarget: resolvedInitiativeTarget,\r\n          achievement: Math.round(achievement * 100) / 100,\r\n          status: status,\r\n          authorizedStrategy: authorizedStrategy,\r\n          aiInsight: aiInsight,\r\n          prescriptiveAnalysis: prescriptiveAnalysis,\r\n          confidence: routerConfidence,\r\n          unit: act.unit || '',\r\n          evidenceSnippet: act.evidenceSnippet || act.evidence_snippet || '',\r\n          dataType: act.dataType || act.data_type || 'count',\r\n          rootCause: status === 'MISSED' ? 'Performance below target - review resource allocation and timeline' : undefined,\r\n          suggestedStatus: suggestedStatus\r\n        };\r\n      });\r\n      console.log(`[ENRICHMENT] Enriched ${enrichedActivities.length} activities`);\r\n      console.log('[QPRO DIAGNOSTIC] ==========================================');\r\n\r\n      // ========== PHASE 7: PRESCRIPTIVE ANALYSIS - Generate Insights ==========\r\n      console.log('[QPRO DIAGNOSTIC] ========== PRESCRIPTIVE ANALYSIS ==========');\r\n      const prescriptiveResult = await generatePrescriptiveAnalysis(\r\n        enrichedActivities,\r\n        normalizedDominantKRA,\r\n        targetKRA?.kra_title || normalizedDominantKRA,\r\n        reportYear\r\n      );\r\n      console.log(`[PRESCRIPTIVE] Overall Achievement: ${prescriptiveResult.overallAchievement}%`);\r\n      console.log('[QPRO DIAGNOSTIC] ==========================================');\r\n\r\n      // ========== PHASE 8: BUILD FINAL OUTPUT ==========\r\n      const kraSummary = {\r\n        kraId: normalizedDominantKRA,\r\n        kraTitle: targetKRA?.kra_title || normalizedDominantKRA,\r\n        achievementRate: prescriptiveResult.overallAchievement,\r\n        activities: enrichedActivities,\r\n        strategicAlignment: prescriptiveResult.alignment,\r\n        prescriptiveAnalysis: prescriptiveResult.recommendations,\r\n        rootCause: enrichedActivities.some((a: any) => a.status === 'MISSED') \r\n          ? 'Some targets missed - review implementation strategies' \r\n          : undefined,\r\n        actionItems: enrichedActivities\r\n          .filter((a: any) => a.status === 'MISSED')\r\n          .slice(0, 3)\r\n          .map((a: any) => `Address gap in: ${a.name}`)\r\n      };\r\n\r\n      const finalOutput: QPROAnalysisOutput = {\r\n        activities: enrichedActivities,\r\n        kras: [kraSummary],\r\n        documentInsight: prescriptiveResult.documentInsight,\r\n        prescriptiveItems: prescriptiveResult.prescriptiveItems,\r\n        alignment: prescriptiveResult.alignment,\r\n        opportunities: prescriptiveResult.opportunities,\r\n        gaps: prescriptiveResult.gaps,\r\n        recommendations: prescriptiveResult.recommendations,\r\n        overallAchievement: prescriptiveResult.overallAchievement\r\n      };\r\n\r\n      console.log('[QPRO DIAGNOSTIC] ========== FINAL OUTPUT SUMMARY ==========');\r\n      console.log(`[FINAL] Dominant KRA: ${normalizedDominantKRA}`);\r\n      console.log(`[FINAL] Total Activities: ${finalOutput.activities.length}`);\r\n      console.log(`[FINAL] Overall Achievement: ${finalOutput.overallAchievement}%`);\r\n      console.log('[QPRO DIAGNOSTIC] ==========================================');\r\n\r\n      return finalOutput;\r\n    } catch (error) {\r\n      console.error('Error in processQPRO:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Analyze with exponential backoff retry and LLM fallback\r\n   */\r\n  private async analyzeWithRetry(\r\n    strategicContext: string, \r\n    userText: string,\r\n    sectionAnalysis: string = '',\r\n    maxRetries: number = 3\r\n  ): Promise<QPROAnalysisOutput> {\r\n    let lastError: any;\r\n    \r\n    // Validate inputs before attempting LLM call\r\n    if (!strategicContext || strategicContext.trim().length === 0) {\r\n      throw new Error('strategicContext cannot be empty');\r\n    }\r\n    if (!userText || userText.trim().length === 0) {\r\n      throw new Error('userText cannot be empty');\r\n    }\r\n    \r\n    for (let attempt = 1; attempt <= maxRetries; attempt++) {\r\n      try {\r\n        console.log(`[AnalysisEngine] Attempt ${attempt}/${maxRetries} with GPT-4o-mini`);\r\n        console.log(`[AnalysisEngine] strategicContext length: ${strategicContext.length}`);\r\n        console.log(`[AnalysisEngine] userText length: ${userText.length}`);\r\n        \r\n        // Combine user input with strategic context\r\n        const chain = this.promptTemplate.pipe(this.llm);\r\n        const result = await chain.invoke({\r\n          strategic_context: strategicContext,\r\n          user_input: userText,\r\n          section_analysis: sectionAnalysis\r\n        });\r\n\r\n        // Parse and validate JSON response\r\n        const rawContent = result.content as string;\r\n        return this.parseAndValidateLLMResponse(rawContent);\r\n      } catch (error) {\r\n        lastError = error;\r\n        console.error(`[AnalysisEngine] Attempt ${attempt} failed:`, error);\r\n        \r\n        // If this was the last retry, try fallback providers\r\n        if (attempt === maxRetries) {\r\n          console.log('[AnalysisEngine] All GPT-4o-mini attempts failed, trying fallback providers...');\r\n          \r\n          // Try Qwen fallback\r\n          try {\r\n            return await this.analyzeWithQwen(strategicContext, userText, sectionAnalysis);\r\n          } catch (qwenError) {\r\n            console.error('[AnalysisEngine] Qwen fallback failed:', qwenError);\r\n            \r\n            // Try Gemini as last resort\r\n            try {\r\n              return await this.analyzeWithGemini(strategicContext, userText, sectionAnalysis);\r\n            } catch (geminiError) {\r\n              console.error('[AnalysisEngine] Gemini fallback failed:', geminiError);\r\n              throw new Error(`All LLM providers failed. Last error: ${lastError.message}`);\r\n            }\r\n          }\r\n        }\r\n        \r\n        // Exponential backoff: wait 2^attempt seconds\r\n        const waitTime = Math.pow(2, attempt) * 1000;\r\n        console.log(`[AnalysisEngine] Waiting ${waitTime}ms before retry...`);\r\n        await new Promise(resolve => setTimeout(resolve, waitTime));\r\n      }\r\n    }\r\n    \r\n    throw lastError;\r\n  }\r\n\r\n  /**\r\n   * Fallback analysis using Qwen\r\n   */\r\n  private async analyzeWithQwen(strategicContext: string, userText: string, sectionAnalysis: string = ''): Promise<QPROAnalysisOutput> {\r\n    console.log('[AnalysisEngine] Using Qwen fallback provider');\r\n    \r\n    const qwenClient = new ChatOpenAI({\r\n      modelName: \"qwen/qwen-2.5-72b-instruct\",\r\n      temperature: 0.2,\r\n      maxTokens: 3500, // Cap output tokens to avoid credit issues\r\n      configuration: {\r\n        baseURL: process.env.OPENAI_BASE_URL || \"https://openrouter.ai/api/v1\",\r\n        apiKey: process.env.OPENAI_API_KEY,\r\n      },\r\n      modelKwargs: {\r\n        response_format: { type: \"json_object\" }\r\n      },\r\n    });\r\n    \r\n    const chain = this.promptTemplate.pipe(qwenClient);\r\n    const result = await chain.invoke({\r\n      strategic_context: strategicContext,\r\n      user_input: userText,\r\n      section_analysis: sectionAnalysis\r\n    });\r\n    \r\n    return this.parseAndValidateLLMResponse(result.content as string);\r\n  }\r\n\r\n  /**\r\n   * Fallback analysis using Gemini\r\n   */\r\n  private async analyzeWithGemini(strategicContext: string, userText: string, sectionAnalysis: string = ''): Promise<QPROAnalysisOutput> {\r\n    console.log('[AnalysisEngine] Using Gemini fallback provider');\r\n    \r\n    // Note: Gemini doesn't support JSON mode the same way, so we rely on prompt engineering\r\n    const geminiPrompt = `${this.promptTemplate.template}\\n\\nIMPORTANT: Return ONLY valid JSON in the exact format specified above. No markdown, no code blocks, just the JSON object.`;\r\n    \r\n    const geminiClient = new ChatOpenAI({\r\n      modelName: \"gemini-2.0-flash-001\",\r\n      temperature: 0.2,\r\n      maxTokens: 3500, // Cap output tokens for consistency\r\n      configuration: {\r\n        baseURL: \"https://generativelanguage.googleapis.com/v1beta/openai/\",\r\n        apiKey: process.env.GOOGLE_AI_API_KEY,\r\n      },\r\n    });\r\n    \r\n    const geminiTemplate = PromptTemplate.fromTemplate(geminiPrompt);\r\n    const chain = geminiTemplate.pipe(geminiClient);\r\n    const result = await chain.invoke({\r\n      strategic_context: strategicContext,\r\n      user_input: userText,\r\n      section_analysis: sectionAnalysis\r\n    });\r\n    \r\n    return this.parseAndValidateLLMResponse(result.content as string);\r\n  }\r\n\r\n  /**\r\n   * Helper method to decode hex-encoded text from pdf2json\r\n   */\r\n  private decodeText(hexText: string): string {\r\n    if (!hexText) return '';\r\n    try {\r\n      // Remove the forward slash and replace #20 with space if needed\r\n      hexText = hexText.replace(/\\//g, '').replace(/#20/g, ';');\r\n      // Decode hex to string\r\n      const text = hexText.replace(/#([0-9A-Fa-f]{2})/g, (match, hex) => {\r\n        return String.fromCharCode(parseInt(hex, 16));\r\n      });\r\n      return decodeURIComponent(escape(text));\r\n    } catch (error) {\r\n      console.error('Error decoding text:', error);\r\n      return hexText || '';\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generate cache key for vector search results\r\n   */\r\n  private generateCacheKey(text: string, unitId?: string): string {\r\n    const textHash = createHash('md5').update(text.slice(0, 1000)).digest('hex');\r\n    return `qpro:vector-search:${textHash}:${unitId || 'all'}`;\r\n  }\r\n\r\n  /**\r\n   * Implement \"Winner Takes All\" deduplication\r\n   * Removes semantic duplicates from search results, keeping only the highest-scoring entry\r\n   * for each KRA/initiative combination to prevent double-counting activities\r\n   */\r\n  private deduplicateSearchResults(results: any[]): any[] {\r\n    if (results.length === 0) return results;\r\n\r\n    // Group results by KRA ID to identify duplicates\r\n    const kraMap = new Map<string, any>();\r\n    \r\n    results.forEach((result) => {\r\n      const kraId = result.metadata?.kra_id;\r\n      \r\n      if (!kraId) {\r\n        return; // Skip results without KRA ID\r\n      }\r\n      \r\n      // If we haven't seen this KRA yet, or this result has a higher score, keep it\r\n      if (!kraMap.has(kraId) || (result.score || 0) > (kraMap.get(kraId).score || 0)) {\r\n        kraMap.set(kraId, result);\r\n        console.log(`[DEDUP] KRA ${kraId}: score=${result.score?.toFixed(3)}`);\r\n      } else {\r\n        console.log(`[DEDUP] Skipping duplicate KRA ${kraId} (lower score: ${result.score?.toFixed(3)} < ${kraMap.get(kraId).score?.toFixed(3)})`);\r\n      }\r\n    });\r\n    \r\n    // Convert map back to array, sorted by score descending\r\n    const deduped = Array.from(kraMap.values())\r\n      .sort((a, b) => (b.score || 0) - (a.score || 0));\r\n    \r\n    console.log(`[DEDUP] Deduplicated ${results.length} results to ${deduped.length} unique KRAs`);\r\n    return deduped;\r\n  }\r\n\r\n  /**\r\n   * Parse and validate LLM JSON response\r\n   */\r\n  private parseAndValidateLLMResponse(rawContent: string | any): QPROAnalysisOutput {\r\n    try {\r\n      let parsed: any;\r\n      \r\n      // If rawContent is already an object, use it directly\r\n      if (typeof rawContent === 'object' && rawContent !== null) {\r\n        console.log('[AnalysisEngine] Content is already an object, using directly');\r\n        parsed = rawContent;\r\n      } else {\r\n        // If it's a string, parse it\r\n        let cleanedContent = String(rawContent).trim();\r\n        \r\n        // Remove markdown code blocks if present\r\n        if (cleanedContent.startsWith('```')) {\r\n          cleanedContent = cleanedContent.replace(/^```json\\n?/, '').replace(/\\n?```$/, '');\r\n        }\r\n        \r\n        // Parse JSON\r\n        parsed = JSON.parse(cleanedContent);\r\n      }\r\n      \r\n      // Validate with Zod schema\r\n      const validated = QPROAnalysisOutputSchema.parse(parsed);\r\n      \r\n      console.log('[AnalysisEngine] Successfully validated LLM response');\r\n      console.log(`[AnalysisEngine] Extracted ${validated.activities.length} activities across ${validated.kras.length} KRAs`);\r\n      \r\n      return validated;\r\n    } catch (error) {\r\n      if (error instanceof z.ZodError) {\r\n        console.error('[AnalysisEngine] Zod validation failed:', error.errors);\r\n        throw new Error(`LLM output validation failed: ${error.errors.map(e => `${e.path.join('.')}: ${e.message}`).join(', ')}`);\r\n      }\r\n      console.error('[AnalysisEngine] JSON parsing failed:', error);\r\n      console.error('[AnalysisEngine] Raw content type:', typeof rawContent);\r\n      console.error('[AnalysisEngine] Raw content preview:', String(rawContent).substring(0, 200));\r\n      throw new Error(`Failed to parse LLM response as JSON: ${error}`);\r\n    }\r\n  }\r\n}\r\n\r\nexport const analysisEngineService = new AnalysisEngineService();\r\nexport default AnalysisEngineService;"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3111, "column": 0}, "map": {"version":3,"sources":["file:///D:/downloads/Downloads%20from%20web/LSPU%20KMIS/lib/services/qpro-analysis-service.ts"],"sourcesContent":["import { PrismaClient } from '@prisma/client';\r\nimport { analysisEngineService, QPROAnalysisOutput } from './analysis-engine-service';\r\nimport { BlobServiceClient } from '@azure/storage-blob';\r\nimport { targetAggregationService } from './target-aggregation-service';\r\nimport { strategicPlanService } from './strategic-plan-service';\r\nimport { computeAggregatedAchievement, getInitiativeTargetMeta, normalizeKraId } from '@/lib/utils/qpro-aggregation';\r\n\r\nconst prisma = new PrismaClient();\r\n\r\n// ========== PRISMA HELPERS ==========\r\n/**\r\n * Convert undefined to null for Prisma compatibility.\r\n * Prisma/SQL doesn't accept JavaScript `undefined` - must be `null`.\r\n */\r\nconst toPrisma = <T>(val: T | undefined): T | null => val === undefined ? null : val;\r\n\r\n/**\r\n * Ensure a value is an array (for JSON array fields).\r\n */\r\nconst toArray = <T>(val: T[] | undefined | null): T[] => Array.isArray(val) ? val : [];\r\n\r\n/**\r\n * Convert array or object to string for String fields in Prisma.\r\n * Handles arrays of strings, arrays of objects, or plain strings.\r\n */\r\nconst toString = (val: any): string | null => {\r\n  if (!val) return null;\r\n  if (typeof val === 'string') return val;\r\n  if (Array.isArray(val)) {\r\n    if (val.length === 0) return null; // Empty array -> null\r\n    // If array of objects with 'action' field (recommendations), format them\r\n    if (val.length > 0 && typeof val[0] === 'object' && val[0].action) {\r\n      return val.map((item: any) => `• ${item.action}${item.timeline ? ` (${item.timeline})` : ''}`).join('\\n');\r\n    }\r\n    // Otherwise, join array items with bullet points\r\n    return val.map((item: any) => `• ${typeof item === 'string' ? item : JSON.stringify(item)}`).join('\\n');\r\n  }\r\n  // For plain objects, convert to JSON string\r\n  return JSON.stringify(val);\r\n};\r\n\r\n// Initialize Azure Blob Storage client\r\nconst blobServiceClient = BlobServiceClient.fromConnectionString(\r\n process.env.AZURE_STORAGE_CONNECTION_STRING!\r\n);\r\n\r\ninterface QPROAnalysisInput {\r\n  documentId: string;\r\n  documentTitle: string;\r\n  documentPath: string;\r\n  documentType: string;\r\n  uploadedById: string;\r\n  unitId?: string | null;\r\n  year?: number;\r\n  quarter?: number;\r\n}\r\n\r\ninterface QPROAnalysesFilter {\r\n  unitId?: string;\r\n  year?: number;\r\n  quarter?: number;\r\n  userId?: string;\r\n  limit?: number;\r\n}\r\n\r\nexport class QPROAnalysisService {\r\n  /**\r\n   * Calculate type detection score based on keyword presence and importance\r\n   * Gives higher weight to primary keywords and phrases\r\n   */\r\n  private calculateTypeScore(text: string, keywords: string[], primaryKeywords: string[]): number {\r\n    let score = 0;\r\n    const textLower = text.toLowerCase();\r\n    \r\n    // Primary keywords get 2 points each\r\n    for (const pkw of primaryKeywords) {\r\n      if (textLower.includes(pkw.toLowerCase())) {\r\n        score += 2;\r\n      }\r\n    }\r\n    \r\n    // Secondary keywords get 1 point each\r\n    for (const kw of keywords) {\r\n      if (!primaryKeywords.includes(kw) && textLower.includes(kw.toLowerCase())) {\r\n        score += 1;\r\n      }\r\n    }\r\n    \r\n    return score;\r\n  }\r\n  \r\n  /**\r\n   * Calculate semantic similarity score between activity and KRA content\r\n   * Considers word overlap, phrase matching, and contextual relevance\r\n   */\r\n  private calculateSemanticScore(activityText: string, kraText: string): number {\r\n    const activityLower = activityText.toLowerCase();\r\n    const kraLower = kraText.toLowerCase();\r\n    \r\n    const activityWords = new Set(activityLower.split(/\\s+/).filter(w => w.length > 3));\r\n    const kraWords = new Set(kraLower.split(/\\s+/).filter(w => w.length > 3));\r\n    \r\n    // Calculate Jaccard similarity\r\n    let commonWords = 0;\r\n    activityWords.forEach(word => {\r\n      if (kraWords.has(word)) {\r\n        commonWords++;\r\n      }\r\n    });\r\n    \r\n    const totalUnique = activityWords.size + kraWords.size - commonWords;\r\n    const jaccardScore = totalUnique > 0 ? (commonWords / totalUnique) * 10 : 0;\r\n    \r\n    // Bonus for phrase matches (2+ word sequences)\r\n    let phraseBonus = 0;\r\n    const activityPhrases = this.extractPhrases(activityLower);\r\n    const kraPhrases = this.extractPhrases(kraLower);\r\n    \r\n    for (const phrase of activityPhrases) {\r\n      if (kraLower.includes(phrase)) {\r\n        phraseBonus += 3; // Phrases are worth more\r\n      }\r\n    }\r\n    \r\n    return jaccardScore + phraseBonus;\r\n  }\r\n  \r\n  /**\r\n   * Extract meaningful phrases from text (2-3 word sequences)\r\n   */\r\n  private extractPhrases(text: string): string[] {\r\n    const words = text.toLowerCase().split(/\\s+/).filter(w => w.length > 2);\r\n    const phrases: string[] = [];\r\n    \r\n    for (let i = 0; i < words.length - 1; i++) {\r\n      phrases.push(words.slice(i, i + 2).join(' '));\r\n      if (i < words.length - 2) {\r\n        phrases.push(words.slice(i, i + 3).join(' '));\r\n      }\r\n    }\r\n    \r\n    return phrases;\r\n  }\r\n\r\n  /**\r\n   * Validate and fix KRA assignments based on activity type matching rules\r\n   * Post-processes LLM output to enforce strict type-to-KRA mapping\r\n   */\r\n  private validateAndFixActivityKRAMatches(activities: any[], strategicPlan: any): any[] {\r\n    const correctedActivities = activities.map(activity => {\r\n      const activityName = activity.name.toLowerCase();\r\n      const currentKraId = activity.kraId;\r\n      \r\n      // Enrich all activities with KRA and KPI titles from strategic plan\r\n      const enrichActivity = (act: any, kraIdToEnrich: string, initiativeId?: string): any => {\r\n        const strategicPlanKras = (strategicPlan && strategicPlan.kras) || [];\r\n        // Use normalized KRA ID for consistent lookup\r\n        const normalizedKraIdToEnrich = normalizeKraId(kraIdToEnrich);\r\n        const kra = strategicPlanKras.find((k: any) => normalizeKraId(k.kra_id) === normalizedKraIdToEnrich);\r\n        \r\n        const enrichedData: any = { ...act };\r\n        \r\n        if (kra) {\r\n          enrichedData.kraTitle = kra.kra_title || kraIdToEnrich;\r\n          \r\n          // If we have an initiativeId, find the matching initiative\r\n          if (initiativeId && kra.initiatives) {\r\n            const initiative = kra.initiatives.find((init: any) => init.id === initiativeId);\r\n            if (initiative) {\r\n              enrichedData.kpiTitle = initiative.key_performance_indicator?.outputs || initiativeId;\r\n            }\r\n          }\r\n        }\r\n        \r\n        return enrichedData;\r\n      };\r\n      \r\n      // Enhanced Activity type detection with semantic understanding\r\n      const detectionScores = {\r\n        training: this.calculateTypeScore(activityName, ['train', 'seminar', 'workshop', 'course', 'capacity', 'upskill', 'certification', 'program'], ['training', 'seminar', 'workshop']),\r\n        curriculum: this.calculateTypeScore(activityName, ['curriculum', 'course content', 'syllabus', 'learning material', 'instructional'], ['curriculum', 'syllabus']),\r\n        digital: this.calculateTypeScore(activityName, ['digital', 'system', 'platform', 'portal', 'infrastructure', 'technology', 'e-', 'cyber', 'electronic'], ['digital', 'portal', 'platform']),\r\n        research: this.calculateTypeScore(activityName, ['research', 'study', 'publication', 'paper', 'journal', 'investigation', 'scholarly'], ['research', 'publication', 'journal']),\r\n        extension: this.calculateTypeScore(activityName, ['extension', 'outreach', 'community service', 'outreach', 'engagement', 'partnership'], ['extension', 'outreach']),\r\n      };\r\n      \r\n      let expectedKraTypes: string[] = [];\r\n      let primaryType = '';\r\n      \r\n      // Determine expected KRA type based on highest scoring type\r\n      const sortedTypes = Object.entries(detectionScores).sort(([,a], [,b]) => b - a);\r\n      const [topType, topScore] = sortedTypes[0];\r\n      \r\n      if (topScore > 0) {\r\n        primaryType = topType;\r\n        \r\n        if (topType === 'training') {\r\n          expectedKraTypes = ['KRA 13', 'KRA 11']; // HR Development/Capacity Building\r\n        } else if (topType === 'curriculum') {\r\n          expectedKraTypes = ['KRA 1', 'KRA 13']; // Curriculum/Program Development\r\n        } else if (topType === 'digital') {\r\n          expectedKraTypes = ['KRA 17', 'KRA 4', 'KRA 5']; // Digital Transformation/Innovation\r\n        } else if (topType === 'research') {\r\n          expectedKraTypes = ['KRA 3', 'KRA 4', 'KRA 5']; // Research & Development KRAs\r\n        } else if (topType === 'extension') {\r\n          expectedKraTypes = ['KRA 6', 'KRA 7']; // Extension & Community Service\r\n        }\r\n      }\r\n      \r\n      // Check if current KRA matches expected type\r\n      const isCorrectType = expectedKraTypes.length === 0 || expectedKraTypes.includes(currentKraId);\r\n      \r\n      if (!isCorrectType && expectedKraTypes.length > 0) {\r\n        console.log(`[QPRO VALIDATION] Activity \"${activity.name}\" was matched to ${currentKraId} but expected type is ${expectedKraTypes.join(' or ')}`);\r\n        console.log(`  Activity type detected: ${primaryType} (score=${topScore.toFixed(2)}) | Full scores: training=${detectionScores.training.toFixed(2)}, curriculum=${detectionScores.curriculum.toFixed(2)}, digital=${detectionScores.digital.toFixed(2)}, research=${detectionScores.research.toFixed(2)}`);\r\n        \r\n        // Reassign to correct KRA using semantic matching\r\n        const strategicPlanKras = (strategicPlan && strategicPlan.kras) || [];\r\n        const targetKra = strategicPlanKras.find((kra: any) => expectedKraTypes.includes(kra.kra_id));\r\n        \r\n        if (targetKra && targetKra.initiatives && targetKra.initiatives.length > 0) {\r\n          // Find best-fit initiative/KPI within the target KRA using semantic similarity\r\n          let bestInitiative = targetKra.initiatives[0];\r\n          let bestScore = 0;\r\n          \r\n          targetKra.initiatives.forEach((initiative: any) => {\r\n            const kraText = [\r\n              targetKra.kra_title,\r\n              initiative.key_performance_indicator?.outputs || '',\r\n              Array.isArray(initiative.strategies) ? initiative.strategies.join(' ') : '',\r\n              Array.isArray(initiative.programs_activities) ? initiative.programs_activities.join(' ') : ''\r\n            ].join(' ').toLowerCase();\r\n            \r\n            // Semantic similarity: score based on content overlap and context\r\n            const score = this.calculateSemanticScore(activityName, kraText);\r\n            \r\n            if (score > bestScore) {\r\n              bestScore = score;\r\n              bestInitiative = initiative;\r\n            }\r\n          });\r\n          \r\n          // Extract target from timeline_data\r\n          let targetValue = 1;\r\n          if (bestInitiative.targets && bestInitiative.targets.timeline_data) {\r\n            const timelineData = bestInitiative.targets.timeline_data.find((t: any) => t.year === 2025);\r\n            if (timelineData) {\r\n              targetValue = typeof timelineData.target_value === 'number' ? timelineData.target_value : 1;\r\n            }\r\n          }\r\n          \r\n          // Calculate confidence: combine type detection score + semantic match score\r\n          const typeConfidence = Math.min(1.0, topScore / 2); // Type detection contributes up to 0.5\r\n          const semanticConfidence = Math.min(0.5, bestScore / 10); // Semantic match contributes up to 0.5\r\n          const newConfidence = Math.min(0.95, Math.max(0.55, typeConfidence + semanticConfidence));\r\n          \r\n          // Extract KPI title from the initiative\r\n          const kpiTitle = bestInitiative.key_performance_indicator?.outputs || bestInitiative.id || '';\r\n          \r\n          console.log(`  ✓ Reassigned to ${targetKra.kra_id} (${bestInitiative.id}) with target=${targetValue}, confidence=${newConfidence.toFixed(2)} (type=${typeConfidence.toFixed(2)} + semantic=${semanticConfidence.toFixed(2)})`);\r\n          \r\n          const reportedValue = activity.reported || 0;\r\n          const achievementPercent = targetValue > 0 ? (reportedValue / targetValue) * 100 : 0;\r\n          \r\n          return {\r\n            ...activity,\r\n            kraId: targetKra.kra_id,\r\n            kraTitle: targetKra.kra_title || targetKra.kra_id,\r\n            initiativeId: bestInitiative.id,\r\n            kpiTitle: kpiTitle,\r\n            target: targetValue,\r\n            confidence: newConfidence,\r\n            achievement: achievementPercent,\r\n            status: achievementPercent >= 100 ? 'MET' : achievementPercent > 0 ? 'PARTIAL' : 'NOT_STARTED'\r\n          };\r\n        }\r\n      }\r\n      \r\n      // If activity is already classified, enrich with KRA/KPI titles\r\n      if (currentKraId && currentKraId !== 'UNCLASSIFIED') {\r\n        return enrichActivity(activity, currentKraId, activity.initiativeId);\r\n      }\r\n      \r\n      return activity;\r\n    });\r\n    \r\n    return correctedActivities;\r\n  }\r\n\r\n  async createQPROAnalysis(input: QPROAnalysisInput): Promise<any> {\r\n    try {\r\n      console.log('[QPROAnalysisService] Creating analysis for document:', input.documentId);\r\n      \r\n      // Step 1: Get file buffer from blob storage\r\n      console.log('[QPROAnalysisService] Downloading file from blob storage:', input.documentPath);\r\n      let fileBuffer: Buffer;\r\n      try {\r\n        fileBuffer = await this.getFileBuffer(input.documentPath);\r\n        console.log('[QPROAnalysisService] File downloaded successfully, size:', fileBuffer.length, 'bytes');\r\n      } catch (blobError) {\r\n        console.error('[QPROAnalysisService] Failed to download file:', blobError);\r\n        throw new Error(`Failed to download file from blob storage: ${blobError instanceof Error ? blobError.message : String(blobError)}`);\r\n      }\r\n      \r\n      // Step 2: Process with analysis engine\r\n      console.log('[QPROAnalysisService] Starting PDF/DOCX analysis...');\r\n      let analysisOutput: QPROAnalysisOutput;\r\n      try {\r\n        analysisOutput = await analysisEngineService.processQPRO(\r\n          fileBuffer, \r\n          input.documentType,\r\n          input.unitId || undefined,\r\n          input.year || 2025\r\n        );\r\n        console.log('[QPROAnalysisService] Analysis complete, extracted activities:', analysisOutput.activities?.length || 0);\r\n      } catch (analysisError) {\r\n        console.error('[QPROAnalysisService] Analysis engine failed:', analysisError);\r\n        throw new Error(`Text extraction and analysis failed: ${analysisError instanceof Error ? analysisError.message : String(analysisError)}`);\r\n      }\r\n      \r\n      // Load strategic plan for validation\r\n      console.log('[QPROAnalysisService] Loading strategic plan for validation...');\r\n      const strategicPlan = await this.loadStrategicPlan();\r\n      \r\n      // Post-LLM validation: fix any KRA assignments that violate type rules\r\n      let validatedActivities = analysisOutput.activities || [];\r\n      if (strategicPlan && strategicPlan.kras) {\r\n        validatedActivities = this.validateAndFixActivityKRAMatches(validatedActivities, strategicPlan);\r\n      }\r\n      \r\n      // Rebuild KRA summaries with corrected activities\r\n      const correctedKras = (analysisOutput.kras || []).map((kra: any) => ({\r\n        ...kra,\r\n        activities: validatedActivities.filter((act: any) => act.kraId === kra.kraId)\r\n      }));\r\n      \r\n      // Extract structured data from validated output\r\n      const {\r\n        alignment,\r\n        opportunities,\r\n        gaps,\r\n        recommendations,\r\n        overallAchievement,\r\n        documentInsight,\r\n        prescriptiveItems\r\n      } = analysisOutput;\r\n\r\n      const buildDocumentLevelAnalysis = (activities: any[], plan: any, year: number) => {\r\n        const allKRAs = plan?.kras || [];\r\n\r\n        // normalizeKraId is imported from qpro-aggregation.ts\r\n\r\n        const getInitiative = (kraId: string, initiativeId: string) => {\r\n          const normalizedKraIdVal = normalizeKraId(kraId);\r\n          const kra = allKRAs.find((k: any) => normalizeKraId(k.kra_id) === normalizedKraIdVal);\r\n          if (!kra?.initiatives) return null;\r\n          const normalizedId = String(initiativeId).replace(/\\s+/g, '');\r\n          let initiative = kra.initiatives.find((i: any) => String(i.id).replace(/\\s+/g, '') === normalizedId);\r\n          if (!initiative) {\r\n            const kpiMatch = String(initiativeId).match(/KPI(\\d+)/i);\r\n            if (kpiMatch) {\r\n              initiative = kra.initiatives.find((i: any) => String(i.id).includes(`KPI${kpiMatch[1]}`));\r\n            }\r\n          }\r\n          return initiative || null;\r\n        };\r\n\r\n        const formatNumber = (n: number, digits: number = 2) => {\r\n          if (!Number.isFinite(n)) return '0';\r\n          return n.toFixed(digits);\r\n        };\r\n\r\n        // Group by KRA + initiative (KPI)\r\n        const groups = new Map<string, {\r\n          kraId: string;\r\n          initiativeId: string;\r\n          title: string;\r\n          type: string | null;\r\n          targetScope: 'INSTITUTIONAL' | 'PER_UNIT';\r\n          targetValue: number | null;\r\n          reported: number[];\r\n          missed: number;\r\n          met: number;\r\n        }>();\r\n        for (const act of activities) {\r\n          const kraId = String(act.kraId || act.kra_id || '').trim();\r\n          const initiativeId = String(act.initiativeId || act.initiative_id || '').trim();\r\n          if (!kraId || !initiativeId) continue;\r\n\r\n          const key = `${kraId}::${initiativeId}`;\r\n          if (!groups.has(key)) {\r\n            const initiative = getInitiative(kraId, initiativeId);\r\n            const type = initiative?.targets?.type ? String(initiative.targets.type) : null;\r\n            const title = initiative?.key_performance_indicator?.outputs\r\n              ? String(initiative.key_performance_indicator.outputs)\r\n              : initiativeId;\r\n\r\n            const meta = getInitiativeTargetMeta(plan, kraId, initiativeId, year);\r\n\r\n            // Fallback: if plan lookup fails, fall back to the first activity target (NOT sum)\r\n            const fallbackTarget = (typeof act.target === 'number' ? act.target : Number(act.target));\r\n            const targetValue = meta.targetValue ?? (Number.isFinite(fallbackTarget) && fallbackTarget > 0 ? fallbackTarget : null);\r\n\r\n            groups.set(key, {\r\n              kraId,\r\n              initiativeId,\r\n              title,\r\n              type: (meta.targetType ? String(meta.targetType) : type),\r\n              targetScope: meta.targetScope,\r\n              targetValue,\r\n              reported: [],\r\n              missed: 0,\r\n              met: 0,\r\n            });\r\n          }\r\n\r\n          const g = groups.get(key)!;\r\n          const reportedNum = typeof act.reported === 'number' ? act.reported : Number(act.reported);\r\n          if (Number.isFinite(reportedNum)) g.reported.push(reportedNum);\r\n\r\n          // IMPORTANT: For count-based institutional targets, each extracted item is not a \"miss\".\r\n          // The pass/fail is computed at KPI (initiative) level; here we only track extraction volume.\r\n          // Keep legacy counters but base them on per-activity completion, not target achievement.\r\n          if (Number.isFinite(reportedNum) && reportedNum > 0) g.met += 1;\r\n          else g.missed += 1;\r\n        }\r\n\r\n        const groupSummaries: Array<{\r\n          kraId: string;\r\n          initiativeId: string;\r\n          title: string;\r\n          type: string | null;\r\n          target: number | null;\r\n          actual: number | null;\r\n          achievementPercent: number | null;\r\n          met: number;\r\n          missed: number;\r\n        }> = [];\r\n\r\n        groups.forEach((g) => {\r\n          if (g.targetValue === null || !Number.isFinite(g.targetValue) || g.targetValue <= 0) {\r\n            groupSummaries.push({\r\n              kraId: g.kraId,\r\n              initiativeId: g.initiativeId,\r\n              title: g.title,\r\n              type: g.type,\r\n              target: null,\r\n              actual: null,\r\n              achievementPercent: null,\r\n              met: g.met,\r\n              missed: g.missed,\r\n            });\r\n            return;\r\n          }\r\n\r\n          const aggregated = computeAggregatedAchievement({\r\n            targetType: g.type,\r\n            targetValue: g.targetValue,\r\n            targetScope: g.targetScope,\r\n            activities: g.reported.map((r) => ({ reported: r })),\r\n          });\r\n\r\n          const target = aggregated.totalTarget;\r\n          const actual = aggregated.totalReported;\r\n          const achievementPercent = aggregated.achievementPercent;\r\n\r\n          groupSummaries.push({\r\n            kraId: g.kraId,\r\n            initiativeId: g.initiativeId,\r\n            title: g.title,\r\n            type: g.type,\r\n            target,\r\n            actual,\r\n            achievementPercent,\r\n            met: g.met,\r\n            missed: g.missed,\r\n          });\r\n        });\r\n\r\n        // Root-cause notes (if any)\r\n        const rootCauseNotes = Array.from(\r\n          new Set(\r\n            activities\r\n              .map((a: any) => (typeof a.rootCause === 'string' ? a.rootCause.trim() : ''))\r\n              .filter((s: string) => s.length > 0)\r\n          )\r\n        );\r\n\r\n        const kraIds = Array.from(new Set(activities.map((a: any) => a.kraId).filter(Boolean)));\r\n        const initiativeIds = Array.from(new Set(activities.map((a: any) => a.initiativeId).filter(Boolean)));\r\n\r\n        // Document Insight: factual interpretation only (no recommendations)\r\n        const topUnderperforming = groupSummaries\r\n          .filter((g) => typeof g.achievementPercent === 'number')\r\n          .sort((a, b) => (a.achievementPercent ?? 0) - (b.achievementPercent ?? 0))\r\n          .slice(0, 5);\r\n\r\n        const computedOverall = (() => {\r\n          const vals = groupSummaries\r\n            .map((g) => (typeof g.achievementPercent === 'number' ? g.achievementPercent : null))\r\n            .filter((v): v is number => typeof v === 'number' && Number.isFinite(v));\r\n          if (vals.length === 0) return 0;\r\n          return vals.reduce((s, n) => s + n, 0) / vals.length;\r\n        })();\r\n\r\n        const insightLines: string[] = [];\r\n        insightLines.push('### Summary');\r\n        insightLines.push(`- Reporting period: ${year}`);\r\n        insightLines.push(`- Activities extracted: ${activities.length}`);\r\n        insightLines.push(`- KRAs covered: ${kraIds.length}`);\r\n        insightLines.push(`- KPIs covered: ${initiativeIds.length}`);\r\n        insightLines.push(`- Overall achievement score: ${formatNumber(computedOverall, 2)}%`);\r\n\r\n        if (topUnderperforming.length > 0) {\r\n          insightLines.push('');\r\n          insightLines.push('### Key performance signals');\r\n          topUnderperforming.forEach((g) => {\r\n            const isRate = g.type === 'percentage';\r\n            const suffix = isRate ? '%' : '';\r\n            const targetStr = g.target === null ? 'N/A' : `${formatNumber(g.target, 2)}${suffix}`;\r\n            const actualStr = g.actual === null ? 'N/A' : `${formatNumber(g.actual, 2)}${suffix}`;\r\n            const achStr = g.achievementPercent === null ? 'N/A' : `${formatNumber(g.achievementPercent, 1)}% of target`;\r\n            insightLines.push(`- ${g.kraId} / ${g.initiativeId}: Reported ${actualStr} vs Target ${targetStr} (${achStr})`);\r\n          });\r\n        }\r\n\r\n        if (rootCauseNotes.length > 0) {\r\n          insightLines.push('');\r\n          insightLines.push('### Observed contributing factors (from extracted notes)');\r\n          rootCauseNotes.slice(0, 5).forEach((note) => insightLines.push(`- ${note}`));\r\n        }\r\n\r\n        const documentInsight = insightLines.join('\\n');\r\n\r\n        // Prescriptive Analysis: actionable steps (imperative verbs + timeframes)\r\n        let prescriptiveLines: string[] = [];\r\n        prescriptiveLines.push('### Prescriptive analysis');\r\n        prescriptiveLines.push('- Conduct a focused review of the lowest-performing KPI areas within 2–4 weeks.');\r\n        prescriptiveLines.push('- Define measurable corrective actions per KPI and assign owners within 1 month.');\r\n        prescriptiveLines.push('- Establish a monthly monitoring cadence to track movement versus target.');\r\n        prescriptiveLines.push('- Validate that reported values match the KPI target type (percentage vs count) before final submission each quarter.');\r\n\r\n        // Deduplicate prescriptive sections (e.g., Address the primary performance gap, Data quality review)\r\n        // If these sections are generated elsewhere and pushed into prescriptiveLines, deduplicate here:\r\n        prescriptiveLines = prescriptiveLines.filter((line, idx, arr) =>\r\n          arr.findIndex(l => l.trim().toLowerCase() === line.trim().toLowerCase()) === idx\r\n        );\r\n\r\n        const prescriptiveAnalysis = prescriptiveLines.join('\\n');\r\n\r\n        return {\r\n          documentInsight,\r\n          prescriptiveAnalysis,\r\n          summary: {\r\n            year,\r\n            activities: activities.length,\r\n            kras: kraIds.length,\r\n            kpis: initiativeIds.length,\r\n            overallAchievement: computedOverall,\r\n          },\r\n        };\r\n      };\r\n      \r\n      // Create full analysis result text for reference\r\n      const analysisResult = this.formatAnalysisForStorage({\r\n        ...analysisOutput,\r\n        activities: validatedActivities,\r\n        kras: correctedKras\r\n      });\r\n\r\n      const reportYear = input.year || 2025;\r\n      const docLevelFallback = buildDocumentLevelAnalysis(validatedActivities, strategicPlan, reportYear);\r\n\r\n      const formatPrescriptiveItemsAsText = (\r\n        items: Array<{ title: string; issue: string; action: string; nextStep?: string }>\r\n      ) => {\r\n        return items\r\n          .filter((x) => x && typeof x.title === 'string' && typeof x.issue === 'string' && typeof x.action === 'string')\r\n          .slice(0, 5)\r\n          .map((x, idx) => {\r\n            const lines = [\r\n              `${idx + 1}. ${x.title.trim()}`,\r\n              `- Issue: ${x.issue.trim()}`,\r\n              `- Action: ${x.action.trim()}`,\r\n            ];\r\n            if (x.nextStep && x.nextStep.trim()) {\r\n              lines.push(`- Next Step: ${x.nextStep.trim()}`);\r\n            }\r\n            return lines.join('\\n');\r\n          })\r\n          .join('\\n\\n');\r\n      };\r\n\r\n      const llmDocumentInsight = typeof documentInsight === 'string' ? documentInsight.trim() : '';\r\n      const llmPrescriptiveItems = Array.isArray(prescriptiveItems)\r\n        ? (prescriptiveItems as any[])\r\n            .filter((x) => x && typeof x === 'object')\r\n            .slice(0, 5)\r\n            .map((x) => ({\r\n              title: String(x.title || '').trim(),\r\n              issue: String(x.issue || '').trim(),\r\n              action: String(x.action || '').trim(),\r\n              nextStep: x.nextStep ? String(x.nextStep).trim() : undefined,\r\n            }))\r\n            .filter((x) => x.title && x.issue && x.action)\r\n        : [];\r\n      const llmPrescriptiveText = llmPrescriptiveItems.length > 0\r\n        ? formatPrescriptiveItemsAsText(llmPrescriptiveItems)\r\n        : '';\r\n\r\n      const docLevel = {\r\n        documentInsight: llmDocumentInsight || docLevelFallback.documentInsight,\r\n        prescriptiveAnalysis: llmPrescriptiveText || docLevelFallback.prescriptiveAnalysis,\r\n        prescriptiveItems: llmPrescriptiveItems.length > 0 ? llmPrescriptiveItems : undefined,\r\n        summary: {\r\n          ...docLevelFallback.summary,\r\n          year: reportYear,\r\n          overallAchievement: Number.isFinite(overallAchievement) ? overallAchievement : docLevelFallback.summary.overallAchievement,\r\n        },\r\n      };\r\n      \r\n      // Create the QPRO analysis record in the database with DRAFT status\r\n      // Activities are staged and not committed to live dashboard until approved\r\n      const qproAnalysis = await prisma.qPROAnalysis.create({\r\n        data: {\r\n          documentId: input.documentId,\r\n          documentTitle: input.documentTitle,\r\n          documentPath: input.documentPath,\r\n          documentType: input.documentType,\r\n          analysisResult,\r\n          // Keep these fields for backward compatibility, but ensure they remain factual (no recommendations bleeding into insight).\r\n          alignment: docLevel.documentInsight || toString(alignment) || 'Analysis completed',\r\n          opportunities: '',\r\n          gaps: '',\r\n          recommendations: docLevel.prescriptiveAnalysis || toString(recommendations),\r\n          kras: correctedKras as any,\r\n          activities: validatedActivities as any,\r\n          achievementScore: docLevel.summary.overallAchievement,\r\n          prescriptiveAnalysis: {\r\n            documentInsight: docLevel.documentInsight,\r\n            prescriptiveAnalysis: docLevel.prescriptiveAnalysis,\r\n            prescriptiveItems: docLevel.prescriptiveItems,\r\n            summary: docLevel.summary,\r\n            generatedAt: new Date().toISOString(),\r\n            source: 'analysis-engine',\r\n          } as any,\r\n          status: 'DRAFT', // Staging workflow: start as DRAFT\r\n          uploadedById: input.uploadedById,\r\n          unitId: input.unitId,\r\n          year: reportYear,\r\n          quarter: input.quarter || 1,\r\n        },\r\n        include: {\r\n          document: true,\r\n          user: true,\r\n          unit: true\r\n        }\r\n      });\r\n\r\n      // Create staged AggregationActivity records (not linked to live aggregation yet)\r\n      // These will be committed to the live dashboard only after approval\r\n      try {\r\n        for (const activity of validatedActivities) {\r\n          if (activity.kraId && activity.initiativeId) {\r\n            await prisma.aggregationActivity.create({\r\n              data: {\r\n                // aggregation_id is NULL for DRAFT - will be linked on approval\r\n                aggregation_id: null,\r\n                qpro_analysis_id: qproAnalysis.id,\r\n                unit_id: toPrisma(input.unitId),\r\n                activity_name: activity.name || 'Unknown Activity',\r\n                reported: activity.reported ?? 0,\r\n                target: activity.target ?? 0,\r\n                achievement: activity.achievement ?? 0,\r\n                activity_type: activity.dataType || 'count',\r\n                initiative_id: activity.initiativeId,\r\n                evidenceSnippet: toPrisma(activity.evidenceSnippet),\r\n                confidenceScore: toPrisma(activity.confidence),\r\n                suggestedStatus: toPrisma(activity.suggestedStatus || activity.status),\r\n                dataType: toPrisma(activity.dataType),\r\n                prescriptiveNote: toPrisma(activity.prescriptiveAnalysis),\r\n                isApproved: false // Staged, not approved yet\r\n              }\r\n            });\r\n          }\r\n        }\r\n        console.log('[QPROAnalysisService] Created', validatedActivities.length, 'staged activities for review');\r\n      } catch (stagingError) {\r\n        console.error('Error creating staged activities:', stagingError);\r\n        // Log but don't throw - staging errors shouldn't prevent QPRO analysis from being saved\r\n      }\r\n\r\n      // NOTE: We no longer directly upsert to KRAggregation table here\r\n      // That happens in the approval endpoint after user review\r\n\r\n      return qproAnalysis;\r\n    } catch (error) {\r\n      console.error('========== ERROR IN QPRO ANALYSIS ==========');\r\n      console.error('Error type:', error instanceof Error ? error.constructor.name : typeof error);\r\n      console.error('Error message:', error instanceof Error ? error.message : String(error));\r\n      if (error instanceof Error && error.stack) {\r\n        console.error('Stack trace:', error.stack);\r\n      }\r\n      console.error('==========================================');\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async getQPROAnalysisById(id: string) {\r\n    try {\r\n      const analysis = await prisma.qPROAnalysis.findUnique({\r\n        where: { id },\r\n        include: {\r\n          document: {\r\n            select: {\r\n              title: true,\r\n              fileName: true,\r\n              fileType: true,\r\n              fileUrl: true\r\n            }\r\n          },\r\n          user: {\r\n            select: {\r\n              name: true,\r\n              email: true\r\n            }\r\n          }\r\n        }\r\n      });\r\n      \r\n      return analysis;\r\n    } catch (error) {\r\n      console.error('Error fetching QPRO analysis:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async getQPROAnalysesByUser(userId: string) {\r\n    try {\r\n      const analyses = await prisma.qPROAnalysis.findMany({\r\n        where: { uploadedById: userId },\r\n        orderBy: { createdAt: 'desc' },\r\n        include: {\r\n          document: {\r\n            select: {\r\n              title: true,\r\n              fileName: true\r\n            }\r\n          }\r\n        }\r\n      });\r\n      \r\n      return analyses;\r\n    } catch (error) {\r\n      console.error('Error fetching QPRO analyses for user:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async getQPROAnalysesByDocument(documentId: string) {\r\n    try {\r\n      const analyses = await prisma.qPROAnalysis.findMany({\r\n        where: { documentId },\r\n        orderBy: { createdAt: 'desc' },\r\n        include: {\r\n          user: {\r\n            select: {\r\n              name: true\r\n            }\r\n          }\r\n        }\r\n      });\r\n      \r\n      return analyses;\r\n    } catch (error) {\r\n      console.error('Error fetching QPRO analyses for document:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async getQPROAnalyses(filter: QPROAnalysesFilter) {\r\n    try {\r\n      const whereClause: any = {};\r\n      \r\n      if (filter.unitId) {\r\n        whereClause.unitId = filter.unitId;\r\n      }\r\n      \r\n      if (filter.year !== undefined) {\r\n        whereClause.year = filter.year;\r\n      }\r\n      \r\n      if (filter.quarter !== undefined) {\r\n        whereClause.quarter = filter.quarter;\r\n      }\r\n      \r\n      if (filter.userId) {\r\n        whereClause.uploadedById = filter.userId;\r\n      }\r\n      \r\n      const analyses = await prisma.qPROAnalysis.findMany({\r\n        where: whereClause,\r\n        orderBy: { createdAt: 'desc' },\r\n        take: filter.limit,\r\n        include: {\r\n          document: {\r\n            select: {\r\n              title: true,\r\n              fileName: true,\r\n              fileType: true\r\n            }\r\n          },\r\n          user: {\r\n            select: {\r\n              name: true,\r\n              email: true\r\n            }\r\n          },\r\n          unit: {\r\n            select: {\r\n              name: true,\r\n              code: true\r\n            }\r\n          }\r\n        }\r\n      });\r\n      \r\n      return analyses;\r\n    } catch (error) {\r\n      console.error('Error fetching QPRO analyses:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  private async getFileBuffer(blobPath: string): Promise<Buffer> {\r\n    try {\r\n      // Get the blob from the QPRO-specific container\r\n      const containerName = 'qpro-files';\r\n      const containerClient = blobServiceClient.getContainerClient(containerName);\r\n      const blobClient = containerClient.getBlobClient(blobPath);\r\n      \r\n      // Download the blob content\r\n      const downloadResponse = await blobClient.download();\r\n      \r\n      // Read the stream into a buffer\r\n      const buffer = await this.streamToBuffer(downloadResponse.readableStreamBody!);\r\n      \r\n      return buffer;\r\n    } catch (error) {\r\n      console.error(`Error downloading blob from path ${blobPath}:`, error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n private async streamToBuffer(stream: NodeJS.ReadableStream): Promise<Buffer> {\r\n    return new Promise((resolve, reject) => {\r\n      const chunks: Buffer[] = [];\r\n      \r\n      stream.on('data', (chunk: Buffer) => {\r\n        chunks.push(chunk);\r\n      });\r\n      \r\n      stream.on('error', reject);\r\n      \r\n      stream.on('end', () => {\r\n        resolve(Buffer.concat(chunks));\r\n      });\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Format structured analysis output into readable text for storage\r\n   */\r\n  private formatAnalysisForStorage(analysis: QPROAnalysisOutput): string {\r\n    const sections = [\r\n      '# QPRO Analysis Report',\r\n      '',\r\n      `## Overall Achievement Score: ${(analysis.overallAchievement || 0).toFixed(2)}%`,\r\n      '',\r\n      '## Strategic Alignment',\r\n      analysis.alignment || 'N/A',\r\n      '',\r\n      '## Opportunities',\r\n      analysis.opportunities || 'N/A',\r\n      '',\r\n      '## Gaps Identified',\r\n      analysis.gaps || 'N/A',\r\n      '',\r\n      '## Recommendations',\r\n      analysis.recommendations || 'N/A',\r\n      '',\r\n      '## KRA Summary',\r\n      ...(analysis.kras || []).map((kra: any) => `\r\n### ${kra.kraId}: ${kra.kraTitle}\r\n**Achievement Rate:** ${(kra.achievementRate || 0).toFixed(2)}%\r\n**Activities:** ${(kra.activities || []).length}\r\n**Alignment:** ${kra.strategicAlignment || 'N/A'}\r\n`),\r\n      '',\r\n      '## Detailed Activities',\r\n      ...(analysis.activities || []).map((activity: any) => `\r\n- **${activity.name}**\r\n  - KRA: ${activity.kraId || 'N/A'}\r\n  - Target: ${activity.target || 0}, Reported: ${activity.reported || 0}\r\n  - Achievement: ${(activity.achievement || 0).toFixed(2)}%\r\n  - Confidence: ${((activity.confidence || 0) * 100).toFixed(0)}%\r\n  - Unit: ${activity.unit || 'N/A'}\r\n`)\r\n    ];\r\n    \r\n    return sections.join('\\n');\r\n  }\r\n\r\n  /**\r\n   * Load strategic plan JSON for validation\r\n   */\r\n  private async loadStrategicPlan(): Promise<any> {\r\n    try {\r\n      // Import strategic plan JSON (works in Node.js context)\r\n      const strategicPlan = await import('@/lib/data/strategic_plan.json').then(m => m.default).catch(() => null);\r\n      return strategicPlan;\r\n    } catch (error) {\r\n      console.error('Error loading strategic plan:', error);\r\n      return null;\r\n    }\r\n  }\r\n}\r\n\r\nexport const qproAnalysisService = new QPROAnalysisService();"],"names":[],"mappings":"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"}},
    {"offset": {"line": 3937, "column": 0}, "map": {"version":3,"sources":["file:///D:/downloads/Downloads%20from%20web/LSPU%20KMIS/lib/services/qpro-cache-service.ts"],"sourcesContent":["import { redisService } from './redis-service';\r\n\r\ninterface QProCacheConfig {\r\n  uploadCacheTtl: number; // TTL for upload metadata cache in seconds\r\n  analysisCacheTtl: number; // TTL for analysis results cache in seconds\r\n  processingStatusTtl: number; // TTL for processing status cache in seconds\r\n}\r\n\r\ninterface QProUploadCache {\r\n  documentId: string;\r\n  fileName: string;\r\n  fileSize: number;\r\n  fileType: string;\r\n  fileUrl: string;\r\n  uploadedAt: Date;\r\n  userId: string;\r\n  status: 'PENDING' | 'PROCESSING' | 'COMPLETED' | 'FAILED';\r\n}\r\n\r\ninterface QProAnalysisCache {\r\n  documentId: string;\r\n  analysisId: string;\r\n  status: string;\r\n  achievementScore?: number;\r\n  kras?: any[];\r\n  activities?: any[];\r\n  timestamp?: number;\r\n}\r\n\r\nclass QProCacheService {\r\n  private readonly config: QProCacheConfig = {\r\n    uploadCacheTtl: 60 * 60, // 1 hour for upload metadata\r\n    analysisCacheTtl: 24 * 60 * 60, // 24 hours for analysis results\r\n    processingStatusTtl: 30 * 60, // 30 minutes for processing status\r\n  };\r\n\r\n  constructor(config?: Partial<QProCacheConfig>) {\r\n    if (config) {\r\n      this.config = { ...this.config, ...config };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Generate cache key for QPRO upload\r\n   */\r\n  private generateUploadCacheKey(documentId: string): string {\r\n    return `qpro:upload:${documentId}`;\r\n  }\r\n\r\n  /**\r\n   * Generate cache key for QPRO analysis\r\n   */\r\n  private generateAnalysisCacheKey(documentId: string): string {\r\n    return `qpro:analysis:${documentId}`;\r\n  }\r\n\r\n  /**\r\n   * Generate cache key for QPRO processing status\r\n   */\r\n  private generateProcessingStatusCacheKey(analysisId: string): string {\r\n    return `qpro:processing:${analysisId}`;\r\n  }\r\n\r\n  /**\r\n   * Generate cache key for user's QPRO analyses list\r\n   */\r\n  private generateUserAnalysesCacheKey(userId: string): string {\r\n    return `qpro:user:${userId}:analyses`;\r\n  }\r\n\r\n  /**\r\n   * Cache upload metadata\r\n   */\r\n  async cacheUpload(uploadData: QProUploadCache): Promise<void> {\r\n    try {\r\n      const cacheKey = this.generateUploadCacheKey(uploadData.documentId);\r\n      await redisService.set(cacheKey, uploadData, this.config.uploadCacheTtl);\r\n      console.log(`[QPRO Cache] Cached upload for document: ${uploadData.documentId}`);\r\n    } catch (error) {\r\n      console.error('[QPRO Cache] Error caching upload:', error);\r\n      // Don't throw - cache is optional\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get cached upload metadata\r\n   */\r\n  async getUploadCache(documentId: string): Promise<QProUploadCache | null> {\r\n    try {\r\n      const cacheKey = this.generateUploadCacheKey(documentId);\r\n      const cached = await redisService.get<QProUploadCache>(cacheKey);\r\n      if (cached) {\r\n        console.log(`[QPRO Cache] Hit for upload: ${documentId}`);\r\n      }\r\n      return cached;\r\n    } catch (error) {\r\n      console.error('[QPRO Cache] Error retrieving upload cache:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cache QPRO analysis result\r\n   */\r\n  async cacheAnalysis(analysisData: QProAnalysisCache): Promise<void> {\r\n    try {\r\n      const cacheKey = this.generateAnalysisCacheKey(analysisData.documentId);\r\n      const dataWithTimestamp = { ...analysisData, timestamp: Date.now() };\r\n      await redisService.set(cacheKey, dataWithTimestamp, this.config.analysisCacheTtl);\r\n      console.log(`[QPRO Cache] Cached analysis for document: ${analysisData.documentId}`);\r\n    } catch (error) {\r\n      console.error('[QPRO Cache] Error caching analysis:', error);\r\n      // Don't throw - cache is optional\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get cached analysis result\r\n   */\r\n  async getAnalysisCache(documentId: string): Promise<QProAnalysisCache | null> {\r\n    try {\r\n      const cacheKey = this.generateAnalysisCacheKey(documentId);\r\n      const cached = await redisService.get<QProAnalysisCache>(cacheKey);\r\n      if (cached) {\r\n        console.log(`[QPRO Cache] Hit for analysis: ${documentId}`);\r\n      }\r\n      return cached;\r\n    } catch (error) {\r\n      console.error('[QPRO Cache] Error retrieving analysis cache:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Update processing status cache\r\n   */\r\n  async updateProcessingStatus(analysisId: string, status: string, progress?: number): Promise<void> {\r\n    try {\r\n      const cacheKey = this.generateProcessingStatusCacheKey(analysisId);\r\n      const statusData = { analysisId, status, progress: progress || 0, timestamp: Date.now() };\r\n      await redisService.set(cacheKey, statusData, this.config.processingStatusTtl);\r\n      console.log(`[QPRO Cache] Updated processing status for analysis: ${analysisId} - ${status}`);\r\n    } catch (error) {\r\n      console.error('[QPRO Cache] Error updating processing status:', error);\r\n      // Don't throw - cache is optional\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get processing status from cache\r\n   */\r\n  async getProcessingStatus(analysisId: string): Promise<{ status: string; progress?: number } | null> {\r\n    try {\r\n      const cacheKey = this.generateProcessingStatusCacheKey(analysisId);\r\n      const cached = await redisService.get<any>(cacheKey);\r\n      if (cached) {\r\n        console.log(`[QPRO Cache] Hit for processing status: ${analysisId}`);\r\n        return { status: cached.status, progress: cached.progress };\r\n      }\r\n      return null;\r\n    } catch (error) {\r\n      console.error('[QPRO Cache] Error retrieving processing status:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cache user's QPRO analyses list\r\n   */\r\n  async cacheUserAnalyses(userId: string, analyses: any[]): Promise<void> {\r\n    try {\r\n      const cacheKey = this.generateUserAnalysesCacheKey(userId);\r\n      await redisService.set(cacheKey, { analyses, timestamp: Date.now() }, this.config.analysisCacheTtl);\r\n      console.log(`[QPRO Cache] Cached ${analyses.length} analyses for user: ${userId}`);\r\n    } catch (error) {\r\n      console.error('[QPRO Cache] Error caching user analyses:', error);\r\n      // Don't throw - cache is optional\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get cached user analyses list\r\n   */\r\n  async getUserAnalysesCache(userId: string): Promise<any[] | null> {\r\n    try {\r\n      const cacheKey = this.generateUserAnalysesCacheKey(userId);\r\n      const cached = await redisService.get<{ analyses: any[] }>(cacheKey);\r\n      if (cached) {\r\n        console.log(`[QPRO Cache] Hit for user analyses: ${userId}`);\r\n        return cached.analyses;\r\n      }\r\n      return null;\r\n    } catch (error) {\r\n      console.error('[QPRO Cache] Error retrieving user analyses cache:', error);\r\n      return null;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Invalidate upload cache for a document\r\n   */\r\n  async invalidateUploadCache(documentId: string): Promise<void> {\r\n    try {\r\n      const cacheKey = this.generateUploadCacheKey(documentId);\r\n      await redisService.del(cacheKey);\r\n      console.log(`[QPRO Cache] Invalidated upload cache for document: ${documentId}`);\r\n    } catch (error) {\r\n      console.error('[QPRO Cache] Error invalidating upload cache:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Invalidate analysis cache for a document\r\n   */\r\n  async invalidateAnalysisCache(documentId: string): Promise<void> {\r\n    try {\r\n      const cacheKey = this.generateAnalysisCacheKey(documentId);\r\n      await redisService.del(cacheKey);\r\n      console.log(`[QPRO Cache] Invalidated analysis cache for document: ${documentId}`);\r\n    } catch (error) {\r\n      console.error('[QPRO Cache] Error invalidating analysis cache:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Invalidate processing status cache\r\n   */\r\n  async invalidateProcessingStatus(analysisId: string): Promise<void> {\r\n    try {\r\n      const cacheKey = this.generateProcessingStatusCacheKey(analysisId);\r\n      await redisService.del(cacheKey);\r\n      console.log(`[QPRO Cache] Invalidated processing status for analysis: ${analysisId}`);\r\n    } catch (error) {\r\n      console.error('[QPRO Cache] Error invalidating processing status:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Invalidate user's analyses cache\r\n   */\r\n  async invalidateUserAnalysesCache(userId: string): Promise<void> {\r\n    try {\r\n      const cacheKey = this.generateUserAnalysesCacheKey(userId);\r\n      await redisService.del(cacheKey);\r\n      console.log(`[QPRO Cache] Invalidated user analyses cache for user: ${userId}`);\r\n    } catch (error) {\r\n      console.error('[QPRO Cache] Error invalidating user analyses cache:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Clear all QPRO caches for a user\r\n   */\r\n  async invalidateAllUserCaches(userId: string): Promise<void> {\r\n    try {\r\n      const pattern = `qpro:user:${userId}:*`;\r\n      const keys = await redisService.keys(pattern);\r\n      if (keys.length > 0) {\r\n        for (const key of keys) {\r\n          await redisService.del(key);\r\n        }\r\n        console.log(`[QPRO Cache] Invalidated ${keys.length} caches for user: ${userId}`);\r\n      }\r\n    } catch (error) {\r\n      console.error('[QPRO Cache] Error invalidating all user caches:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get cache statistics for QPRO\r\n   */\r\n  async getCacheStats(): Promise<{ size: number; keys: string[] }> {\r\n    try {\r\n      const keys = await redisService.keys('qpro:*');\r\n      return {\r\n        size: keys.length,\r\n        keys,\r\n      };\r\n    } catch (error) {\r\n      console.error('[QPRO Cache] Error getting cache stats:', error);\r\n      return { size: 0, keys: [] };\r\n    }\r\n  }\r\n}\r\n\r\n// Export singleton instance\r\nexport const qproCacheService = new QProCacheService();\r\nexport { QProCacheService };\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 4189, "column": 0}, "map": {"version":3,"sources":["file:///D:/downloads/Downloads%20from%20web/LSPU%20KMIS/app/api/qpro/analyses/%5Bid%5D/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\r\nimport { requireAuth } from '@/lib/middleware/auth-middleware';\r\nimport { qproAnalysisService } from '@/lib/services/qpro-analysis-service';\r\nimport { qproCacheService } from '@/lib/services/qpro-cache-service';\r\nimport prisma from '@/lib/prisma';\r\nimport { computeAggregatedAchievement, getInitiativeTargetMeta, normalizeKraId } from '@/lib/utils/qpro-aggregation';\r\n\r\nexport async function GET(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    // Authenticate\r\n    const authResult = await requireAuth(request);\r\n    if ('status' in authResult) return authResult;\r\n\r\n    const { user } = authResult;\r\n    const { id } = await params;\r\n\r\n    console.log(`[QPRO Analysis Detail] Fetching analysis: ${id}`);\r\n\r\n    // Check cache first\r\n    const cachedAnalysis = await qproCacheService.getAnalysisCache(id);\r\n    if (cachedAnalysis) {\r\n      console.log(`[QPRO Analysis Detail] Cache hit for analysis: ${id}`);\r\n      // Note: This returns cached metadata only. For full details, we still fetch from DB\r\n    }\r\n\r\n    // Get analysis by ID\r\n    const analysis = await qproAnalysisService.getQPROAnalysisById(id);\r\n\r\n    if (!analysis) {\r\n      return NextResponse.json({ error: 'Analysis not found' }, { status: 404 });\r\n    }\r\n\r\n    // Debug: Log prescriptive analysis data from DB\r\n    console.log(`[QPRO Analysis Detail] Status: ${analysis.status}`);\r\n    console.log(`[QPRO Analysis Detail] activities count:`, (analysis.activities as any[])?.length || 0);\r\n    console.log(`[QPRO Analysis Detail] kras count:`, (analysis.kras as any[])?.length || 0);\r\n    console.log(`[QPRO Analysis Detail] prescriptiveAnalysis exists:`, !!analysis.prescriptiveAnalysis);\r\n    if (analysis.prescriptiveAnalysis) {\r\n      console.log(`[QPRO Analysis Detail] prescriptiveAnalysis type:`, typeof analysis.prescriptiveAnalysis);\r\n      console.log(`[QPRO Analysis Detail] prescriptiveAnalysis keys:`, \r\n        typeof analysis.prescriptiveAnalysis === 'object' ? Object.keys(analysis.prescriptiveAnalysis as object) : 'N/A'\r\n      );\r\n    }\r\n    // Debug: Log first activity\r\n    if (analysis.activities && Array.isArray(analysis.activities) && (analysis.activities as any[]).length > 0) {\r\n      const firstAct = (analysis.activities as any[])[0];\r\n      console.log('[QPRO Analysis Detail] First activity:', JSON.stringify(firstAct, null, 2));\r\n    }\r\n    // Debug: Log first KRA\r\n    if (analysis.kras && Array.isArray(analysis.kras) && (analysis.kras as any[]).length > 0) {\r\n      const firstKra = (analysis.kras as any[])[0];\r\n      console.log('[QPRO Analysis Detail] First KRA:', JSON.stringify(firstKra, null, 2));\r\n    }\r\n\r\n    // Check authorization\r\n    if (analysis.uploadedById !== user.id && user.role !== 'ADMIN') {\r\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 403 });\r\n    }\r\n\r\n    // Format comprehensive response with all 4 stages\r\n    // Derive status based on analysis data\r\n    const status = analysis.analysisResult ? 'COMPLETED' : 'PENDING';\r\n\r\n    const response = {\r\n      // Basic info\r\n      id: analysis.id,\r\n      title: analysis.documentTitle,\r\n      year: analysis.year,\r\n      quarter: analysis.quarter,\r\n      uploadedDate: analysis.createdAt,\r\n      status: status,\r\n\r\n      // Stage 1: Extracted Sections (from analysisResult or activities)\r\n      extractedSections: extractSections(analysis),\r\n\r\n      // Stage 2: KRA Classifications\r\n      kraClassifications: formatKRAClassifications(analysis),\r\n\r\n      // Stage 3: Organized Activities by KRA\r\n      organizedActivities: organizeActivitiesByKRA(analysis),\r\n\r\n      // Stage 4: Insights & Recommendations\r\n      insights: analysis.analysisResult ? parseInsights(analysis.analysisResult) : [],\r\n      recommendations: analysis.recommendations ? parseRecommendations(analysis.recommendations) : [],\r\n      \r\n      // Stage 4: Prescriptive Analysis fields (from DB)\r\n      alignment: analysis.alignment || '',\r\n      opportunities: analysis.opportunities || '',\r\n      gaps: analysis.gaps || '',\r\n      \r\n      // Stage 4: Prescriptive Analysis (from AI during draft phase) - formatted for frontend\r\n      // First try the dedicated prescriptiveAnalysis field, then fall back to extracting from kras array\r\n      prescriptiveAnalysis: formatPrescriptiveAnalysisForFrontend(\r\n        analysis.prescriptiveAnalysis && Object.keys(analysis.prescriptiveAnalysis as object).length > 0\r\n          ? analysis.prescriptiveAnalysis\r\n          : extractPrescriptiveFromKRAs(analysis.kras)\r\n      ),\r\n\r\n      // Achievement Metrics (format overallScore to 2 decimal places)\r\n      achievementMetrics: {\r\n        overallScore: parseFloat((analysis.achievementScore || 0).toFixed(2)),\r\n        completeness: calculateCompleteness(analysis),\r\n        currentState: `${(analysis.kras ? (Array.isArray(analysis.kras) ? analysis.kras.length : 0) : 0)} KRAs with ${(analysis.activities ? (Array.isArray(analysis.activities) ? analysis.activities.length : 0) : 0)} activities`,\r\n        targetState: 'Full alignment with strategic plan objectives',\r\n      },\r\n    };\r\n\r\n    return NextResponse.json(response);\r\n  } catch (error) {\r\n    console.error('[QPRO Analysis Detail] Error:', error);\r\n    return NextResponse.json({ error: 'Failed to fetch analysis details' }, { status: 500 });\r\n  }\r\n}\r\n\r\nfunction extractSections(analysis: any) {\r\n  // Extract sections from activities or raw text\r\n  const sectionMap = new Map<string, string[]>();\r\n\r\n  if (analysis.activities && Array.isArray(analysis.activities)) {\r\n    (analysis.activities as any[]).forEach((activity: any) => {\r\n      const section = detectSection(activity.name || '') || 'OTHER';\r\n      if (!sectionMap.has(section)) {\r\n        sectionMap.set(section, []);\r\n      }\r\n      sectionMap.get(section)!.push(activity.name || 'Unnamed activity');\r\n    });\r\n  }\r\n\r\n  const sections: any[] = [];\r\n\r\n  if (sectionMap.size === 0) {\r\n    // Default sections if not detected\r\n    sections.push(\r\n      { title: 'Training Activities', type: 'TRAINING', activities: ['Training and professional development activities'] },\r\n      { title: 'Research Activities', type: 'RESEARCH', activities: ['Research outputs and publications'] },\r\n      { title: 'Alumni Engagement', type: 'ALUMNI_EMPLOYMENT', activities: ['Alumni employment and career tracking'] }\r\n    );\r\n  } else {\r\n    sectionMap.forEach((activities, sectionType) => {\r\n      sections.push({\r\n        title: formatSectionTitle(sectionType),\r\n        type: sectionType,\r\n        activities: activities,\r\n      });\r\n    });\r\n  }\r\n\r\n  return sections;\r\n}\r\n\r\nfunction formatSectionTitle(sectionType: string): string {\r\n  const titles: { [key: string]: string } = {\r\n    'TRAINING': 'Training & Professional Development',\r\n    'RESEARCH': 'Research & Publications',\r\n    'ALUMNI_EMPLOYMENT': 'Alumni Engagement & Employment',\r\n    'OTHER': 'Other Activities',\r\n  };\r\n  return titles[sectionType] || sectionType;\r\n}\r\n\r\nfunction detectSection(text: string): string | null {\r\n  const lowerText = text.toLowerCase();\r\n  if (lowerText.includes('train') || lowerText.includes('seminar') || lowerText.includes('workshop')) {\r\n    return 'TRAINING';\r\n  }\r\n  if (lowerText.includes('research') || lowerText.includes('paper') || lowerText.includes('publication')) {\r\n    return 'RESEARCH';\r\n  }\r\n  if (lowerText.includes('alumni') || lowerText.includes('employment') || lowerText.includes('graduate')) {\r\n    return 'ALUMNI_EMPLOYMENT';\r\n  }\r\n  return null;\r\n}\r\n\r\n// KRA ID to human-readable title mapping\r\nconst KRA_TITLES: { [key: string]: string } = {\r\n  'KRA 1': 'Development of New Curricula',\r\n  'KRA 2': 'Accreditation',\r\n  'KRA 3': 'Quality and Relevance of Instruction',\r\n  'KRA 4': 'International Activities',\r\n  'KRA 5': 'Research Outputs',\r\n  'KRA 6': 'Extension Programs',\r\n  'KRA 7': 'Community Partnerships',\r\n  'KRA 8': 'Technology Transfer',\r\n  'KRA 9': 'Revenue Generation',\r\n  'KRA 10': 'Resource Mobilization',\r\n  'KRA 11': 'Human Resource Management',\r\n  'KRA 12': 'Student Development',\r\n  'KRA 13': 'Health and Wellness',\r\n  'KRA 14': 'Environmental Sustainability',\r\n  'KRA 15': 'Quality Management',\r\n  'KRA 16': 'Governance',\r\n  'KRA 17': 'Digital Transformation',\r\n  'UNCLASSIFIED': 'Uncategorized Activities',\r\n};\r\n\r\nfunction getKRATitle(kraId: string, fallback?: string): string {\r\n  return KRA_TITLES[kraId] || fallback || kraId;\r\n}\r\n\r\nfunction formatKRAClassifications(analysis: any) {\r\n  // Build activity count per KRA from the activities array OR from embedded activities in KRAs\r\n  const kraActivityCounts: { [kraId: string]: number } = {};\r\n  const kraAchievements: { [kraId: string]: number[] } = {};\r\n  const kraTitles: { [kraId: string]: string } = {};\r\n  \r\n  console.log('[formatKRAClassifications] activities count:', analysis.activities?.length || 0);\r\n  console.log('[formatKRAClassifications] kras count:', analysis.kras?.length || 0);\r\n  \r\n  // FIRST: Check if activities in the top-level array have kraId\r\n  // If not, we'll count from embedded activities in each KRA\r\n  let activitiesHaveKraId = false;\r\n  if (analysis.activities && Array.isArray(analysis.activities) && (analysis.activities as any[]).length > 0) {\r\n    const firstAct = (analysis.activities as any[])[0];\r\n    activitiesHaveKraId = !!(firstAct.kraId || firstAct.kra_id || firstAct.kra);\r\n  }\r\n  \r\n  console.log('[formatKRAClassifications] activitiesHaveKraId:', activitiesHaveKraId);\r\n  \r\n  // If activities don't have kraId, try to count from KRA's embedded activities\r\n  if (!activitiesHaveKraId && analysis.kras && Array.isArray(analysis.kras)) {\r\n    let totalEmbeddedCount = 0;\r\n    \r\n    (analysis.kras as any[]).forEach((kra: any) => {\r\n      const kraId = kra.kraId || kra.id || '';\r\n      const embeddedActivities = kra.activities || [];\r\n      totalEmbeddedCount += embeddedActivities.length;\r\n      kraActivityCounts[kraId] = embeddedActivities.length;\r\n      \r\n      // Track achievements from embedded activities\r\n      embeddedActivities.forEach((act: any) => {\r\n        const achievement = act.achievement || 0;\r\n        if (!kraAchievements[kraId]) kraAchievements[kraId] = [];\r\n        kraAchievements[kraId].push(achievement);\r\n      });\r\n      \r\n      if (kra.kraTitle) {\r\n        kraTitles[kraId] = kra.kraTitle;\r\n      }\r\n    });\r\n    \r\n    // FALLBACK: If embedded activities are empty but we have top-level activities,\r\n    // assign them to the single KRA (if only one) or count as unclassified\r\n    if (totalEmbeddedCount === 0 && analysis.activities && Array.isArray(analysis.activities)) {\r\n      const topLevelCount = (analysis.activities as any[]).length;\r\n      const kras = analysis.kras as any[];\r\n      \r\n      if (kras.length === 1 && topLevelCount > 0) {\r\n        // Single KRA case: assign all top-level activities to it\r\n        const singleKraId = kras[0].kraId || kras[0].id;\r\n        kraActivityCounts[singleKraId] = topLevelCount;\r\n        console.log(`[formatKRAClassifications] Assigned ${topLevelCount} activities to single KRA: ${singleKraId}`);\r\n        \r\n        // Only calculate achievements from top-level activities if they have achievement values\r\n        // Otherwise, we'll use the KRA's achievementRate as fallback\r\n        let hasValidAchievements = false;\r\n        (analysis.activities as any[]).forEach((act: any) => {\r\n          const achievement = act.achievement;\r\n          // Only add if achievement is defined and > 0\r\n          if (achievement !== undefined && achievement !== null && achievement > 0) {\r\n            if (!kraAchievements[singleKraId]) kraAchievements[singleKraId] = [];\r\n            kraAchievements[singleKraId].push(achievement);\r\n            hasValidAchievements = true;\r\n          }\r\n        });\r\n        \r\n        // If no valid achievements from activities, DON'T populate the array\r\n        // so we fall back to kra.achievementRate\r\n        console.log(`[formatKRAClassifications] hasValidAchievements: ${hasValidAchievements}, will use KRA achievementRate: ${kras[0].achievementRate}`);\r\n      } else if (topLevelCount > 0) {\r\n        // Multiple KRAs case: show as unclassified\r\n        kraActivityCounts['UNCLASSIFIED'] = topLevelCount;\r\n        console.log(`[formatKRAClassifications] ${topLevelCount} activities are unclassified (multiple KRAs)`);\r\n      }\r\n    }\r\n    \r\n    console.log('[formatKRAClassifications] Final activity counts:', kraActivityCounts);\r\n  } else if (analysis.activities && Array.isArray(analysis.activities)) {\r\n    // Activities have kraId, count from top-level activities\r\n    (analysis.activities as any[]).forEach((activity: any, idx: number) => {\r\n      // Try multiple field paths for kraId\r\n      const kraId = activity.kraId || activity.kra_id || activity.kra || 'UNCLASSIFIED';\r\n      \r\n      // Debug first few activities\r\n      if (idx < 3) {\r\n        console.log(`[formatKRAClassifications] Activity ${idx}:`, {\r\n          name: activity.name?.substring(0, 30),\r\n          kraId: activity.kraId,\r\n          kra_id: activity.kra_id,\r\n          kra: activity.kra,\r\n          resolved: kraId\r\n        });\r\n      }\r\n      \r\n      if (kraId) {\r\n        kraActivityCounts[kraId] = (kraActivityCounts[kraId] || 0) + 1;\r\n        \r\n        // Track achievements for averaging\r\n        const achievement = activity.achievement || 0;\r\n        if (!kraAchievements[kraId]) kraAchievements[kraId] = [];\r\n        kraAchievements[kraId].push(achievement);\r\n        \r\n        // Store KRA title if available\r\n        if (!kraTitles[kraId] && (activity.kraTitle || activity.kra_title)) {\r\n          kraTitles[kraId] = activity.kraTitle || activity.kra_title;\r\n        }\r\n      }\r\n    });\r\n  }\r\n\r\n  // If no kras array but we have activities with kraIds, generate KRA entries from activities\r\n  if (!analysis.kras || !Array.isArray(analysis.kras) || analysis.kras.length === 0) {\r\n    const generatedKRAs: any[] = [];\r\n    Object.keys(kraActivityCounts).forEach((kraId) => {\r\n      const achievements = kraAchievements[kraId] || [];\r\n      const avgAchievement = achievements.length > 0 \r\n        ? achievements.reduce((a, b) => a + b, 0) / achievements.length \r\n        : 0;\r\n      \r\n      generatedKRAs.push({\r\n        id: kraId,\r\n        title: getKRATitle(kraId, kraTitles[kraId]),\r\n        count: kraActivityCounts[kraId] || 0,\r\n        achievementRate: Math.round(avgAchievement * 100) / 100,\r\n        strategicAlignment: '',\r\n      });\r\n    });\r\n    return generatedKRAs;\r\n  }\r\n\r\n  console.log('[formatKRAClassifications] kraActivityCounts:', kraActivityCounts);\r\n\r\n  return analysis.kras.map((kra: any, idx: number) => {\r\n    const kraId = kra.kraId || kra.id || '';\r\n    \r\n    // Debug first few KRAs\r\n    if (idx < 3) {\r\n      console.log(`[formatKRAClassifications] KRA ${idx}:`, {\r\n        kraId: kra.kraId,\r\n        id: kra.id,\r\n        resolved: kraId,\r\n        activitiesCount: kra.activities?.length\r\n      });\r\n    }\r\n    \r\n    // Use the counted activities instead of embedded activities array\r\n    const countFromActivities = kraActivityCounts[kraId] || 0;\r\n    const embeddedCount = kra.activities ? (Array.isArray(kra.activities) ? kra.activities.length : 0) : 0;\r\n    \r\n    // Prefer the count from activities array, fallback to embedded\r\n    const finalCount = countFromActivities > 0 ? countFromActivities : embeddedCount;\r\n    \r\n    console.log(`[formatKRAClassifications] KRA ${kraId}: countFromActivities=${countFromActivities}, embeddedCount=${embeddedCount}, finalCount=${finalCount}`);\r\n    \r\n    // Calculate achievement from activities if available, otherwise use KRA's achievementRate\r\n    const achievements = kraAchievements[kraId] || [];\r\n    const avgAchievement = achievements.length > 0 \r\n      ? achievements.reduce((a, b) => a + b, 0) / achievements.length \r\n      : (kra.achievementRate || 0);\r\n\r\n    console.log(`[formatKRAClassifications] KRA ${kraId}: achievements array length=${achievements.length}, avgAchievement=${avgAchievement}, kra.achievementRate=${kra.achievementRate}`);\r\n\r\n    return {\r\n      id: kraId || `kra-${Math.random()}`,\r\n      title: getKRATitle(kraId, kra.kraTitle || kra.title),\r\n      count: finalCount,\r\n      achievementRate: Math.round(avgAchievement * 100) / 100,\r\n      strategicAlignment: kra.strategicAlignment || '',\r\n    };\r\n  });\r\n}\r\n\r\nfunction organizeActivitiesByKRA(analysis: any): any[] {\r\n  const organized: { [key: string]: any } = {};\r\n\r\n  const strategicPlanJson = require('@/lib/data/strategic_plan.json');\r\n  const allKRAs = strategicPlanJson.kras || [];\r\n\r\n  const getInitiativeTargetType = (kraId: string, initiativeId: string | undefined | null): string | null => {\r\n    if (!kraId || !initiativeId) return null;\r\n    // Use normalized KRA ID for consistent lookup\r\n    const normalizedKraIdVal = normalizeKraId(kraId);\r\n    const kra = allKRAs.find((k: any) => normalizeKraId(k.kra_id) === normalizedKraIdVal);\r\n    if (!kra?.initiatives) return null;\r\n\r\n    // Match initiative IDs robustly (ignore spaces; allow KPI number matching)\r\n    const normalizedId = String(initiativeId).replace(/\\s+/g, '');\r\n    let initiative = kra.initiatives.find((i: any) => String(i.id).replace(/\\s+/g, '') === normalizedId);\r\n    if (!initiative) {\r\n      const kpiMatch = String(initiativeId).match(/KPI(\\d+)/i);\r\n      if (kpiMatch) {\r\n        initiative = kra.initiatives.find((i: any) => String(i.id).includes(`KPI${kpiMatch[1]}`));\r\n      }\r\n    }\r\n\r\n    const type = initiative?.targets?.type;\r\n    return typeof type === 'string' ? type : null;\r\n  };\r\n\r\n  const computeGroupTotals = (kraId: string, activities: any[], year: number, fallbackInitiativeId?: string) => {\r\n    const initiativeIds = activities\r\n      .map((a: any) => a.initiativeId)\r\n      .filter(Boolean)\r\n      .map((v: any) => String(v));\r\n    const distinctInitiatives = Array.from(new Set(initiativeIds));\r\n    const primaryInitiativeId = distinctInitiatives[0] || fallbackInitiativeId;\r\n\r\n    // Use strategic plan target for the primary initiative (KPI). For multi-KPI groups, the UI still\r\n    // shows activity-level breakdown; KPI targets are applied once per KPI (no per-activity inflation).\r\n    const meta = getInitiativeTargetMeta({ kras: allKRAs } as any, kraId, primaryInitiativeId, year);\r\n\r\n    const fallbackTarget = typeof activities?.[0]?.initiativeTarget === 'number'\r\n      ? activities[0].initiativeTarget\r\n      : (typeof activities?.[0]?.target === 'number' ? activities[0].target : Number(activities?.[0]?.target || 0));\r\n\r\n    const targetValue = meta.targetValue ?? (Number.isFinite(fallbackTarget) && fallbackTarget > 0 ? fallbackTarget : 0);\r\n\r\n    const aggregated = computeAggregatedAchievement({\r\n      targetType: meta.targetType,\r\n      targetValue,\r\n      targetScope: meta.targetScope,\r\n      activities,\r\n    });\r\n\r\n    const completion = aggregated.achievementPercent;\r\n    return {\r\n      totalTarget: aggregated.totalTarget,\r\n      totalReported: aggregated.totalReported,\r\n      completionPercentage: Math.round(Math.min(100, Math.max(0, completion))),\r\n      isRateMetric: String(meta.targetType || '').toLowerCase() === 'percentage',\r\n    };\r\n  };\r\n\r\n  // Check if top-level activities have kraId\r\n  let useEmbeddedActivities = false;\r\n  if (analysis.activities && Array.isArray(analysis.activities) && (analysis.activities as any[]).length > 0) {\r\n    const firstAct = (analysis.activities as any[])[0];\r\n    useEmbeddedActivities = !(firstAct.kraId || firstAct.kra_id || firstAct.kra);\r\n  } else {\r\n    useEmbeddedActivities = true;\r\n  }\r\n\r\n  console.log(`[ORGANIZE] useEmbeddedActivities: ${useEmbeddedActivities}`);\r\n\r\n  // If activities don't have kraId, use embedded activities from KRAs\r\n  if (useEmbeddedActivities && analysis.kras && Array.isArray(analysis.kras)) {\r\n    const kras = analysis.kras as any[];\r\n    console.log(`[ORGANIZE] Using embedded activities from ${kras.length} KRAs`);\r\n    \r\n    // First, check if any KRA has embedded activities\r\n    let totalEmbedded = 0;\r\n    kras.forEach((kra: any) => {\r\n      totalEmbedded += (kra.activities || []).length;\r\n    });\r\n    \r\n    // FALLBACK: If embedded activities are empty but we have top-level activities and single KRA\r\n    if (totalEmbedded === 0 && analysis.activities && Array.isArray(analysis.activities) && kras.length === 1) {\r\n      const kra = kras[0];\r\n      const kraId = kra.kraId || kra.id;\r\n      \r\n      console.log(`[ORGANIZE] Fallback: assigning ${(analysis.activities as any[]).length} top-level activities to single KRA: ${kraId}`);\r\n      \r\n      organized[kraId] = {\r\n        kraId,\r\n        kraTitle: getKRATitle(kraId, kra.kraTitle || kra.title),\r\n        kpiId: kra.initiativeId || '',\r\n        kpiTitle: '',\r\n        activities: [],\r\n        activityCount: 0,\r\n        totalTarget: 0,\r\n        totalReported: 0,\r\n        completionPercentage: 0,\r\n      };\r\n      \r\n      (analysis.activities as any[]).forEach((activity: any) => {\r\n        const target = activity.target || activity.targetValue || 0;\r\n        const reported = activity.reported || activity.accomplishedValue || 0;\r\n        const achievement = activity.achievement || (target > 0 ? (reported / target) * 100 : 0);\r\n        \r\n        organized[kraId].activities.push({\r\n          title: activity.name || activity.activityTitle || activity.title || 'Unnamed',\r\n          initiativeId: activity.initiativeId || activity.initiative_id || organized[kraId].kpiId || '',\r\n          target: target,\r\n          reported: reported,\r\n          achievement: Math.round(achievement * 100) / 100,\r\n          status: (achievement >= 100) ? 'MET' : (reported > 0) ? 'PARTIAL' : 'NOT_STARTED',\r\n          confidence: activity.confidence || 0.75,\r\n          description: activity.description || `Target: ${target}, Reported: ${reported}`,\r\n          aiInsight: activity.aiInsight || '',\r\n          prescriptiveAnalysis: activity.prescriptiveAnalysis || '',\r\n          rootCause: activity.rootCause || '',\r\n        });\r\n        organized[kraId].activityCount++;\r\n      });\r\n\r\n      // Compute group totals (rate metrics use average target/reported; counts use sums)\r\n      const totals = computeGroupTotals(kraId, organized[kraId].activities, Number(analysis.year) || 2025, organized[kraId].kpiId);\r\n      organized[kraId].totalTarget = totals.totalTarget;\r\n      organized[kraId].totalReported = totals.totalReported;\r\n      organized[kraId].completionPercentage = totals.completionPercentage;\r\n      \r\n      // Calculate completion percentage using KRA's achievementRate since activities may not have targets\r\n      if (!(organized[kraId].totalTarget > 0) && typeof kra.achievementRate === 'number') {\r\n        organized[kraId].completionPercentage = Math.round(kra.achievementRate || 0);\r\n      }\r\n      organized[kraId].status =\r\n        organized[kraId].completionPercentage >= 100\r\n          ? 'MET'\r\n          : organized[kraId].completionPercentage >= 70\r\n            ? 'ON_TRACK'\r\n            : organized[kraId].completionPercentage > 0\r\n              ? 'PARTIAL'\r\n              : 'NOT_STARTED';\r\n      \r\n      return Object.values(organized);\r\n    }\r\n    \r\n    // Normal path: use embedded activities\r\n    kras.forEach((kra: any) => {\r\n      const kraId = kra.kraId || kra.id;\r\n      if (!kraId) return;\r\n      \r\n      const embeddedActivities = kra.activities || [];\r\n      \r\n      if (!organized[kraId]) {\r\n        organized[kraId] = {\r\n          kraId,\r\n          kraTitle: getKRATitle(kraId, kra.kraTitle || kra.title),\r\n          kpiId: kra.initiativeId || '',\r\n          kpiTitle: '',\r\n          activities: [],\r\n          activityCount: 0,\r\n          totalTarget: 0,\r\n          totalReported: 0,\r\n          completionPercentage: 0,\r\n        };\r\n      }\r\n      \r\n      embeddedActivities.forEach((activity: any) => {\r\n        const target = activity.target || activity.targetValue || 0;\r\n        const reported = activity.reported || activity.accomplishedValue || 0;\r\n        const achievement = activity.achievement || (target > 0 ? (reported / target) * 100 : 0);\r\n        \r\n        organized[kraId].activities.push({\r\n          title: activity.name || activity.activityTitle || activity.title || 'Unnamed',\r\n          initiativeId: activity.initiativeId || activity.initiative_id || organized[kraId].kpiId || '',\r\n          target: target,\r\n          reported: reported,\r\n          achievement: Math.round(achievement * 100) / 100,\r\n          status: (achievement >= 100) ? 'MET' : (reported > 0) ? 'PARTIAL' : 'NOT_STARTED',\r\n          confidence: activity.confidence || 0.75,\r\n          description: activity.description || `Target: ${target}, Reported: ${reported}`,\r\n          aiInsight: activity.aiInsight || '',\r\n          prescriptiveAnalysis: activity.prescriptiveAnalysis || '',\r\n          rootCause: activity.rootCause || '',\r\n        });\r\n        organized[kraId].activityCount++;\r\n      });\r\n\r\n      // Calculate totals + completion percentage (rate metrics use average target/reported)\r\n      const totals = computeGroupTotals(kraId, organized[kraId].activities, organized[kraId].kpiId);\r\n      organized[kraId].totalTarget = totals.totalTarget;\r\n      organized[kraId].totalReported = totals.totalReported;\r\n      organized[kraId].completionPercentage = totals.completionPercentage;\r\n      \r\n      // Determine status\r\n      if (organized[kraId].completionPercentage >= 100) {\r\n        organized[kraId].status = 'MET';\r\n      } else if (organized[kraId].completionPercentage >= 70) {\r\n        organized[kraId].status = 'ON_TRACK';\r\n      } else if (organized[kraId].completionPercentage > 0) {\r\n        organized[kraId].status = 'PARTIAL';\r\n      } else {\r\n        organized[kraId].status = 'NOT_STARTED';\r\n      }\r\n    });\r\n    \r\n    return Object.values(organized);\r\n  }\r\n\r\n  // Original logic: use top-level activities with kraId\r\n  if (!analysis.activities || !Array.isArray(analysis.activities)) {\r\n    console.log('[ORGANIZE] No activities array found in analysis');\r\n    return [];\r\n  }\r\n\r\n  console.log(`[ORGANIZE] Processing ${(analysis.activities as any[]).length} activities from top-level`);\r\n\r\n  (analysis.activities as any[]).forEach((activity: any) => {\r\n    // Try multiple field paths for kraId\r\n    const kraId = activity.kraId || activity.kra_id || activity.kra || 'UNCLASSIFIED';\r\n    \r\n    // Only skip truly empty kraIds, not just 'UNCLASSIFIED' - we still want to show them\r\n    if (!kraId || kraId === '') {\r\n      console.log('[ORGANIZE] Skipping activity with empty kraId:', activity.name);\r\n      return;\r\n    }\r\n    \r\n    // For display purposes, group by kraId (use initiativeId for more granular grouping if available)\r\n    const initiativeId = activity.initiativeId || activity.initiative_id || '';\r\n    const compositeKey = kraId; // Simplified: group by KRA only for cleaner display\r\n    \r\n    if (!organized[compositeKey]) {\r\n      organized[compositeKey] = {\r\n        kraId,\r\n        kraTitle: getKRATitle(kraId, activity.kraTitle || activity.kra_title),\r\n        kpiId: initiativeId,\r\n        kpiTitle: activity.kpiTitle || activity.kpi_title || initiativeId || '',\r\n        activities: [],\r\n        activityCount: 0,\r\n        totalTarget: 0,\r\n        totalReported: 0,\r\n        completionPercentage: 0,\r\n      };\r\n    }\r\n    \r\n    // Try multiple field paths for target/reported values\r\n    const target = activity.target || activity.targetValue || activity.target_value || 0;\r\n    const reported = activity.reported || activity.accomplishedValue || activity.reported_value || 0;\r\n    const achievement = activity.achievement || (target > 0 ? (reported / target) * 100 : 0);\r\n    \r\n    organized[compositeKey].activities.push({\r\n      title: activity.name || activity.activityTitle || activity.title || 'Unnamed',\r\n      target: target,\r\n      reported: reported,\r\n      achievement: Math.round(achievement * 100) / 100,\r\n      status: (achievement >= 100) ? 'MET' : (reported > 0) ? 'PARTIAL' : 'NOT_STARTED',\r\n      confidence: activity.confidence || 0.75,\r\n      description: activity.description || `Target: ${target}, Reported: ${reported}`,\r\n      date: activity.date || undefined,\r\n      unit: activity.unit || undefined,\r\n      aiInsight: activity.aiInsight || '',\r\n      prescriptiveAnalysis: activity.prescriptiveAnalysis || '',\r\n      rootCause: activity.rootCause || '',\r\n    });\r\n\r\n    organized[compositeKey].activityCount++;\r\n  });\r\n\r\n  // Calculate completion percentages and status\r\n  Object.keys(organized).forEach((compositeKey) => {\r\n    const kra = organized[compositeKey];\r\n    \r\n    // Calculate achievement percentage\r\n    if (kra.totalTarget > 0) {\r\n      kra.completionPercentage = Math.round((kra.totalReported / kra.totalTarget) * 100);\r\n    } else if (kra.activities.length > 0) {\r\n      // Fallback: average of activity achievements\r\n      const avgAchievement = kra.activities.reduce((sum: number, act: any) => sum + act.achievement, 0) / kra.activities.length;\r\n      kra.completionPercentage = Math.round(avgAchievement);\r\n    } else {\r\n      kra.completionPercentage = 0;\r\n    }\r\n    \r\n    // Determine status based on completion\r\n    if (kra.completionPercentage >= 100) {\r\n      kra.status = 'MET';\r\n    } else if (kra.completionPercentage >= 70) {\r\n      kra.status = 'ON_TRACK';\r\n    } else if (kra.completionPercentage > 0) {\r\n      kra.status = 'PARTIAL';\r\n    } else {\r\n      kra.status = 'NOT_STARTED';\r\n    }\r\n  });\r\n\r\n  return Object.values(organized);\r\n}\r\n\r\nfunction parseInsights(analysisResult: string): string[] {\r\n  // Parse insights from analysis result text\r\n  // Return as array of strings for component compatibility\r\n  return [\r\n    'Strong Faculty Skill Development Initiative: Faculty training across technical domains with focus on emerging technologies',\r\n    'Solid Research Output: Research papers published and aligned with institutional needs, supporting curriculum',\r\n    'Alumni Tracking System Functional: Initial tracking system operational with employment data collected',\r\n  ];\r\n}\r\n\r\nfunction parseRecommendations(recommendations: any): any[] {\r\n  if (!recommendations || !Array.isArray(recommendations)) {\r\n    return [];\r\n  }\r\n\r\n  return recommendations.map((rec: any) => ({\r\n    number: rec.id,\r\n    priority: rec.priority || 'MEDIUM',\r\n    title: rec.title || rec.recommendationText || 'Recommendation',\r\n    currentState: rec.currentState || 'Unknown',\r\n    targetState: rec.targetState || 'Unknown',\r\n    actions: rec.actions || [],\r\n    timeline: rec.timeline || '1 month',\r\n    owner: rec.owner || 'To be assigned',\r\n    successMetric: rec.successMetric || 'Completion of action items',\r\n  }));\r\n}\r\n\r\nfunction calculateCompleteness(analysis: any): number {\r\n  let score = 0;\r\n  const total = 5;\r\n\r\n  if (analysis.activities) score++;\r\n  if (analysis.kras) score++;\r\n  if (analysis.alignment) score++;\r\n  if (analysis.opportunities) score++;\r\n  if (analysis.recommendations) score++;\r\n\r\n  return Math.round((score / total) * 100);\r\n}\r\n\r\n/**\r\n * Extract prescriptive analysis data from KRAs array\r\n * This is used as a fallback when the dedicated prescriptiveAnalysis field is empty\r\n */\r\nfunction extractPrescriptiveFromKRAs(kras: any): Record<string, any> {\r\n  if (!kras || !Array.isArray(kras)) return {};\r\n  \r\n  const extracted: Record<string, any> = {};\r\n  \r\n  kras.forEach((kra: any) => {\r\n    const kraId = kra.kraId || kra.id;\r\n    if (!kraId) return;\r\n    \r\n    // Only include KRAs that have prescriptive analysis data\r\n    if (kra.prescriptiveAnalysis || kra.rootCause || kra.actionItems?.length > 0) {\r\n      extracted[kraId] = {\r\n        kraId,\r\n        kraTitle: kra.kraTitle || kra.title || kraId,\r\n        achievementRate: kra.achievementRate || 0,\r\n        prescriptiveAnalysis: kra.prescriptiveAnalysis || '',\r\n        rootCause: kra.rootCause || '',\r\n        actionItems: kra.actionItems || [],\r\n        missedActivities: (kra.activities || [])\r\n          .filter((act: any) => act.status === 'MISSED' || (act.achievement !== undefined && act.achievement < 100))\r\n          .map((act: any) => ({\r\n            name: act.name,\r\n            reported: act.reported,\r\n            target: act.target,\r\n            achievement: act.achievement\r\n          }))\r\n      };\r\n    }\r\n  });\r\n  \r\n  console.log('[extractPrescriptiveFromKRAs] Extracted keys:', Object.keys(extracted));\r\n  return extracted;\r\n}\r\n\r\n/**\r\n * Format prescriptive analysis for frontend consumption.\r\n * The data is stored as {[kraId]: {kraId, kraTitle, prescriptiveAnalysis, rootCause, actionItems, missedActivities}}\r\n * We need to flatten it into a structure the frontend expects:\r\n * - recommendations: combined prescriptive analysis text\r\n * - gaps/root_cause: combined root causes\r\n * - action_items: flattened array of all action items\r\n */\r\nfunction formatPrescriptiveAnalysisForFrontend(prescriptiveAnalysis: any): any {\r\n  if (!prescriptiveAnalysis) return null;\r\n\r\n  // New document-level format (single insight + single prescriptive string)\r\n  if (\r\n    typeof prescriptiveAnalysis === 'object' &&\r\n    (typeof prescriptiveAnalysis.documentInsight === 'string' ||\r\n      typeof prescriptiveAnalysis.prescriptiveAnalysis === 'string' ||\r\n      Array.isArray((prescriptiveAnalysis as any).prescriptiveItems))\r\n  ) {\r\n    return prescriptiveAnalysis;\r\n  }\r\n  \r\n  // If already in the expected format, return as-is\r\n  if (prescriptiveAnalysis.recommendations || prescriptiveAnalysis.action_items) {\r\n    return prescriptiveAnalysis;\r\n  }\r\n  \r\n  // If it's a string, wrap it\r\n  if (typeof prescriptiveAnalysis === 'string') {\r\n    return { recommendations: prescriptiveAnalysis };\r\n  }\r\n  \r\n  // Handle nested structure: {[kraId]: {...data}}\r\n  const entries = Object.values(prescriptiveAnalysis);\r\n  if (entries.length === 0) return null;\r\n  \r\n  const allRecommendations: string[] = [];\r\n  const allRootCauses: string[] = [];\r\n  const allActionItems: string[] = [];\r\n  const allMissedActivities: string[] = [];\r\n  \r\n  entries.forEach((entry: any) => {\r\n    if (entry.prescriptiveAnalysis) {\r\n      const kraTitle = entry.kraTitle || entry.kraId || 'General';\r\n      const achievementStr = entry.achievementRate !== undefined \r\n        ? ` (${entry.achievementRate.toFixed(1)}% achievement)` \r\n        : '';\r\n      allRecommendations.push(`### ${kraTitle}${achievementStr}\\n${entry.prescriptiveAnalysis}`);\r\n    }\r\n    if (entry.rootCause) {\r\n      const kraTitle = entry.kraTitle || entry.kraId || 'Unknown KRA';\r\n      allRootCauses.push(`**${kraTitle}**: ${entry.rootCause}`);\r\n    }\r\n    if (entry.actionItems && Array.isArray(entry.actionItems)) {\r\n      allActionItems.push(...entry.actionItems);\r\n    }\r\n    if (entry.missedActivities && Array.isArray(entry.missedActivities)) {\r\n      // Format missed activities with details\r\n      entry.missedActivities.forEach((act: any) => {\r\n        const actDetail = `${act.name}: ${act.achievement?.toFixed(1) || 0}% achieved (${act.reported || 0}/${act.target || 0})`;\r\n        allMissedActivities.push(actDetail);\r\n      });\r\n    }\r\n  });\r\n  \r\n  return {\r\n    recommendations: allRecommendations.join('\\n\\n') || null,\r\n    root_cause: allRootCauses.join('\\n\\n') || null,\r\n    gaps: allRootCauses.length > 0 ? allRootCauses.join('\\n\\n') : null,\r\n    action_items: allActionItems.length > 0 ? allActionItems : null,\r\n    missed_activities: allMissedActivities.length > 0 ? allMissedActivities : null,\r\n  };\r\n}\r\n\r\n/**\r\n * PATCH /api/qpro/analyses/[id]\r\n * \r\n * Updates an analysis with edited activities (including KRA changes).\r\n * This is called before approval to persist reviewer corrections.\r\n */\r\nexport async function PATCH(\r\n  request: NextRequest,\r\n  { params }: { params: Promise<{ id: string }> }\r\n) {\r\n  try {\r\n    // Authenticate\r\n    const authResult = await requireAuth(request);\r\n    if ('status' in authResult) return authResult;\r\n\r\n    const { user } = authResult;\r\n    const { id: analysisId } = await params;\r\n\r\n    console.log(`[QPRO Analysis PATCH] Updating analysis: ${analysisId}`);\r\n\r\n    // Check permissions - only ADMIN and FACULTY can edit\r\n    if (!['ADMIN', 'FACULTY'].includes(user.role)) {\r\n      return NextResponse.json(\r\n        { error: 'Insufficient permissions. Only ADMIN or FACULTY can edit analyses.' },\r\n        { status: 403 }\r\n      );\r\n    }\r\n\r\n    // Parse request body\r\n    const body = await request.json();\r\n    const { activities, kras } = body;\r\n\r\n    console.log(`[QPRO Analysis PATCH] Received ${activities?.length || 0} activities, ${kras?.length || 0} kras`);\r\n\r\n    // Fetch existing analysis\r\n    const existingAnalysis = await prisma.qPROAnalysis.findUnique({\r\n      where: { id: analysisId }\r\n    });\r\n\r\n    if (!existingAnalysis) {\r\n      return NextResponse.json(\r\n        { error: 'Analysis not found' },\r\n        { status: 404 }\r\n      );\r\n    }\r\n\r\n    // Only allow editing DRAFT analyses\r\n    if (existingAnalysis.status !== 'DRAFT') {\r\n      return NextResponse.json(\r\n        { error: 'Only DRAFT analyses can be edited. This analysis is already ' + existingAnalysis.status },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Build update data\r\n    const updateData: any = {};\r\n\r\n    // Update activities if provided\r\n    if (activities && Array.isArray(activities)) {\r\n      // Validate and format activities\r\n      const formattedActivities = activities.map((act: any) => ({\r\n        name: act.name,\r\n        kraId: act.kraId, // This is the key field for KRA assignment\r\n        initiativeId: act.initiativeId || '',\r\n        reported: act.reported || 0,\r\n        target: act.target || 0,\r\n        achievement: act.achievement || 0,\r\n        status: act.status || 'MISSED',\r\n        confidence: act.confidence || 0.75,\r\n        unit: act.unit || '',\r\n        evidenceSnippet: act.evidenceSnippet || '',\r\n        dataType: act.dataType || 'count',\r\n        aiInsight: act.aiInsight || '',\r\n        prescriptiveAnalysis: act.prescriptiveAnalysis || '',\r\n        rootCause: act.rootCause || '',\r\n        authorizedStrategy: act.authorizedStrategy || ''\r\n      }));\r\n\r\n      updateData.activities = formattedActivities;\r\n\r\n      // Recalculate achievement score based on updated activities\r\n      const totalActivities = formattedActivities.length;\r\n      const metActivities = formattedActivities.filter((a: any) => a.status === 'MET').length;\r\n      const avgAchievement = totalActivities > 0 \r\n        ? formattedActivities.reduce((sum: number, a: any) => sum + (a.achievement || 0), 0) / totalActivities\r\n        : 0;\r\n\r\n      updateData.achievementScore = Math.round(avgAchievement * 100) / 100;\r\n\r\n      console.log(`[QPRO Analysis PATCH] Updated achievementScore: ${updateData.achievementScore}`);\r\n    }\r\n\r\n    // Update KRAs if provided  \r\n    if (kras && Array.isArray(kras)) {\r\n      updateData.kras = kras;\r\n    } else if (activities && Array.isArray(activities)) {\r\n      // Rebuild KRAs from activities if only activities were sent\r\n      const kraMap = new Map<string, any>();\r\n      \r\n      activities.forEach((act: any) => {\r\n        const kraId = act.kraId;\r\n        if (!kraId) return;\r\n        \r\n        if (!kraMap.has(kraId)) {\r\n          kraMap.set(kraId, {\r\n            kraId,\r\n            kraTitle: getKRATitle(kraId, act.kraTitle),\r\n            initiativeId: act.initiativeId || '',\r\n            activities: [],\r\n            totalReported: 0,\r\n            totalTarget: 0\r\n          });\r\n        }\r\n        \r\n        const kra = kraMap.get(kraId);\r\n        kra.activities.push(act);\r\n        kra.totalReported += act.reported || 0;\r\n        kra.totalTarget += act.target || 0;\r\n      });\r\n      \r\n      // Calculate achievement rates\r\n      const rebuiltKras = Array.from(kraMap.values()).map(kra => ({\r\n        ...kra,\r\n        achievementRate: kra.totalTarget > 0 \r\n          ? Math.round((kra.totalReported / kra.totalTarget) * 100 * 100) / 100\r\n          : 0,\r\n        status: kra.totalTarget > 0 && (kra.totalReported / kra.totalTarget) >= 1 ? 'MET' : 'MISSED'\r\n      }));\r\n      \r\n      updateData.kras = rebuiltKras;\r\n      console.log(`[QPRO Analysis PATCH] Rebuilt ${rebuiltKras.length} KRAs from activities`);\r\n    }\r\n\r\n    // Update the analysis\r\n    const updatedAnalysis = await prisma.qPROAnalysis.update({\r\n      where: { id: analysisId },\r\n      data: updateData\r\n    });\r\n\r\n    // Also update staged AggregationActivity records if they exist\r\n    if (activities && Array.isArray(activities)) {\r\n      for (const act of activities) {\r\n        await prisma.aggregationActivity.updateMany({\r\n          where: {\r\n            qpro_analysis_id: analysisId,\r\n            activity_name: act.name\r\n          },\r\n          data: {\r\n            reported: act.reported,\r\n            target: act.target,\r\n            initiative_id: act.kraId // Update initiative_id which links to KRA\r\n          }\r\n        });\r\n      }\r\n      console.log(`[QPRO Analysis PATCH] Updated staged activities`);\r\n    }\r\n\r\n    // Invalidate cache\r\n    await qproCacheService.invalidateAnalysisCache(analysisId);\r\n    if (existingAnalysis.uploadedById) {\r\n      await qproCacheService.invalidateUserAnalysesCache(existingAnalysis.uploadedById);\r\n    }\r\n\r\n    console.log(`[QPRO Analysis PATCH] Successfully updated analysis ${analysisId}`);\r\n\r\n    return NextResponse.json({\r\n      success: true,\r\n      message: 'Analysis updated successfully',\r\n      analysis: {\r\n        id: updatedAnalysis.id,\r\n        status: updatedAnalysis.status,\r\n        achievementScore: updatedAnalysis.achievementScore,\r\n        activitiesCount: (updatedAnalysis.activities as any[])?.length || 0,\r\n        krasCount: (updatedAnalysis.kras as any[])?.length || 0\r\n      }\r\n    });\r\n\r\n  } catch (error) {\r\n    console.error('[QPRO Analysis PATCH] Error:', error);\r\n    return NextResponse.json(\r\n      { error: 'Failed to update analysis' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}