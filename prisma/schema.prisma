generator client {
  provider        = "prisma-client-js"
  previewFeatures = []
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id              String               @id @default(dbgenerated("gen_random_uuid()"))
  email           String               @unique
 name            String
 unitId          String?              @map("unitId")
  avatar          String?
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
  password        String?
  role            UserRole             @default(STUDENT)
  activities      Activity[]
  comments        DocumentComment[]
  downloads       DocumentDownload[]
  permissions     DocumentPermission[]
  views           DocumentView[]
  documents       Document[]
  qproAnalyses    QPROAnalysis[]       // QPRO analyses created by this user
  unitPermissions UnitPermission[]
  userUnit        Unit?                @relation("UserUnit", fields: [unitId], references: [id])

  @@map("users")
}

model Document {
  id                       String               @id @default(cuid())
  title                    String
  description              String
  category                 String
  tags                     Json
  uploadedBy               String
  uploadedAt               DateTime             @default(now())
  fileUrl                  String
  fileName                 String
  fileType                 String
  fileSize                 Int
  version                  Int                  @default(1)
  versionNotes             String?
  parentDocumentId         String?
  downloadsCount           Int                  @default(0)
  viewsCount               Int                  @default(0)
  createdAt                DateTime             @default(now())
  updatedAt                DateTime             @updatedAt
  uploadedById             String
  unitId                   String?              @map("unitId")
  status                   DocumentStatus       @default(ACTIVE)
  colivaraDocumentId       String?
  colivaraEmbeddings       Json?
  colivaraMetadata         Json?
  colivaraProcessingStatus String?              @default("PENDING")
  colivaraProcessedAt      DateTime?
  colivaraChecksum         String?
 colivaraIndexes          ColivaraIndex[]
  comments                 DocumentComment[]
  downloads                DocumentDownload[]
  permissions              DocumentPermission[]
  views                    DocumentView[]
  qproAnalyses             QPROAnalysis[]       // QPRO analyses associated with this document
  parentDocument           Document?            @relation("DocumentVersions", fields: [parentDocumentId], references: [id])
  documents                Document[]           @relation("DocumentVersions")
  documentUnit             Unit?                @relation(fields: [unitId], references: [id])
  uploadedByUser           User                 @relation(fields: [uploadedById], references: [id], onDelete: Cascade)

  @@map("documents")
}

model Unit {
  id            String           @id @default(cuid())
  name          String           @unique
  code          String           @unique
  description   String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  documents     Document[]
  permissions   UnitPermission[]
  users         User[]           @relation("UserUnit")
  qproAnalyses  QPROAnalysis[]

  @@map("units")
}

model DocumentPermission {
  id         String   @id @default(cuid())
  documentId String
  userId     String
  createdAt  DateTime @default(now())
  permission String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([documentId, userId])
  @@map("document_permissions")
}

model UnitPermission {
  id         String   @id @default(cuid())
  unitId     String
  userId     String
  permission String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  unit       Unit     @relation(fields: [unitId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([unitId, userId])
  @@map("unit_permissions")
}

model DocumentDownload {
  id           String   @id @default(cuid())
  documentId   String
  userId       String
  downloadedAt DateTime @default(now())
  document     Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("document_downloads")
}

model DocumentView {
  id         String   @id @default(cuid())
  documentId String
  userId     String
  viewedAt   DateTime @default(now())
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("document_views")
}

model DocumentComment {
  id              String            @id @default(cuid())
  documentId      String
  userId          String
  parentCommentId String?
  content         String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  document        Document          @relation(fields: [documentId], references: [id], onDelete: Cascade)
  parentComment   DocumentComment?  @relation("CommentReplies", fields: [parentCommentId], references: [id], onDelete: Cascade)
  replies         DocumentComment[] @relation("CommentReplies")
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("document_comments")
}

model ColivaraIndex {
  id              String   @id @default(cuid())
  documentId      String
  chunkId         String?
  content         String
  embeddings      Json
  pageNumbers     Int[]
  documentSection String?
  confidenceScore Float?
  createdAt       DateTime @default(now())
  document        Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@map("colivara_indexes")
}



model Activity {
  id          String     @id @default(cuid())
  type        String
  userId      String
  userRole    String?
  postId      String?
  action      String?
  description String
  timestamp   DateTime   @default(now())
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([timestamp])
}

enum UserRole {
  ADMIN
  FACULTY
  STUDENT
  EXTERNAL
}

enum DocumentStatus {
  ACTIVE
  ARCHIVED
  PENDING_REVIEW
}

enum PermissionLevel {
  READ
  WRITE
  ADMIN
}

model QPROAnalysis {
  id                String   @id @default(cuid())
  documentId        String   // Reference to the document that was analyzed
  documentTitle     String   // Title of the analyzed document
  documentPath      String   // Path to the stored document file
  documentType      String   // File type (PDF/DOCX)
  analysisResult    String   // The full analysis result from the LLM
  alignment         String?  // Section about alignment with strategic plan
  opportunities     String? // Section about potential strategic opportunities
  gaps              String?  // Section about gaps or conflicts
  recommendations   String?  // Section with actionable recommendations
  kras              Json?    // JSON array of related KRAs with activity matching
  unitId            String?  // Unit this QPRO belongs to
  year              Int      @default(2025) // Reporting year
  quarter           Int      @default(1) // Quarter (1-4)
  activities        Json?    // Extracted activities from QPRO document
  achievementScore  Float?   // Overall achievement percentage (0-100)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  uploadedById      String   // User who uploaded the document
  document          Document @relation(fields: [documentId], references: [id], onDelete: Cascade, map: "qpro_analysis_document_fkey")
  user              User     @relation(fields: [uploadedById], references: [id], onDelete: Cascade, map: "qpro_analysis_user_fkey")
  unit              Unit?    @relation(fields: [unitId], references: [id])
  aggregationActivities AggregationActivity[]
  
  @@index([unitId])
  @@index([year, quarter])
  @@map("qpro_analyses")
}

model KRAggregation {
  id                       String   @id @default(dbgenerated("gen_random_uuid()"))
  year                     Int      // Reporting year
  quarter                  Int      // Quarter (1-4)
  kra_id                   String   // KRA identifier
  kra_title                String?  // KRA title
  initiative_id            String   // Initiative/KPI identifier
  total_reported           Int?     // Total reported value
  target_value             Decimal? // Target value for this KRA
  achievement_percent      Decimal? // Calculated achievement percentage
  submission_count         Int      @default(0) // Number of submissions
  participating_units      Json?    // Array of unit IDs that contributed
  status                   String?  // Status: MET, MISSED, ON_TRACK, NOT_APPLICABLE
  last_updated             DateTime @default(now()) @updatedAt
  updated_by               String?  // User who last updated
  previous_quarter_achieved Decimal? // Previous quarter achievement for trending
  previous_quarter_reported Int?    // Previous quarter reported value
  previous_quarter_target   Decimal? // Previous quarter target
  aggregationActivities    AggregationActivity[]
  
  @@unique([year, quarter, kra_id, initiative_id], name: "unique_aggregation")
  @@index([year, quarter])
  @@index([kra_id])
  @@index([status])
  @@map("kra_aggregations")
}

model AggregationActivity {
  id                String   @id @default(dbgenerated("gen_random_uuid()"))
  aggregation_id    String   // Reference to KRAggregation
  qpro_analysis_id  String   // Reference to QPROAnalysis
  unit_id           String?  // Unit that reported this activity
  activity_name     String   // Name of the activity
  reported          Int?     // Reported value for this activity
  target            Int?     // Target for this activity
  achievement       Decimal? // Achievement percentage
  activity_type     String?  // Type of activity
  initiative_id     String   // Initiative identifier
  created_at        DateTime @default(now())
  aggregation       KRAggregation @relation(fields: [aggregation_id], references: [id], onDelete: Cascade)
  qproAnalysis      QPROAnalysis @relation(fields: [qpro_analysis_id], references: [id], onDelete: Cascade)
  
  @@index([aggregation_id])
  @@index([qpro_analysis_id])
  @@index([unit_id])
  @@map("aggregation_activities")
}

