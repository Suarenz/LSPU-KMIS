module.exports=[99737,e=>{"use strict";var t=e.i(47909),r=e.i(74017),a=e.i(96250),n=e.i(59756),i=e.i(61916),l=e.i(14444),o=e.i(37092),s=e.i(69741),u=e.i(16795),d=e.i(87718),c=e.i(95169),p=e.i(47587),g=e.i(66012),m=e.i(70101),v=e.i(26937),f=e.i(10372),y=e.i(93695);e.i(52474);var h=e.i(220),_=e.i(89171),I=e.i(81563),P=e.i(15270),T=e.i(23257),R=e.i(83522);function E(e){if(!e)return"COUNT";let t=e.toLowerCase().trim();return t.includes("milestone")||t.includes("binary")||"boolean"===t?"MILESTONE":t.includes("percentage")||t.includes("percent")||t.includes("rate")?"PERCENTAGE":t.includes("currency")||t.includes("financial")||t.includes("budget")||t.includes("revenue")||t.includes("cost")?"FINANCIAL":t.includes("text")||t.includes("condition")||t.includes("status")||t.includes("qualitative")?"TEXT_CONDITION":(t.includes("count")||t.includes("numeric")||t.includes("number")||t.includes("quantity"),"COUNT")}async function A(e){try{let t=await (0,I.requireAuth)(e);if("status"in t)return t;let{searchParams:r}=new URL(e.url),a=r.get("kraId"),n=parseInt(r.get("year")||new Date().getFullYear().toString()),i=r.get("quarter")?parseInt(r.get("quarter")):void 0,l=T.default.kras||[],o=a?(0,R.normalizeKraId)(a):null,s=o?l.find(e=>(0,R.normalizeKraId)(e.kra_id)===o):null;if(a&&!s)return _.NextResponse.json({error:"KRA not found"},{status:404});let u=await P.default.aggregationActivity.findMany({where:{isApproved:!0},include:{qproAnalysis:{select:{year:!0,quarter:!0,unitId:!0,unit:{select:{id:!0,name:!0,code:!0}}}}}}),d=(()=>{if(!a)return null;let e=(0,R.normalizeKraId)(a),t=e.replace(/\s+/g,"");return Array.from(new Set([a,e,t]))})(),c=await P.default.kPIContribution.findMany({where:{year:n,...i&&{quarter:i},...d&&{kra_id:{in:d}}},orderBy:{created_at:"desc"}}),p=await P.default.aggregationActivity.findMany({where:{isApproved:!1,qproAnalysis:{year:n,...i&&{quarter:i},status:"DRAFT"}},include:{qproAnalysis:{select:{id:!0,year:!0,quarter:!0,unitId:!0,status:!0,unit:{select:{id:!0,name:!0,code:!0}}}}}});console.log(`[KPI Progress] Found ${p.length} DRAFT activities for year ${n}${i?`, quarter ${i}`:""}`),p.length>0&&console.log("[KPI Progress] Sample draft activity:",JSON.stringify(p[0],null,2));let g=new Map;for(let e of(console.log(`[KPI Progress] Processing ${c.length} KPIContribution records...`),c)){let t=`${(0,R.normalizeKraId)(e.kra_id)}|${e.initiative_id}|${e.year}|${e.quarter}`,r=g.get(t);if(!e.target_type||"string"!=typeof e.target_type){console.error(`[KPI Progress] ⚠️  CRITICAL: Invalid target_type in contribution ${e.id}: ${e.target_type} (type: ${typeof e.target_type})`);continue}let a=e.target_type.toUpperCase();r?(r.targetType.toUpperCase()!==a&&console.warn(`[KPI Progress] ⚠️  Target type mismatch for ${t}: existing="${r.targetType}", current="${e.target_type}". Using existing type.`),"SNAPSHOT"===a||"MILESTONE"===a||"BOOLEAN"===a||"TEXT_CONDITION"===a?e.created_at>r.latestAt&&(r.latestValue=e.value,r.latestAt=e.created_at):r.total+=e.value,r.count+=1):g.set(t,{total:e.value,count:1,targetType:e.target_type,latestValue:e.value,latestAt:e.created_at})}console.log(`[KPI Progress] Aggregation summary: ${g.size} unique KPI/period combinations`);let m=new Map;g.forEach((e,t)=>{let r=e.targetType.toUpperCase();m.set(r,(m.get(r)||0)+1),console.log(`[KPI Progress] ${t}: type=${r}, count=${e.count}, total=${e.total}, latest=${e.latestValue}`),"COUNT"===r&&e.count>1&&e.total===e.latestValue&&console.warn(`[KPI Progress] ⚠️  Possible aggregation anomaly for ${t}: COUNT type with ${e.count} contributions but total=${e.total} equals latest=${e.latestValue}`)}),console.log(`[KPI Progress] Aggregation types: ${Array.from(m.entries()).map(([e,t])=>`${e}=${t}`).join(", ")}`);let v=await P.default.kRAggregation.findMany({where:{year:n,...i&&{quarter:i},...d&&{kra_id:{in:d}}}}),f=new Map,y=e=>{if(null==e)return null;let t="number"==typeof e?e:Number(String(e).replace(/,/g,"").trim());return Number.isFinite(t)?t:null},h=new Set;for(let e of c){let t=`${(0,R.normalizeKraId)(e.kra_id)}|${e.initiative_id}|${e.year}|${e.quarter}`;h.add(t)}for(let e of u){let t=e.qproAnalysis;if(!t||t.year!==n||i&&t.quarter!==i)continue;let r=e.initiative_id,o=r.match(/^(KRA\s?\d+)/i),s=o?o[1]:null,u=s?(0,R.normalizeKraId)(s):null;if(a&&u!==(0,R.normalizeKraId)(a)||!u)continue;let d=`${u}|${r}|${t.year}|${t.quarter}`;if(h.has(d)){console.log(`[KPI Progress] Skipping legacy activity for ${d} - has KPIContribution records`);continue}f.has(u)||f.set(u,new Map);let c=f.get(u);c.has(r)||c.set(r,[]);let p=c.get(r),g=p.find(e=>e.year===t.year&&e.quarter===t.quarter);if(!g){let e=(0,R.normalizeKraId)(u),a=l.find(t=>(0,R.normalizeKraId)(t.kra_id)===e),n=a?.initiatives.find(e=>e.id===r),i=n?.targets?.timeline_data?.find(e=>e.year===t.year),o=n?.targets?.type||"count",s=E(o);g={initiativeId:r,year:t.year,quarter:t.quarter,targetValue:i?.target_value??0,currentValue:0,achievementPercent:0,status:"PENDING",submissionCount:0,participatingUnits:[],targetType:s,manualOverride:null,manualOverrideReason:null,manualOverrideBy:null,manualOverrideAt:null,valueSource:"none",hasUnapprovedData:!1},p.push(g)}if(null!=e.reported){let a=y(e.reported);if(null!==a){let n=(0,R.getInitiativeTargetMeta)(T.default,u,r,t.year),i=String(n.targetType||"").toLowerCase();if("percentage"===i){let t=null;if(a>=0&&a<=100)t=a;else{let r=y(e.target);if(null!==r&&r>0&&a>=0){let e=a/r*100;e>=0&&e<=100&&(t=e)}}if(null!==t){let e="_pctSum",r="_pctCount";g[e]=(g[e]||0)+t,g[r]=(g[r]||0)+1}}else{let e="number"==typeof g.currentValue?g.currentValue:0;g.currentValue=e+a}}}g.submissionCount++,t.unit&&!g.participatingUnits.includes(t.unit.code)&&g.participatingUnits.push(t.unit.code)}for(let e of(console.log(`[KPI Progress] Processing ${p.length} DRAFT activities...`),p)){let t=e.qproAnalysis;if(!t)continue;let r=e.initiative_id;console.log(`[KPI Progress] DRAFT activity: ${r}, reported: ${e.reported}, year: ${t.year}, quarter: ${t.quarter}`);let n=r.match(/^(KRA\s?\d+)/i),i=n?n[1]:null,o=i?(0,R.normalizeKraId)(i):null;if(a&&o!==(0,R.normalizeKraId)(a)||!o)continue;f.has(o)||f.set(o,new Map);let s=f.get(o);s.has(r)||s.set(r,[]);let u=s.get(r),d=u.find(e=>e.year===t.year&&e.quarter===t.quarter);if(!d){let e=(0,R.normalizeKraId)(o),a=l.find(t=>(0,R.normalizeKraId)(t.kra_id)===e),n=a?.initiatives.find(e=>e.id===r),i=n?.targets?.timeline_data?.find(e=>e.year===t.year),s=n?.targets?.type||"count",c=E(s);d={initiativeId:r,year:t.year,quarter:t.quarter,targetValue:i?.target_value??0,currentValue:0,achievementPercent:0,status:"PENDING",submissionCount:0,participatingUnits:[],targetType:c,manualOverride:null,manualOverrideReason:null,manualOverrideBy:null,manualOverrideAt:null,valueSource:"none",hasUnapprovedData:!0},u.push(d)}if(null!=e.reported){let a=y(e.reported);if(null!==a){let n=(0,R.getInitiativeTargetMeta)(T.default,o,r,t.year),i=String(n.targetType||"").toLowerCase();if("percentage"===i){let t=null;if(a>=0&&a<=100)t=a;else{let r=y(e.target);if(null!==r&&r>0&&a>=0){let e=a/r*100;e>=0&&e<=100&&(t=e)}}if(null!==t){let e="_pctSum",r="_pctCount";d[e]=(d[e]||0)+t,d[r]=(d[r]||0)+1}}else{let e="number"==typeof d.currentValue?d.currentValue:0;d.currentValue=e+a}}}d.submissionCount++,d.hasUnapprovedData=!0,t.unit&&!d.participatingUnits.includes(t.unit.code)&&d.participatingUnits.push(t.unit.code)}for(let e of v){let t=(0,R.normalizeKraId)(e.kra_id);f.has(t)||f.set(t,new Map);let r=f.get(t);r.has(e.initiative_id)||r.set(e.initiative_id,[]);let a=r.get(e.initiative_id),n=a.find(t=>t.year===e.year&&t.quarter===e.quarter),i=null!==e.manual_override&&void 0!==e.manual_override,l=e.total_reported??0,o=i?e.manual_override?.toNumber()??l:l,s=i?"manual":l>0?"qpro":"none";n?(n.currentValue=o,null!=e.achievement_percent&&(n.achievementPercent=e.achievement_percent.toNumber()),e.status&&(n.status=e.status),n.manualOverride=i?e.manual_override?.toNumber():null,n.manualOverrideReason=e.manual_override_reason||null,n.manualOverrideBy=e.manual_override_by||null,n.manualOverrideAt=e.manual_override_at?.toISOString()||null,n.valueSource=s):(n={initiativeId:e.initiative_id,year:e.year,quarter:e.quarter,targetValue:e.target_value?.toNumber()??0,currentValue:o,achievementPercent:e.achievement_percent?.toNumber()??0,status:e.status||"PENDING",submissionCount:e.submission_count,participatingUnits:e.participating_units||[],targetType:e.target_type||"COUNT",manualOverride:i?e.manual_override?.toNumber():null,manualOverrideReason:e.manual_override_reason||null,manualOverrideBy:e.manual_override_by||null,manualOverrideAt:e.manual_override_at?.toISOString()||null,valueSource:s},a.push(n))}for(let[e,t]of(console.log(`[KPI Progress] Processing ${g.size} contribution totals...`),g)){let r;console.log(`[KPI Progress] Processing contribution key: ${e}, total=${t.total}, count=${t.count}`);let[a,n,i,o]=e.split("|"),s=parseInt(i),u=parseInt(o);console.log(`[KPI Progress] Parsed: kraIdKey=${a}, initiativeId=${n}, year=${s}, quarter=${u}`),f.has(a)||(f.set(a,new Map),console.log(`[KPI Progress] Created new kraMap for ${a}`));let d=f.get(a);d.has(n)||(d.set(n,[]),console.log(`[KPI Progress] Created new progressItems array for ${n}`));let c=d.get(n);console.log(`[KPI Progress] Current progressItems length: ${c.length}`);let p=c.find(e=>e.year===s&&e.quarter===u);if(console.log(`[KPI Progress] Found existing progressItem: ${!!p}`),!p){let e=l.find(e=>(0,R.normalizeKraId)(e.kra_id)===a),t=e?.initiatives.find(e=>e.id===n),r=t?.targets?.timeline_data?.find(e=>e.year===s),i=t?.targets?.type||"count",o=E(i);console.log(`[KPI Progress] Target lookup for ${n}:`),console.log(`  - KRA found: ${!!e}`),console.log(`  - Initiative found: ${!!t}`),console.log(`  - Targets object: ${!!t?.targets}`),console.log(`  - Timeline data array: ${t?.targets?.timeline_data?.length||0} items`),console.log(`  - Looking for year: ${s}`),console.log(`  - Timeline data found: ${!!r}`),r&&console.log(`  - Target value: ${r.target_value}`),p={initiativeId:n,year:s,quarter:u,targetValue:r?.target_value??0,currentValue:0,achievementPercent:0,status:"PENDING",submissionCount:0,participatingUnits:[],targetType:o,manualOverride:null,manualOverrideReason:null,manualOverrideBy:null,manualOverrideAt:null,valueSource:"none",hasUnapprovedData:!1},c.push(p)}console.log(`[KPI Progress] progressItem found/created, valueSource=${p.valueSource}, currentValue=${p.currentValue}`),console.log("[KPI Progress] Updating progressItem with contribution data (overriding any manual value)");let g=t.targetType.toUpperCase();r="SNAPSHOT"===g||"MILESTONE"===g||"BOOLEAN"===g||"TEXT_CONDITION"===g?t.latestValue:"RATE"===g||"PERCENTAGE"===g?t.count>0?Math.round(t.total/t.count):0:t.total,p.currentValue=r,p.submissionCount=t.count,p.valueSource="qpro",p.manualOverride=null,p.manualOverrideReason=null,p.manualOverrideBy=null,p.manualOverrideAt=null,!0!==p.hasUnapprovedData&&(p.hasUnapprovedData=!1),console.log(`[KPI Progress] Applied contribution: ${e} -> currentValue=${r}, submissionCount=${t.count} (type: ${g}, method: ${"SNAPSHOT"===g?"latest":"RATE"===g||"PERCENTAGE"===g?"average":"sum"})`)}for(let[e,t]of f)for(let[r,a]of t)for(let t of a){let a=t._pctCount,n=t._pctSum;a&&void 0!==n&&(t.currentValue=Math.round(n/a));let i="number"==typeof t.currentValue?t.currentValue:parseFloat(String(t.currentValue))||0;if(0===t.achievementPercent&&i>0){let e="number"==typeof t.targetValue?t.targetValue:parseFloat(String(t.targetValue))||0;console.log(`[KPI Progress] Final calc check for ${t.initiativeId}: currentValue=${i}, targetValue=${e} (from item.targetValue=${t.targetValue})`),e>0?(t.achievementPercent=Math.round(i/e*1e4)/100,console.log(`[KPI Progress] Achievement calc for ${t.initiativeId}: currentValue=${i}, targetValue=${e}, achievement=${t.achievementPercent}%`)):console.log(`[KPI Progress] ⚠️ SKIP: target is 0 or negative for ${t.initiativeId}`)}t.achievementPercent=Math.min(100,Math.max(0,t.achievementPercent||0));let l=(0,R.getInitiativeTargetMeta)(T.default,e,r,t.year),o=String(l.targetType||"").toLowerCase();"percentage"===o&&(t.currentValue=Math.min(100,Math.max(0,i))),"PENDING"===t.status&&t.achievementPercent>0&&(t.achievementPercent>=100?t.status="MET":t.achievementPercent>=80?t.status="ON_TRACK":t.status="MISSED")}let A=a?[s]:l,$=[];for(let e of A){if(!e)continue;let t=(0,R.normalizeKraId)(e.kra_id),r={kraId:e.kra_id,kraTitle:e.kra_title,initiatives:[]};for(let a of e.initiatives||[]){let e=f.get(t),l=e?.get(a.id)||[];console.log(`[KPI Progress Response] Building response for ${a.id}: found ${l.length} progress items in progressMap`);let o=a.targets?.timeline_data?.find(e=>e.year===n);if(o){let e=i?[i]:[1,2,3,4],t=a.targets?.type||"count",r=E(t);for(let t of e)l.find(e=>e.year===n&&e.quarter===t)||l.push({initiativeId:a.id,year:n,quarter:t,targetValue:o.target_value,currentValue:0,achievementPercent:0,status:"PENDING",submissionCount:0,participatingUnits:[],targetType:r,manualOverride:null,manualOverrideReason:null,manualOverrideBy:null,manualOverrideAt:null,valueSource:"none"});l.sort((e,t)=>e.quarter-t.quarter)}r.initiatives.push({id:a.id,outputs:a.key_performance_indicator?.outputs||"",outcomes:a.key_performance_indicator?.outcomes||"",targetType:a.targets?.type||"count",progress:l}),l.length>0&&l.some(e=>0!==e.currentValue)&&console.log(`[KPI Progress Response] Added ${a.id} with ${l.length} items:`,l.map(e=>`Q${e.quarter}=${e.currentValue}`).join(", "))}$.push(r)}return console.log(`[KPI Progress] Final response: ${$.length} KRAs`),_.NextResponse.json({success:!0,year:n,quarter:i,data:a?$[0]:$},{headers:{"Cache-Control":"no-store, no-cache, must-revalidate, proxy-revalidate",Pragma:"no-cache",Expires:"0"}})}catch(e){return console.error("Error fetching KPI progress:",e),_.NextResponse.json({error:"Failed to fetch KPI progress",details:e.message},{status:500,headers:{"Cache-Control":"no-store, no-cache, must-revalidate, proxy-revalidate",Pragma:"no-cache",Expires:"0"}})}}async function $(e){try{let t=await (0,I.requireAuth)(e);if("status"in t)return t;let{user:r}=t,{kraId:a,initiativeId:n,year:i,quarter:l,value:o,reason:s,targetType:u}=await e.json();if(!a||!n||!i||!l)return _.NextResponse.json({error:"Missing required fields: kraId, initiativeId, year, quarter"},{status:400});let d=u;if(!d){let e=T.default.kras||[],t=(0,R.normalizeKraId)(a),r=e.find(e=>(0,R.normalizeKraId)(e.kra_id)===t),i=r?.initiatives?.find(e=>e.id===n);d=E(i?.targets?.type||"count")}let c=(0,R.normalizeKraId)(a),p=[a,c,c.replace(/\s+/g,"")],g=await P.default.kRAggregation.findFirst({where:{kra_id:{in:p},initiative_id:n,year:i,quarter:l}});if(!g){let e=(T.default.kras||[]).find(e=>(0,R.normalizeKraId)(e.kra_id)===c),t=e?.initiatives?.find(e=>e.id===n),a=t?.targets?.timeline_data?.find(e=>e.year===i),u=a?.target_value??0,p=0,g=null,m="NOT_APPLICABLE";if(null!==o)if("TEXT_CONDITION"===d)"Met"===o?(p=100,m="MET"):"In Progress"===o?(p=50,m="ON_TRACK"):(p=0,m="MISSED");else if("MILESTONE"===d)p=100*(1===o||"1"===o),g=+(1===o||"1"===o),m=1===o||"1"===o?"MET":"NOT_APPLICABLE";else{let e="number"==typeof o?o:parseFloat(String(o).replace(/,/g,""))||0,t="number"==typeof u?u:parseFloat(String(u))||0;p=t>0?e/t*100:0,g=e,p>=100?m="MET":p>=80?m="ON_TRACK":e>0&&(m="MISSED")}let v=await P.default.kRAggregation.create({data:{kra_id:c,kra_title:e?.kra_title||"",initiative_id:n,year:i,quarter:l,total_reported:0,target_value:"number"==typeof u?u:parseFloat(String(u))||0,achievement_percent:p,submission_count:0,participating_units:[],status:m,target_type:d,current_value:null!==o?String(o):null,manual_override:g,manual_override_reason:s||null,manual_override_by:r.id,manual_override_at:new Date}});return _.NextResponse.json({success:!0,message:"Manual override created",data:{id:v.id,kraId:c,initiativeId:n,year:i,quarter:l,value:o,valueSource:null!==o?"manual":"none"}})}let m=g.target_value?.toNumber()??0,v=0,f=null!==o?o:g.total_reported??0,y=null,h="NOT_APPLICABLE";if(null!==o)if("TEXT_CONDITION"===d)"Met"===o?(v=100,h="MET"):"In Progress"===o?(v=50,h="ON_TRACK"):(v=0,h="MISSED"),f=String(o);else if("MILESTONE"===d){let e=1===o||"1"===o;v=100*!!e,h=e?"MET":"NOT_APPLICABLE",f=y=+!!e}else{let e="number"==typeof o?o:parseFloat(String(o).replace(/,/g,""))||0;f=e,y=e,m>0&&(v=e/m*100),v>=100?h="MET":v>=80?h="ON_TRACK":e>0&&(h="MISSED")}else{let e=g.total_reported??0;f=e,m>0&&e>0&&(h=(v=e/m*100)>=100?"MET":v>=80?"ON_TRACK":"MISSED")}let A=await P.default.kRAggregation.update({where:{id:g.id},data:{target_type:d,current_value:null!==o?String(o):g.current_value,manual_override:y,manual_override_reason:null!==o&&s||null,manual_override_by:null!==o?r.id:null,manual_override_at:null!==o?new Date:null,achievement_percent:v,status:h}});return _.NextResponse.json({success:!0,message:null!==o?"Manual override saved":"Manual override cleared",data:{id:A.id,kraId:g.kra_id,initiativeId:n,year:i,quarter:l,currentValue:f,manualOverride:o,qproValue:g.total_reported,achievementPercent:v,status:h,targetType:d,valueSource:null!==o?"manual":(g.total_reported??0)>0?"qpro":"none"}})}catch(e){return console.error("Error saving KPI manual override:",e),_.NextResponse.json({error:"Failed to save manual override",details:e.message},{status:500})}}e.s(["GET",()=>A,"PATCH",()=>$],78738);var C=e.i(78738);let N=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/kpi-progress/route",pathname:"/api/kpi-progress",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/kpi-progress/route.ts",nextConfigOutput:"standalone",userland:C}),{workAsyncStorage:O,workUnitAsyncStorage:S,serverHooks:w}=N;function K(){return(0,a.patchFetch)({workAsyncStorage:O,workUnitAsyncStorage:S})}async function b(e,t,a){N.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let _="/api/kpi-progress/route";_=_.replace(/\/index$/,"")||"/";let I=await N.prepare(e,t,{srcPage:_,multiZoneDraftMode:!1});if(!I)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:P,params:T,nextConfig:R,parsedUrl:E,isDraftMode:A,prerenderManifest:$,routerServerContext:C,isOnDemandRevalidate:O,revalidateOnlyGenerated:S,resolvedPathname:w,clientReferenceManifest:K,serverActionsManifest:b}=I,M=(0,s.normalizeAppPath)(_),q=!!($.dynamicRoutes[M]||$.routes[w]),k=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,E,!1):t.end("This page could not be found"),null);if(q&&!A){let e=!!$.routes[w],t=$.dynamicRoutes[M];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await k();throw new y.NoFallbackError}}let x=null;!q||N.isDev||A||(x="/index"===(x=w)?"/":x);let V=!0===N.isDev||!q,D=q&&!V;b&&K&&(0,l.setReferenceManifestsSingleton)({page:_,clientReferenceManifest:K,serverActionsManifest:b,serverModuleMap:(0,o.createServerModuleMap)({serverActionsManifest:b})});let U=e.method||"GET",F=(0,i.getTracer)(),L=F.getActiveScopeSpan(),z={params:T,prerenderManifest:$,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:V,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,a)=>N.onRequestError(e,t,a,C)},sharedContext:{buildId:P}},H=new u.NodeNextRequest(e),B=new u.NodeNextResponse(t),j=d.NextRequestAdapter.fromNodeNextRequest(H,(0,d.signalFromNodeResponse)(t));try{let l=async e=>N.handle(j,z).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=F.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let a=r.get("next.route");if(a){let t=`${U} ${a}`;e.setAttributes({"next.route":a,"http.route":a,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${_}`)}),o=!!(0,n.getRequestMeta)(e,"minimalMode"),s=async n=>{var i,s;let u=async({previousCacheEntry:r})=>{try{if(!o&&O&&S&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await l(n);e.fetchMetrics=z.renderOpts.fetchMetrics;let s=z.renderOpts.pendingWaitUntil;s&&a.waitUntil&&(a.waitUntil(s),s=void 0);let u=z.renderOpts.collectedTags;if(!q)return await (0,g.sendResponse)(H,B,i,z.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(i.headers);u&&(t[f.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==z.renderOpts.collectedRevalidate&&!(z.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&z.renderOpts.collectedRevalidate,a=void 0===z.renderOpts.collectedExpire||z.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:z.renderOpts.collectedExpire;return{value:{kind:h.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:a}}}}catch(t){throw(null==r?void 0:r.isStale)&&await N.onRequestError(e,t,{routerKind:"App Router",routePath:_,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:O})},C),t}},d=await N.handleResponse({req:e,nextConfig:R,cacheKey:x,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:$,isRoutePPREnabled:!1,isOnDemandRevalidate:O,revalidateOnlyGenerated:S,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:o});if(!q)return null;if((null==d||null==(i=d.value)?void 0:i.kind)!==h.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(s=d.value)?void 0:s.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",O?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),A&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,m.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&q||c.delete(f.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,v.getCacheControlHeader)(d.cacheControl)),await (0,g.sendResponse)(H,B,new Response(d.value.body,{headers:c,status:d.value.status||200})),null};L?await s(L):await F.withPropagatedContext(e.headers,()=>F.trace(c.BaseServerSpan.handleRequest,{spanName:`${U} ${_}`,kind:i.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},s))}catch(t){if(t instanceof y.NoFallbackError||await N.onRequestError(e,t,{routerKind:"App Router",routePath:M,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:O})}),q)throw t;return await (0,g.sendResponse)(H,B,new Response(null,{status:500})),null}}e.s(["handler",()=>b,"patchFetch",()=>K,"routeModule",()=>N,"serverHooks",()=>w,"workAsyncStorage",()=>O,"workUnitAsyncStorage",()=>S],99737)}];

//# sourceMappingURL=node_modules_next_dist_esm_build_templates_app-route_cadf4767.js.map