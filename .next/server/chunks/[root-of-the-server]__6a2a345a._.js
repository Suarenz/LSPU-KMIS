module.exports=[18622,(e,r,t)=>{r.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,r,t)=>{r.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,r,t)=>{r.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,r,t)=>{r.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},70406,(e,r,t)=>{r.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},93695,(e,r,t)=>{r.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},29173,(e,r,t)=>{r.exports=e.x("@prisma/client",()=>require("@prisma/client"))},15270,e=>{"use strict";var r=e.i(29173);let t=globalThis.prisma||new r.PrismaClient({log:["query","info","warn","error"]});e.s(["default",0,t])},75188,e=>{"use strict";let r=new class{secret;constructor(){this.secret=process.env.JWT_SECRET||"6dFk5d0vbyLnZC0Amy83LtI47DsNr/KB4M+FgbUc6njd4cjk7XB2/8nTuhQDWW8OOgQ6fI74huxJE3a/RP2giw=="}stringToUint8Array(e){return new TextEncoder().encode(e)}uint8ArrayToBase64Url(e){let r="";for(let t=0;t<e.byteLength;t++)r+=String.fromCharCode(e[t]);return btoa(r).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}async importSecret(){let e=new TextEncoder().encode(this.secret);return await crypto.subtle.importKey("raw",e,{name:"HMAC",hash:"SHA-256"},!1,["sign","verify"])}async generateToken(e){try{let r=Math.floor(Date.now()/1e3),t={...e,iat:r,exp:r+3600},a=this.uint8ArrayToBase64Url(this.stringToUint8Array(JSON.stringify({alg:"HS256",typ:"JWT"}))),n=this.uint8ArrayToBase64Url(this.stringToUint8Array(JSON.stringify(t))),i=`${a}.${n}`,s=await this.importSecret(),o=new TextEncoder().encode(i),l=await crypto.subtle.sign("HMAC",s,o),c=new Uint8Array(l),u=this.uint8ArrayToBase64Url(c);return`${i}.${u}`}catch(e){throw console.error("JWT token generation failed:",e),Error("Failed to generate JWT token")}}async verifyToken(e){try{if(!e||"string"!=typeof e||""===e.trim())return console.error("Invalid token provided for verification"),null;let r=e.split(".");if(3!==r.length)return console.error("Token format is invalid"),null;let[t,a,n]=r;if(!this.base64UrlDecode(t))return console.error("Failed to decode token header"),null;let i=this.base64UrlDecode(a);if(!i)return console.error("Failed to decode token payload"),null;let s=JSON.parse(i),o=Math.floor(Date.now()/1e3);if(s.exp&&s.exp<o)return console.error("Token has expired"),null;let l=await this.importSecret();if(!await this.verifySignature(`${t}.${a}`,n,l))return console.error("Token signature verification failed"),null;return s}catch(e){return console.error("Token verification failed:",e?.message||e),null}}async verifySignature(e,r,t){try{let a=this.base64UrlDecodeToUint8Array(r);if(!a)return!1;let n=new TextEncoder().encode(e),i=new Uint8Array(a.buffer,a.byteOffset,a.byteLength),s=new Uint8Array(n.buffer,n.byteOffset,n.byteLength);return await crypto.subtle.verify("HMAC",t,i,s)}catch(e){return console.error("Signature verification error:",e),!1}}decodeToken(e){try{if(!e||"string"!=typeof e||""===e.trim())return null;let r=e.split(".");if(3!==r.length)return console.error("Token format is invalid"),null;let t=r[1],a=this.base64UrlDecode(t);if(!a)return null;return JSON.parse(a)}catch(e){return console.error("Token decoding failed:",e?.message||e),null}}isTokenExpired(e){try{let r=this.decodeToken(e);if(!r||!r.exp)return!0;let t=Math.floor(Date.now()/1e3);return r.exp<t}catch(e){return console.error("Error checking token expiration:",e),!0}}base64UrlDecode(e){try{let r="=".repeat((4-e.length%4)%4),t=e.replace(/-/g,"+").replace(/_/g,"/")+r,a=atob(t);return decodeURIComponent(escape(a))}catch(e){return console.error("Base64 URL decode error:",e),null}}base64UrlDecodeToUint8Array(e){try{let r="=".repeat((4-e.length%4)%4),t=e.replace(/-/g,"+").replace(/_/g,"/")+r,a=atob(t),n=new Uint8Array(a.length);for(let e=0;e<a.length;e++)n[e]=a.charCodeAt(e);return n}catch(e){return console.error("Base64 URL decode to Uint8Array error:",e),null}}};e.s(["default",0,r])},81563,83274,e=>{"use strict";var r=e.i(89171),t=e.i(75188),a=e.i(15270);function n(e,r){return e===r}function i(e,r){return r.includes(e)}async function s(e,n){let s=e.headers.get("authorization"),o=null;if(s&&s.startsWith("Bearer "))o=s.substring(7);else{let r=e.cookies;o=r.get("access_token")?.value}if(!o)return e.nextUrl.pathname.startsWith("/api/")?r.NextResponse.json({error:"Authentication required"},{status:401}):r.NextResponse.redirect(new URL("/login",e.url));let l=await t.default.verifyToken(o);if(!l)return(console.error("Token verification failed:",o?o.substring(0,20)+"...":"null"),e.nextUrl.pathname.startsWith("/api/"))?r.NextResponse.json({error:"Invalid or expired token"},{status:401}):r.NextResponse.redirect(new URL("/",e.url));if(console.log("Decoded token:",l),!l.userId)return(console.error("Token does not contain userId:",l),e.nextUrl.pathname.startsWith("/api/"))?r.NextResponse.json({error:"Invalid token: missing user ID"},{status:401}):r.NextResponse.redirect(new URL("/login",e.url));let c=await a.default.user.findUnique({where:{id:l.userId},select:{id:!0,email:!0,name:!0,role:!0,unitId:!0}});return c?n&&n.length>0&&!i(c.role,n)?e.nextUrl.pathname.startsWith("/api/")?r.NextResponse.json({error:"User does not have required role to perform this action"},{status:403}):r.NextResponse.redirect(new URL("/unauthorized",e.url)):{user:c}:(console.error("User not found with ID from token:",l.userId),r.NextResponse.redirect(new URL("/login",e.url)))}e.s(["hasAnyRole",()=>i,"hasRole",()=>n],83274),e.s(["requireAuth",()=>s],81563)},66680,(e,r,t)=>{r.exports=e.x("node:crypto",()=>require("node:crypto"))},14747,(e,r,t)=>{r.exports=e.x("path",()=>require("path"))},92509,(e,r,t)=>{r.exports=e.x("url",()=>require("url"))},83522,e=>{"use strict";function r(e){if(null==e)return null;if("number"==typeof e)return Number.isFinite(e)?e:null;let r=String(e).replace(/,/g,"").trim();if(!r)return null;let t=Number(r);return Number.isFinite(t)?t:null}function t(e){return String(e||"").replace(/\s+/g,"")}function a(e){let r=String(e||"").trim().replace(/\s+/g," "),t=r.match(/^KRA\s*(\d+)$/i);return t?`KRA ${t[1]}`:r}function n(e,n,i,s){let o=function(e,r,n){if(!r||!n)return null;let i=e?.kras||[],s=a(r),o=i.find(e=>a(e.kra_id)===s);if(!o?.initiatives)return null;let l=t(String(n)),c=o.initiatives.find(e=>t(String(e.id))===l);if(!c){let e=String(n).match(/KPI(\d+)/i);e&&(c=o.initiatives.find(r=>String(r.id).includes(`KPI${e[1]}`)))}return c||null}(e,n,i),l=o?.targets?.type??null,c="string"==typeof o?.targets?.unit_basis?o.targets.unit_basis:null,u=o?.targets?.target_scope==="PER_UNIT"?"PER_UNIT":"INSTITUTIONAL";return{targetType:l,targetValue:function(e,t){if(!Array.isArray(e)||0===e.length)return null;let a=e.find(e=>Number(e?.year)===t),n=r(a?.target_value);if(null!==n)return n;let i=e.map(e=>({year:Number(e?.year),target:r(e?.target_value)})).filter(e=>Number.isFinite(e.year)&&null!==e.target),s=i.filter(e=>e.year<=t).sort((e,r)=>r.year-e.year);if(s.length>0)return s[0].target;let o=i.sort((e,r)=>e.year-r.year);return o.length>0?o[0].target:null}(o?.targets?.timeline_data||[],s),targetScope:u,unitBasis:c}}function i(e){return e.reduce((e,r)=>e+("number"==typeof r&&Number.isFinite(r)?r:0),0)}function s(e){let{targetType:t,targetValue:a,targetScope:n="INSTITUTIONAL",unitMultiplier:s,activities:o}=e,l=String(t||"").toLowerCase(),c="PER_UNIT"===n?a*("number"==typeof s&&Number.isFinite(s)?s:1):a;if("percentage"===l){let e,t=0===(e=o.map(e=>{let t=r(e.reported);if(null===t)return null;if(t>=0&&t<=100)return t;let a=r(e.target);if(null!==a&&a>0&&t>=0){let e=t/a*100;if(e>=0&&e<=100)return e}return null}).filter(e=>"number"==typeof e&&Number.isFinite(e))).length?0:e.reduce((e,r)=>e+r,0)/e.length;return{totalReported:t,totalTarget:c,achievementPercent:c>0?t/c*100:0}}if("financial"===l||"count"===l){let e=i(o.map(e=>r(e.reported)));0===e&&o.length>0&&"count"===l&&(e=o.length);let t=c>0?e/c*100:0;return{totalReported:e,totalTarget:c,achievementPercent:t}}if("milestone"===l||"text_condition"===l){let e=o.some(e=>{let r=e.reported;return"number"==typeof r?r>0:"string"==typeof r&&r.trim().length>0});return{totalReported:+!!e,totalTarget:1,achievementPercent:100*!!e}}let u=i(o.map(e=>r(e.reported)));0===u&&o.length>0&&(u=o.length);let g=c>0?u/c*100:0;return{totalReported:u,totalTarget:c,achievementPercent:g}}e.s(["computeAggregatedAchievement",()=>s,"getInitiativeTargetMeta",()=>n,"normalizeKraId",()=>a])},73716,e=>{"use strict";var r=e.i(88461);let t=new class{config={uploadCacheTtl:3600,analysisCacheTtl:86400,processingStatusTtl:1800};constructor(e){e&&(this.config={...this.config,...e})}generateUploadCacheKey(e){return`qpro:upload:${e}`}generateAnalysisCacheKey(e){return`qpro:analysis:${e}`}generateProcessingStatusCacheKey(e){return`qpro:processing:${e}`}generateUserAnalysesCacheKey(e){return`qpro:user:${e}:analyses`}async cacheUpload(e){try{let t=this.generateUploadCacheKey(e.documentId);await r.redisService.set(t,e,this.config.uploadCacheTtl),console.log(`[QPRO Cache] Cached upload for document: ${e.documentId}`)}catch(e){console.error("[QPRO Cache] Error caching upload:",e)}}async getUploadCache(e){try{let t=this.generateUploadCacheKey(e),a=await r.redisService.get(t);return a&&console.log(`[QPRO Cache] Hit for upload: ${e}`),a}catch(e){return console.error("[QPRO Cache] Error retrieving upload cache:",e),null}}async cacheAnalysis(e){try{let t=this.generateAnalysisCacheKey(e.documentId),a={...e,timestamp:Date.now()};await r.redisService.set(t,a,this.config.analysisCacheTtl),console.log(`[QPRO Cache] Cached analysis for document: ${e.documentId}`)}catch(e){console.error("[QPRO Cache] Error caching analysis:",e)}}async getAnalysisCache(e){try{let t=this.generateAnalysisCacheKey(e),a=await r.redisService.get(t);return a&&console.log(`[QPRO Cache] Hit for analysis: ${e}`),a}catch(e){return console.error("[QPRO Cache] Error retrieving analysis cache:",e),null}}async updateProcessingStatus(e,t,a){try{let n=this.generateProcessingStatusCacheKey(e),i={analysisId:e,status:t,progress:a||0,timestamp:Date.now()};await r.redisService.set(n,i,this.config.processingStatusTtl),console.log(`[QPRO Cache] Updated processing status for analysis: ${e} - ${t}`)}catch(e){console.error("[QPRO Cache] Error updating processing status:",e)}}async getProcessingStatus(e){try{let t=this.generateProcessingStatusCacheKey(e),a=await r.redisService.get(t);if(a)return console.log(`[QPRO Cache] Hit for processing status: ${e}`),{status:a.status,progress:a.progress};return null}catch(e){return console.error("[QPRO Cache] Error retrieving processing status:",e),null}}async cacheUserAnalyses(e,t){try{let a=this.generateUserAnalysesCacheKey(e);await r.redisService.set(a,{analyses:t,timestamp:Date.now()},this.config.analysisCacheTtl),console.log(`[QPRO Cache] Cached ${t.length} analyses for user: ${e}`)}catch(e){console.error("[QPRO Cache] Error caching user analyses:",e)}}async getUserAnalysesCache(e){try{let t=this.generateUserAnalysesCacheKey(e),a=await r.redisService.get(t);if(a)return console.log(`[QPRO Cache] Hit for user analyses: ${e}`),a.analyses;return null}catch(e){return console.error("[QPRO Cache] Error retrieving user analyses cache:",e),null}}async invalidateUploadCache(e){try{let t=this.generateUploadCacheKey(e);await r.redisService.del(t),console.log(`[QPRO Cache] Invalidated upload cache for document: ${e}`)}catch(e){console.error("[QPRO Cache] Error invalidating upload cache:",e)}}async invalidateAnalysisCache(e){try{let t=this.generateAnalysisCacheKey(e);await r.redisService.del(t),console.log(`[QPRO Cache] Invalidated analysis cache for document: ${e}`)}catch(e){console.error("[QPRO Cache] Error invalidating analysis cache:",e)}}async invalidateProcessingStatus(e){try{let t=this.generateProcessingStatusCacheKey(e);await r.redisService.del(t),console.log(`[QPRO Cache] Invalidated processing status for analysis: ${e}`)}catch(e){console.error("[QPRO Cache] Error invalidating processing status:",e)}}async invalidateUserAnalysesCache(e){try{let t=this.generateUserAnalysesCacheKey(e);await r.redisService.del(t),console.log(`[QPRO Cache] Invalidated user analyses cache for user: ${e}`)}catch(e){console.error("[QPRO Cache] Error invalidating user analyses cache:",e)}}async invalidateAllUserCaches(e){try{let t=`qpro:user:${e}:*`,a=await r.redisService.keys(t);if(a.length>0){for(let e of a)await r.redisService.del(e);console.log(`[QPRO Cache] Invalidated ${a.length} caches for user: ${e}`)}}catch(e){console.error("[QPRO Cache] Error invalidating all user caches:",e)}}async getCacheStats(){try{let e=await r.redisService.keys("qpro:*");return{size:e.length,keys:e}}catch(e){return console.error("[QPRO Cache] Error getting cache stats:",e),{size:0,keys:[]}}}};e.s(["qproCacheService",0,t])},24868,(e,r,t)=>{r.exports=e.x("fs/promises",()=>require("fs/promises"))},74382,e=>{"use strict";var r=e.i(24868),t=e.i(14747);let a=new class{cachedPlan=null;async getStrategicPlan(){if(this.cachedPlan)return this.cachedPlan;try{let a=[];try{let{fileURLToPath:r}=e.r(92509),n=r(module.url||module.__filename||"");if(n){let e=t.default.dirname(n);a.push(t.default.join(e,"..","data","strategic_plan.json"))}}catch(e){}a.push(t.default.join(process.cwd(),"lib","data","strategic_plan.json")),a.push(t.default.join(process.cwd(),"strategic_plan.json"));let n=null,i=null;for(let e of a)try{await r.default.access(e),n=await r.default.readFile(e,"utf-8");break}catch(e){i=e}if(!n)throw i||Error("strategic_plan.json not found");return this.cachedPlan=JSON.parse(n),this.cachedPlan}catch(e){throw console.error("Error loading strategic plan:",e),Error("Failed to load strategic plan")}}async getKRA(e){return(await this.getStrategicPlan()).kras.find(r=>r.kra_id===e)||null}async getInitiative(e,r){let t=await this.getKRA(e);return t&&t.initiatives.find(e=>e.id===r)||null}async getTargetType(e,r){let t=await this.getInitiative(e,r);return t?t.targets.type:null}async getAllKRAsWithTypes(){let e=await this.getStrategicPlan(),r=[];for(let t of e.kras)for(let e of t.initiatives)r.push({kraId:t.kra_id,kraTitle:t.kra_title,initiativeId:e.id,targetType:e.targets.type});return r}invalidateCache(){this.cachedPlan=null}};e.s(["default",0,a,"strategicPlanService",0,a])},84101,e=>{"use strict";var r=e.i(15270),t=e.i(74382);let a=new class{async getTargetValue(e,r,a){try{let n=(await t.strategicPlanService.getStrategicPlan()).kras.find(r=>r.kra_id===e);if(!n)return null;let i=n.initiatives.find(e=>e.id===r);if(!i)return null;return i.targets.timeline_data.find(e=>e.year===a)||null}catch(e){return console.error("Error fetching target value:",e),null}}calculateCountAggregation(e,r){let t=e/r*100;return{achieved:e,target:r,achievementPercent:Math.round(100*t)/100,status:t>=100?"MET":t>=80?"ON_TRACK":"MISSED",variance:e-r,message:`${e}/${r} items achieved (${t.toFixed(1)}%)`}}calculatePercentageAggregation(e,r){if(e<0||e>100)return{achieved:e,target:r,achievementPercent:0,status:"NOT_APPLICABLE",variance:0,message:`Invalid percentage value: ${e}% (must be 0-100)`};let t=e/r*100;return{achieved:e,target:r,achievementPercent:Math.round(100*t)/100,status:e>=r?"MET":e>=.8*r?"ON_TRACK":"MISSED",variance:e-r,message:`${e}% / ${r}% target (${t.toFixed(1)}% achievement)`}}calculateFinancialAggregation(e,r){let t=e/r*100,a=e-r;return{achieved:`₱${e.toLocaleString()}`,target:`₱${r.toLocaleString()}`,achievementPercent:Math.round(100*t)/100,status:t>=100?"MET":t>=80?"ON_TRACK":"MISSED",variance:a,message:`₱${e.toLocaleString()} / ₱${r.toLocaleString()} achieved (${t.toFixed(1)}%)`}}calculateMilestoneAggregation(e,r){let t=!0===e||"yes"===e||"completed"===e||"YES"===e||"true"===e;return{achieved:t?"Completed":"Not Completed",target:r,achievementPercent:100*!!t,status:t?"MET":"MISSED",variance:0,message:`Milestone: ${r} - ${t?"COMPLETED":"PENDING"}`}}calculateTextConditionAggregation(e,r){let t=e.toLowerCase().includes(r.toLowerCase());return{achieved:e,target:r,achievementPercent:100*!!t,status:t?"MET":"MISSED",variance:0,message:`Condition: ${r} - ${t?"SATISFIED":"NOT SATISFIED"}`}}async calculateAggregation(e,r,t,a,n){try{let i=await this.getTargetValue(e,r,t);if(!i)return{achieved:"number"==typeof a?a:0,target:0,achievementPercent:0,status:"NOT_APPLICABLE",variance:0,message:"Target not found in strategic plan"};let s=i.target_value;switch(n.toLowerCase()){case"count":case"snapshot":return this.calculateCountAggregation(Number(a),Number(s));case"rate":case"percentage":return this.calculatePercentageAggregation(Number(a),Number(s));case"financial":return this.calculateFinancialAggregation(Number(a),Number(s));case"milestone":return this.calculateMilestoneAggregation(String(a),String(s));case"text_condition":return this.calculateTextConditionAggregation(String(a),String(s));default:return{achieved:"number"==typeof a?a:0,target:"number"==typeof s?s:0,achievementPercent:0,status:"NOT_APPLICABLE",variance:0,message:`Unknown target type: ${n}`}}}catch(e){return console.error("Aggregation calculation error:",e),{achieved:"number"==typeof a?a:0,target:0,achievementPercent:0,status:"NOT_APPLICABLE",variance:0,message:`Error calculating aggregation: ${e.message}`}}}async validateReportedValue(e,r){let t=[];switch(r.toLowerCase()){case"count":("number"!=typeof e||e<0||!Number.isInteger(e))&&t.push("Count must be a non-negative integer");break;case"percentage":("number"!=typeof e||e<0||e>100)&&t.push("Percentage must be between 0 and 100");break;case"financial":("number"!=typeof e||e<0)&&t.push("Financial amount must be non-negative");break;case"milestone":"string"!=typeof e&&"boolean"!=typeof e&&"number"!=typeof e&&t.push("Milestone must be a status indicator");break;case"text_condition":"string"!=typeof e&&t.push("Text condition must be a string")}return{valid:0===t.length,errors:t}}async rollupByUnit(e,t,a){try{let n=await r.default.qPROAnalysis.findMany({where:{year:t,quarter:a}}),i=new Map;for(let r of n)if(r.kras)for(let n of Array.isArray(r.kras)?r.kras:[r.kras]){let s=n.kraId||n.id;if(s===e)for(let e of n.activities||[]){let n=`${s}-${e.initiativeId}`;if(i.has(n)){let e=i.get(n);r.unitId&&!e.participatingUnits.includes(r.unitId)&&e.participatingUnits.push(r.unitId),e.submissionCount+=1}else i.set(n,{kraId:s,initiativeId:e.initiativeId,year:t,quarter:a,targetType:e.targetType||"count",metrics:{achieved:0,target:e.target,achievementPercent:0,status:"ON_TRACK",variance:0,message:""},participatingUnits:r.unitId?[r.unitId]:[],submissionCount:1})}}return Array.from(i.values())}catch(e){return console.error("Rollup by unit error:",e),[]}}async getUniversitySummary(e,t){try{let a=await r.default.qPROAnalysis.findMany({where:{year:e,quarter:t}}),n=0,i=0,s=0,o=0,l=0,c=new Set;for(let e of a)if(e.kras)for(let r of Array.isArray(e.kras)?e.kras:[e.kras]){let e=r.kraId||r.id;c.add(e);let t=r.status;"MET"===t?i++:"MISSED"===t?s++:"ON_TRACK"===t&&o++,l+=r.achievement||0}let u=(n=c.size)>0?l/n:0;return{totalKRAs:n,metKRAs:i,missedKRAs:s,onTrackKRAs:o,overallAchievementPercent:Math.round(100*u)/100}}catch(e){return console.error("University summary error:",e),{totalKRAs:0,metKRAs:0,missedKRAs:0,onTrackKRAs:0,overallAchievementPercent:0}}}};e.s(["default",0,a,"targetAggregationService",0,a])}];

//# sourceMappingURL=%5Broot-of-the-server%5D__6a2a345a._.js.map