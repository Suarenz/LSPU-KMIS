module.exports=[77273,e=>{"use strict";var t=e.i(15270),a=e.i(89892);let i=new(e.i(92674)).default,o=new class{async findUserById(e){let a=await t.default.user.findUnique({where:{id:e}});return a?{id:a.id,email:a.email,name:a.name,role:a.role,unitId:a.unitId||void 0,avatar:a.avatar||void 0,createdAt:a.createdAt,updatedAt:a.updatedAt}:null}async getDocuments(e=1,a=10,i,o,r,n,d="desc",s){let c={status:"ACTIVE"};if(i&&"all"!==i&&(c.category=i),s&&(c.unitId=s),o){let e={OR:[{title:{contains:o,mode:"insensitive"}},{description:{contains:o,mode:"insensitive"}},{tags:{array_contains:[o]}}]};Object.keys(c).length>1?(c.AND=c.AND||[],c.AND.push(e)):Object.assign(c,e)}if(r){let e=await this.findUserById(r);if(e&&"ADMIN"!==e.role&&"FACULTY"!==e.role){let t={OR:[{uploadedById:e.id},{permissions:{some:{userId:e.id,permission:{in:["READ","WRITE","ADMIN"]}}}}]};Object.keys(c).length>1?(c.AND=c.AND||[],c.AND.push(t)):Object.assign(c,t)}}try{let[i,o]=await Promise.all([t.default.document.findMany({where:c,skip:(e-1)*a,take:a,orderBy:n?{[n]:d}:{uploadedAt:"desc"},include:{uploadedByUser:!0,documentUnit:!0}}),t.default.document.count({where:c})]);return{documents:i.map(e=>({...e,tags:Array.isArray(e.tags)?e.tags:"object"==typeof e.tags&&null!==e.tags?Object.values(e.tags):[],unitId:e.unitId??void 0,blobName:e.blobName??void 0,versionNotes:e.versionNotes??void 0,downloadsCount:e.downloadsCount??0,viewsCount:e.viewsCount??0,uploadedBy:e.uploadedByUser?.name||e.uploadedBy,unit:e.documentUnit||void 0,uploadedAt:new Date(e.uploadedAt),createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt)})),total:o}}catch(e){if(console.error("Database connection error in getDocuments:",e),e instanceof Error&&(e.message.includes("Authentication failed")||e.message.includes("password")||e.message.includes("credentials")))throw Error("Database authentication failed. Please check your database credentials.");throw e}}async getDocumentById(e,a){try{if(!e||"string"!=typeof e||""===e.trim()||e.includes("undefined")||e.includes(".pdf")||e.includes("."))return console.warn("Invalid document ID format received in getDocumentById:",e),null;let i=await t.default.document.findUnique({where:{id:e},include:{uploadedByUser:!0,documentUnit:!0}});if(!i)return null;if(a){let o=await this.findUserById(a);if(o&&"ADMIN"!==o.role&&"FACULTY"!==o.role&&!await t.default.documentPermission.findFirst({where:{documentId:e,userId:o.id,permission:{in:["READ","WRITE","ADMIN"]}}})&&i.uploadedById!==o.id)return null}return{...i,tags:Array.isArray(i.tags)?i.tags.map(e=>String(e)):"object"==typeof i.tags&&null!==i.tags?Object.values(i.tags).map(e=>String(e)):[],year:i.year??void 0,quarter:i.quarter??void 0,unitId:i.unitId||void 0,blobName:i.blobName??void 0,versionNotes:i.versionNotes||void 0,downloadsCount:i.downloadsCount||0,viewsCount:i.viewsCount||0,uploadedBy:i.uploadedByUser?.name||i.uploadedBy,status:i.status,unit:i.documentUnit&&i.documentUnit.code?{id:i.documentUnit.id,name:i.documentUnit.name,code:i.documentUnit.code,description:i.documentUnit.description||void 0,createdAt:i.documentUnit.createdAt,updatedAt:i.documentUnit.updatedAt}:void 0,uploadedAt:new Date(i.uploadedAt),createdAt:new Date(i.createdAt),updatedAt:new Date(i.updatedAt),colivaraDocumentId:i.colivaraDocumentId??void 0,colivaraProcessingStatus:i.colivaraProcessingStatus??void 0,colivaraProcessedAt:i.colivaraProcessedAt?new Date(i.colivaraProcessedAt):void 0,colivaraChecksum:i.colivaraChecksum??void 0}}catch(e){if(console.error("Database connection error in getDocumentById:",e),e instanceof Error&&(e.message.includes("Authentication failed")||e.message.includes("password")||e.message.includes("credentials")))throw Error("Database authentication failed. Please check your database credentials.");throw e}}async createDocument(e,a,i,o,r,n,d,s,c,u,l){try{console.log("Creating document in database...",{title:e,description:a,category:i,tags:o,uploadedBy:r,fileUrl:n,fileName:d,fileType:s,fileSize:c,userId:u});let m=await this.findUserById(u);if(console.log("User lookup result:",{user:!!m,role:m?.role}),!m||!["ADMIN","FACULTY"].includes(m.role))throw Error("Only admins and faculty can upload documents");let f=await t.default.document.create({data:{title:e,description:a,category:i,tags:o||[],uploadedBy:m.name,uploadedById:m.id,fileUrl:n,fileName:d,fileType:s,fileSize:c,unitId:l||void 0,status:"ACTIVE"},include:{uploadedByUser:!0,documentUnit:!0}});return console.log("Document created:",f.id),await t.default.documentPermission.create({data:{documentId:f.id,userId:m.id,permission:"ADMIN"}}),console.log("Document permissions granted"),{id:f.id,title:f.title,description:f.description,category:f.category,tags:Array.isArray(f.tags)?f.tags.map(e=>String(e)):"object"==typeof f.tags&&null!==f.tags?Object.values(f.tags).map(e=>String(e)):[],uploadedBy:f.uploadedByUser?.name||f.uploadedBy,uploadedById:f.uploadedById,uploadedAt:new Date(f.uploadedAt),fileUrl:f.fileUrl,fileName:f.fileName,fileType:f.fileType,fileSize:f.fileSize,downloadsCount:f.downloadsCount||0,viewsCount:f.viewsCount||0,version:f.version||1,versionNotes:f.versionNotes||void 0,status:f.status,createdAt:new Date(f.createdAt),updatedAt:new Date(f.updatedAt),unitId:f.unitId||void 0,unit:f.documentUnit&&f.documentUnit.code?{id:f.documentUnit.id,name:f.documentUnit.name,code:f.documentUnit.code,description:f.documentUnit.description||void 0,createdAt:f.documentUnit.createdAt,updatedAt:f.documentUnit.updatedAt}:void 0,colivaraDocumentId:f.colivaraDocumentId??void 0,colivaraProcessingStatus:f.colivaraProcessingStatus??void 0,colivaraProcessedAt:f.colivaraProcessedAt?new Date(f.colivaraProcessedAt):void 0,colivaraChecksum:f.colivaraChecksum??void 0}}catch(e){if(console.error("Database connection error in createDocument:",e),e instanceof Error&&(e.message.includes("Authentication failed")||e.message.includes("password")||e.message.includes("credentials")))throw Error("Database authentication failed. Please check your database credentials.");throw e}}async updateDocument(e,a,i,o,r,n,d,s){try{let s=await t.default.document.findUnique({where:{id:e}});if(!s)return null;let c=null,u=null;if(d&&(u=await this.findUserById(d))&&(c=await t.default.documentPermission.findFirst({where:{documentId:e,userId:u.id,permission:{in:["WRITE","ADMIN"]}}})),d&&!c&&u?.role!=="ADMIN"&&s.uploadedById!==u?.id)throw Error("User does not have permission to update this document");let l=await t.default.document.update({where:{id:e},data:{...a&&{title:a},...i&&{description:i},...o&&{category:o},...void 0!==r&&{tags:r||[]},...void 0!==n&&{unitId:n},updatedAt:new Date},include:{uploadedByUser:!0,documentUnit:!0}});return{id:l.id,title:l.title,description:l.description,category:l.category,tags:Array.isArray(l.tags)?l.tags.map(e=>String(e)):"object"==typeof l.tags&&null!==l.tags?Object.values(l.tags).map(e=>String(e)):[],uploadedBy:l.uploadedByUser?.name||l.uploadedBy,uploadedById:l.uploadedById,uploadedAt:new Date(l.uploadedAt),fileUrl:l.fileUrl,fileName:l.fileName,fileType:l.fileType,fileSize:l.fileSize,downloadsCount:l.downloadsCount||0,viewsCount:l.viewsCount||0,version:l.version||1,versionNotes:l.versionNotes||void 0,status:l.status,createdAt:new Date(l.createdAt),updatedAt:new Date(l.updatedAt),unitId:l.unitId||void 0,unit:l.documentUnit&&l.documentUnit.code?{id:l.documentUnit.id,name:l.documentUnit.name,code:l.documentUnit.code,description:l.documentUnit.description||void 0,createdAt:l.documentUnit.createdAt,updatedAt:l.documentUnit.updatedAt}:void 0,colivaraDocumentId:l.colivaraDocumentId??void 0,colivaraProcessingStatus:l.colivaraProcessingStatus??void 0,colivaraProcessedAt:l.colivaraProcessedAt?new Date(l.colivaraProcessedAt):void 0,colivaraChecksum:l.colivaraChecksum??void 0}}catch(e){if(console.error("Database connection error in updateDocument:",e),e instanceof Error&&(e.message.includes("Authentication failed")||e.message.includes("password")||e.message.includes("credentials")))throw Error("Database authentication failed. Please check your database credentials.");throw e}}async deleteDocument(e,o){try{let r=await t.default.document.findUnique({where:{id:e},include:{permissions:!0,comments:!0,downloads:!0,views:!0}});if(!r)return!1;let n=await this.findUserById(o);if(!n)throw Error("User not found");if(!await t.default.documentPermission.findFirst({where:{documentId:e,userId:n.id,permission:"ADMIN"}})&&"ADMIN"!==n.role&&r.uploadedById!==n.id)throw Error("User does not have permission to delete this document");let d=await t.default.kPIContribution.findMany({where:{document_id:e},select:{id:!0,kra_id:!0,initiative_id:!0,value:!0,year:!0,quarter:!0,target_type:!0}}),s=await t.default.qPROAnalysis.findFirst({where:{documentId:e},select:{id:!0,year:!0,quarter:!0,unitId:!0,aggregationActivities:{where:{isApproved:!0},select:{initiative_id:!0,reported:!0,aggregation_id:!0}}}}),c=new Map;for(let e of d){let t=`${e.kra_id}|${e.initiative_id}|${e.year}|${e.quarter}`;c.set(t,{kraId:e.kra_id,initiativeId:e.initiative_id,value:e.value,year:e.year,quarter:e.quarter})}let u=[];if(0===d.length&&s?.aggregationActivities)for(let e of s.aggregationActivities)e.aggregation_id&&null!==e.reported&&u.push({aggregationId:e.aggregation_id,initiativeId:e.initiative_id,reportedValue:e.reported});console.log(`[Document Delete] Found ${d.length} KPIContributions to deduct, ${u.length} legacy aggregation activities`),await t.default.documentComment.deleteMany({where:{documentId:e}}),await t.default.documentDownload.deleteMany({where:{documentId:e}}),await t.default.documentView.deleteMany({where:{documentId:e}}),await t.default.documentPermission.deleteMany({where:{documentId:e}}),await t.default.colivaraIndex.deleteMany({where:{documentId:e}});try{let e=r.fileUrl.split("/").pop();e?await a.default.deleteFile(e)||console.warn(`Failed to delete file ${e} from storage, but continuing with database deletion`):console.warn(`Could not extract filename from URL: ${r.fileUrl}`)}catch(e){console.error("Error deleting file from storage:",e)}try{i.isInitialized||await i.initialize(),await i.deleteFromIndex(e)}catch(t){console.error(`Failed to delete document ${e} from Colivara index:`,t)}if(await t.default.document.delete({where:{id:e}}),c.size>0)for(let[,e]of(console.log(`[Document Delete] Deducting ${c.size} KPI contributions from aggregations`),c))try{let a=await t.default.kRAggregation.findFirst({where:{year:e.year,quarter:e.quarter,kra_id:e.kraId,initiative_id:e.initiativeId}});if(!a){console.log(`[Document Delete] No KRAggregation found for ${e.kraId}/${e.initiativeId}`);continue}let i=Math.max(0,(a.total_reported??0)-e.value),o=Math.max(0,a.submission_count-1);if(0===o)await t.default.kRAggregation.delete({where:{id:a.id}}),console.log(`[Document Delete] Deleted empty KRAggregation: ${a.id}`);else{let r=a.target_value?.toNumber()??1,n=r>0?i/r*100:0;await t.default.kRAggregation.update({where:{id:a.id},data:{total_reported:i,submission_count:o,achievement_percent:Math.min(n,100),last_updated:new Date}}),console.log(`[Document Delete] Deducted ${e.value} from KRAggregation ${a.id}: new total=${i}`)}}catch(t){console.error(`[Document Delete] Error deducting contribution for ${e.initiativeId}:`,t)}else if(u.length>0)for(let e of(console.log(`[Document Delete] Legacy recalculating ${u.length} affected KRAggregation records`),u))try{let a=await t.default.aggregationActivity.findMany({where:{aggregation_id:e.aggregationId,isApproved:!0},select:{reported:!0}});if(0===a.length)await t.default.kRAggregation.delete({where:{id:e.aggregationId}}),console.log(`[Document Delete] Deleted orphaned KRAggregation: ${e.aggregationId}`);else{let i=a.reduce((e,t)=>e+(t.reported??0),0),o=a.length,r=await t.default.kRAggregation.findUnique({where:{id:e.aggregationId},select:{target_value:!0}}),n=r?.target_value?.toNumber()??1,d=n>0?i/n*100:0;await t.default.kRAggregation.update({where:{id:e.aggregationId},data:{total_reported:i,submission_count:o,achievement_percent:Math.min(d,100),last_updated:new Date}}),console.log(`[Document Delete] Updated KRAggregation ${e.aggregationId}: total=${i}, count=${o}`)}}catch(t){console.error(`[Document Delete] Error recalculating KRAggregation ${e.aggregationId}:`,t)}return!0}catch(e){if(console.error("Database connection error in deleteDocument:",e),e instanceof Error&&(e.message.includes("Authentication failed")||e.message.includes("password")||e.message.includes("credentials")))throw Error("Database authentication failed. Please check your database credentials.");throw e}}async getDocumentPermissions(e,a){try{let i=await this.findUserById(a);if(!i)throw Error("User not found");if(!await t.default.documentPermission.findFirst({where:{documentId:e,userId:i.id,permission:"ADMIN"}})&&"ADMIN"!==i.role)throw Error("User does not have permission to view document permissions");return(await t.default.documentPermission.findMany({where:{documentId:e}})).map(e=>({...e,permission:e.permission,createdAt:new Date(e.createdAt)}))}catch(e){if(console.error("Database connection error in getDocumentPermissions:",e),e instanceof Error&&(e.message.includes("Authentication failed")||e.message.includes("password")||e.message.includes("credentials")))throw Error("Database authentication failed. Please check your database credentials.");throw e}}async setDocumentPermission(e,a,i,o){try{let r=await this.findUserById(a);if(!r)throw Error("Requesting user not found");if(!await t.default.documentPermission.findFirst({where:{documentId:e,userId:r.id,permission:"ADMIN"}})&&"ADMIN"!==r.role)throw Error("User does not have permission to manage document permissions");let n=await this.findUserById(i);if(!n)throw Error("Target user does not exist");let d=await t.default.documentPermission.upsert({where:{documentId_userId:{documentId:e,userId:n.id}},update:{permission:o},create:{documentId:e,userId:n.id,permission:o}});return{...d,permission:d.permission,createdAt:new Date(d.createdAt)}}catch(e){if(console.error("Database connection error in setDocumentPermission:",e),e instanceof Error&&(e.message.includes("Authentication failed")||e.message.includes("password")||e.message.includes("credentials")))throw Error("Database authentication failed. Please check your database credentials.");throw e}}async removeDocumentPermission(e,a,i){try{let o=await this.findUserById(a);if(!o)throw Error("Requesting user not found");if(!await t.default.documentPermission.findFirst({where:{documentId:e,userId:o.id,permission:"ADMIN"}})&&"ADMIN"!==o.role)throw Error("User does not have permission to manage document permissions");let r=await this.findUserById(i);if(!r)throw Error("Target user does not exist");return await t.default.documentPermission.delete({where:{documentId_userId:{documentId:e,userId:r.id}}}),!0}catch(e){if(console.error("Database connection error in removeDocumentPermission:",e),e instanceof Error&&(e.message.includes("Authentication failed")||e.message.includes("password")||e.message.includes("credentials")))throw Error("Database authentication failed. Please check your database credentials.");throw e}}async recordDownload(e,a){try{let i=await this.findUserById(a);if(!i)throw Error("User not found");await t.default.documentDownload.create({data:{documentId:e,userId:i.id}}),await t.default.document.update({where:{id:e},data:{downloadsCount:{increment:1}}})}catch(e){if(console.error("Database connection error in recordDownload:",e),e instanceof Error&&(e.message.includes("Authentication failed")||e.message.includes("password")||e.message.includes("credentials")))throw Error("Database authentication failed. Please check your database credentials.");throw e}}async recordView(e,a){try{let i=await this.findUserById(a);if(!i)throw Error("User not found");await t.default.documentView.findFirst({where:{documentId:e,userId:i.id,viewedAt:{gte:new Date(Date.now()-864e5)}}})||(await t.default.documentView.create({data:{documentId:e,userId:i.id}}),await t.default.document.update({where:{id:e},data:{viewsCount:{increment:1}}}))}catch(e){if(console.error("Database connection error in recordView:",e),e instanceof Error&&(e.message.includes("Authentication failed")||e.message.includes("password")||e.message.includes("credentials")))throw Error("Database authentication failed. Please check your database credentials.");throw e}}async getDocumentComments(e,a=1,i=10){try{let[o,r]=await Promise.all([t.default.documentComment.findMany({where:{documentId:e},skip:(a-1)*i,take:i,orderBy:{createdAt:"desc"},include:{user:!0}}),t.default.documentComment.count({where:{documentId:e}})]);return{comments:o.map(e=>({...e,parentCommentId:e.parentCommentId??void 0,createdAt:new Date(e.createdAt),updatedAt:new Date(e.updatedAt)})),total:r}}catch(e){if(console.error("Database connection error in getDocumentComments:",e),e instanceof Error&&(e.message.includes("Authentication failed")||e.message.includes("password")||e.message.includes("credentials")))throw Error("Database authentication failed. Please check your database credentials.");throw e}}async addDocumentComment(e,a,i,o){try{let r=await t.default.document.findUnique({where:{id:e}});if(!r)throw Error("Document not found");let n=await this.findUserById(a);if(!n)throw Error("User not found");if("ADMIN"!==n.role&&"FACULTY"!==n.role&&!await t.default.documentPermission.findFirst({where:{documentId:e,userId:n.id,permission:{in:["READ","WRITE","ADMIN"]}}})&&r.uploadedById!==n.id)throw Error("User does not have permission to comment on this document");if(o){let a=await t.default.documentComment.findUnique({where:{id:o}});if(!a||a.documentId!==e)throw Error("Invalid parent comment")}let d=await t.default.documentComment.create({data:{documentId:e,userId:n.id,content:i,parentCommentId:o}});return{...d,parentCommentId:d.parentCommentId??void 0,createdAt:new Date(d.createdAt),updatedAt:new Date(d.updatedAt)}}catch(e){if(console.error("Database connection error in addDocumentComment:",e),e instanceof Error&&(e.message.includes("Authentication failed")||e.message.includes("password")||e.message.includes("credentials")))throw Error("Database authentication failed. Please check your database credentials.");throw e}}async getDocumentByColivaraId(e,a){try{if(!e||"string"!=typeof e||""===e.trim()||e.includes("undefined")||e.includes(".pdf")||e.includes("."))return console.warn("Invalid colivara document ID format received in getDocumentByColivaraId:",e),null;let i=await t.default.document.findFirst({where:{colivaraDocumentId:e},include:{uploadedByUser:!0,documentUnit:!0}});if(!i)return null;if(a){let e=await this.findUserById(a);if(e&&"ADMIN"!==e.role&&"FACULTY"!==e.role&&!await t.default.documentPermission.findFirst({where:{documentId:i.id,userId:e.id,permission:{in:["READ","WRITE","ADMIN"]}}})&&i.uploadedById!==e.id)return null}return{id:i.id,title:i.title,description:i.description,category:i.category,tags:Array.isArray(i.tags)?i.tags.map(e=>String(e)):"object"==typeof i.tags&&null!==i.tags?Object.values(i.tags).map(e=>String(e)):[],uploadedBy:i.uploadedByUser?.name||i.uploadedBy,uploadedById:i.uploadedById,uploadedAt:new Date(i.uploadedAt),fileUrl:i.fileUrl,blobName:i.blobName??void 0,fileName:i.fileName,fileType:i.fileType,fileSize:i.fileSize,downloadsCount:i.downloadsCount||0,viewsCount:i.viewsCount||0,version:i.version||1,versionNotes:i.versionNotes||void 0,status:i.status,createdAt:new Date(i.createdAt),updatedAt:new Date(i.updatedAt),unitId:i.unitId||void 0,unit:i.documentUnit?{id:i.documentUnit.id,name:i.documentUnit.name,code:i.documentUnit.code||"",description:i.documentUnit.description||void 0,createdAt:i.documentUnit.createdAt,updatedAt:i.documentUnit.updatedAt}:void 0,colivaraDocumentId:i.colivaraDocumentId??void 0,colivaraProcessingStatus:i.colivaraProcessingStatus??void 0,colivaraProcessedAt:i.colivaraProcessedAt?new Date(i.colivaraProcessedAt):void 0,colivaraChecksum:i.colivaraChecksum??void 0}}catch(e){if(console.error("Database connection error in getDocumentByColivaraId:",e),e instanceof Error&&(e.message.includes("Authentication failed")||e.message.includes("password")||e.message.includes("credentials")))throw Error("Database authentication failed. Please check your database credentials.");throw e}}};e.s(["default",0,o])}];

//# sourceMappingURL=lib_services_document-service_ts_ad322d14._.js.map