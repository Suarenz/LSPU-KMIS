generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id               String               @id @default(dbgenerated("gen_random_uuid()"))
  email            String               @unique
  name             String
  unitId           String?              @map("unitId")
  avatar           String?
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  supabase_auth_id String?              @unique
  role             UserRole             @default(STUDENT)
  comments         DocumentComment[]
  downloads        DocumentDownload[]
  permissions      DocumentPermission[]
  views            DocumentView[]
  documents        Document[]
  unitPermissions  UnitPermission[]
  userUnit         Unit?                @relation("UserUnit", fields: [unitId], references: [id])

  @@map("users")
}

model Document {
  id               String               @id @default(cuid())
  title            String
  description      String
  category         String
  tags             Json
  uploadedBy       String
  uploadedAt       DateTime             @default(now())
  fileUrl          String
  fileName         String
  fileType         String
  fileSize         Int
  version          Int                  @default(1)
  versionNotes     String?
  parentDocumentId String?
  downloadsCount   Int                  @default(0)
  viewsCount       Int                  @default(0)
  createdAt        DateTime             @default(now())
  updatedAt        DateTime             @updatedAt
  uploadedById     String
  unitId           String?              @map("unitId")
  status           DocumentStatus       @default(ACTIVE)
  comments         DocumentComment[]
  downloads        DocumentDownload[]
  permissions      DocumentPermission[]
  views            DocumentView[]
  parentDocument   Document?            @relation("DocumentVersions", fields: [parentDocumentId], references: [id])
  documents        Document[]           @relation("DocumentVersions")
  documentUnit     Unit?                @relation(fields: [unitId], references: [id])
  uploadedByUser   User                 @relation(fields: [uploadedById], references: [id])

  @@map("documents")
}

model Unit {
  id          String           @id @default(cuid())
  name        String           @unique
  code        String?          @unique
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  documents   Document[]
  permissions UnitPermission[]
  users       User[]           @relation("UserUnit")

  @@map("units")
}

model DocumentPermission {
  id         String          @id @default(cuid())
  documentId String
  userId     String
  createdAt  DateTime        @default(now())
  permission PermissionLevel
  document   Document        @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([documentId, userId])
  @@map("document_permissions")
}

model UnitPermission {
  id         String          @id @default(cuid())
  unitId     String
  userId     String
  permission PermissionLevel
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt
  unit       Unit            @relation(fields: [unitId], references: [id], onDelete: Cascade)
  user       User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([unitId, userId])
  @@map("unit_permissions")
}

model DocumentDownload {
  id           String   @id @default(cuid())
  documentId   String
  userId       String
  downloadedAt DateTime @default(now())
  document     Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("document_downloads")
}

model DocumentView {
  id         String   @id @default(cuid())
  documentId String
  userId     String
  viewedAt   DateTime @default(now())
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("document_views")
}

model DocumentComment {
  id              String            @id @default(cuid())
  documentId      String
  userId          String
  parentCommentId String?
  content         String
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  document        Document          @relation(fields: [documentId], references: [id], onDelete: Cascade)
  parentComment   DocumentComment?  @relation("CommentReplies", fields: [parentCommentId], references: [id])
  replies         DocumentComment[] @relation("CommentReplies")
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("document_comments")
}

enum UserRole {
  ADMIN
  FACULTY
  STUDENT
  EXTERNAL
}

enum DocumentStatus {
  ACTIVE
  ARCHIVED
  PENDING_REVIEW
}

enum PermissionLevel {
  READ
  WRITE
  ADMIN
}
